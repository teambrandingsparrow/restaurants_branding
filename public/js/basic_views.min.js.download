
FB_Module.register({index:2},function(){app.p_views.Dashboard=Backbone.View.extend({el:$(".mcarv_dashboard"),events:{"click .dashboard-item":"ditem_clicked","click .ds_stat_db":"stat_item_clicked"},initialize:function(){app.eventBus.on("show:dashboard",this.show,this);this.template=_.template($("#dashitem_template").html())},load_stats:function(){var b,a,c;b=new Backbone.Model;a=this;b.url="/statistics/";b.fetch({success:function(e,d){var f;a.$el.find(".ds_stat_ul").html(a.template({items:d.items}))}})},hide_accs:function(){var c,b,a,d;b=$(".dashboard-items>li");for(c=0,a=b.length;c<a;c++){d=$(b[c]).data("ak");if(d&&!AL.any_access(d)){$(b[c]).hide()}cfg=$(b[c]).data("cfg");if(cfg&&get_cfg(cfg)!="true"){$(b[c]).hide()}}},show:function(){var a;a=this;app.pages.show_page(a);app.TopButtons.set();if(get_cfg("is_group_inner")=="true"){a.$el.find(".dashboard_sec._statistics").hide()}else{a.load_stats()}a.hide_accs()},ditem_clicked:function(f){var c,b,d,a;d=$(f.target).closest(".dashboard-item");c=d.data("href");b=d.data("popup");if(c){app.router.navigate(c,{trigger:true})}else{if(b){a=d.data("popup-option");if(typeof a==="string"){a=JSON.parse(a)}app.popups[b].show(_.extend({},a))}}},stat_item_clicked:function(b){var a=$(b.target).closest(".ds_stat_db").data("href");app.router.navigate(a,{trigger:true})}});FB_Module.init_fn(function(){app.SideMenu.add_item({view:"dashboard",item_id:"dashboard",label:"Dashboard",index:1})})});if(get_cfg("is_group")=="true"){(function(){app.WorkingAccount=new (Backbone.View.extend({events:{"click .dropdown-label":"toogle_dropdown",submit:"form_submitted"},el:$("#working_accounts_div"),initialize:function(){var b,a;a=this;this.form=new app.Form({appendTo:this.$el.find(".dropdown-box"),class_name:"_inline_bl",fields:{name:{type:"combobox",id:"",class_name:"_md _type2 _comp_inline _w30em _mgtp_5x _mgrt_1em",label:"Account Book",url:"/working_accounts/?name={{value}}&pagination=false",list_selector:"items",label_sel:"name",value_sel:"id",embedd_list_el:false,dlgTo:"scope"},_submit_btn:{tagName:"button",className:"component btn _type1 _mgtp_1x _comp_inline hdr_btn _md _w4em _theme1",innerHTML:"Set",attrs:{type:"submit"}}}});this.form.renderInputs();b=new Backbone.Model;b.url="/working_accounts/";b.fetch({data:$.param({op:"get_current"}),success:function(d,c){a.set_working_account(c.name)},error:function(c,d){a.form.renderServerErrors(d)}})},re_intialize:function(){app.SideMenu.removeAll();app.p_views={};app.p_view_inst={};app.popup_views={};app.popups={};app.objects={};$(".main_content_area").html(app.main_content_clone.html());app.eventBus.off();FB_Module.init_fns=[];FB_Module.load_all();FB_Module.init_all();if(window.after_init){after_init()}_.each(app.p_views,function(c,a){var b;b=app.p_view_inst[a]=new c;b.$el.data("view_inst",b)})},set_working_account:function(a){this.$el.parent().find(".header-branchname > .header-field-innr").text(get_cfg("branch_name"));this.$el.find(".working_accounts.dropdown-label > span").text(a)},toogle_dropdown:function(b){var a=this.$el.find(".dropdown-box");if(a.is(":visible")){a.hide()}else{app.set_dropdown(a);a.show();this.form.renderErrors()}},set_finperiod:function(a,b){app.finperiod_dd.form_submitted(null,a,{is_set_form:true,callback:b})},toogleLoadingMode:function(a){$("#loader_cnt").css(a?{display:"block",opacity:0.7}:{display:"none"})},accounts_changed:function(a,c){var b;b=this;b.remReq--;if(!a){b.remReq=-1;b.toogleLoadingMode(false);b.notifications.add("Error","Error while changing account book","error")}else{if(b.remReq==0){b.re_intialize();b.set_working_account(c.name);app.router.handleViewRoute(c.scope?"accounts":"dashboard");b.toogleLoadingMode(false);app.notifications.add("Running Account Book changed successfully","The Running Account Book has been changed successully","success")}}},form_submitted:function(){var c,b,d,a=this;b=this.form.get_values();c=new Backbone.Model;c.url="/working_accounts/";b.op="set";if(a.xhr){return}setTimeout(function(){if(a.xhr){a.xhr.abort();a.xhr=null}},3000);a.xhr=c.save(b,{success:function(g,f){var e;a.toogleLoadingMode(true);_.extend(app.appdata,_.pick(f,["scope","cid","branch_name","is_group_inner","ah","eh"]),f.configs);app.fb_doc_types=_.object(_.map(f.fb_doc_types,function(h){return[h.name,h]}));app.fb_docnum_classes=_.object(_.map(f.fb_docnum_classes,function(h){return[h.id,h]}));a.remReq=1;a.xhr=null;e={fn:a.accounts_changed,context:a,data:f};a.$el.find(".dropdown-box").hide();app.set_dropdown(null);if(f.finperiod_start){a.set_finperiod({from_date:f.finperiod_start,to_date:f.finperiod_end},e)}},error:function(e,f){a.xhr=null;a.form.renderServerErrors(f)}})}}))()})()};FB_Module.register({index:0},function(){var a={};a.vat={tax_info_popup_schema:{show_save_n_next:false,events:{submit:"submit_form","click .op_btn":"submit_form"},beforeInit:function(){return true},render:function(d){var g,f,e,c,b;b=this;if(!d){f=b.form=new app.Form(_.extend({appendTo:b.$el.find(".popup_body")},{default_attr:{class_name:"_type1 _lg _mgbt_1em"},fields:{vat_state_name:{type:"combobox",id:"",label:"State",url:"/list/states/?country_key=comp_country&name={{value}}&pagination=false"},vat_trn:{type:"inputbox",id:"",label:"TRN"}}}));f.renderInputs();b.listenTo(f,"all",b.form_ev_handler)}g=b.options.data;b.setMode("idle");if(g){b.form.set_values(g)}else{b.form.reset()}},submit_form:function(c){var b=this;b.options.invoker.tax_values=b.form.get_values();b.close()}},ps_ips_ext:{total_col:"gross_amount",ips_schema:{tax_perc:{head_label:"VAT%",width:10,index:60,ip_options:{type:"inputbox",id:"no_fade_disabled",label:"VAT%",disabled:true}},tax:{head_label:"VAT",width:10,index:70,ip_options:{type:"inputbox",id:"no_fade_disabled",label:"VAT",disabled:true}},gross_amount:{head_label:"Amount + VAT",width:10,index:80,ip_options:{type:"inputbox",id:"no_fade_disabled",label:"Amount+VAT",disabled:true}}},set_price:function(g){var f,e,b,h,c,d;b=this.parent.form.components.tax_regime.get_value();c=g.data.tax_det;f=this.get_values(g,["quantity","rate"]);if(!isNaN(f.quantity)&&!isNaN(f.rate)){e=f.quantity>=0&&f.rate>=0?wacky_round(Number(f.quantity)*Number(f.rate),2):"";h=c.vat_perc;d=(f.rate*f.quantity*(c.vat_perc/100));this.set_values(g,{amount:e,tax_perc:h,tax:d,gross_amount:e?e+d:""})}},schema:function(b,c){return c}},item_group_tax_popup_schema:{show_save_n_next:false,events:{submit:"submit_form","click .op_btn":"submit_form"},head:"Tax Details",class_name:"_mw600x",beforeInit:function(){return true},render:function(d){var g,f,e,c,b;b=this;if(!d){f=b.form=new app.Form(_.extend({appendTo:b.$el.find(".popup_body")},{default_attr:{class_name:"_type1 _lg _mgbt_1em"},fields:{taxability:{type:"selectbox",label:"Taxability",default_option:"",id:"_w10em _mgbt_1em",options:{taxable:"Taxable",nullrate:"Null Rated"},dlgTo:"scope"},vat_perc:{type:"inputbox",id:"_comp_inline _mgrt_1em _w8em",label:"VAT %",dlgTo:"scope"},cess:{type:"inputbox",id:"_w10em",label:"Cess %"}},validation:{taxability:{required:true},vat_perc:{required:true}}}));f.renderInputs();b.listenTo(f,"all",b.form_ev_handler)}g=b.options.data;b.setMode("idle");if(g){b.form.set_values(g)}else{b.form.reset()}},form_ev_handler:function(f,c,g){var b,d;d=this.form},submit_form:function(f){var c=this,d=c.options,b,g;b=c.form.get_values();g=c.form.validate();c.form.renderErrors(g);if(!_.isEmpty(g)){return}d.callback.call(d.invoker,b);c.close()}}};a.gst={tax_info_popup_schema:{show_save_n_next:false,events:{submit:"submit_form","click .op_btn":"submit_form"},beforeInit:function(){return true},render:function(d){var g,f,e,c,b;b=this;if(!d){f=b.form=new app.Form(_.extend({appendTo:b.$el.find(".popup_body")},{default_attr:{class_name:"_type1 _lg _mgbt_1em"},fields:{gst_state_name:{type:"combobox",id:"",label:"State",url:"/list/states/?country_key=comp_country&name={{value}}&pagination=false"},gst_reg_type:{type:"selectbox",label:"Registration Type",default_option:"",id:"_w10em _mgbt_1em",options:{reg:"Regular",comp:"Composition"},dlgTo:"scope"},gst_gstin:{type:"inputbox",id:"",label:"GSTIN"}}}));f.renderInputs();b.listenTo(f,"all",b.form_ev_handler)}g=b.options.data;b.setMode("idle");if(g){b.form.set_values(g)}else{b.form.reset()}},fill_tax_values:function(c,b){c.tax_values=_.pick(b,["gst_state_name","gst_reg_type","gst_gstin"])},submit_form:function(c){var b=this;b.options.invoker.tax_values=b.form.get_values();b.close()}},customer_form_schema:{state_name:{type:"combobox",id:"",label:"State",url:"/list/states/?country_key=comp_country&name={{value}}&pagination=false"},gstin:{type:"inputbox",id:"",label:"GSTIN"}},ps_ips_ext:{total_col:"gross_amount",ips_schema:{tax_perc:{head_label:"GST%",width:30,index:60,ip_options:{type:"inputbox",id:"no_fade_disabled",label:"GST%",disabled:true}},tax:{head_label:"GST",width:10,index:70,ip_options:{type:"inputbox",id:"no_fade_disabled",label:"GST",disabled:true}},cess:(get_cfg("en_cess")=="true"?{head_label:"Cess",width:10,index:70,ip_options:{type:"inputbox",id:"no_fade_disabled",label:"Cess",disabled:true}}:null),gross_amount:{head_label:"Total Amount",width:10,index:80,ip_options:{type:"inputbox",id:"no_fade_disabled",label:"Total Amount",disabled:true}}},schema:function(c,d){var b;b=c.doc_type=="bill"||c.doc_type=="credit_note"?_.omit(this.ips_schema,["cess"]):this.ips_schema;return _.extend({},d,b)},set_price:function(h){var g,f,b,i,c,e,d;b=this.parent.form.components.tax_regime.get_value();c=h.data.tax_det;g=this.get_values(h,["quantity","rate"]);if(!isNaN(g.quantity)&&!isNaN(g.rate)){f=g.quantity>=0&&g.rate>=0?wacky_round(Number(g.quantity)*Number(g.rate),2):"";i="GST "+c.igst+"% ("+(b=="st"?"CGST "+c.cgst+"% + SGST "+c.sgst+"%":"IGST "+c.igst+"%")+")";e=wacky_round(g.rate*g.quantity*(c.igst/100),2);d=get_cfg("en_cess")=="true"&&c.cess?wacky_round(g.rate*g.quantity*(c.cess/100),2):0;this.set_values(h,_.extend({amount:f,tax_perc:i,tax:e,gross_amount:f?wacky_round(f+e+d,2):""},(this.parent.doc_type=="invoice"||this.parent.doc_type=="debit_note")?{cess:d}:null))}}},invoice_bill_ext:{form_schema:{sp_cat:{fields:{tax_regime:{type:"selectbox",label:"Tax Regime",default_option:"",options:[{st:"Within State"},{is:"Interstate"}]}},validation:{tax_regime:{required:true}}}}},item_group_tax_popup_schema:{show_save_n_next:false,events:{submit:"submit_form","click .op_btn":"submit_form"},head:"Tax Details",class_name:"_mw600x",beforeInit:function(){return true},render:function(d){var g,f,e,c,b;b=this;if(!d){f=b.form=new app.Form(_.extend({appendTo:b.$el.find(".popup_body")},{default_attr:{class_name:"_type1 _lg _mgbt_1em"},fields:{hsn_code:{type:"inputbox",id:"_w15em",label:"HSN Code"},taxability:{type:"selectbox",label:"Taxability",default_option:"",id:"_w10em _mgbt_1em",options:{taxable:"Taxable",excempted:"Excempted"},dlgTo:"scope"},igst:{type:"inputbox",id:"_comp_inline _mgrt_1em _w8em",label:"IGST %",dlgTo:"scope"},cgst:{type:"inputbox",id:"_comp_inline _mgrt_1em _w8em",label:"CGST %"},sgst:{type:"inputbox",id:"_comp_inline _mgrt_1em _w8em",label:"SGST %"},cess:{type:"inputbox",id:"_w10em",label:"Cess %"}},validation:{hsn_code:{required:true},taxability:{required:true},igst:{required:true},cgst:{required:true},sgst:{required:true}}}));f.renderInputs();b.listenTo(f,"all",b.form_ev_handler)}g=b.options.data;b.setMode("idle");if(g){b.form.set_values(g)}else{b.form.reset()}b.form_ev_handler("changed",b.form.components.taxability)},form_ev_handler:function(f,c,g){var b,d;d=this.form;if(f=="keyup"&&c.name=="igst"){b=Number(c.get_value());if((!isNaN(b))&&b>=0&&b<100){d.set_values({cgst:b/2,sgst:b/2})}}else{if(f=="changed"&&c.name=="taxability"){this.form[c.get_value()=="taxable"?"show_comps":"hide_comps"](["igst","cgst","sgst"])}}},submit_form:function(f){var c=this,d=c.options,b,g;b=c.form.get_values();g=c.form.validate();c.form.renderErrors(g);if(!_.isEmpty(g)){return}d.callback.call(d.invoker,b);c.close()}}};a.no_tax={};set_objs({tax_methods:a})});FB_Module.register({index:2},function(){var c={fields:{name:{head_label:"Account Name",width:"40%",maxWidth:300},acc_type:{head_label:"Nature of Account",key:"acc_type_txt",width:"134px",choices:[{asset:"Asset"},{liability:"Liability"},{expense:"Expense"},{income:"Income"}]},subacc_of_name:{head_label:"Parent Account",width:"40%",url:"/accounts/?name={{value}}&pagination=false&is_cntlacc=true&_select_fields=name",list_selector:"items",label_sel:"name"},description:{head_label:"Description",width:"20%"},o_balance:{head_label:"Opening Balance",width:"150px",type:"money",wrapSPAN:"_amount_bl",align:"right"},c_balance:{head_label:"Current Balance",width:"150px",type:"money",wrapSPAN:true,align:"right"}},show_items:["name","acc_type","subacc_of_name","description","o_balance","c_balance"],filter_enable:["name","acc_type","subacc_of_name"],ips_filter_enable:["c_balance"]};set_objs({accounts_schema:c});var e=app.Tab.extend({label:"Regular Accounts",tab_id:"regular",model:app.models.Account,drill_to_view:"accounts",drill_arguments:{summary:true},is_tab_view:true,heading:"Regular Account",ds_options:{flex_schema:c,class_name:"hoverable ds_within_tab",has_pagination:true,has_filter:true,enable_sorting:true,ds_id:"ds_regular_accs",default_params:{sort_by:"name",is_cntlacc:"false",show_o_balance:"true"},idAttr:"id"},context_menu_items:[{key:"edit",value:"Edit"},{key:"report",value:"Make Report"}],popup:app.popups.AccountPopup,popup_options:{data:{is_cntlacc:false}},initComponents:function(){var f=this;var g;this.context_menu_items=g=_.clone(this.context_menu_items);g.splice(1,0,{key:"associate",value:"Associations"});swap_obj_keys(this,"_context_item_click","context_item_click");this.init();this.children=[this.ds]},_context_item_click:function(i,f,h){if(f=="edit"){var g=h.ds.get_row(i);if(g.defacc_key=="inventory"&&get_cfg("en_inventory")!="true"){app.popups.InventoryPopup.show({invoker:this,method:"create"})}else{this.show_popup({method:"update",id:i,data:g})}}else{if(f=="report"){app.popups.AccountReportPopup.show({account_id:i})}else{if(f=="associate"){app.popups.ASC.show({id:i,itype:"acc"})}}}},search_item:function(f){if(!f.name){delete f.name}_.extend(f,_.omit(this.$scope.args,["name"]));app.router.navigate(app.generate_url("accounts",null,f),{trigger:true,replace:true});this.ds.load({params:f})},onshow:function(f){if(!this.is_inited){this.initComponents();this.is_inited=true}this.$top_sec_el.show();this.ds.load({params:_.omit(this.$scope.args,["tab"]),presv_flt:!f.is_navigate})}});e.merge(app.ListPageTemplate,true);var a=app.Tab.extend({label:"Control Accounts",tab_id:"control_accounts",model:app.models.Account,enable_sorting:true,drill_to_view:"accounts",drill_arguments:{summary:true},is_tab_view:true,heading:"Control Account",ds_options:{flex_schema:c,class_name:"hoverable ds_within_tab",has_pagination:true,has_filter:true,enable_sorting:true,ds_id:"ds_cntl_accs",default_params:{sort_by:"name",is_cntlacc:"true",show_o_balance:"true"},idAttr:"id"},context_menu_items:[{key:"edit",value:"Edit"},{key:"report",value:"Make Report"}],popup:app.popups.AccountPopup,popup_options:{data:{is_cntlacc:true}},initComponents:function(){var f=this;var g;this.context_menu_items=g=_.clone(this.context_menu_items);g.splice(1,0,{key:"associate",value:"Associations"});swap_obj_keys(this,"_context_item_click","context_item_click");this.init()},_context_item_click:function(i,f,h){if(f=="edit"){var g=h.ds.get_row(i);this.show_popup({method:"update",id:i,data:g})}else{if(f=="report"){app.popups.AccountReportPopup.show({account_id:i})}else{if(f=="associate"){app.popups.ASC.show({id:i,itype:"acc"})}}}},search_item:function(f){if(!f.name){delete f.name}_.extend(f,_.omit(this.$scope.args,["name"]));app.router.navigate(app.generate_url("accounts",null,f),{trigger:true,replace:true});this.ds.load({params:f})},onshow:function(f){if(!this.is_inited){this.initComponents();this.is_inited=true}this.$top_sec_el.show();this.ds.load({params:_.omit(this.$scope.args,["tab"]),presv_flt:!f.is_navigate})}});a.merge(app.ListPageTemplate,true);var b={name:{head_label:"Account Name",style:"width:35%",index:0},item_list_txt:{head_label:"Accounts",style:"width:50%",index:1},description:{head_label:"Description",style:"width:15%",index:1}};var d=app.Tab.extend({label:"Account Groups",tab_id:"account_groups",model:app.models.AccountGroup,enable_sorting:true,drill_to_view:"accounts",drill_arguments:{summary:true,is_group:true},is_tab_view:true,heading:"Account Group",ds_options:{schema:b,class_name:"hoverable ds_within_tab",has_pagination:true,enable_sorting:true,ds_id:"ds_acc_groups",default_params:{sort_by:"name"},idAttr:"id"},context_menu_items:[{key:"edit",value:"Edit"},{key:"report",value:"Make Report"}],popup:app.popups.AccountGroupPopup,initComponents:function(){var f=this;var g;this.context_menu_items=g=_.clone(this.context_menu_items);g.splice(1,0,{key:"associate",value:"Associations"});swap_obj_keys(this,"_context_item_click","context_item_click");this.init()},_context_item_click:function(i,f,h){if(f=="edit"){var g=h.ds.get_row(i);this.show_popup({method:"update",id:i,data:g})}else{if(f=="report"){app.popups.AccountReportPopup.show({account_id:i,is_group:true})}else{if(f=="associate"){app.popups.ASC.show({id:i,itype:"accgrp"})}}}},search_item:function(f){this.ds.load({params:f})},onshow:function(f){if(!this.is_inited){this.initComponents();this.is_inited=true}this.$top_sec_el.show();this.ds.load({params:_.omit(this.$scope.args,["tab"]),presv_flt:!f.is_navigate})}});d.merge(app.ListPageTemplate,true);app.p_views.ChartofAccounts=app.PageTemplate.extend({page_name:"accounts",heading_plural:"Chart of Accounts",is_focusable:false,initialize:function(){var f=this;f.init({create_el:true});f.tabs=new app.Tabs({appendTo:f.$el,$scope:f,id:"prsr_tabs"});f.listenTo(f.tabs,"tab_show",f.tab_show);f.tabs.append([new e(),new a(),new d()]);f.search_box=new app.components.InputBox({options:{id:"top_right_srchbx",label:"Account Name",defaults:{class_name:"_type2 _lg"}},scope:f});f.$el.find(".float-right").append(f.search_box.$el);f.listenTo(f.search_box,"keydown",f.search_box_keydown);f.children=[f.tabs,f.search_box];app.eventBus.on("show:accounts",f.show,f)},search_box_keydown:function(f,g){if(g.keyCode==13){this.tabs.tabs[this.tabs.current_tab].search_item({name:f.get_value()})}},print_data:function(){var f,h,g;g=this.tabs.get_current_tab().ds;f=app.generate_ext_url("accounts",null,_.extend({op:"print_preview",is_cntlacc:this.tabs.current_tab=="control_accounts"},g.default_params,g.options.params));window.open(f,"_blank").addEventListener("load",function(){this.focus();this.print()},false)},export_data:function(){var f;f=this.tabs.get_current_tab().ds;$("#myiframwe").attr("src",app.generate_ext_url("accounts",null,_.extend({op:"export_to_excel",is_cntlacc:this.tabs.current_tab=="control_accounts"},f.default_params,f.options.params)))},on_page_url:function(h,g,j){var i,f;if(!app.has_permission("view_accounts")){return}if(h!=null){app.eventBus.trigger("show:account_details",h,g,j);return}else{if(!(g&&g.tab)){i=this.tabs.current_tab||"regular";this.args=g||{tab:"regular"}}else{i=g.tab;this.args=g}f={};f.do_replace=true;f.is_navigate=j;this.tabs.show_tab(i,f);app.TopButtons.set(["print","export"]);app.pages.show_page(this)}},tab_show:function(f,g){var h;h=this.$el.find(".top_buttons");h.hide();g=g||{};app.router.navigate(app.generate_url("accounts",null,_.extend(this.args,{tab:f})),{trigger:false,replace:g.do_replace})}});FB_Module.init_fn(function(){app.SideMenu.add_item({item_id:"accounts",label:"Accounting Masters",index:3,is_disabled:(!AL.any_access("accounts.display"))&&(!(get_cfg("en_costcenter")=="true"&&AL.any_access("cost_center.list")))});app.SideMenu.add_item({view:"accounts",item_id:"char_of_accounts",icon:"chartaccounts",under:"accounts",label:"Chart of Accounts",index:3,is_disabled:!AL.any_access("accounts.display")})})});FB_Module.register({index:2},function(){if(!(get_cfg("en_costcenter")=="true"&&AL.any_access("cost_center.list"))){return}var f,b,a;var g=gen_model("/cost_centers/");var b={default_attr:{class_name:"_type1 _lg _mgbt_1em"},fields:{name:{type:"inputbox",id:"",label:"Name"},itype:{type:"selectbox",label:"Type",id:"_w10em",options:[{grp:"Group"},{reg:"Regular"}],default_option:""},is_under:{type:"checkbox",id:"_comp_inline _mgtp_1em _mgrt_05em",label:"",value:"true",index:14,dlgTo:"scope"},under_name:{type:"combobox",id:"",label:"Under",class_name:"_type1 _lg _comp_inline _w20em",url:"/cost_centers/?name={{value}}&is_group=true&pagination=false",index:15},description:{type:"textarea",id:"_mgtp_1em",label:"Description"}},validation:{name:{required:true},cc_type:{required:true}}};var e=new (app.Popup.extend({id:"costcenter_popup",head:"Cost Center",show_save_n_next:true,handle_snnx:true,model:g,events:{submit:"submit_form","click .op_btn":"submit_form"},beforeInit:function(){return true},render:function(i){var j,h;h=this;if(!i){h.form=new app.Form(_.extend({appendTo:h.$el.find(".popup_body")},b));h.form.renderInputs();h.listenTo(h.form,"all",h.form_ev_handler)}j=h.options.data;h.setMode("idle");h.current_tab=null;if(j){j.is_under=!(!(j.under_name));j.itype=j.is_group==true?"grp":"reg";h.form.components.under_name[j.under_name!=""?"enable":"disable"]();h.form.set_values(j)}else{h.form.components.under_name.disable();h.form.reset()}h.form_ev_handler("clicked",h.form.components.is_under,null)},form_ev_handler:function(j,i,k){var h;h=this;if(j=="clicked"&&i.name=="is_under"){h.form.components.under_name[i.get_value()!=""?"enable":"disable"]()}}}))();f={costcenter_name:{head_label:"Cost Center",width:80,index:10,ip_options:{type:"combobox",id:"",label:"Cost Center",class_name:"_type2 _sm2 _nouline",url:"/cost_centers/?name={{value}}&pagination=false&is_group=false&name_not_in={{excl_names}}",dlgTo:"scope"}},amount:{head_label:"Amount",width:20,index:10,ip_options:{type:"inputbox",id:"_ralign",thousand_sep:true,label:"Amount",dlgTo:"scope"}},quantity:{head_label:"Quantity",width:20,index:10,ip_options:{type:"inputbox",id:"_ralign",thousand_sep:true,label:"Quantity",dlgTo:"scope"}}};a={costcenter_name:{required:true},amount:{required:true},quantity:{required:true}};var d=app.IPS.extend({head:"Cost Allocations",ips_id:"cost_allocsheet",class_name:"costallc_ip_sheet",schema:f,validation:a,ip_defaults:{class_name:"_sm2 _type2 _nouline"},row_delete_key_col:"costcenter_name",after_init:function(i){var h=this;h.listenTo(h,"all",h.ips_event_handler);_.extend(h,_.pick(i,["qty_based","vald_options"]));h.set_schema();h.parent=i.parent},set_schema:function(){var h;h=this;h.schema=_.omit(h.schema,[h.qty_based?"amount":"quantity"]);h.validation=_.omit(h.validation,[h.qty_based?"amount":"quantity"])},update_excl_names:function(m,l){var n,j,o,k,h;h=this;j=_.map(h.rows,function(p){var i=p.cols.costcenter_name.ip.get_value();if(i!=""){return i}else{return null}});n=l?h.rows:[h.rows[m]];for(k=0;k<n.length;k++){o=_.filter(j,function(p,q){return p!=null&&q!=m});n[k].cols.costcenter_name.ip.url_args={excl_names:o.join("|")}}},ips_event_handler:function(p,q,j,n,k){var o,l,m,h;o=q;q=this.rows[q];switch(p){case"row_insert":this.update_excl_names(o);break;case"item_selected":case"keydown":if(j=="costcenter_name"){this.update_excl_names(o,true)}break;case"text_changed":if(n.keyCode==8){this.backspace_pressed(q,o,j,n)}break;case"enterkey_press":if(this.focusColumn(q,j,"next",true,{select:true})==false){this.validate_row(q,true)}break}},post_validate:function(m,j,k){var i,l,h;h=this;l=h.qty_based?"quantity":"amount";i=_.reduce(this.get_value_list(),function(o,n){return o+Number(n[l])},0);if(h.vald_options){if(k&&!_.isEmpty(j)&&i!=h.vald_options[l]){app.notifications.add("Allocation Mismath","Allocation "+l+" should be equal to "+l,"error");return false}if(!k&&!_.isEmpty(j)&&i>h.vald_options[l]){app.notifications.add("Allocation Mismath","Allocation "+l+" should be equal to "+l,"error");return false}}return true}});d.merge(app.IPS_ext);var c=app.Tab.extend({label:"Cost Allocation",tab_id:"cost_alloc",afterAppend:function(){self=this;self.ip_sheet=new d({appendTo:self.$el,head:null,parent:this});self.ip_sheet.render()},load_ips:function(){var n,k,o,m,p,j,l,h;j=this;l=j.$scope.options;j.ip_sheet.release(true);m=l.row.extra_values||{};if(l.qty_based){j.ip_sheet.vald_options={quantity:l.quantity}}j.ip_sheet.qty_based=l.qty_based;h=m.cost_alloc;if(h){for(n=0;n<h.length;n++){j.ip_sheet.insertRow(h[n])}p=traverse(l,"row.errors.alloc_errors");if(p&&p.cost_alloc_errors){j.ip_sheet.renderErrors(null,p.cost_alloc_errors,{focus_first:true});p.cost_alloc_errors=null}}else{j.ip_sheet.insertRow({})}},validate:function(){return this.ip_sheet.validate_rows()},render_errors:function(h){if(h.cost_alloc_errors){this.ip_sheet.renderErrors(null,h.cost_alloc_errors);delete h.cost_alloc_errors}},get_values:function(){return{cost_alloc:this.ip_sheet.get_value_list()}},on_popup_show:function(){var h;h=this;h.load_ips()}});set_object("alloc_tab","cost_alloc",c,1);app.p_views.CostCenter=app.ListPageTemplate.extend({page_name:"cost_centers",model:g,popup:e,heading:"Cost Center",heading_plural:"Cost Centers",ds_options:{idAttr:"id",ds_id:"ds_cost_centers",schema:{name:{head_label:"Name",style:"width:30%"},itype_txt:{head_label:"Type",style:"width:10%"},under_name:{head_label:"Under",style:"width:30%"},description:{head_label:"Description",style:"width:30%"}},class_name:"hoverable _fz14",default_params:{}},initialize:function(){this.init({create_el:true})},ds_rendr:function(l){var h,k,j,n,m;n=l.$el.find(".table_list > li");for(h in l.rows){k=l.rows[h];n.eq(h).find("._cname").css({paddingLeft:(5+k.level*12).toString()+"px"}).addClass(k.is_group?"_b":"")}},ds_handler:function(m,p,n,o){var j,k,h,l;if(m=="rendered"){this.ds_rendr(n)}else{return this._ds_handler(m,p,n,o)}}});FB_Module.init_fn(function(){app.SideMenu.add_item({item_id:"accounts",label:"Accounting Masters",index:3});app.SideMenu.add_item({view:"cost_centers",item_id:"cost_centers",icon:"costcenters",under:"accounts",label:"Cost Centers",index:3,is_disabled:!(get_cfg("en_costcenter")=="true"&&AL.any_access("cost_center.list"))})})});FB_Module.register({index:2},function(){if(!(get_cfg("en_jobs")=="true")){return}var d,f,e;var g=gen_model("/jobs/");var f={default_attr:{class_name:"_type1 _sm2 _mgbt_1em"},fields:{name:{type:"inputbox",id:"_w15em _mgrt_1em",label:"Job ID"},job_type:{type:"selectbox",label:"Job Type",id:"_comp_inline _mgrt_1em _w10em",dlgTo:"scope",options:{proj:"Project",subc:"Sub Contract"},default_option:""},start_date:{type:"datefield",label:"Work Start Date",id:"_comp_inline _w8em _mgrt_05em"},end_date:{type:"datefield",label:"Work End Date",id:"_comp_inline _w8em _mgrt_05em"},description:{type:"inputbox",id:"_w25em",label:"Description"},est_amount:{type:"inputbox",id:"_comp_inline _w10em _mgrt_1em",label:"Est. Amount",thousand_sep:true},retention:{type:"inputbox",id:"_comp_inline _w10em",label:"Retention",thousand_sep:true},_cnt1:{tagName:"div",fields:{customer_name:{type:"combobox",id:"_w20em _comp_inline _mgrt_2em",label:"Customer",url1:"/cust_n_vendor/customers/?name={{value}}&pagination=false",url2:"/cust_n_vendor/subcontr/?name={{value}}&pagination=false",new_item_btn:true,dlgTo:"scope"},inactive:{type:"checkbox",id:"_comp_inline _mgtp_1em",label:"Inactive",value:"true",index:14,dlgTo:"scope"}}},use_phases:{type:"checkbox",id:"_comp_inline _mgrt_05em _mgbt_1em",label:"Use Phases",value:"true",index:14,dlgTo:"scope"}},validation:{job_name:{required:true}}};var c=new (app.Popup.extend({id:"jobs_popup",head:"Job",show_save_n_next:true,handle_snnx:true,model:g,events:{"click .op_btn":"submit_form"},beforeInit:function(){return true},render:function(i){var j,h;h=this;if(!i){h.form=new app.Form(_.extend({appendTo:h.$el.find(".popup_body")},f));h.form.renderInputs();h.listenTo(h.form,"all",h.form_ev_handler)}j=h.options.data;h.setMode("idle");h.current_tab=null;if(j){h.form.set_values(j)}else{h.form.reset()}h.form_ev_handler("changed",h.form.components.job_type)},form_ev_handler:function(l,i,m){var h,n,j,k;h=this;n=h.form.components;if(l=="changed"&&i.name=="job_type"){j=i.get_value()=="subc";n.customer_name.set_label(!j?"Customer":"Sub Contractor");n.customer_name.url=f.fields._cnt1.fields.customer_name[!j?"url1":"url2"];n.retention[j?"show":"hide"]();if(m){n.customer_name.set_value("")}}else{if(l=="add_new_clicked"&&i.name=="customer_name"){k={name:i.get_value(true),is_debcred:"true",m_type:n.job_type.get_value()=="subc"?"subc":"cust"};app.popups.CustVendPopup.show({method:"create",m_type:k.m_type,invoker:this,hide_cont_btn:true,data:k,callback:function(p,o){i.set_value(o.name);i.emul_itemselect()}})}}}}))();d={job_name:{head_label:"Job",width:80,index:10,ip_options:{type:"combobox",id:"",label:"Job ID",class_name:"_type2 _sm2 _nouline",url:"/jobs/?name={{value}}&pagination=false&is_group=false",dlgTo:"scope",label_sel:"name",value_sel:"name"}},phase_name:{head_label:"Phase",width:80,index:10,ip_options:{type:"combobox",id:"",label:"Phase",class_name:"_type2 _sm2 _nouline",url:"/phases/?name={{value}}&pagination=false&is_group=false",dlgTo:"scope"}},amount:{head_label:"Amount",width:30,index:10,ip_options:{type:"inputbox",id:"_ralign",thousand_sep:true,label:"Amount",dlgTo:"scope"}},quantity:{head_label:"Quantity",width:30,index:10,ip_options:{type:"inputbox",id:"_ralign",thousand_sep:true,label:"Quantity",dlgTo:"scope"}}};e={costcenter_name:{required:true},amount:{required:true},quantity:{required:true}};var b=app.IPS.extend({head:"Job Allocations",ips_id:"job_allocsheet",class_name:"joballc_ip_sheet",ip_defaults:{class_name:"_sm2 _type2 _nouline"},row_delete_key_col:"job_name",after_init:function(i){var h=this;h.listenTo(h,"all",h.ips_event_handler);_.extend(h,_.pick(i,["qty_based","vald_options"]));h.parent=i.parent;h.set_schema()},set_schema:function(){var h;h=this;h.schema=_.omit(d,[h.qty_based?"amount":"quantity"]);h.validation=_.omit(e,[h.qty_based?"amount":"quantity"]);h.render()},ips_event_handler:function(p,r,j,n,k){var o,l,m,h,q;o=r;r=this.rows[r];q=this;switch(p){case"row_insert":r.cols.job_name.ip.emul_itemselect();break;case"item_selected":case"keyup":if(j=="job_name"){m=k.comp.get_selected_data();if(m){r.extra_values.en_phases=m.use_phases}if(n.type){r.cols.phase_name.ip.set_value("")}r.cols.phase_name.ip[m&&m.use_phases?"show":"hide"](true)}break;case"text_changed":if(n.keyCode==8){this.backspace_pressed(r,o,j,n)}break;case"enterkey_press":if(this.focusColumn(r,j,"next",true,{select:true})==false){this.validate_row(r,true)}break}},post_validate:function(l,i,j){var m,k,h;h=this;k=h.qty_based?"quantity":"amount";m=_.reduce(this.get_value_list(),function(o,n){return o+Number(n[k])},0);if(h.vald_options){if(j&&m>0&&m!=h.vald_options[k]){app.notifications.add("Allocation Mismath","Allocation "+k+" should be equal to transaction "+k,"error");return false}if(!j&&m>0&&m>h.vald_options[k]){app.notifications.add("Allocation Mismath","Allocation "+k+" should be equal to "+k,"error");return false}}return true}});b.merge(app.IPS_ext);var a=app.Tab.extend({label:"Job Allocation",tab_id:"job_alloc",afterAppend:function(){self=this;self.ip_sheet=new b({appendTo:self.$el,head:null,parent:this});self.ip_sheet.render()},load_ips:function(){var m,j,o,l,p,h,k,n;h=this;k=h.$scope.options;h.ip_sheet.release();l=k.row.extra_values||{};if(k.qty_based){h.ip_sheet.vald_options={quantity:k.quantity}}h.ip_sheet.qty_based=k.qty_based;h.ip_sheet.set_schema();n=l.job_alloc;if(n){for(m=0;m<n.length;m++){h.ip_sheet.insertRow(n[m])}p=traverse(k,"row.errors.alloc_errors");if(p&&p.job_alloc_errors){h.ip_sheet.renderErrors(null,p.job_alloc_errors,{focus_first:true});p.job_alloc_errors=null}}else{h.ip_sheet.insertRow({})}},validate:function(){return this.ip_sheet.validate_rows()},get_values:function(){return{job_alloc:this.ip_sheet.get_value_list()}},render_errors:function(h){if(h.job_alloc_errors){this.ip_sheet.renderErrors(null,h.job_alloc_errors);delete h.job_alloc_errors}},on_popup_show:function(){var h;h=this;setTimeout(function(){h.load_ips()},100)}});set_object("alloc_tab","job_alloc",a,0);app.p_views.Jobs=app.ListPageTemplate.extend({page_name:"jobs",model:g,popup:c,heading:"Job",heading_plural:"Jobs",ds_options:{idAttr:"id",ds_id:"ds_jobs",flex_schema:{fields:{name:{head_label:"ID",width:"10%"},job_type:{head_label:"Job Type",width:"10%",key:"job_type_txt"},description:{head_label:"Description",width:"30%"},party_name:{head_label:"Party",width:"20%"},start_date:{head_label:"Start Date",width:"10%"},end_date:{head_label:"End Date",width:"10%"},est_amount:{head_label:"Est. Amount",width:"10%",align:"right",type:"money",wrapSPAN:true}},show_items:["name","job_type","description","party_name","start_date","end_date","est_amount"],filter_enable:["name","job_type","description","start_date","end_date","est_amount"]},class_name:"hoverable _fz14",default_params:{}},initialize:function(){var h;h=this;h.init({create_el:true})},ds_rendr:function(l){var h,k,j,n,m;n=l.$el.find(".table_list > li");for(h in l.rows){k=l.rows[h];n.eq(h).find("._cname").css({paddingLeft:(5+k.level*12).toString()+"px"}).addClass(k.is_group?"_b":"")}},ds_handler:function(p,k,j,n){var o,l,m,q,h,r;r=this;if(p=="rendered"){r.ds_rendr(j)}else{if(p=="before_render"){q={proj:"Project",subc:"Sub Contract"};for(l=0,m=k.items.length;l<m;l++){h=k.items[l];h.job_type_txt=q[h.job_type]}}else{return r._ds_handler(p,k,j,n)}}}});FB_Module.init_fn(function(){app.SideMenu.add_item({item_id:"accounts",label:"Accounting Masters",index:3});app.SideMenu.add_item({view:"jobs",item_id:"jobs",icon:"jobs",under:"accounts",label:"Jobs",index:3,is_disabled:!(get_cfg("en_jobs")=="true"&&AL.any_access("jobs.list"))})})});FB_Module.register({index:2},function(){if(!get_cfg("en_phases")=="true"){return}var a=gen_model("/phases/");var c={default_attr:{class_name:"_type1 _sm2 _mgbt_1em"},fields:{name:{type:"inputbox",id:"_w10em _mgrt_1em",label:"Name"},description:{type:"inputbox",id:"_w25em",label:"Description"}},validation:{name:{required:true}}};var b=new (app.Popup.extend({id:"phases_popup",head:"Phase",show_save_n_next:true,handle_snnx:true,model:a,events:{"click .op_btn":"submit_form"},beforeInit:function(){return true},render:function(e){var f,d;d=this;if(!e){d.form=new app.Form(_.extend({appendTo:d.$el.find(".popup_body")},c));d.form.renderInputs();d.listenTo(d.form,"all",d.form_ev_handler)}f=d.options.data;d.setMode("idle");d.current_tab=null;if(f){d.form.set_values(f)}else{d.form.reset()}},form_ev_handler:function(g,f,h){var d;d=this}}))();app.p_views.Phases=app.ListPageTemplate.extend({page_name:"phases",model:a,popup:b,heading:"Phase",heading_plural:"Phases",ds_options:{idAttr:"id",ds_id:"ds_phase",schema:{name:{head_label:"Name",style:"width:40%"},description:{head_label:"Description",style:"width:60%"}},class_name:"hoverable _fz14",default_params:{}},initialize:function(){var d;d=this;d.init({create_el:true})},ds_handler:function(m,g,f,k){var l,j,h,d,n;n=this;return n._ds_handler(m,g,f,k)}});FB_Module.init_fn(function(){app.SideMenu.add_item({item_id:"accounts",label:"Accounting Masters",index:3});app.SideMenu.add_item({view:"phases",item_id:"phases",under:"accounts",label:"Phases",index:3,is_disabled:!(get_cfg("en_phases")=="true"&&AL.any_access("phases.list"))})})});FB_Module.register({index:2},function(){if(!(get_cfg("en_subcontract")=="true")){return}var a=gen_model("/cust_n_vendor/subcontr/");app.p_views.SubContrs=app.ListPageTemplate.extend({page_name:"sub_contractors",model:a,popup_options:{m_type:"subc",data:{m_type:"subc"}},heading:"Sub Contractor",heading_plural:"Sub Contractors",ds_options:{idAttr:"id",ds_id:"ds_subc",schema:{name:{head_label:"Name",style:"width:40%"},description:{head_label:"Description",style:"width:60%"}},class_name:"hoverable _fz14",default_params:{}},initialize:function(){var b;b=this;b.popup=app.popups.CustVendPopup;b.init({create_el:true})},ds_handler:function(k,d,c,h){var j,g,f,b,l;l=this;return l._ds_handler(k,d,c,h)}});FB_Module.init_fn(function(){app.SideMenu.add_item({item_id:"accounts",label:"Accounting Masters",index:3});app.SideMenu.add_item({view:"sub_contractors",item_id:"sub_contractors",under:"accounts",label:"Sub Contractors",index:3,is_disabled:!AL.any_access("jobs.list")})})});FB_Module.register({index:2},function(){var h,e,d;h={code:{head_label:"Account Code",style:"width:10%",index:0},name:{head_label:"Account Name",style:"width:30%",index:0},cntreg_txt:{head_label:"Account Type",style:"width:10%",index:1},description:{head_label:"Description",style:"width:30%",index:1},c_balance:{head_label:"Closing Balance",prefix:"{currency}",style:"width:20%;text-align:right",type:"money",wrapSPAN:true,index:2}};var g={fields:{date:{head_label:"Date",width:"100px"},particulars:{head_label:"Particulars",width:"50%"},vtype:{head_label:"Vchr Type",key:"vtype_txt",width:"100px"},vchr_ref_no:{head_label:"Doc Ref No",width:"25%"},description:{head_label:"Description",width:"25%"},debit:{head_label:"Debit",type:"money",wrapSPAN:true,width:"120px",align:"right"},credit:{head_label:"Credit",type:"money",wrapSPAN:true,width:"120px",align:"right"},balance:{head_label:"Balance",type:"money",wrapSPAN:true,width:"150px",align:"right"}},show_items:["date","particulars","vtype","vchr_ref_no","description","debit","credit","balance"],filter_enable:["customer_name","policy_no","date"]};set_objs({trs_schema:g});d={date_txt:{head_label:"&nbsp;",style:"width:140px"},debit_sum_txt:{head_label:"Total Debit",style:"width:160px;text-align:right"},credit_sum_txt:{head_label:"Total Credit",style:"width:160px;text-align:right"},closing_balance_txt:{head_label:"Closing Balance",style:"width:170px;text-align:right",index:2}};var b=app.Tab.extend({label:"Statement of Account",tab_id:"statement",model:app.models.Transaction,drill_to_view:"voucher",has_unclickable:true,is_tab_view:true,no_newbtn:true,ds_options:{flex_schema:g,schema:e,default_params:{inc_vchr_ref_no:true},class_name:"hoverable ds_within_tab",ds_id:"ds_accdet_trans",idAttr:"voucher_id",enable_sorting:true,sort_enabled_to:["date"]},initComponents:function(){var i=this;this.init();this.children=[this.ds]},print_data:function(){var i,j;i=app.generate_ext_url("reports","account",_.extend({op:"print_preview",account_id:this.$scope.current_account.id},_.omit(this.$scope.args,"tab_id")));window.open(i,"_blank").addEventListener("load",function(){this.focus();this.print()},false)},export_data:function(){$("#myiframwe").attr("src",app.generate_ext_url("reports","account",_.extend({output_format:"excel",account_id:this.$scope.current_account.id},_.omit(this.$scope.args,"tab_id"))))},onshow:function(i){if(!this.is_inited){this.initComponents();this.is_inited=true}this.ds.load({params:_.extend({account:this.$scope.current_account.id},_.omit(this.$scope.args,"tab_id")),success:function(k,j){var l=this.$el.find(".table_list > li");if(j.items.length&&j.items[0].clickable==false){l.eq(0).addClass("unclickable")}},presv_flt:!i.is_navigate})},onhide:function(){this.ds.release()}});b.merge(app.ListPageTemplate,true);var c=app.Tab.extend({label:"Monthly Summary",tab_id:"summary",model:app.models.AccountSummary,is_tab_view:true,no_newbtn:true,ds_options:{model:new app.models.AccountSummary,schema:d,ds_id:"ds_month_summery",class_name:"hoverable",default_params:{on:"monthly"},idAttr:"date_txt",has_pagination:false,handle_pagination:false},initComponents:function(){var i=this;this.init()},print_data:function(){var i,j;i=app.generate_ext_url("account_summary",null,_.extend({op:"print_preview",on:"monthly",account_id:this.$scope.current_account.id},_.omit(this.$scope.args,"tab_id")));window.open(i,"_blank").addEventListener("load",function(){this.focus();this.print()},false)},ds_handler:function(i,m,j,k){if(i=="li_clicked"){var l=j.get_row(m);if(!l.account_id){return}app.router.navigate(app.generate_url("accounts",l.account_id,{tab_id:"statement",from_date:l.from_date,to_date:l.to_date}),{trigger:true})}},onshow:function(i){if(!this.is_inited){this.initComponents();this.is_inited=true}this.ds.load({params:_.extend({account_id:this.$scope.current_account.id},_.omit(this.$scope.args,"tab_id")),presv_flt:!i.is_navigate})},onhide:function(){this.ds.release()}});c.merge(app.ListPageTemplate,true);var f={default_attr:{class_name:"_type1 _sm2 _comp_inline _mgrt_1em"},fields:{name:{type:"inputbox",label:"Account Name",id:"_w20em"},show_zero_balance:{type:"checkbox",id:"_mgtp_1em",label:"Hide accounts with zero balance",value:"false"},_submit_btn:{tagName:"button",className:"component btn _type1 _md _theme1 _mgtp_9x",innerHTML:"Submit",attrs:{type:"submit"}}},validation:{}};var a=app.Tab.extend({label:"Sub Accounts",tab_id:"subaccounts",model:app.models.Account,is_tab_view:true,drill_to_view:"accounts",no_newbtn:true,context_menu_items:[{key:"edit",value:"Edit"},{key:"report",value:"Make Report"}],ds_options:{schema:h,ds_id:"ds_subaccs",class_name:"hoverable ds_within_tab",idAttr:"id",handle_pagination:true,has_pagination:true,model:new app.models.Account},initComponents:function(){var i=this;i.form=new app.Form(_.extend({appendTo:this.$el,class_name:"accountdetail_form _mgbt_1em"},f));i.form.renderInputs();i.listenTo(i.form,"form_submit",function(){i.load_ds(_.extend({show_zero_balance:true},i.form.get_values(true)),{is_navigate:true})});this.init()},ds_handler:function(i,l,j,k){if(i=="li_clicked"&&l){app.router.navigate(app.generate_url("accounts",l,_.omit(this.$scope.args,["tab_id","is_group"])),{trigger:true})}else{if(i=="context_menu"){this.context_menu.show(l,{left:k.pageX,top:k.pageY},{ds:j})}}},context_item_click:function(l,i,k){if(i=="edit"){var j=k.ds.get_row(l);app.popups.AccountPopup.show({invoker:this,callback:function(){this.load_ds(null,{is_navigate:false})},method:"update",id:l,data:j})}else{if(i=="report"){app.popups.AccountReportPopup.show({account_id:l})}}},print_data:function(){var i,j;i=app.generate_ext_url("accounts",null,_.extend({op:"print_preview",subacc_of_id:this.$scope.current_account.id},_.omit(this.$scope.args,"tab_id")));window.open(i,"_blank").addEventListener("load",function(){this.focus();this.print()},false)},export_data:function(){$("#myiframwe").attr("src",app.generate_ext_url("accounts",null,_.extend({op:"export_to_excel",subacc_of_id:this.$scope.current_account.id},_.omit(this.$scope.args,"tab_id"))))},load_ds:function(l,k){var j,i;j=this;i=j.$scope;this.ds.load({params:_.extend({subacc_of_id:i.current_account.id},_.omit(i.args,"tab_id"),l),success:function(n,m){if(i.data.defkey=="cost_of_op"&&m.cogs&&!i.data.cogs_loaded){i.data.c_balance=Number(i.data.c_balance)+Number(m.cogs);var o=i.template1({items:{"Closing Balance":to_money2(i.data.c_balance,2)}});i.$el.find(".account_info").html(o);i.data.cogs_loaded=true}},presv_flt:!k.is_navigate})},onshow:function(j){var i=this;if(!i.is_inited){i.initComponents();i.is_inited=true}i.form.reset();i.form.set_values(_.pick(i.$scope.args,["show_zero_balance"]));i.load_ds(null,j)},onhide:function(){this.ds.release()}});a.merge(app.ListPageTemplate,true);app.p_views.AccountDetails=app.PageTemplate.extend({heading_plural:"Account Details",is_focusable:false,is_dynamic_load:true,events:{"click .content-topsec .btn":"top_btn_clicked"},initialize:function(){var j=this,i;if(!AL.has_access("accounts","display")){return}j.init({create_el:true});app.eventBus.on("show:account_details",j.show,j);j.accounts_view=app.p_view_inst.ChartofAccounts;j.on("hide",j.onhide);i=_.template("<%_.each(btns,function(btn){%><button class='component btn _type1 _md _theme1 <%=btn.pop_cls%>'><%=btn.head%></button> <%});%>");j.$el.find(".content-topsec > .float-right").html($(i({btns:[{pop_cls:"_edit_btn",head:"Edit Account"},{pop_cls:"_delete_btn",head:"Delete Account"}]})));j.$el.find(".content-topsec").append('<div class="info_bar account_info"></div>');j.template1=_.template("<dl><% for(item in items){ %><dt><%=item%></dt><dd><%=items[item]%></dd><% } %></dl>");j.tabs=new app.Tabs({appendTo:j.$el,$scope:j,id:"accdet_tabs"});j.listenTo(j.tabs,"tab_show",j.tab_show);j.tabs.append([new b(),new c(),new a()]);j.children=[j.tabs];j.on("popup_event",j.popup_event)},top_btn_clicked:function(k){var j,i;j=$(k.target);i=this;if(j.hasClass("_edit_btn")){app.popups.AccountPopup.show({invoker:i,method:"update",data:i.data})}else{if(j.hasClass("_delete_btn")){app.Prompt.show({context:i,prompt_type:"yes_no",head:"Delete "+i.data.name,text:'Do you sure you want to delete "'+i.data.name+'"'})}}},popup_event:function(l,i,k){var j=this;if(l=="save_success"){app.router.navigate(app.generate_url("accounts",i.id,{summary:true}),{trigger:true,replace:true});app.notifications.add("Account Details Changed","Account Details of ("+this.model.name+") has been changed","success")}else{if(l=="prompt_btn:click"){if(k=="yes"){this.model.destroy({success:function(n,m){app.router.navigate(app.generate_url("accounts"),{trigger:true});app.notifications.add("Account Deleted","Account ("+j.model.get("name")+") has been deleted","success")},error:function(n,o){var m=o.responseJSON;if(m&&m.errors.__all__){app.notifications.add("Error",m.errors.__all__,"error")}else{app.notifications.add("Error","Unknown Error while Deleting account","error")}}})}}}$.magnificPopup.instance.close()},load_data:function(m,k,i,n){var l,j;this.$el.find(".account_info").addClass("float_right");this.$el.find(".page_head").text(m.name);this.current_account=m;this.account_sel=i;this.args=k||{};l=m.is_cntlacc?"subaccounts":"statement";if(!this.args.tab_id){this.args.tab_id=l}app.TopButtons.set(["print","export"]);j={is_navigate:n};this.tabs.show_tab(this.args.tab_id,j);app.focus_handler.page_changed(true)},tab_show:function(i,j){app.router.navigate(app.generate_url("accounts",this.account_sel,_.extend(this.args,{tab_id:i})),{trigger:false,replace:j})},print_data:function(i){var j;j=this.tabs.current_tab;this.tabs.tabs[j].print_data()},export_data:function(i){var j;j=this.tabs.current_tab;this.tabs.tabs[j].export_data()},show:function(i,k,l){var j=this;k=k||{};this.model=new (!k||!k.is_group?app.models.Account:app.models.AccountGroup);this.model.set("id",i.replace("/","__sl__"));app.pages.show_page(j);this.model.fetch({data:$.param(_.omit(k,"tab_id")),success:function(n,m){var o;j.$el.find(".ds_head").text(m.name);j.data=m;o={};o[k.from_cf?"Balance":"Closing Balance"]=to_money2(m.c_balance,2);var p=j.template1({items:o});j.$el.find(".account_info").html(p);j.load_data(m,k,i,l)},error:function(){alert("This account does not exist")}})},onhide:function(){this.tabs.tabs[this.tabs.current_tab].onhide()}})});FB_Module.register({index:2},function(){var c=Backbone.Model.extend({urlRoot:"/company/details/",sync:function(g,e,d){if(g=="create"||g=="update"){var f=new FormData();_.each(e.attributes,function(i,h){f.append(h,i)});_.defaults(d||(d={}),{data:f,processData:false,contentType:false})}return Backbone.sync.call(this,g,e,d)}});var b={default_attr:{class_name:"_type1 _md _mgbt_05em"},fields:{name:{type:"inputbox",id:"_w25em",label:"Name",index:10},name_abbr:{type:"inputbox",id:"_w25em",label:"Abbr",index:10},branch_name:(get_cfg("is_branch")=="True"?{type:"inputbox",id:"_w25em",label:"Branch Name",index:10}:null),website:{type:"inputbox",id:"_w25em",label:"Website",index:20},email:{type:"inputbox",id:"_w25em",label:"E-Mail",index:30},finyear_start:{type:"inputbox",id:"_w10em",label:"Financial Year Start Date",index:40},book_start:{type:"inputbox",id:"_w10em",label:"Book Start Date",index:40},logo:{type:"filefield",id:"_w25em",ret_files:true,label:"Logo",index:50},address:{type:"textarea",id:"_w25em",label:"Address",index:60},shipping_address:{type:"textarea",id:"_w25em",label:"Default Shipping Address",index:60}},validation:{finyear_start:{required:true,pattern:"date"}}};app.popups.CompanyDetailPopup=new (app.Popup.extend({id:"company_details_popup",head:"Company Detail",events:{submit:"submit_form","click .op_btn":"submit_form"},form_schema:b,model:c,beforeInit:function(){return true},onshow:function(d){this.options=d.el.data("trigger_data");this._render()},render:function(f){var d=this;if(!f){this.form=new app.Form(_.extend({appendTo:this.$el.find(".popup_body"),order_items:true},this.form_schema));this.form.renderInputs()}this.setMode("idle");var e=new c;e.fetch({success:function(g,h){d.form.set_values(_.pick(h,Object.keys(d.form_schema.fields)))}})}}))();var a=app.Tab.extend({label:"General",tab_id:"general",no_append:true,events:{"click .edit_details_btn":"edit_btn_clicked"},initComponents:function(){var d=new Backbone.Model;d.url="/company/details";d.view=this;this.model=d;this.load_data()},load_data:function(){this.model.fetch({success:this.render_details})},render_details:function(e,f){this.data=f;var d=e.view,g;f.address=f.address.replace(/\n/g,"<br>");g={name:".company_name",country_name:".country_name",branch_name:".branch_name",currency_name:".currency_name",state_name:".state_name",tax_name:".tax_method",address:".address",email:".email",website:".website"};for(key in g){d.$el.find(g[key]).html(f[key])}d.$el.find(".company_logo").attr("src","/company/logo?"+new Date().getTime())},edit_btn_clicked:function(){app.popups.CompanyDetailPopup.show({invoker:this,callback:function(e,d){set_cfg("finyear_start",d.data.finyear_start);this.load_data()}})},onshow:function(){if(!this.is_inited){this.initComponents();this.is_inited=true}}});if(AL.any_access("other_settings")){set_object("company_tabs1","general_tab",a)}});FB_Module.register({index:2},function(){var a={default_attr:{class_name:"_type1 _md _mgbt_05em "},fields:{name:{type:"inputbox",id:"_w20em",label:"Name"},username:{type:"inputbox",id:"_w20em",label:"User ID"},email:{type:"inputbox",id:"_w20em",label:"Email"},designation:{type:"inputbox",id:"_w20em",label:"Designation"},password1:{type:"inputbox",ip_type:"password",id:"_w20em",label:"Password"},password2:{type:"inputbox",ip_type:"password",id:"_w20em",label:"Password Confirm"},accesslist_name:{type:"combobox",id:"_w20em",label:"Access List",url:"/access_lists/?name={{value}}&pagination=false",list_selector:"items",label_sel:"name",embedd_list_el:false,index:30},en_mfa:{type:"selectbox",label:"Enable Multi-factor Authentication (MFA)",id:"_w20em",options:[{"false":"No"},{"true":"Yes"}],default_option:"false",dlgTo:"scope"},mfa_det_btn:{type:"button",label:"Show QR",id:"_w7em",dlgTo:"scope"},_qr_cnt:{tagName:"div",className:"_qr_cnt"}},validation:{username:{required:true},email:{required:false,pattern:"email"},name:{required:true},password1:[{required:true},{equalTo:"password2",msg:"Passwords should match"}],password2:{required:true}}};app.popups.Member=new (app.Popup.extend({id:"member_popup",head:"User",events:{submit:"submit_form","click .op_btn":"submit_form"},model:app.models.Member,beforeInit:function(){return true},onshow:function(d){this.options=d.el.data("trigger_data");this._render()},render:function(e){var d,g;d=this;if(!e){d.form=new app.Form(_.extend({appendTo:d.$el.find(".popup_body")},a));d.form.renderInputs();d.listenTo(d.form,"all",d.form_ev_handler)}var f=d.options.data;d.form[d.options.method=="update"?"hide_comps":"show_comps"](["password1","password2"]);d.form.hide_comps(["mfa_det_btn"]);d.setMode("idle");g=d.form.components;g.en_mfa.is_qr_shown=false;g.mfa_det_btn.set_label("Show QR");d.form.$el.find("._qr_cnt").html("").css({height:"180px"}).hide();d.mfa_key=null;d.form.reset();if(f){d.form.set_values(f)}},after_get_values:function(e){var d;d=this;if(e.en_mfa=="true"){if(!d.mfa_key){d.form.components.en_mfa.render_error("Scan QR to enable mfa");return false}e.mfa_key=d.mfa_key}},form_ev_handler:function(k,i,j){var n,d,f,g,h,l;n=this;d=n.form.components;if(k=="changed"&&i.name=="en_mfa"){d.mfa_det_btn[i.get_value()=="true"?"show":"hide"]()}else{if(k=="clicked"&&i.name=="mfa_det_btn"){f=n.form.$el.find("._qr_cnt");if(i.is_qr_shown){f.html("").hide()}else{h=d.name.get_value();if(h==""){d.name.render_error("This field is required");return}f.show();n.center();g=new n.model;g.fetch({data:$.param({op:"get_mfa_qr",name:h}),success:function(m,e){f.html("<img src='data:image/svg+xml;base64,"+e.img_b64+"'>");n.mfa_key=e.key},error:function(e,m){app.notifications.add("Error","Unable to fetch QR","error")}})}i.is_qr_shown=!i.is_qr_shown;i.set_label(i.is_qr_shown?"Hide QR":"Show QR");n.center()}}}}))();var b={name:{head_label:"Name",style:"width:40%",index:0},email:{head_label:"Email",style:"width:20%",index:1},designation:{head_label:"Designation",style:"width:20%",index:2},accesslist_name:{head_label:"AccessList",style:"width:20%",index:4}};var c=app.Tab.extend({label:"Users",tab_id:"members",model:app.models.Member,is_tab_view:true,heading:"User",ds_options:{schema:b,ds_id:"ds_members"},popup:app.popups.Member,initComponents:function(){var d=this,f,e;if(AL.has_access("members","create")){f=_.clone(this.context_menu_items);f.splice(1,0,{key:"change_password",value:"Change Password"});f.splice(2,0,{key:"settings",value:"User Settings"});this.context_menu_items=f;swap_obj_keys(this,"_context_item_click","context_item_click")}this.init()},_context_item_click:function(g,d){var f,e;e=this;if(d=="change_password"){app.popups.ChangePasswordPopup.show({popup_type:"update",invoker:e,member_id:g,callback:function(){app.notifications.add("Password Changed","The password has been changed successfully","success")}})}else{if(d=="settings"){app.popups.UserSettingPopup.show({invoker:e,member_id:g,method:"set",callback:function(){e.ds.load()}})}else{return this._context_item_click(g,d)}}},onshow:function(){if(!this.is_inited){this.initComponents();this.is_inited=true}this.$top_sec_el.show();this.ds.load()}});c.merge(app.ListPageTemplate);if(AL.any_access("members")){set_object("company_tabs","members_tab",c)}});FB_Module.register({index:2},function(){var g,j,e,d;g={default_attr:{class_name:"_type1 _md _mgbt_1em"},fields:{name:{type:"inputbox",id:"_mgbt_1em",label:"Name"},doc_cat:{type:"selectbox",id:"_w12em",label:"Document Category",default_option:"",options:[{cd:"Company Document"},{ed:"Employee Document"}]},has_expiry:{type:"checkbox",value:"true",id:"_mgrt_05em _comp_block _mgbt_1em",label:"Has Expiry?"},is_unique:{type:"checkbox",id:"_mgbt_1em _comp_block",value:"true",label:"Is the document number unique?",dlgTo:"scope"},unique_against:{type:"selectbox",id:"_mgbt_1em",label:"Unique Against?",default_option:"",options:[{1:"Employee ID"},{2:"Employee Nationality"}]}},validation:{name:{required:true}}};e={default_attr:{class_name:"_type1 _md"},fields:{document_type_name:{type:"combobox",id:"_mgbt_1em",label:"Document Type",url:"/doc_man/doc_types/?q={value}&pagination=false",dlgTo:"scope"},employee_name:{type:"combobox",label:"Employee",id:"_mgbt_1em",url:"/employees/?name={{value}}&pagination=false"},document_no:{type:"inputbox",id:"_mgbt_1em _w15em",label:"Document No"},expiry_date:{type:"datefield",id:"_mgbt_1em _w10em _comp_inline",label:"Expiry Date"},description:{type:"textarea",id:"_w30em",label:"Description"}},validation:{name:{required:true}}};var f=gen_model("/doc_man/doc_types/");j=new (app.Popup.extend({id:"document_type_popup",head:"Document Types",class_name:"_w600px",model:f,events:{submit:"submit_form","click .op_btn":"submit_form"},beforeInit:function(){return true},render:function(k){var l;if(!k){this.form=new app.Form(_.extend({appendTo:this.$el.find(".popup_body")},g));this.form.renderInputs();this.listenTo(this.form,"all",this.form_ev_handler)}l=this.options.data;this.setMode("idle");this.current_tab=null;this.form.hide_comps(["unique_against"]);if(l){this.form.set_values(l);this.form_ev_handler("clicked",this.form.components.is_unique)}else{this.form.reset()}},form_ev_handler:function(l,k,m){if(l=="clicked"&&k.name=="is_unique"){this.form[k.get_value()=="true"&&this.form.components.doc_cat.get_value()=="ed"?"show_comps":"hide_comps"](["unique_against"])}else{if(l=="changed"&&k.name=="doc_cat"){this.form.hide_comps(["unique_against"])}}}}))();var c={name:{head_label:"Name",style:"width:70%",index:0},description:{head_label:"Description",style:"width:30%",index:0}};var b=app.Tab.extend({label:"Document Types",tab_id:"doc_types",model:f,is_tab_view:true,heading:"Document Type",ds_options:{schema:c,ds_id:"ds_doc_types"},popup:j,initComponents:function(){var k=this;this.init()},onshow:function(){if(!this.is_inited){this.initComponents();this.is_inited=true}this.$top_sec_el.show();this.ds.load()}});b.merge(app.ListPageTemplate);var i=gen_model("/doc_man/documents/");var h={fields:{document_type_name:{head_label:"Document Type",width:"15%",url:"/doc_man/doc_types/?q={value}&pagination=false"},employee_name:{head_label:"Employee",width:"30%",url:"/employees/?name={{value}}&pagination=false"},document_type_cat:{head_label:"Category",key:"dtype_cat_txt",width:"10%"},document_no:{head_label:"Document No",width:"10%"},expiry_date:{head_label:"Expiry Date",width:"95px"},description:{head_label:"Description",width:"25%"}},show_items:["document_type_cat","employee_name","document_type_name","document_no","expiry_date","description"],filter_enable:["document_type_name","employee_name","document_no","description"],ips_filter_enable:["expiry_date"]};d=new (app.Popup.extend({id:"document_popup",head:"Document",class_name:"_w600px",model:i,events:{submit:"submit_form","click .op_btn":"submit_form"},beforeInit:function(){return true},render:function(m){var o,l,k,n;k=this;if(!m){n=k.form=new app.Form(_.extend({appendTo:k.$el.find(".popup_body")},e));n.renderInputs();k.listenTo(n,"all",k.form_ev_handler)}n=k.form;l=k.options;o=l.data;k.setMode("idle");k.current_tab=null;n.reset();n.hide_comps(["employee_name","expiry_date"]);if(o){n.set_values(o);n.components.document_type_name.emul_itemselect()}},form_ev_handler:function(n,l,o){var p,k,m;k=this;if(n=="item_selected"&&l.name=="document_type_name"){p=l.get_selected_data();m=k.form.components;m.employee_name[p.doc_cat=="cd"?"hide":"show"]();m.expiry_date[p.has_expiry?"show":"hide"]()}}}))();var a=app.Tab.extend({label:"Documents",tab_id:"documents",model:i,is_tab_view:true,heading:"Document",ds_options:{flex_schema:h,has_filter:true,ds_id:"ds_docs"},popup:d,initComponents:function(){var k=this;this.init()},onshow:function(k){if(!this.is_inited){this.initComponents();this.is_inited=true}this.$top_sec_el.show();this.ds.load({params:k})},ds_rendr:function(n){var k,m,l,p,o;p=n.$el.find(".table_list > li");for(k in n.rows){m=n.rows[k];if(m.expiry_status!="not_expired"){p.eq(k).find("._cexpiry_date").addClass(m.expiry_status=="expired"?"_red":"_yellow")}}},ds_handler:function(t,n,m,r){var s,l,p,q,o,k;if(t=="rendered"){this.ds_rendr(m)}else{if(t=="before_render"){s=n.items;l={cd:"Company Document",ed:"Employee Document"};for(p=0,q=s.length;p<q;p++){s[p].dtype_cat_txt=l[s[p].document_type_cat]}}else{return this._ds_handler(t,n,m,r)}}}});a.merge(app.ListPageTemplate,true);if(AL.any_access("other_settings")){set_object("company_tabs","doc_types_tab",b);set_object("company_tabs","doc_tab",a)}});FB_Module.register({index:2},function(){var b=gen_model("/currencies/");var d={default_attr:{class_name:"_type1 _md _mgbt_05em"},class_name:"_mgbt_2em",fields:{name:{type:"inputbox",id:"_w20em",label:"Name",dlgTo:"scope"},abbr:{type:"inputbox",id:"_comp_inline _w7em _mgrt_1em",label:"Abbr"},symbol:{type:"inputbox",id:"_comp_inline _w4em _mgrt_1em",label:"Symbol"},unit_name:{type:"inputbox",id:"_comp_inline _w10em _mgrt_1em",label:"Unit"},subunit_name:{type:"inputbox",id:"_comp_inline _w10em _mgrt_1em",label:"Sub Unit"}},validation:{name:{required:true},abbr:{required:true},symbol:{required:true},unit_name:{required:true},subunit_name:{required:true}}};app.popups.CurrencyPopup=new (app.Popup.extend({id:"currency_popup",head:"Currency",model:b,class_name:"_mw600x",events:{"click .op_btn":"submit_form"},beforeInit:function(){return true},render:function(f){var h,g,e;e=this;if(!f){this.form=new app.Form(_.extend({appendTo:this.$el.find(".popup_body")},d));this.form.renderInputs();this.listenTo(this.form,"all",this.form_ev_handler);g=app.IPS.extend({ip_defaults:{class_name:"_md _type2 _nouline"},class_name:"currency_rate_ips",row_delete_key_col:"date",schema:{date:{head_label:"Applicable From",width:30,ip_options:{type:"datefield",id:"",label:"Applicable From",dlgTo:"scope"}},mx1:{head_label:"MX1",width:20,ip_options:{type:"inputbox",id:"_ralign",dp:4,thousand_sep:true,label:"MX1"}},tc:{head_label:"&nbsp;",width:40,ip_options:{type:"inputbox",id:"",label:"Base Currency",disabled:true}},mx2:{head_label:"MX2",width:20,ip_options:{type:"inputbox",id:"_ralign",dp:4,thousand_sep:true,label:"MX2"}},bc:{head_label:"&nbsp;",width:40,ip_options:{type:"inputbox",id:"",label:"Currency",disabled:true}}},validation:{date:{required:true},mx1:{required:true},mx2:{required:true}},after_init:function(i){this.listenTo(this,"all",this.ips_event_handler)},ips_event_handler:function(p,o,j,n,k){var r,l,m,q;r=this.rows[o];switch(p){case"row_insert":this.set_values(r,{tc:e.form.components.name.get_value()+" =",bc:get_cfg("bcurr_name")});e.center();break;case"text_changed":if(n.keyCode==8){this.backspace_pressed(r,o,j);e.center()}break;case"enterkey_press":m=this.isLast(r)&&j==this.lastCol()&&!_.some(_.values(this.get_values(r)));if(m){if(!(this.rows.length==1&&!_.some(_.values(q.get_values(0))))){e.$el.find(".op_btn_sncl").focus();return}}if(this.focusColumn(r,j,"next",true,{select:true})==false){this.validate_row(r,true)}break}}});g.merge(app.IPS_ext);e.ip_sheet=new g({head:"Currency Rate",ips_id:"crate_ips",appendTo:e.$el.find(".popup_body")});e.ip_sheet.render()}h=this.options.data;this.setMode("idle");e.ip_sheet.release(true);if(h){this.form.set_values(h);this.ip_sheet.set_value_list(h.rates)}else{this.form.reset();e.ip_sheet.insertRow({})}},form_ev_handler:function(j,g,l){var h,f,k;k=this.ip_sheet;if(j=="focusout"&&g.name=="name"){for(h=0,f=k.rows.length;h<f;h++){k.rows[h].cols.tc.ip.set_value(g.get_value()+" =")}}},after_get_values:function(e){e.currency_rates=this.ip_sheet.get_value_list()}}))();var c={name:{head_label:"Name",style:"width:30%",index:0},abbr:{head_label:"Abbr",style:"width:20%",index:0},symbol:{head_label:"Symbol",style:"width:10%",index:0},unit_name:{head_label:"Unit",style:"width:15%",index:0},subunit_name:{head_label:"Sub Unit",style:"width:15%",index:0},description:{head_label:"Description",style:"width:10%",index:0}};var a=app.Tab.extend({label:"Currencies",tab_id:"currencies",model:b,is_tab_view:true,heading:"Currency",ds_options:{schema:c,ds_id:"ds_currencies",default_params:{inc_rates:true}},popup:app.popups.CurrencyPopup,initComponents:function(){var e=this;this.init()},onshow:function(){if(!this.is_inited){this.initComponents();this.is_inited=true}this.$top_sec_el.show();this.ds.load({success:function(f,e){app.appdata.bcurr_name=e.bcurr_name}})}});a.merge(app.ListPageTemplate);if(AL.any_access("currencies")){set_object("company_tabs","currency_tab",a)}});FB_Module.register({index:2},function(){var b,a;b={year:{head_label:"Year",style:"width:20%",index:0},month_txt:{head_label:"Month",style:"width:60%",index:0},lock_status_txt:{head_label:"Lock Status",style:"width:20%",index:0}};a=app.Tab.extend({label:"Voucher Lock",tab_id:"voucher_lock",model:app.models.VoucherLock,is_tab_view:true,no_newbtn:true,ds_options:{schema:b,has_pagination:false,idAttr:"month",has_pagination:true,default_params:{per_page:20}},initComponents:function(){var c=this;this.init();this.listenTo(this.$scope,"top_btn_click",this.top_btn_clicked)},top_btn_clicked:function(c){if(c[0]==this.$top_sec_el.find(".btn")[0]){this.show_popup()}},ds_handler:function(n,g,d,m){var k,j,l,h,c,o,f;if(n=="rendered"){f=d.$el.find(".table_list > li");for(i in d.rows){k=d.rows[i];f.eq(i).find("li:eq(2)").addClass(k.lock_status=="locked"?"_green":"_red")}}else{if(n=="context_menu"){k={unlocked:{key:"lock",value:"Lock"},locked:{key:"unlock",value:"Unlock"}};this.context_menu.items=[k[d.get_row(g).lock_status]];this.context_menu.show(g,{left:m.pageX,top:m.pageY},{ds:d})}}},context_item_click:function(e,f){var d,c;c=this;d=new this.model;d.save({date:e,lock_status:f},{success:function(h,g){c.ds.load({presv_flt:true})},error:function(h,g){alert("Error")}})},onshow:function(){if(!this.is_inited){this.initComponents();this.is_inited=true}this.ds.load({presv_flt:false})}});a.merge(app.ListPageTemplate,true);if(AL.any_access("voucher_lock")){set_object("company_tabs","voucherlock_tab",a)}});FB_Module.register({index:2},function(){app.p_views.Company=Backbone.View.extend({el:$(".mcarv_company"),initialize:function(){var a=this,b,c;if(!AL.any_access(["members","departments","monthly_targets","working_days","other_settings","voucher_lock"])){return}this.tabs=new app.Tabs({el:$(".company_tabs"),$scope:this});b=[],tab_views=get_object("company_tabs");c=get_object("company_tabs1","general_tab");if(c){b.push(new c({el:this.tabs.$el.find(".general_tab"),no_append:true}))}else{this.tabs.$el.find(".general_tab").remove()}for(view in tab_views){b.push(new tab_views[view]())}this.tabs.append(b);this.listenTo(this.tabs,"tab_show",this.tab_show);app.eventBus.on("show:company",this.show,this)},show:function(b,c){var a=this;if(!b){b=this.tabs.current_tab||"general";this.args=c||{}}this.tabs.show_tab(b,c,true);app.pages.show_page(this)},tab_show:function(a,b,d){var c=this.$el.find(".top_buttons");c.hide();app.router.navigate(app.generate_url("company",a,this.args),{trigger:false,args:b,replace:d})}});FB_Module.init_fn(function(){app.SideMenu.add_item({view:"company",item_id:"company",label:"Company",index:8,is_disabled:!AL.any_access(["members","departments","monthly_targets","working_days","other_settings","voucher_lock"])})})});FB_Module.register({index:2},function(){var a,e;e={default_attr:{class_name:"_type1 _md"},fields:{name:{type:"inputbox",id:"alist_name",label:"AccessList Name"},access_allow:{type:"checkbox",id:"_theme1 _mgbt_1em",label:"Allow Access to this device",value:"true"}},validation:{name:{required:true}}};var f={item_key:{head_label:"Item",width:50,index:10,ip_options:{type:"selectbox",id:"naf_type",label:"Type",dlgTo:"scope",default_option:"",options:{}}},access:{head_label:"Access",width:30,index:20,ip_options:{type:"selectbox",id:"naf_type",label:"Access Method",default_option:"",options:{}}},target:{head_label:"Target",width:30,index:20,ip_options:{type:"selectbox",id:"naf_type",label:"Target",dlgTo:"scope",default_option:"",options:[{ow:"Own"},get_cfg("en_association")=="true"?{asc:"Associated"}:null,get_cfg("en_association")=="true"?{owasc:"Own/Associated"}:null,{dp:"Department"},{al:"All"}]}},extra_options:{width:10,index:30,head_label:"&nbsp;",ip_options:{type:"button",id:"al_btn",class_name:"_type1 _md _extra_options_btn _theme1",label:"",dlgTo:"scope"}},"delete":{width:15.5,index:30,head_label:"&nbsp;",ip_options:{type:"button",id:"al_btn",class_name:"_type1 _md _theme1",label:"Delete",dlgTo:"scope"}}};a={default_attr:{class_name:"_type1 _md _mgbt_1em"},fields:{scope:{type:"checkbox",id:"",label:"Use Secondary Scope",value:"true"},_sep1:{tagName:"div"},doc_date_lock:{type:"checkbox",id:"",label:"Enable document date lock",value:"true"},_sep3:{tagName:"div"},access_period:{type:"inputbox",id:"_w10em",label:"Access Period (Hours)"}}};var d=new (app.Popup.extend({id:"extra_options_popup",head:"Extra Options",btn_map:{set:["OK"]},events:{submit:"submit_form","click .op_btn":"submit_form"},render:function(l){var h=this.options,k,j;if(!l){this.form=new app.Form(_.extend({appendTo:this.$el.find(".popup_body")},a));this.form.renderInputs()}this.setMode("idle");this.form.reset();this.form.set_values(h.data)},submit_form:function(h){_.extend(this.options.data,this.form.get_values());this.close()}}))();var c=app.Tab.extend({events:{"click ._ipsheet_add_new_btn":"add_new_clicked"},afterAppend:function(){var h=this;this.ip_sheet=new app.IPS({ips_id:"alisheet",ip_defaults:{class_name:"_md _type3 _nouline"},appendTo:this.$el,schema:f});this.listenTo(this.ip_sheet,"all",this.ip_sheet_handler);this.$el.append($("<div><button class='component btn _md _type1 _theme1 _ipsheet_add_new_btn'>Add New Item</button><div>"))},validate_last_row:function(){var k,j,l,h;k=this.ip_sheet.rows;if(k.length==0){return{success:"success"}}else{if(k.length>=80){return{error:"Maximum limit of 80 rules is exceeded!"}}}if(k.length){l=k.length;h=this.ip_sheet.get_values(k[l-1]);if(h.item_key==""||h.access==""){return{error:"Error: Incomplete Rule!"}}}for(j=0;j<l-1;j++){if(_.isEqual(_.extend({},this.ip_sheet.get_values(k[j]),_.pick(k[j].extra_options,["scope","target_key"])),_.extend({},h,_.pick(k[l-1].extra_options,["scope","target_key"])))){return{error:"Error : Rule is repeated!"}}}return{success:"success"}},add_new_clicked:function(k){var j,l;j=this.validate_last_row();if(j.error){app.notifications.add("Rule Error",j.error,"error")}else{l=this.ip_sheet.insertRow({});l.extra_options={scope:false,target_key:false,access_period:"",doc_date_lock:false};var h=this.ip_sheet.$el.find(".table_listcnt")[0];h.scrollTop=h.scrollHeight;this.ip_sheet.focusRow(l)}},ip_sheet_handler:function(l,j,k,m,h){var n,p,o;o=this.ip_sheet.rows[j];if(k=="item_key"&&l=="changed"){n=h.value;p={};_.each(AL.schema[n].options,function(r,q){p[q]=r.label});o.cols.access.ip.set_options(p)}else{if(l=="clicked"){if(k=="delete"){this.ip_sheet.deleteRow(j)}else{if(k=="extra_options"){d.show({method:"set",data:o.extra_options})}}}}}});app.popup_views.AccessListPopup=app.Popup.extend({id:"accesslist_popup",head:"AccessList",model:app.models.AccessList,events:{"click .op_btn":"form_submitted"},initComponents:function(){var h;h=this;h.form=new app.Form(_.extend({appendTo:h.$el.find(".popup_body")},e));h.form.renderInputs();h.form.components.access_allow[get_cfg("en_access_lock")=="true"?"show":"hide"]();_.each(AL.schema,function(j){f.item_key.ip_options.options[j.key]=j.label});h.tabs=new app.Tabs({appendTo:this.$el.find(".popup_body"),$scope:h,id:"alist_tabs"});h.tabs.append([new c({label:"Allow Rules",tab_id:"allow_rules"}),new c({label:"Deny Rules",tab_id:"deny_rules"})])},onclose:function(){var h;h=this.tabs.tabs;for(i in h){h[i].ip_sheet.release()}},render:function(l){var h=this.options,k,j;if(!l){this.initComponents()}j=this.tabs.tabs;for(k in j){j[k].ip_sheet.render()}this.setMode("idle");this.tabs.show_tab("allow_rules");this.form.reset();if(h.data){if(!h.clone){this.form.set_values(_.pick(h.data,["name","access_allow","description"]))}this.set_ip_sheet(h.data)}else{this.form.set_values({name:"",description:""})}},add_ip_sheet_row:function(h,j){var l,k;l={};_.each(AL.schema[j.item_key].options,function(n,m){l[m]=n.label});k=h.insertRow(_.pick(j,["item_key","target","target_group_name"]));k.cols.access.ip.set_options(l).set_value(j.access);k.extra_options=_.pick(j,["scope","target_key","access_period","doc_date_lock"])},set_ip_sheet:function(l){var k,h;h=this;var j=new app.models.AccessList;k=this.tabs.tabs;j.set("id",l.id);j.fetch({success:function(n,m){var o;for(o in m.allow_list){h.add_ip_sheet_row(k.allow_rules.ip_sheet,m.allow_list[o])}for(o in m.deny_list){h.add_ip_sheet_row(k.deny_rules.ip_sheet,m.deny_list[o])}},error:function(m,n){}})},form_submitted:function(o){var t=this,j,p,k,l,m,u=this.options,q;var h=this.form,s=h.get_values(),r=h.validate(),n;o.preventDefault();j=this.tabs.tabs;p={allow_list:j.allow_rules.ip_sheet.get_value_list(null,function(v,w){_.extend(v,w.extra_options)}),deny_list:j.deny_rules.ip_sheet.get_value_list()};h.renderErrors(r);if(!r){n=new this.model(_.extend(s,p));if(u.method=="update"){n.set("id",u.data.id)}this.setMode("working");Backbone.sync(u.method=="update"?"update":"create",n,{success:function(v){if(u.callback){u.callback.call(u.invoker,"save_success",v)}else{u.invoker.trigger("popup_event","save_success",v)}app.notifications.add(v.head,v.msg,"success");t.close();t.setMode("idle")},error:function(v){h.renderServerErrors(v);t.setMode("idle")}})}}});app.popups.AccessListPopup=new app.popup_views.AccessListPopup();var b={name:{head_label:"Name",style:"width:40%",index:0},description:{head_label:"Description",style:"width:60%",index:0}};var g=app.Tab.extend({label:"Access Lists",tab_id:"access_lists",model:app.models.AccessList,is_tab_view:true,heading:"AccessList",ds_options:{schema:b,class_name:"ds_within_tab",ds_id:"ds_accesslists"},popup:app.popups.AccessListPopup,edit_data_filter:["name","access_allow","description","id","allow_hash","deny_hash"],initComponents:function(){var h=this;var j;this.context_menu_items=j=_.clone(this.context_menu_items);j.splice(0,0,{key:"clone",value:"Clone Access List"});swap_obj_keys(this,"_context_item_click","context_item_click");this.init()},onshow:function(){if(!this.is_inited){this.initComponents();this.is_inited=true}this.$top_sec_el.show();this.ds.load()},_context_item_click:function(j,h){if(h=="clone"){data=this.ds.get_row(j);this.popup.show({method:"create",invoker:this,callback:this.popup_callback,id:j,clone:true,data:data});return}return this._context_item_click(j,h)}});g.merge(app.ListPageTemplate);if(AL.any_access("access_lists")){set_object("settings_tabs","alist_tab",g)}});FB_Module.register({index:2},function(){var b={default_attr:{class_name:"_type1 _md"},fields:{name:{type:"inputbox",id:"_mgbt_1em _w30em",label:"Group Name"},key:{type:"inputbox",id:"_mgbt_1em _w15em",label:"Group ID"},_ipsheet_cnt:{tagName:"div",className:"_ipsheet_cnt"},description:{type:"textarea",id:"",label:"Description"}},validation:{name:{required:true}}};var d={name:{head_label:"Name",width:80,index:10,ip_options:{type:"combobox",id:"",label:"Name",url:"/members?name={{value}}&pagination=false&_select_fields=name"}}};var a=new (app.Popup.extend({id:"usergroup_popup",head:"User Group",model:app.models.AccessGroup,events:{"click .op_btn":"submit_form"},render:function(f){var g;if(!f){this.form=new app.Form(_.extend({appendTo:this.$el.find(".popup_body")},b));this.form.renderInputs();this.ip_sheet=new app.IPS_ext({ips_id:"alisheet",class_name:"_mgbt_1em",ip_defaults:{class_name:"_md _nouline _type2"},appendTo:this.$el.find("._ipsheet_cnt"),schema:d});this.listenTo(this.ip_sheet,"all",this.ip_sheet_handler)}g=this.options.data;this.setMode("idle");this.current_tab=null;this.ip_sheet.release();this.ip_sheet.render();if(g){this.form.set_values(g);this.ip_sheet.set_value_list(g.member_list)}else{this.form.reset()}},validate_last_row:function(){var h,g,j,f;h=this.ip_sheet.rows;if(h.length==0){return{success:"success"}}else{if(h.length>=500){return{error:"Maximum limit of 500 members is exceeded!"}}}if(h.length){j=h.length;f=this.ip_sheet.get_values(h[j-1]);if(f.name==""){return{error:"Error: Incomplete Field!"}}}for(g=0;g<j-1;g++){if(_.isEqual(this.ip_sheet.get_values(h[g]),f)){return{error:"Error : Member is repeated!"}}}return{success:"success"}},after_get_values:function(f){f.members_list=this.ip_sheet.get_value_list()},add_new_clicked:function(h){var g;g=this.validate_last_row();if(g.error){app.notifications.add("List Error",g.error,"error")}else{this.ip_sheet.insertRow({});var f=this.ip_sheet.$el.find(".table_listcnt")[0];f.scrollTop=f.scrollHeight}this.ip_sheet.focusRow(this.ip_sheet.getLastRow())},ip_sheet_handler:function(l,k,f,j,o){var n,g,h,m;m=this.ip_sheet;if(k!=undefined){n=m.rows[k]}switch(l){case"enterkey_press":if(m.focusColumn(n,column,"next",true,{select:true})==false){m.validate_row(n,true)}break;case"text_changed":if(j.keyCode==8){m.backspace_pressed(n,k,column,j)}break}},delete_clicked:function(g){var f,h;f=$(g.target);h=f.closest(".table_list > li");this.ip_sheet.deleteRow(h.index())}}))();var e={name:{head_label:"Name",style:"width:25%",index:0},description:{head_label:"Description",style:"width:30%",index:0},members_txt:{head_label:"Members",style:"width:45%",index:0}};var c=app.Tab.extend({label:"User Groups",tab_id:"user_groups",model:app.models.AccessGroup,is_tab_view:true,heading:"User Group",ds_options:{schema:e,ds_id:"ds_usergroup"},popup:a,initComponents:function(){var f=this;this.init()},onshow:function(){if(!this.is_inited){this.initComponents();this.is_inited=true}this.$top_sec_el.show();this.ds.load()}});c.merge(app.ListPageTemplate,true);if(AL.any_access("access_lists")){set_object("settings_tabs","usergroup_tab",c)}});FB_Module.register({index:2},function(){var f,j;var f={default_attr:{class_name:"_type1 _md _mgbt_1em"},fields:{dnc_name:{type:"combobox",id:"_w15em vtyp_docno_prefix",label:"DocNo Class Name",url:"/docno_classes/?name={{value}}&pagination=false",embedd_list_el:false},num_method:{type:"selectbox",id:"_w15em",label:"Numbering Method",options:{auto:"System Generated",manu:"Manual"}},is_enabled:{type:"selectbox",class_name:"_type4 _md _mgbt_1em",label:"Enabled",options:{"true":"Yes","false":"No"},default_option:"true"},print_on_save:{type:"selectbox",class_name:"_type4 _md _mgbt_1em",label:"Print voucher when saved",options:{"true":"Yes","false":"No"},default_option:"false"},en_approval:{type:"selectbox",class_name:"_type4 _md _mgbt_1em",label:"Enable Voucher Approval",options:{"true":"Yes","false":"No"},default_option:"false"},en_multicurr:{type:"selectbox",class_name:"_type4 _md _mgbt_1em",label:"Enable Multiple Currencies",options:{"true":"Yes","false":"No"},default_option:"false"},custom_export_format:{type:"inputbox",id:"_w15em",label:"Custom 'Export Format'"},top_margin:{type:"inputbox",id:"_w10em",label:"Print top margin (cm)"}}};var g=app.Tab.extend({label:"General",tab_id:"general",has_unclickable:true,is_tab_view:true,no_newbtn:true,initComponents:function(){var k=this;this.form=new app.Form(_.extend({appendTo:this.$el},f));this.form.renderInputs();this.listenTo(this.form,"all",this.form_ev_handler)},afterAppend:function(k){if(!this.is_inited){this.initComponents();this.is_inited=true}},render:function(){var k;k=this.$scope.options.data;this.form.reset();if(k){this.form.set_values(k)}},form_ev_handler:function(l,k,m){},get_values:function(k){var l,m;l=this.form.get_values();m=this.form.validate();if(m){this.form.renderErrors(m);return 1}_.extend(k,l);return 0}});g.merge(app.PageTemplate,true);var d=app.Tab.extend({label:"Print/Export Options",tab_id:"print_export",is_tab_view:true,no_newbtn:true,initComponents:function(){var k=this;this.init();ips=app.IPS_ext.extend({ip_defaults:{class_name:"_sm2 _type2 _nouline _pdlt0"},class_name:"printformat_ips",schema:{itype:{head_label:"Type",width:20,ip_options:{type:"selectbox",class_name:"_type3 _sm2 _nouline",label:"Type",default_option:"",options:[{dpf:"Default Print"},{dex:"Default Export"},{cpf:"Custom Print"},{cex:"Custom Export"}]}},name:{head_label:"Report Name",width:35,ip_options:{type:"inputbox",id:"",label:"Report Name"}},format:{head_label:"Format",width:35,ip_options:{type:"filefield",ret_files:true,id:"",label:"Format"}}},validation:{itype:{required:true},name:{required:true},format:{required:true}},after_init:function(l){this.listenTo(this,"all",this.ips_event_handler);this.vald_form=new app.Form({el:this.$el,validation:this.validation});this.parent=l.parent},post_validate:function(m,l){return true},ips_event_handler:function(r,t,l,p,m){var q,n,o,s;q=t;t=this.rows[t];switch(r){case"text_changed":if(p.keyCode==8){this.backspace_pressed(t,q,l,p)}break;case"enterkey_press":p.preventDefault();if(this.focusColumn(t,l,"next",true,{select:true})==false){this.validate_row(t,true)}break}}});this.ip_sheet=new ips({appendTo:this.$el});this.ip_sheet.render()},afterAppend:function(k){if(!this.is_inited){this.initComponents();this.is_inited=true}},render:function(){var k;k=this.$scope.options.data.format_data;if(!_.isEmpty(k)){this.ip_sheet.set_value_list(k)}else{this.ip_sheet.release(true);this.ip_sheet.insertRow({})}},get_values:function(l){var m,o,n,k;if(!this.ip_sheet.validate_rows()){return 1}m=this.ip_sheet.get_value_list();l.formats=JSON.stringify(_.map(m,function(p){return _.omit(p,["format"])}));for(n=0,k=m.length;n<k;n++){l["format_"+n]=m[n].format}return 0}});d.merge(app.PageTemplate,true);app.popups.VoucherTypePopup=new (app.Popup.extend({id:"vouchertype_popup",head:"Voucher Type",model:app.models.VoucherType,events:{"click .op_btn":"submit_form"},beforeInit:function(){return true},render:function(m){var o,l,n,k;k=this;if(!m){k.tabs=new app.Tabs({appendTo:k.$el.find(".popup_body"),$scope:k});tabs=[new g(),new d()];k.tabs.append(tabs)}k.setMode(k.options.popup_type);k.current_tab=null;k.tabs.tabs.general.render();k.tabs.tabs.print_export.render();k.tabs.show_tab("general")},before_request:function(k){k.set("id",this.options.data.id)},after_request:function(m,k,l){var n;if(k=="success"){n=this.options.data.name;app.fb_doc_types[n].num_method=l.num_method}else{if(k=="error"){if(m.responseJSON){this.tabs.tabs.general.form.renderErrors(null,m.responseJSON);if(m.responseJSON.format_errors){this.tabs.tabs.print_export.ip_sheet.renderErrors(m.responseJSON.format_errors);this.tabs.show_tab("print_export")}}else{app.notifications.add("Error","Error while submiting data,please check your internet connection","error")}}}},submit_form:function(p){var n,o,l,q,m,k;k=this;n=k.options;p.preventDefault();l={};if(k.tabs.tabs.general.get_values(l)!=0){return 0}if(k.tabs.tabs.print_export.get_values(l)!=0){return 0}k.post_submit(l,p)}}))();var i={default_attr:{class_name:"_type1 _sm2 _mgbt_1em"},fields:{name:{type:"inputbox",id:"",label:"Name"},doc_no_prefix:{type:"inputbox",id:"_w15em _comp_inline _mgrt_1em",label:"Vouher No Prefix"},doc_no_suffix:{type:"inputbox",id:"_w10em _comp_inline _mgrt_1em",label:"Vouher No Suffix"},initial_doc_no:{type:"inputbox",id:"_w8em _comp_inline",label:"Initial Voucher No"}}};var c={docformat:{head_label:"DocFormat",width:70,index:10,ip_options:{type:"inputbox",label:"Doc Format"}},last_doc_no:{head_label:"Last Doc No",width:30,index:20,ip_options:{type:"inputbox",label:"Last Doc No"}}};app.popups.DocNoClass=new (app.Popup.extend({id:"docnoclass_popup",head:"Document Number Classes",model:app.models.DocNoClass,events:{"click .op_btn":"submit_form"},beforeInit:function(){return true},render:function(l){var n,k,m;if(!l){this.form=new app.Form(_.extend({appendTo:this.$el.find(".popup_body")},i));this.form.renderInputs();this.ips=new app.IPS_ext({ips_id:"sheet1",ip_defaults:{class_name:"_sm2 _type2 _nouline"},appendTo:this.$el.find(".popup_body"),schema:c,validation:{doc_format:{required:true},last_doc_no:{required:true}}});this.listenTo(this.ips,"all",this.ips_handler)}n=this.options.data;this.setMode("idle");this.current_tab=null;this.ips.release();this.ips.render();this.form.reset();if(n){this.form.set_values(n);if(!_.isEmpty(n.doc_nos)){for(k in n.doc_nos){m=this.ips.insertRow(n.doc_nos[k]);m.id=n.doc_nos[k].id}}else{this.ips.insertRow({})}}},after_get_values:function(k){k.last_dn_li=this.ips.get_value_list()},ips_handler:function(o,n,m,p,l){var k=this;row=this.ips.rows[n];switch(o){case"row_insert":k.center();break;case"text_changed":if(p.keyCode==8){k.ips.backspace_pressed(row,n,m,p);k.center()}break;case"enterkey_press":if(k.ips.focusColumn(row,m,"next",true,{select:true})==false){k.ips.validate_row(row,true,{})}break}}}))();var a={heading:{head_label:"Name",style:"width:60%",index:0},dnc_name:{head_label:"Doc No Class",style:"width:20%",index:0},num_method_txt:{head_label:"Numbering Method",style:"width:20%",index:0}};var h=app.Tab.extend({label:"Voucher Types",tab_id:"vtypes",model:app.models.VoucherType,no_newbtn:true,is_tab_view:true,ds_options:{schema:a,default_params:{pagination:false,is_allowed:true},ds_id:"ds_vchr_types",has_pagination:false},popup:app.popups.VoucherTypePopup,context_menu_items:[{key:"edit",value:"Edit"}],initComponents:function(){var k=this;this.init()},onshow:function(){if(!this.is_inited){this.initComponents();this.is_inited=true}this.ds.load()},context_item_click:function(m,k){var l;if(k=="edit"){l=this.ds.get_row(m),self=this;if(this.edit_data_filter){l=_.pick(l,this.edit_data_filter)}this.popup.show({popup_type:"create",invoker:this,callback:this.popup_callback,id:m,data:l})}}});h.merge(app.ListPageTemplate,true);var e={name:{head_label:"Name",style:"width:40%",index:0},doc_no_prefix:{head_label:"Doc No Prefix",style:"width:20%",index:0},doc_no_suffix:{head_label:"Doc No Suffix",style:"width:20%",index:0},initial_doc_no:{head_label:"Initial Doc No",style:"width:20%",index:0}};var b=app.Tab.extend({label:"Doc No Classes",tab_id:"doc_no_classes",heading:"Doc No Class",model:app.models.DocNoClass,is_tab_view:true,ds_options:{schema:e,default_params:{pagination:false},ds_id:"ds_docnoclasses_types",has_pagination:false},popup:app.popups.DocNoClass,initComponents:function(){var k=this;this.init()},onshow:function(){if(!this.is_inited){this.initComponents();this.is_inited=true}this.$top_sec_el.show();this.ds.load()},context_item_click:function(m,k){var l;if(k=="edit"){l=this.ds.get_row(m),self=this;if(this.edit_data_filter){l=_.pick(l,this.edit_data_filter)}this.popup.show({method:"update",invoker:this,callback:this.popup_callback,id:m,data:l})}else{if(k=="delete"){app.Prompt.show({head:"Delete this item?",text:"Do you sure you want to delete this item?",data:m,callback:this.delete_item,context:this})}}}});b.merge(app.ListPageTemplate,true);if(AL.any_access("vtypes")){set_object("settings_tabs","vouchertype_tab",h)}if(AL.any_access("docno_classes")){set_object("settings_tabs","docnoclass_tab",b)}});FB_Module.register({index:2},function(){app.p_views.Settings=app.PageTemplate.extend({page_name:"settings",heading_plural:"Settings",initialize:function(){var a=this,b,c;if(!AL.any_access("other_settings")){return}this.init({create_el:true});this.tabs=new app.Tabs({appendTo:this.$el,$scope:this});b=[],tab_views=get_object("settings_tabs");for(view in tab_views){b.push(new tab_views[view]())}this.tabs.append(b);this.listenTo(this.tabs,"tab_show",this.tab_show)},onshow:function(b,c){var a=this;if(!b){b=this.tabs.current_tab||"vtypes";this.args=c||{}}this.tabs.show_tab(b,true)},tab_show:function(a,c){var b=this.$el.find(".top_buttons");b.hide();app.router.navigate(app.generate_url("settings",a,this.args),{trigger:false,replace:c})}});FB_Module.init_fn(function(){app.SideMenu.add_item({view:"settings",item_id:"settings",label:"Settings",index:8,is_disabled:!AL.any_access("other_settings")})})});FB_Module.register({index:3},function(){if(get_cfg("tax_method")!="no_tax"){app.popups.TaxInfoPopup=new (app.Popup.extend(get_obj("tax_methods")[get_cfg("tax_method")].tax_info_popup_schema))({})}var a={default_attr:{class_name:"_sm2 _type1 _mgbt_1em"},fields:{en_acc_groups:{type:"checkbox",value:"true",id:"_comp_inline _w30pc _mgrt_2em ",index:1,label:"Enable Account Groups"},en_journal_reversing:{type:"checkbox",value:"true",id:"_comp_inline _w30pc _mgrt_2em ",index:1,label:"Enable Journal Reversing"},currency_symbol_as_prefix:{type:"checkbox",value:"true",id:"_comp_inline _w30pc _mgrt_2em ",index:1,label:"Current Symbol as Prefix"},_sep0:{tagName:"div",index:1},default_blsheet_display:{type:"selectbox",class_name:"_type4 _sm2 _mgbt_1em",id:"_comp_inline _w30pc _type4 _mgrt_2em",index:1,default_option:"",options:[{t:"T Mode"},{vertical:"Vertical Mode"}],label:"Default Balance Sheet Mode"},max_blsheet_years:{type:"selectbox",class_name:"_type4 _sm2 _mgbt_1em",id:"_comp_inline _w30pc _type4 _mgrt_2em",index:1,default_option:"",options:{"1":"1","2":"2","3":"3","4":"4","5":"5","6":"6"},label:"Max Balance Sheet comparison years"},_sep1:{tagName:"div",index:1},default_prloss_display:{type:"selectbox",class_name:"_type4 _sm2 _mgbt_1em",id:"_comp_inline _w30pc _type4 _mgrt_2em",index:1,default_option:"",options:[{t:"T Mode"},{vertical:"Vertical Mode"}],label:"Default Profit&Loss Mode"},max_prloss_years:{type:"selectbox",class_name:"_type4 _sm2 _mgbt_1em",id:"_comp_inline _w30pc _type4 _mgrt_2em",index:1,default_option:"",options:{"1":"1","2":"2","3":"3","4":"4","5":"5","6":"6"},label:"Max Profit&Loss comparison years"},add_stock_to_cos:{type:"checkbox",value:"true",index:1,id:"_comp_inline _w30pc _mgrt_2em",label:"Add stock to COS in Income statement"},en_futr_entry:{type:"checkbox",value:"true",index:1,id:"_comp_inline _w30pc _mgrt_2em",label:"Enable Entry on future date"},en_auto_ref_jr:{type:"checkbox",value:"true",index:1,id:"_comp_inline _w30pc _mgrt_2em",label:"Add Auto ref in journal for customer/supplier"},_sep12:{tagName:"div",index:1},en_costcenter:{type:"checkbox",label:"Enable Cost Center",id:"_mgrt_3em",value:"true",index:1},en_jobs:{type:"checkbox",label:"Enable Jobs",id:"_mgrt_3em",value:"true",index:1},en_phases:{type:"checkbox",label:"Enable Phases",id:"_mgrt_3em",value:"true",index:1},en_multicurr:{type:"checkbox",label:"Enable Multiple Currencies",id:"_mgrt_3em",value:"true",index:1},def_trans_sort:{type:"selectbox",class_name:"_type4 _sm2 _mgbt_1em",id:"_comp_inline _w30pc _type4 _mgrt_2em",index:1,default_option:"",options:[{asc:"Forward"},{desc:"Reverse"}],label:"Default ordering of statements"},base_currency_id:{type:"combobox",id:"_w25em _mgbt_2em",label:"Base Currency",class_name:"_type1 _md",url:"/currencies/?name={{value}}&pagination=false",dlgTo:"scope",index:10,label_sel:"name",value_sel:"id",index:1},ageing_fmt:{type:"inputbox",class_name:"_type4 _sm2 _comp_inline _w20em _pdlt_10em _mgrt_2em ",index:1,label:"Ageing Period Format"},en_alt_address:{type:"checkbox",label:"Alternative Address Setting",id:"_mgrt_3em",value:"true",index:1},en_access_lock:{type:"checkbox",label:"Enable Access Restriction by Devices",id:"_mgrt_3em",value:"true",index:1},_sep2:{tagName:"h1",className:"tbl_head _mgtp_1em",innerHTML:"Receipt and Payment",index:1},cheq_prefix:{type:"inputbox",class_name:"_type4 _sm2 _comp_inline _w8em _pdlt_7em _mgrt_2em ",index:1,label:"Cheq No Prefix:"},instr_acc_no_req:{type:"checkbox",value:"true",id:"_comp_inline _w30pc _mgrt_2em ",index:1,label:"Is Cheque Instrument Account Number Required"},_sep15:{tagName:"div",className:"_mgbt_1em",index:1},rc_use_income:{type:"checkbox",value:"true",id:"_w30pc _mgrt_2em ",index:1,label:"Use income accounts in receipt"},py_use_expense:{type:"checkbox",value:"true",id:"_w30pc _mgrt_2em ",index:1,label:"Use expense accounts in payment"},rcpy_set_status:{type:"checkbox",value:"true",id:"_w30pc _mgrt_2em ",index:1,label:"Enable changing status of cheque within receipt/payment"},_sep13:{tagName:"div",index:1,className:"tbl_head _mgtp_1em",innerHTML:"Taxation"},tax_method:{type:"selectbox",class_name:"_type4 _sm2 _mgbt_1em",id:"_comp_inline _w30pc _type4 _mgrt_2em",index:1,default_option:"",options:[{no_tax:"No TAX"},{vat:"VAT"},{gst:"GST"}],label:"Tax Method",dlgTo:"scope"},set_tax_details:{type:"button",class_name:"_comp_block _type1 _md",label:"Set Tax Details",index:1,dlgTo:"scope"},en_cess:{type:"checkbox",value:"true",id:"_comp_inline _w30pc _mgtp_1em ",index:1,label:"Enable Cess"},_sep:{tagName:"div",index:99},attendance_mode:{type:"selectbox",id:"_mgbt_05em _w10em",label:"Attendance Mode",default_option:"",index:1,options:[{daily:"Daily"},{monthly:"Monthly"}],label:"Attendance Mode"},submit_btn:{type:"button",attrs:{type:"submit"},always_disable:true,class_name:"component btn _type1 _sm2 submit_btn",label:"Save",index:100}},validation:{}};var b=app.Tab.extend({label:"Settings",tab_id:"settings",class_name:"settings_tab",events:{"click .submit_btn":"submit_form","click .calc_dailyreprt_btn":"calculate_acc_report","click .lock_branch_btn":"lock_branch","click .calc_accbalance_btn":"calculate_acc_balances"},initComponents:function(){var c;c=this;c.$el.append($("<h1 class='tbl_head _mgtp_1em'>General Settings</h1>"));_.extend(a.fields,get_obj("extra_settings"));c.form1=new app.Form(_.extend(a,{appendTo:c.$el,order_items:true,class_name:"general_settings_form"}));c.form1.renderInputs();c.listenTo(c.form1,"all",this.form_ev_handler);c.$el.append("<div class='calculate_dreport_cnt'><h3 class='head'>Update Account Balances</h3><button class='component btn _type1 _sm2 calc_dailyreprt_btn'>Update Balances</button></div>");c.form1.components.en_access_lock[AL.has_access("access_lists","create")?"show":"hide"]()},form_ev_handler:function(g,d,h){var c,f;if(g=="clicked"&&d.name=="set_tax_details"){if(app.popups.TaxInfoPopup){app.popups.TaxInfoPopup.show({data:app.appdata,invoker:this})}}else{if(g=="changed"&&d.name=="tax_method"){if(d.get_value()!="no_tax"){if(app.popups.TaxInfoPopup){app.popups.TaxInfoPopup.remove()}app.popups.TaxInfoPopup=new (app.Popup.extend(get_obj("tax_methods")[d.get_value()].tax_info_popup_schema))({})}}}},calculate_acc_report:function(d){var c;c=new Backbone.Model;c.url="/company/calc_daily_report/";$(d.target).text("Update...");c.fetch({success:function(f,e){$(d.target).text("Update");app.notifications.add(e.head,e.msg,"success")},error:function(e,f){$(d.target).text("Update");app.notifications.add("Error","Error whi;e operation","error")}})},calculate_acc_balances:function(d){var c;c=new Backbone.Model;c.url="/company/calc_acc_balances/";$(d.target).text("Calculating...");c.fetch({success:function(f,e){$(d.target).text("Updating");app.notifications.add(e.head,e.msg,"success")},error:function(e,f){$(d.target).text("Update");app.notifications.add("Error","Error while operation","error")}})},submit_form:function(g){var f,d=this,c;f=new Backbone.Model;f.url="/settings/?op=configs";c=d.form1.get_values();_.extend(c,d.tax_values);f.save(c,{success:function(h,e){_.extend(app.appdata,_.mapObject(e.data,function(j,i){return j?j.toString():null}));d.form1.components.set_tax_details[e.tax_method!="no_tax"?"show":"hide"]();app.notifications.add("Settings Saved","Settings has been saved successfuly","success")},error:function(e,h){d.form1.renderServerErrors(h);app.notifications.add("Errors","Error while saving settings","error")}})},onshow:function(){var d,c=this;if(!this.is_inited){this.initComponents();this.is_inited=true}d=new Backbone.Model;d.url="/settings/?op=configs";d.fetch({success:function(f,e){c.form1.set_values(e);c.form1.components.submit_btn.enable();if(app.popups.TaxInfoPopup){app.popups.TaxInfoPopup.fill_tax_values(c,e)}c.form1.components.set_tax_details[e.tax_method!="no_tax"?"show":"hide"]()},error:function(f,e){alert("Error has occured")}})}});if(AL.any_access(["vtypes","access_lists","docno_classes","other_settings"])){set_object("settings_tabs","settings_tab",b)}});FB_Module.register({index:2},function(){var c,a,b,d;c={account_name:{head_label:"Account Name",style:"width:50%",index:0},debit:{head_label:"Debit",style:"width:25%;text-align:right",type:"money",wrapSPAN:true,index:0,prefix:"{currency}"},credit:{head_label:"Credit",style:"width:25%;text-align:right",type:"money",wrapSPAN:true,index:0,prefix:"{currency}"}};a={fields:{sl_no:{head_label:"Sl No",width:"5%",index:1},item_code:{head_label:"Item Code",width:"8%",index:1},item_name:{head_label:"Item Name",width:"27%",index:1},description:{head_label:"Description",width:"15%",index:2},unit_name:{head_label:"Unit",width:"6%",align:"center",index:3},quantity:{head_label:"Quantity",width:"7%",align:"right",type:"money",index:3},inv_q:{head_label:"Inv Qty",width:"7%",align:"right",type:"money",index:3},rate:{head_label:"Rate",width:"8%",align:"right",type:"money",index:4},gross_amount:{head_label:"Gross Amount",width:"8%",align:"right",type:"money",index:4},discount:{head_label:"Discount",width:"8%",align:"right",type:"money",index:4},amount:{head_label:"Net Amount",width:"8%",align:"right",type:"money",index:5,prefix:"{currency}",wrapSPAN:true}},show_items:["sl_no","item_code","item_name","description","unit_name","quantity","inv_q","rate","gross_amount","discount","amount"]};set_objs({vchr_item_ds_schema:a});b={description:{head_label:"Description",style:"width:85%",index:0},amount:{head_label:"Amount",style:"width:15%;text-align:right",index:0,prefix:"{currency}"}};d={schema:[{class_name:"_w3 key_col _theme1 _lg"},{class_name:"_w3 name_col _theme2 _lg"},{class_name:"_w1"}],data:[]};app.p_views.Voucher=Backbone.View.extend({el:$(".mcarv_voucher"),events:{"click .op_btn":"op_btn_click"},model:app.models.Voucher,view_map:{jv:"Voucher",pc:"Voucher",ct:"Voucher",iv:"Invoices",bl:"Bills",rc:"Receipt",pv:"PaymentVoucher",bv:"BankAccounts",srn:"ServiceRcvNote",stn:"ServiceRetNote",dn:"DebitNotes",cn:"CreditNotes",sj:"StockJournal",pr:"PayrollRegister",prp:"PayrollPayRegister",sq:"SalesQuotations",prf:"ProfomaInvoices",po:"PurchaseOrders",sor:"SaleOrders",so:"StockOpening",gdn:"DeliveryNotes",grn:"GRN",gto:"GTO",gt:"GT",gi:"GoodsIssue",psr:"Voucher",civ:"ContrInvoices",sci:"SubCInvoices",c_cnt:"CustomerContracts",s_cnt:"SupplierContracts",boq:"BOQ",boq_v:"BOQ_Variation"},initialize:function(){app.eventBus.on("show:voucher",this.show,this);this.on("hide",this.onhide);this.$el.find(".ds_products").hide();this.item_ds=new app.DS({head:"Items",ds_id:"ds_voucher_items",appendTo:this.$el.find(".ds_products_cnt")});this.item_ds2=new app.DS({flex_schema:{fields:a,show_items:_.without(a.show_items,"inv_q")},head:"Items",ds_id:"ds_voucher_items2",appendTo:this.$el.find(".ds_products_cnt")});this.popup=app.popups.JournalPopup,this.vchr_data_table=new app.Table({data:d,appendTo:this.$el.find(".ds_dtable_cnt")});this.transaction_ds=new app.DS({schema:c,head:"Transactions",ds_id:"ds_trans1",rows:[],appendTo:this.$el.find(".ds_transactions_cnt")});this.listenTo(this.transaction_ds,"li_clicked",function(j,g,h,f){var i;i=g.get_row(j);app.router.navigate(app.generate_url("accounts",i.account_id,null),{trigger:true})});this.listenTo(this.item_ds,"all",function(n,h,g,m,r){var p,f,k,l,j,r,o;p=this;if(n=="li_clicked"){var q;p.edit_btn_clicked()}else{if(n=="rendered"){f=g.$el.find(".ds_container>.table_list_cnt>.table_list>li");for(j=0;j<f.length;j++){l=f.eq(j);if(g.rows[j].inv_q!=undefined){if(g.rows[j].inv_q==0){o="_red"}else{if(g.rows[j].inv_q<g.rows[j].quantity){o="_yellow"}else{o="_green"}}l.find("._cinv_q").addClass(o)}}}}});this.template1=_.template("<dl><% for(item in items){ %><dt><%=item%></dt><dd><%=items[item]%></dd><% } %></dl>")},render:function(){var k,j,l,e,p;p=this;var g=p.data;p.$el.removeClass(function(i,q){return(q.match(/(^|\s)vtype-\S+/g)||[]).join(" ")});p.$el.addClass("vtype-"+g.vtype);if(g.vtype){p.$el.find(".page_head").text(g.vtype_txt)}var f={Date:g.date,Description:g.description},j;p.$el.find(".vchr_data_cnt").html(p.template1({items:f}));var m=p.data.vtype;if(m in p.view_map&&app.p_view_inst[p.view_map[m]].render_voucher){return app.p_view_inst[p.view_map[m]].render_voucher(p.data,p)}if(g.transactions){_.each(g.transactions,function(r,q){r.id=q});p.transaction_ds.$el.show();p.transaction_ds.rows=g.transactions;p.transaction_ds.render()}if(g.items){p.item_ds.flex_schema=g.sub_type=="dr"?b:{fields:a.fields,show_items:_.without(a.show_items,m!="grn"?"inv_q":null)};p.item_ds.rows=g.items;for(j=0,l=g.items.length;j<l;j++){e=g.items[j];e.sl_no=j+1;e.gross_amount=Number(e.amount)+Number(e.discount)}if(g.data.currency_name&&g.data.currency_name.value){p.item_ds.prefix_map["{currency}"]=g.data.currency_name.value}else{p.item_ds.prefix_map["{currency}"]=app.appdata.currency_symbol}p.item_ds.$el.show();p.item_ds.render()}else{p.item_ds.$el.hide()}if(g.data){var h={},n,o;for(j in g.show_items){n=g.show_items[j];o=g.data[n];h[n]=[o.label,o.value]}d.data=h;p.vchr_data_table.$el.show();p.vchr_data_table.render(d)}},show:function(g){var f,e=this;this.$el.find(".vchr_data_cnt").html("");this.transaction_ds.$el.hide();this.item_ds.$el.hide();this.item_ds2.$el.hide();this.vchr_data_table.$el.hide();f=new this.model;f.set({id:g});f.fetch({success:function(i,h){e.data=h;e.render()},error:function(i,j){var h=j.responseJSON;if(h&&h.errors.__all__){app.notifications.add("Error",h.errors.__all__,"error")}else{app.notifications.add("Error","Error while Loading data","error")}}});app.pages.show_page(this);app.TopButtons.set(["print","export"])},op_btn_click:function(g){var f=$(g.target);if(f.hasClass("delete_item_btn")){app.Prompt.show({head:"Delete this item?",text:"Do you sure you want to delete this item?",callback:this.delete_item,context:this})}else{if(f.hasClass("edit_vchr_btn")){this.edit_btn_clicked()}}},edit_voucher:function(f,h){var g={},e;this.popup.show({method:"update",invoker:this,doc_type:_.find(app.fb_doc_types,function(i){return i.abbr==f.vtype}).name,callback:h,data:f})},edit_btn_clicked:function(){var e=this.data.vtype;if(e in this.view_map){app.p_view_inst[this.view_map[e]].edit_voucher(this.data,this.edit_btn_callback)}},edit_btn_callback:function(e,f){app.router.navigate(app.generate_url("voucher",f.voucher_id,{upd:Math.random()}),{trigger:true,replace:true})},export_data:function(){$("#myiframwe").attr("src",app.generate_ext_url("vouchers",this.data.voucher_id,{op:"export_to_excel"}))},print_data:function(f){var e;e=new this.model;e.set({id:f||this.data.voucher_id});e.fetch({data:$.param({op:"print_preview"}),success:function(h,g){if(g.has_mlt_fmt){app.utils.show_print_box(g.print_html)}else{app.utils.print_content(g.print_html)}},error:function(g,h){app.notifications.add("Print Failed","Unable to print Voucher","error")}})},delete_item:function(e){var f,g;if(e=="yes"){g=this.data.vtype;f=new this.model;f.set({id:this.data.voucher_id});f.destroy({success:function(){app.notifications.add("Item Deleted","Item has been successfully deleted","success");window.history.back()},error:function(i,j){var h=j.responseJSON;if(h&&h.errors.__all__){app.notifications.add("Error",h.errors.__all__,"error")}else{app.notifications.add("Error","Unknown Error while Deleting Voucher","error")}}})}$.magnificPopup.instance.close()},onhide:function(){}})});FB_Module.register({index:2},function(){var c={default_attr:{class_name:"_sm2 _type1"},fields:{_top_cnt:{tagName:"div",className:"_form_top_cnt",fields:{doc_no:{type:"inputbox",label:"Vchr No",id:"_mgtp_2x _trans",dlgTo:"scope"},date:{type:"datefield",name:"date",label:"Date",id:"_trans",dlgTo:"scope"},ref_no:{type:"inputbox",label:"Ref No",id:"_mgtp_2x _trans",dlgTo:"scope"},job_name:{type:"combobox",label:"Job ID",id:"_w15em",url:"/jobs/?name={{value}}&pagination=false&is_group=false",dlgTo:"scope",label_sel:"name",value_sel:"name"}}},_ipsheet_cnt:{tagName:"div",className:"_ipsheet_cnt"},_bottom_cnt:{tagName:"div",className:"_bottom_cnt",fields:{description:{type:"inputbox",label:"Description :",class_name:"_sm2 _type4",id:"jrfrm_desc",dlgTo:"scope"}}},print_btn:{type:"button",id:"float_left _theme1 _w6em",label:"Print",index:100,dlgTo:"scope"}},validation:{date:{required:true}}};var a={account_name:{required:true},debit:{type:"number"},credit:{type:"number"}};var b={drcr:{head_label:"&nbsp;",width:4,index:5,ip_options:{type:"inputbox",label:"",id:"jpp_drcr",dlgTo:"scope"}},account_name:{head_label:"Account Name",width:56,index:10,ip_options:{type:"combobox",id:"jpp_accname",label:"Account Name",url:"/accounts/?name={{value}}&is_cntlacc=false&pagination=false&no_genfields=true&_select_fields=id,name,c_balance,acc_type,acc_type_txt2,cost_appl,sub_key",use_local:true,info_sel:"acc_type_txt2",new_item_btn:true,handle_events:["paste"],dlgTo:"scope"}},sub_narration:{head_label:"Remarks",width:30,index:12,ip_options:{type:"inputbox",label:"Remarks",id:"",dlgTo:"scope"}},debit:{head_label:"Debit",width:15,index:20,ip_options:{type:"inputbox",id:"_ralign jvppdebit",label:"Debit",dlgTo:"scope",thousand_sep:true,calc_exp:true}},credit:{head_label:"Credit",width:15,index:30,ip_options:{type:"inputbox",id:"_ralign jvppcredit",label:"Credit",dlgTo:"scope",thousand_sep:true,calc_exp:true}}};app.popups.JournalPopup=new (app.Popup.extend({id:"journal_popup",head:"Journal Voucher",class_name:"doc_pp_t1 _mw1200x",model:app.models.JournalVoucher,events:{submit:"submit_form","click .op_btn":"submit_form"},show_save_n_next:true,beforeInit:function(){this.on("after_show",this.after_show);return true},after_show:function(){var d=this;d.set_colhead_padding();d.set_height();d.set_max_height();d.center()},set_height:function(){var d,e;d=this.$el.find("._ipsheet_cnt");e=$(window).height()-(this.$el.outerHeight()-d.outerHeight())-10;d.css({height:e})},set_max_height:function(){var e,f,d;d=this;e=d.ip_sheet.$el.find(".table_listcnt");f=d.$el.find("._ipsheet_cnt").height()-d.$el.find("._bottom_cnt").height();e.css({maxHeight:f-f%d.ip_sheet.rowHeight})},set_colhead_padding:function(){var d,f,e;d=this.ip_sheet.$el.find(".table_listcnt");f=d.width();e=d.find(">ul").width();d.parent().find(".table_head_ul").css({paddingRight:f-e>3?(f-e)+"px":0})},render:function(d,h){var j,g,e,k,f,n,l,p;var o=this;p=o.options;o.doc_type=p.doc_type;o.head=get_doctype(null,p.doc_type).heading;if(!d){o.form=new app.Form(_.extend({appendTo:o.$el.find(".popup_body")},c));o.form.fields.print_btn.append_to=o.$el.find(".popup_footer");if(get_cfg("en_jobs")!="true"){delete o.form.fields._top_cnt.fields.job_name}o.form.renderInputs(null,o.form.$el.find(".fields"));o.form.$el.find("._bottom_cnt").prepend('<div class="jrform_total"><span class="jrform_titem total_debit">Total: <span class="_tamount"></span></span><span class="jrform_titem total_credit">Total: <span class="_tamount"></span></span></div>').append("<div class='clearfix'></div>");o.ip_sheet=new app.IPS({ips_id:"jv_ipsheet",is_scrollable:true,ip_defaults:{class_name:"_sm2 _type2 _nouline"},appendTo:o.$el.find("._ipsheet_cnt"),schema:b});o.listenTo(o.ip_sheet,"all",o.ipsheet_event);o.vald_form=new app.Form({el:o.ip_sheet.$el,validation:a});o.listenTo(o.form,"all",o.form_ev_handler);o.context_menu=new app.ContextMenu({items:[{key:"display",value:"Display"},{key:"settlement",value:"Settlements and refs"},{key:"allocations",value:"Allocations"},{key:"insert_above",value:"Insert Row Above"},{key:"delete_row",value:"Delete"}],width:200});o.listenTo(o.context_menu,"context_item_click",o.context_item_click)}o.ip_sheet.release();o.ip_sheet.render();o.ip_sheet.rowHeight=null;o.form.reset(null,["date"]);o.setMode("idle");app.set_docno_field(o.doc_type,o.form);o.no_autofocus=(p.method=="update");if(p.data){if(p.data.transactions){o.set_data(p.data)}else{if(o.last_xhr&&o.last_xhr.readyState!=4){o.last_xhr.abort()}f=new app.models.Voucher;f.context=o;f.set({id:p.data.voucher_id});o.last_xhr=f.fetch({data:$.param({acc_sel:app.LocalDB.has_local("/accounts/")?"account_id":"account_name"}),success:function(q,m){q.context.set_data(m)},error:function(m,q){app.notifications.add("Error","Unable to load data, please check your internet connection","error")}})}}else{o.ip_sheet.insertRow({drcr:"Dr",debit:0,credit:0});o.set_total(0,0)}o.form[p.method=="update"?"show_comps":"hide_comps"](["print_btn"]);if(p.method=="update"){}else{g=o.form.components.doc_no;j=h?o.form.components.date.get_value():app.get_new_voucher_date();if(g.disabled){g.set_value(app.generate_doc_no(o.doc_type,j,1,true))}else{g.set_value("")}o.form.set_values({date:j,description:""})}},set_data:function(h){var d,g,f,e,j;if(this.options.method=="update"){this.form.set_values(_.pick(h,["doc_no","date","ref_no","job_name","description"]))}if(this.options.reverse==true){g=_.each(h.transactions,function(l){var k=l.debit;l.debit=l.credit;l.credit=k});f=_.each(h.transactions_extra,function(k){k.drcr=k.drcr=="dr"?"cr":"dr"})}else{g=h.transactions;f=h.transactions_extra}d=this;for(i in g){if(!g[i].account_name&&g[i].account_id){g[i].account_name=app.LocalDB.get("/accounts/?id="+g[i].account_id).name}this.ip_sheet.insertRow(_.extend({},g[i],f[i],{drcr:f[i].drcr=="dr"?"Dr":"Cr"}));j=this.ip_sheet.rows[i].extra_values={};if(f[i].ref_data){j.ref_data={ref_items:f[i].ref_data}}if(f[i].new_ref_data){j.new_ref_data={ref_items:f[i].new_ref_data}}if(f[i].cost_alloc){j.cost_alloc=f[i].cost_alloc}if(f[i].job_alloc){j.job_alloc=f[i].job_alloc}e=this.ip_sheet.rows[i].cols.account_name.ip;this.set_row_balance(e,f[i].c_balance);e.data={items:[{id:f[i].account_id,name:g[i].account_name,sub_key:f[i].acc_sub_type,cost_appl:f[i].cost_appl,c_balance:f[i].c_balance,balance_delta:Number(f[i]["drcr"]=="dr"?g[i]["debit"]:-g[i]["credit"])}]}}this.set_total(null,null,true);this.ip_sheet.scrollTo("top");this.ip_sheet.focusRow(0,"account_name");setTimeout(function(){d.set_colhead_padding()},100)},show_adj_popup:function(h,e){var d,g,f;h.extra_values=h.extra_values||{};d=h.cols.account_name.ip.get_value();g=h.cols.drcr.ip.get_value();f={account_name:d,negate_due:true,to_date:this.form.components.date.get_value(),unresolved:true,calculate_total:true};if(this.options.method=="update"){f.ignore_unresolved_from=this.options.data.voucher_id}app.popups.RefAdj.show({method:"set",invoker:this,row:h,amount:h.cols[g=="Dr"?"debit":"credit"].ip.get_value()*(g=="Dr"?1:-1),params:f,data:{ref_data:h.extra_values.ref_data,new_ref_data:h.extra_values.new_ref_data},callback:function(l){var k,j;j=this;h.extra_values.ref_data=l.ref_data;h.extra_values.new_ref_data=l.new_ref_data;if(e){setTimeout(function(){j.ip_sheet.focusRow(j.ip_sheet.nextRow(h))},400)}}})},set_row_balance:function(f,e){var d=this;if(!this.ip_sheet.rowHeight){setTimeout(function(){d.ip_sheet.rowHeight=f.$el.closest(".tl_li").outerHeight();d.set_max_height()},10)}f.$el.parent().find(">.ip_sheet_balance_txt").removeClass("_negative").addClass("filled"+(e<0?" _negative":"")).html("Closing Balance : "+to_money(e))},context_item_click:function(m,f,g){var j,h,e,d,l,k;l=this;if(f=="insert_above"){j=this.ip_sheet.getRowIndex(m);this.insertRow(j)}else{if(f=="delete_row"){m.cols.account_name.ip.hide_dropdown();if(this.ip_sheet.rows.length>1){this.ip_sheet.deleteRow(m)}}else{if(f=="display"){d=m.cols.account_name.ip;h=d.get_selected_data();if(h){e=new app.models.Account({id:h.id});e.fetch({success:function(o,n){app.popups.AccountPopup.show({method:"update",invoker:l,is_cntlacc:false,hide_cont_btn:true,data:n,callback:function(q,p){d.set_value(p.name+p.suffix);d.data={items:[{id:p.id,cost_appl:p.cost_appl,name:p.name+p.suffix}]};setTimeout(function(){d.focus()},800)}})},error:function(){}})}}else{if(f=="settlement"){this.show_adj_popup(m)}else{if(f=="allocations"){app.popups.AllocationPopup.show({invoker:l,method:"set",qty_based:false,show_tabs:["cost_alloc",get_cfg("en_jobs")=="true"&&l.form.components.job_name.get_value()==""?"job_alloc":null,"gdcost_alloc"],amount:Number(m.cols[m.cols.drcr.ip.get_value()=="Dr"?"debit":"credit"].ip.get_value()),row:m,callback:function(o,n){o.extra_values=o.extra_values||{};_.extend(o.extra_values,n);setTimeout(function(){l.validate_row(o,true)},200)}})}}}}}},form_ev_handler:function(k,h,j){var n,l,d,p,f,g,o;o=this;d=o.form.components;if(k=="keydown"&&h.name=="date"){if(j.keyCode==13){j.preventDefault();o.ip_sheet.focusRow(0)}}else{if(k=="keyup"&&h.name=="date"){dn_comp=d.doc_no;j.preventDefault();p=o.options;l=app.generate_doc_no;if(dn_comp.disabled){n=p.method=="create"?l(o.doc_type,h.get_value(),1,true):p.data.doc_no;d.doc_no.set_value(n)}}else{if(k=="keydown"&&h.name=="description"){if(j.keyCode==13){j.preventDefault();o.$el.find(".popup_footer ."+(o.options.method=="create"?"op_btn_snnx":"op_btn_sncl")).focus()}}else{if(k=="clicked"&&h.name=="print_btn"){app.p_view_inst.Voucher.print_data(o.options.data.voucher_id)}}}}},ipsheet_event:function(r,q,h,p,k){var l,j,g,f,d,t,n,o,m,s;s=this;t=s.ip_sheet.getRow(q);o=s.form.components;switch(r){case"text_changed":if((t.cols[h].ip.get_value()==""||h=="drcr")&&p.keyCode==8&&p.shiftKey){if(t.dclick_flag==true){if(h=="account_name"){t.cols[h].ip.hide_dropdown()}if(s.ip_sheet.rows.length>1){s.ip_sheet.deleteRow(t);s.ip_sheet.rows[q!=0?q-1:0].cols[h].ip.focus()}}else{t.dclick_flag=true;setTimeout(function(){t.dclick_flag=false},200)}}t.extra_values.new_ref_data=null;t.extra_values.ref_data=null;break;case"focusout":if(h=="debit"||h=="credit"){j=t.cols.account_name.ip;tmp=j.get_selected_data();g=Number(k.comp.get_value());if(tmp&&g!=NaN){s.set_row_balance(j,Number(tmp.c_balance)-(tmp.balance_delta||0)+(h=="debit"?g:-g))}s.set_total(null,null,true)}break;case"item_selected":case"enterkey_press":if(r=="enterkey_press"){p.preventDefault()}if(r=="enterkey_press"&&(h=="debit"||h=="credit")&&t.cols.account_name.ip.get_value()==""){o.description.focus();break}if(r=="item_selected"&&h=="account_name"){tmp=k.comp.get_selected_data();if(tmp){s.set_row_balance(k.comp,tmp.c_balance)}if(q==s.ip_sheet.rows.length-1){s.ip_sheet.scrollTo("bottom")}}if(r=="enterkey_press"&&(h=="debit"||h=="credit")){tmp=s.ip_sheet.rows;j=tmp[tmp.length-1].cols;d=j.drcr.ip.get_value();m=t.cols.account_name.ip.get_selected_data();if(m&&_.in_list(m.acc_type,["expense","income"])&&((o.job_name&&o.job_name.get_value()==""&&get_cfg("en_jobs")=="true")||(get_cfg("en_costcenter")=="true"&&m.cost_appl))){app.popups.AllocationPopup.show({invoker:s,method:"set",qty_based:false,show_tabs:["cost_alloc",o.job_name.get_value()==""?"job_alloc":null],amount:Number(k.comp.get_value()),row:t,callback:function(u,e){u.extra_values=u.extra_values||{};_.extend(u.extra_values,e);setTimeout(function(){s.validate_row(u,true)},200)}});return}if((m.sub_key=="payable"||m.sub_key=="receivable")&&!t.extra_values.new_ref_data){if(get_cfg("en_auto_ref_jr")=="true"&&!(t.extra_values.new_ref_data||t.extra_values.ref_items)){g=s.form.get_values(["date","doc_no","ref_no"]);if(s.options.method=="create"){t.extra_values.new_ref_data={ref_items:[{date:g.date,ref_no:g.ref_no||g.doc_no,narration:t.cols.sub_narration.ip.get_value(),due_date:g.date,amount:Number(t.cols.debit.ip.get_value())||Number(t.cols.credit.ip.get_value()),dr_cr:Number(t.cols.debit.ip.get_value())!=0?"Dr":"Cr"}]}}}s.show_adj_popup(t,true)}if(q==tmp.length-2&&_.contains(["0",""],j[d=="Dr"?"debit":"credit"].ip.get_value())){g=this.get_total();f=g.debit>g.credit?"Cr":"Dr";if(d==f){j[f=="Dr"?"debit":"credit"].ip.set_value(wacky_round(Math.abs(g.debit-g.credit),2))}}}if(this.ip_sheet.focusColumn(t,h,"next",true,{select:true})==false){this.validate_row(t,true)}break;case"add_new_clicked":app.popups.AccountPopup.show({method:"create",is_cntlacc:false,hide_cont_btn:true,data:{name:k.comp.get_value(true),is_cntlacc:false},invoker:this,callback:function(u,e){k.comp.set_value(e.name+e.suffix);k.comp.data={items:[{id:e.id,cost_appl:e.cost_appl,name:e.name+e.suffix,c_balance:0}]};setTimeout(function(){k.comp.focus()},800)}});break;case"keydown":if(h=="drcr"){l=(p.keyCode==68?"Dr":(p.keyCode==67?"Cr":null));if(p.keyCode!=9&&p.keyCode!=13){p.preventDefault()}if(l!=null){t.cols.drcr.ip.set_value(l);t.cols.drcr.ip.$el[l=="Dr"?"addClass":"removeClass"]("isDr");t.cols[l=="Dr"?"credit":"debit"].ip.set_value(0).disable();t.cols[l=="Cr"?"credit":"debit"].ip.set_value(0).enable()}}break;case"row_insert":l=t.cols.drcr.ip.get_value();t.cols[l=="Dr"?"credit":"debit"].ip.set_value(0).disable();t.cols.drcr.ip.$el[l=="Dr"?"addClass":"removeClass"]("isDr");l=t.cols.account_name.ip;j=l.$el.parent();j.append("<span class='ip_sheet_balance_txt'></span>");if(q==this.ip_sheet.rows.length-1){this.ip_sheet.scrollTo("bottom")}this.set_colhead_padding();break;case"row_delete":this.set_colhead_padding();break;case"context_menu":l=this;setTimeout(function(){l.context_menu.show(t,{left:p.pageX,top:p.pageY})},100);break;case"arrow_press":f=this.ip_sheet;if(p.keyCode==38&&q>0||p.keyCode==40&&q<f.rows.length-1){l=p.keyCode==38?q-1:q+1;if(h=="credit"||h=="debit"){g=h=="credit"?"debit":"credit";j=f.rows[l].cols[h].ip.disabled?g:h}else{j=h}d=f.rows[l].cols[j].ip;d.focus();setTimeout(function(){d.input_el[0].select()});if(l==0){f.scrollTo("top")}else{if(l==f.rows.length-1){f.scrollTo("bottom")}}}break;case"paste":tmp=p.originalEvent.clipboardData.getData("text/plain");if(tmp.indexOf("\t")!=-1){p.preventDefault();this.pasteFromSpreadSheet(tmp,q)}break}},pasteFromSpreadSheet:function(f,k){var g,n,h,m,e,l,d,j;n=f.split("\n");for(g=0;g<n.length;g++){h=n[g].split("\t");if(h.length<=3&&(h[1]!=""||h[2]!="")){e=h[0];l=h[1].replace(",","").replace(/\.0+$/,"");d=h[2]?h[2].replace(",","").replace(/\.0+$/,""):"";this.ip_sheet.insertRow({drcr:l!=""?"Dr":"Cr",account_name:$.trim(e),debit:l!=""?l:0,credit:d!=""?d:0},k+g);j=this.ip_sheet.rows[k+g].cols.account_name;j.ip.emul_itemselect()}}},edit_voucher:function(e,g){var f={},d;this.popup.show({method:"update",invoker:this,callback:g,data:e})},get_total:function(){var f,e,d;f={debit:0,credit:0};e=this.ip_sheet.get_value_list(["debit","credit"]);for(d in e){f.debit+=Number(e[d]["debit"]);f.credit+=Number(e[d]["credit"])}return f},set_total:function(h,d,f){var e,g;if(f){g=this.get_total();h=g.debit;d=g.credit}e=this.form.$el.find(".jrform_total");e.find(".total_debit > span").text(to_money(h));e.find(".total_credit > span").text(to_money(d))},insertRow:function(e){var d;d=this.get_total();this.set_total(d.debit,d.credit);return this.ip_sheet.insertRow({drcr:d.credit>d.debit?"Dr":"Cr",debit:d.credit>d.debit?wacky_round(d.credit-d.debit,2):0,credit:d.credit<d.debit?wacky_round(d.debit-d.credit,2):0},e)},validate_row:function(o,e,g){var n=this,h,m,j,d,k,f,l;d=this.ip_sheet.get_components(o);this.vald_form.components=d;k=this.vald_form.validate()||{};if(_.isEmpty(k)){l=this.ip_sheet.get_values(o);if(Number(l.debit)==0&&Number(l.credit)==0){k.debit={msg:"Either Dr/Dr should be non zero",reason:"required"}}if(Number(l.debit)!=0&&Number(l.credit)!=0){k.debit={msg:"Either Dr/Dr should be 0",reason:"required"}}}this.vald_form.renderErrors(k);if(!_.isEmpty(k)){this.ip_sheet.focusColumn(o,Object.keys(k)[0]);return false}if(this.ip_sheet.isLast(o)&&e){m=this.insertRow(g)}else{m=this.ip_sheet.nextRow(o)}setTimeout(function(){n.ip_sheet.focusRow(m)},20);return true},submit_form:function(k){var f,h,j,d,g,l;k.preventDefault();f=this;g=f.options;j=f.form;d=j.get_values();l=j.validate();j.renderErrors(l);d.doc_type=f.doc_type;d.transactions=f.ip_sheet.get_value_list();if(!l){h=new f.model;h.set(d);if(g.method=="update"){h.set({id:g.data.voucher_id,voucher_id:g.data.voucher_id})}this.setMode("working");Backbone.sync(g.method=="update"?"update":"create",h,{success:function(e){f.setMode("idle");app.set_last_no(e);if(g.callback){g.callback.call(g.invoker,"save_success",e)}if(g.invoker){g.invoker.trigger("popup_event","save_success",e)}app.notifications.add(e.head,e.msg,"success");if(g.method=="update"||(k.type=="click"&&$(k.target).hasClass("op_btn_sncl"))){f.close()}else{f.render(true,true);f.ip_sheet.focusRow(0,"account_name")}},error:function(e){var m;f.setMode("idle");app.set_docno_field(f.doc_type,f.form);m=traverse(e,"responseJSON.errors.__all__");if(m){app.notifications.add("Error",_.isArray(m)?m[0]:m,"error")}else{f.form.renderServerErrors(e);f.ip_sheet.renderErrors(e,null,{focus_first:true})}}})}}}))();app.models.Attachment=Backbone.Model.extend({urlRoot:"/attachments/",initialize:function(e){var d=this;e=e||{};d.doc_type=e.doc_type;d.doc_id=e.doc_id},fetch:function(e){var d=this;_.proto(d,1).fetch.call(d,_.extend({data:$.param(_.extend({op:"get_attached_files",doc_type:d.doc_type,doc_ids:d.doc_id},e.params))},_.pick(e,["success","error"])))},post:function(f,e){var d=this;d.options=e;d.get_upload_urls(f)},destroy:function(f,e){var d;d=this;_.proto(d,1).fetch.call(d,_.extend({data:$.param({op:"delete_file",id:f}),error:function(g,h){app.notifications.add("Error","Error while delete file:01","error")}},_.pick(e,["success","error"])))},set_default:function(f,e){var d;d=this;_.proto(d,1).fetch.call(d,_.extend({data:$.param({op:"set_default",id:f}),error:function(g,h){app.notifications.add("Error","Error while set default file:01","error")}},_.pick(e,["success","error"])))},get_upload_urls:function(e){var d;d=this;_.proto(d,1).fetch.call(d,_.extend({data:$.param(_.extend({op:"get_upload_urls",doc_type:d.doc_type,doc_id:d.doc_id,sub_id:d.sub_id,file_names:_.reduce(e,function(f,g){return f+(f!=""?",":"")+g.name},"")},_.pick(d.options,["replace_files"]))),success:function(j,h){var k,f,g,l;g=h.file_list;for(k=0,f=g.length;k<f;k++){l=g[k];e[k].id=l.id;d.upload_file(l.url,e[k])}},error:function(f,g){app.notifications.add("Error","Error while uploading file:01","error")}},_.pick(d.options,["error"])))},upload_file:function(f,h){var g,d,j,e;e=this;d=f.fields;j=new FormData();for(g in d){j.append(g,d[g])}j.append("file",h);$.ajax(_.extend({type:"POST",url:f.url,crossDomain:true,data:j,processData:false,contentType:false,success:function(k){e.notify(h)},error:function(){app.notifications.add("Error","Error while uploading file:aws","error")}},_.pick(e.options,["error"])))},notify:function(e){var d=this;_.proto(d,1).fetch.call(d,_.extend({data:$.param(_.extend({op:"mark_as_completed",id:e.id},_.pick(d,["is_bind","is_default"]))),success:function(g,f){var h;if(d.options.success){d.options.success(g,f)}},error:function(f,g){app.notifications.add("Error","Error while uploading file:02","error")}},_.pick(d.options,["error"])))}});app.popups.COMP_VAL=new (app.Popup.extend({id:"dncogs_popup",class_name:"_mw300x",head:function(e){var d;d=this;return d.options?d.options.head:""},events:{"click .op_btn":"submit_form"},render:function(d){var j,k,f,l,m,h,e,g;k=this;if(!d){k.form=new app.Form({default_attr:{class_name:"_type1 _md _mgrt_1em _comp_inline"},fields:{ip:{type:"inputbox",id:"_w10em",label:"Ref No",dlgTo:"scope"}},validation:{},appendTo:this.$el.find(".popup_body")});k.form.renderInputs();k.listenTo(k.form,"all",k.form_ev_handler)}k.setMode("idle");m=k.options;g=k.form.components.ip;g.set_label(k.options.head);g.set_value(m.val)},form_ev_handler:function(f,d,g){},submit_form:function(h){var g,f,d;d=this;g=d.options;f=d.form.get_values(true);if(_.isEmpty(f)){d.form.components.ip.render_error("This field is required");return}g.comp.set_value(f.ip);g.comp.trigger_event("item_selected",g.comp,null);g.comp.focus();d.close()}}))();app.popups.ExportOptions=new (app.Popup.extend({id:"exp_options_popup",head:"Export Options",class_name:"_mw600x",events:{"click .op_btn":"submit_form"},render:function(d){var j,k,f,l,m,h,e,g;k=this;if(!d){k.form=new app.Form({default_attr:{class_name:"_type1 _md _mgrt_1em _comp_inline"},fields:{from_date:{type:"datefield",id:"_w10em",label:"From Date",dlgTo:"scope"},to_date:{type:"datefield",id:"_w10em",label:"To Date",dlgTo:"scope"},detailed:{type:"checkbox",id:"_mgtp_1em",value:"true",label:"Detailed",dlgTo:"scope"}},validation:{},appendTo:this.$el.find(".popup_body")});k.form.renderInputs();k.listenTo(k.form,"all",k.form_ev_handler)}k.setMode("idle");m=k.options},form_ev_handler:function(f,d,g){},submit_form:function(h){var g,f,d;d=this;g=d.options;f=d.form.get_values(true);if(_.isEmpty(f)){}if(g.callback){g.callback.call(g.invoker,f)}d.close()}}))();app.popups.AllocationPopup=new (app.Popup.extend({id:"allocation_popup",class_name:"_mw800x",head:"Allocations",manual_focus:true,disable_anim:true,removalDelay:100,events:{"click .op_btn":"submit_form"},init:function(){var d;d=this;d.tabs=new app.Tabs({appendTo:this.$el.find(".popup_body"),$scope:this});d.tabs.append(_.map(get_object("alloc_tab"),function(f,e){return new f}));console.log(d.tabs)},render:function(e){var g,m,f,n,o,k,d,h,j,l;m=this;o=m.options;if(!e){m.init()}m.setMode("idle");h=m.tabs;for(d in h.tabs){k=o.show_tabs.indexOf(d)!=-1;j=h.tabs[d];j[k?"show":"hide"]();if(k){if(!l){l=d}j.on_popup_show();if(o.row.errors){j.render_errors(o.row.errors)}}}m.tabs.show_tab(l)},after_close:function(){var d=this.options;d.callback.call(d.invoker,d.row,null)},validate:function(){var f,e,d,g;e=this;for(f in e.tabs.tabs){g=e.tabs.tabs[f];if(g.$head_el.is(":visible")){d=g.validate();if(d==false){return false}}}return true},get_values:function(){var f,e,g,d;e=this;d={};for(f in e.tabs.tabs){g=e.tabs.tabs[f];if(g.$head_el.is(":visible")){_.extend(d,e.tabs.tabs[f].get_values())}}return d},submit_form:function(){var e,d;d=this;e=d.options;if(d.validate()){e.callback.call(e.invoker,e.row,d.get_values());this.close(true)}}}))();app.popups.DrillSel=new (app.Popup.extend({id:"drill_sel",class_name:"_mw300x",head:"Drill Selector",removalDelay:0,disable_anim:true,events:{"click .op_btn":"submit_form"},render:function(f){var j,m,g,n,o,e,h,k,d,l;m=this;k=_.template("<ul><% _.each(items,function(item){ if(item!=null){ %><li data-val=<%=item[0]%> ><%=item[2]%></li> <% } }); %></ul>");if(!f){m.$drill_sel=$('<div class="drill_sel"></div>').appendTo(m.$el.find(".popup_body"));m.$drill_sel.on("click","li",function(){m.$drill_sel.find("li").removeClass("active");$(this).closest("li").addClass("active")});m.$drill_sel.on("dblclick","li",function(){m.submit_form()})}o=m.options;m.setMode("idle");d=o.get_item_options(o.map,o);m.$drill_sel.html(k({items:d}))},gl_ev_handler:function(f,h){var g,d;d=this;if(f=="keydown"){g=d.$drill_sel.find(".active");if(g.length==0){d.$drill_sel.find("li:eq(0)").addClass("active")}else{if(h.keyCode==40&&!g.is(":last-child")){g.removeClass("active").next().addClass("active")}else{if(h.keyCode==38&&!g.is(":first-child")){g.removeClass("active").prev().addClass("active")}}}}},submit_form:function(h){var g,f,d;f=this;g=f.options;d=this.$drill_sel.find(".active");if(d.length==0){app.notifications.add("Info","Please select an item","info");return}g.callback.call(g.invoker,d.data("val"));f.close()}}))();app.popups.ASC=new (app.Popup.extend({id:"acp_pp",head:"Associations",model:gen_model("/asc/"),class_name:"_mw600x",events:{"click .op_btn":"submit_form"},render:function(g){var h,d,f,e,j;d=this;if(!g){d.form=new app.Form({appendTo:d.$el.find(".popup_body"),class_name:"_brdbt_t2 _mgbt_1em",fields:{owner_id:{type:"combobox",id:"",label:"Owner",class_name:"_type1 _sm2 _comp_inline _w20em _mgrt_1em _mgbt_05em",label_sel:"name",value_sel:"id",url:"/members/?name={{value}}&pagination=false",dlgTo:"scope"}}});d.form.renderInputs();d.ips=new app.IPS_ext({ip_defaults:{class_name:"_sm _nouline"},schema:{ug_id:{head_label:"Group Name",width:40,index:10,ip_options:{type:"combobox",id:"_type2",label:"User Group",dlgTo:"scope",label_sel:"name",value_sel:"id",url:"/access_groups/?name={{value}}&excl_names={{excl_names}}&pagination=false"}},ac_ls:{head_label:"List",width:10,index:10,ip_options:{type:"checkbox",id:"_type1",label:"",value:"true",dlgTo:"scope"}},ac_rd:{head_label:"Read",width:10,index:10,ip_options:{type:"checkbox",id:"_type1",label:"",value:"true",dlgTo:"scope"}},ac_ud:{head_label:"Update",width:10,index:10,ip_options:{type:"checkbox",id:"_type1",label:"",value:"true",dlgTo:"scope"}},ac_dt:{head_label:"Delete",width:10,index:10,ip_options:{type:"checkbox",id:"_type1",label:"",value:"true",dlgTo:"scope"}}},appendTo:d.$el.find(".popup_body")});d.ips.render()}d.setMode("idle");f=d.options;d.ips.release(true);d.form.reset();e=new d.model;e.fetch({data:$.param({itype:f.itype,id:f.id}),success:function(k,l){d.set_data(d,l,d.ips)}})},set_data:function(e,d,f){e.form.set_values(_.pick(d,["owner_id"]));if(d.items.length){f.set_value_list(d.items)}else{f.insertRow({})}},after_get_values:function(e){var d;d=this;e.id=d.options.id;e.itype=d.options.itype;e.items=d.ips.get_value_list()}}))()});(function(){var a={default_attr:{class_name:"_type1 _md"},fields:{from_date:{type:"datefield",name:"from_date",id:"colfromdate",label:"From Date"},to_date:{type:"datefield",name:"to_date",label:"To Date",id:"coltodate"},_submit_btn_cnt:{tagName:"div",className:"finyr_submit_cnt",fields:{_submit_btn:{tagName:"button",className:"component btn _type1 _sm2 finyr_submit",innerHTML:"Submit",attrs:{type:"submit"}}}}},validation:{from_date:{required:true},to_date:{required:true}}};app.finperiod_dd=new (Backbone.View.extend({events:{"click .fin_period":"toogle_dropdown",submit:"form_submitted"},initialize:function(d){var e,b,c;c=this;c.form=new app.Form(_.extend({appendTo:c.$el.find(".dropdown-box")},a));c.form.renderInputs();e=app.appdata.finperiod_start;b=app.appdata.finperiod_end;c.set_period(e,b,false,true)},set_period:function(e,b,f,d){var c;c=this;c.$el.find(".fin_period ._from_date").text(e);c.$el.find(".fin_period ._to_date").text(b);if(d){c.form.set_values({from_date:e,to_date:b})}if(f){app.appdata.finperiod_start=e;app.appdata.finperiod_end=b;localStorage.setItem("finperiod_start",parse_date(e).toString("YMD"));localStorage.setItem("finperiod_end",parse_date(b).toString("YMD"))}},toogle_dropdown:function(c){var b=this.$el.find(".dropdown-box");if(b.is(":visible")){b.hide()}else{app.set_dropdown(b);b.show()}},form_submitted:function(g,c,f){var d,c,h,b=this;f=f||{};c=c||this.form.get_values();d=new Backbone.Model;d.url="/company/set_fin_period/";d.save(c,{success:function(i,e){b.set_period(e.from_date,e.to_date,true,f.is_set_form);app.last_doc_nos=e.last_doc_nos;b.$el.find(".dropdown-box").hide();app.set_dropdown(null);if(f.callback){f.callback.fn.call(f.callback.context,true,f.callback.data)}app.LocalDB.refresh_model(app.models.Account);app.notifications.add("Period Changed","The financial period has been changed successully","success")},error:function(e,i){b.form.renderServerErrors(i);if(f.callback){f.callback.fn.call(f.callback.context,false,f.callback.data)}}})}}))({el:$("#financial_period")})})();FB_Module.register({index:2},function(){app.popups.PrintExportOptions=new (app.Popup.extend({id:"printexport_options_popup",class_name:"_mw400x",head:"Options",events:{submit:"submit_form","click .op_btn":"submit_form"},beforeInit:function(){return true},render:function(a){var b;if(!a){this.form=new app.Form(_.extend({appendTo:this.$el.find(".popup_body"),class_name:""},{fields:{lang:{type:"selectbox",label:"Language",options:[{en:"English"},{ar:"Arabic"}],default_option:""}},validation:{lang:{required:true}}}));this.form.renderInputs()}this.setMode("idle")},submit_form:function(){var a;a=this.options;a.callback.call(a.invoker,this.form.get_values());this.close()}}))()});FB_Module.register({index:1,name:"Account"},function(){var d={default_attr:{class_name:"_type1 _md _mgbt_05em"},fields:{_more_items:{tagName:"div",className:"al_right",fields:{_more_btn:{tagName:"button",className:"component btn _type1 _sm _theme1 _more_btn",attrs:{type:"button"},innerHTML:"More ..."}}},_name_cnt:{tagName:"div",fields:{name:{type:"inputbox",id:"_comp_inline _w25em _mgrt_1em",label:"Account Name"},suffix:{type:"inputbox",id:"_comp_inline _w8em",label:"Suffix"}}},_alias_cnt:{tagName:"div",fields:{alias:{type:"inputbox",id:"_comp_inline _w25em _mgrt_1em",label:"Alias"},alias_suffix:{type:"inputbox",id:"_comp_inline _w8em",label:"Suffix"}}},code:{type:"inputbox",id:"_w15em _mgrt_1em",label:"Account Code"},_iss1:{tagName:"div",className:"seperator"},is_subacc:{type:"checkbox",id:"naf_issubacc _comp_inline _mgtp_1em _mgrt_05em",label:"",value:"true"},subacc_of_name:{type:"combobox",id:"_w25em _comp_inline _mgbt_05em",label:"Sub Account of",class_name:"_type1 _md",url:"/accounts/?name={{value}}&pagination=false&is_cntlacc=true&_select_fields=name,acc_type",use_local:true,dlgTo:"scope"},_iss:{tagName:"div",className:"seperator"},acc_type:{type:"selectbox",id:"naf_type _mgtp_8x",label:"Nature of Account",default_option:"",options:{asset:"Asset",liability:"Liability",expense:"Expense",income:"Income"},dlgTo:"scope"},is_gross_affected:{type:"checkbox",id:"naf_gross_affected _comp_block",label:"Does this affect gross profit",value:"true"},cost_appl:{type:"checkbox",id:"_mgtp_05em _comp_block",label:"Cost center applicable?",value:"true"},is_cntlacc:{type:"hidden_input",id:"naf_is_cntlacc",label:"Is this Control Account?",value:"true"},show_in_reports:{type:"checkbox",id:"naf_gross_affected _mgtp_05em",label:"Show in reports",value:"true"},display_order:{type:"inputbox",id:"_w10em _mgtp_1em",label:"Display order"},_opening_balance:{tagName:"div",className:"_opening_balance_cnt",fields:{opening_balance:{type:"inputbox",id:"naf_obalance",label:"Opening Balance"},obalance_drcr:{type:"selectbox",class_name:"_md _type3",id:"naf_obalance_drcr",options:{dr:"Dr",cr:"Cr"}}}},description:{type:"textarea",class_name:"_md _type1",id:"naf_description",label:"Description"}},validation:{name:{required:true}}};app.popups.AccountPopup=new (app.Popup.extend({id:"new_acc_popup",head:"Account",events:{"click .naf_issubacc input":"set_subacc_mode","click .op_btn":"submit_form","click ._more_btn":"more_btn_click"},handle_snnx:true,show_save_n_next:true,model:app.models.Account,render:function(j,m){var n,l,h,i,k,g;g=this;if(!j){g.form=new app.Form(_.extend({appendTo:g.$el.find(".popup_body")},d));g.form.renderInputs();g.listenTo(g.form,"all",g.form_ev_handler)}h=g.options;n=h.data;g.setMode("idle");l=g.form.components;g.form.hide_comps(["acc_type","is_gross_affected","cost_appl"]);l.is_subacc[n.is_cntlacc?"show":"hide"]();if(!m){g.form.$el.find("._more_btn").text("More...").removeClass("active");g.form.hide_comps(["suffix","alias_suffix","show_in_reports","display_order"])}g.form.reset();if(h.method=="update"){n=_.clone(n);n.is_subacc=n.subacc_of!=null;if(n.subacc_of==null){n.subacc_of_name=""}i=Number(n.opening_balance);if(n.suffix_len){k=n.name.length-n.suffix_len;n.suffix=n.name.slice(k);n.name=n.name.slice(0,k)}if(n.al_suffix_len){k=n.alias.length-n.al_suffix_len;n.alias_suffix=n.name.slice(k);n.alias=n.name.slice(0,k)}n.obalance_drcr=(i>=0?"dr":"cr");n.opening_balance=Math.abs(i);this.form.set_values(n);i=this.form.components.subacc_of_name;i.data={items:[{name:n.subacc_of_name,acc_type:n.acc_type,is_cntlacc:n.is_cntlacc}]};i.trigger_event("item_selected",i,null)}else{l.subacc_of_name.show();l.subacc_of_name.enable();g.form.set_values(_.extend({obalance_drcr:"dr",is_subacc:true,is_cntlacc:n.is_cntlacc,show_in_reports:n.is_cntlacc},n));g.form.$el.find("._opening_balance_cnt")[n.is_cntlacc?"hide":"show"]()}if(n.is_cntlacc){g.set_subacc_mode()}if(h.disable_subacc){l.subacc_of_name.disable()}if(n.subacc_of_defacc){(new this.model).fetch({data:$.param({defacc_key:n.subacc_of_defacc}),success:function(p,o){var q;if(o.items.length){q=g.form.components.subacc_of_name;q.set_value(objefy(o)[0].name);q.emul_itemselect()}}})}},form_ev_handler:function(m,k,l,p){var g,p,i,j,o,h,n;n=this;g=n.form.components;pp_options=n.options;if(m=="item_selected"&&k.name=="subacc_of_name"){i=k.get_selected_data();j=g.is_cntlacc.get_value()=="true";g.cost_appl[get_cfg("en_costcenter")=="true"&&_.in_list(i.acc_type,["expense","income"])?"show":"hide"]();n.form.$el.find("._opening_balance_cnt")[i&&!j&&pp_options.data.defacc_key!="inventory"&&_.contains(["asset","liability"],i.acc_type)?"show":"hide"]()}else{if(m=="changed"&&k.name=="acc_type"){o=_.contains(["expense","income"],p.value);g.is_gross_affected[o?"show":"hide"]();g.cost_appl[get_cfg("en_costcenter")=="true"&&o?"show":"hide"]()}}},more_btn_click:function(i){var g,h;g=$(i.target);h=g.hasClass("active");g.text(h?"More...":"Less");g[h?"removeClass":"addClass"]("active");this.form[h?"hide_comps":"show_comps"](["show_in_reports","suffix","display_order"]);this.center()},set_subacc_mode:function(){var g=this.form.components;if(g.is_cntlacc.get_value()=="true"){if(g.is_subacc.get_value()=="true"){g.acc_type.hide();g.is_gross_affected.hide();g.subacc_of_name.enable()}else{g.acc_type.show();g.is_gross_affected[_.contains(["expense","income"],g.acc_type.get_value())?"show":"hide"]();g.subacc_of_name.disable()}}},after_get_values:function(g){if(g.is_subacc==""){g.is_subacc=false}}}))();app.popups.BillWiseDetails=new (app.Popup.extend({id:"billwisedetails_popup",class_name:"_mw800px",head:"Bill Wise Details",btn_map:{set:["Set","Setting"]},events:{submit:"submit_form","click .op_btn":"submit_form"},beforeInit:function(){return true},render:function(k){var l,h,j,g;g=this;if(!k){h=app.IPS.extend({ip_defaults:{class_name:"_sm2 _type2 _nouline _pdlt0"},class_name:"billwise_ips",total_col:"amount",schema:{date:{head_label:"Date",width:24,ip_options:{type:"datefield",id:"",label:"Date"}},ref_no:{head_label:"Ref No",width:30,ip_options:{type:"inputbox",id:"",label:"Ref No"}},narration:{head_label:"Description",width:60,ip_options:{type:"inputbox",id:"",label:"Description"}},due_date:{head_label:"Due Date",width:24,ip_options:{type:"datefield",id:"",label:"Due Date"}},amount:{head_label:"Amount",width:25,ip_options:{type:"inputbox",id:"_ralign",label:"Amount"}},dr_cr:{head_label:"&nbsp;",width:8,ip_options:{type:"inputbox",id:"",label:"",dlgTo:"scope"}}},validation:{date:[{required:true,pattern:"date"},{fn:function(n,m){return m.vald_options&&m.vald_options.is_opening&&parse_date(n)>parse_date(get_cfg("book_start"))},msg:"The date should be before book start date"}],narration:{required:false},amount:{required:true}},after_init:function(m){this.listenTo(this,"all",this.ips_event_handler);this.$el.append('<div class="total_sec">0.00</div>');this.parent=m.parent},get_total:function(){return _.reduce(this.rows,function(m,n){return m+(n.cols.dr_cr.ip.get_value()=="Cr"?-1:1)*Number(n.cols[this.total_col].ip.get_value())},0,this)},update_total:function(){var m;m=this.get_total();this.$el.find(".total_sec").text(to_money(Math.abs(m))+(g.options.hide_drcr?"":(m<0?" Cr":" Dr")))},post_validate:function(o,m,p){var n;n=this.parent.options;if(!p){if(o&&this.isLast(o)){if(n.op_balance!=undefined&&this.get_total()==n.op_balance){this.parent.$el.find(".op_btn_sncl").focus();return false}}}else{if(n.op_balance!=undefined&&this.get_total()!=n.op_balance){app.notifications.add("Error","Mismatch in balances","error");return false}}return true},ips_event_handler:function(s,u,m,q,n){var r,o,p,t;r=u;u=this.rows[u];switch(s){case"row_insert":if(g.options.hide_drcr){u.cols.dr_cr.ip.disable();u.cols.dr_cr.ip.hide(true)}g.center();break;case"keydown":if(m=="dr_cr"){if(_.in_list(q.keyCode,[68,67])){n.comp.set_value(q.keyCode==67?"Cr":"Dr");this.update_total()}if(q.keyCode!=9){q.preventDefault()}}break;case"text_changed":if(m=="amount"){this.update_total()}if(q.keyCode==8){this.backspace_pressed(u,r,m,q);this.update_total()}break;case"row_reset":u.cols.dr_cr.ip.set_value("Dr");break;case"enterkey_press":if(this.focusColumn(u,m,"next",true,{select:true})==false){this.validate_row(u,true,{dr_cr:"Dr"});this.update_total()}break}}});h.merge(app.IPS_ext,true);j=app.IPS.extend({ip_defaults:{class_name:"_md _type2 _nouline _pdlt0"},class_name:"advance_ips",total_col:"amount",schema:{narration:{head_label:"Description",width:80,ip_options:{type:"inputbox",id:"",label:"Description"}},amount:{head_label:"Amount",width:20,ip_options:{type:"inputbox",id:"_ralign",label:"Amount"}}},validation:{narration:{required:true},amount:{required:true}},after_init:function(m){this.listenTo(this,"all",this.ips_event_handler);this.$el.append('<div class="total_sec">0.00</div>');this.vald_form=new app.Form({el:this.$el,validation:this.validation,is_opening:m.is_opening});this.parent=m.parent},get_total:function(){return _.reduce(this.rows,function(m,n){return m+Number(n.cols[this.total_col].ip.get_value()*(n.cols.dr_cr=="Cr"?-1:1))},0,this)},update_total:function(){var m;m=this.get_total();this.$el.find(".total_sec").text(to_money(Math.abs(m))+" "+(m<0?"Cr":"Dr"))},post_validate:function(n,m,o){if(n&&this.isLast(n)){if(this.parent.options.op_balance&&this.get_total()==this.parent.options.op_balance){this.parent.$el.find(".op_btn_sncl").focus();return false}}return true},ips_event_handler:function(s,u,m,q,n){var r,o,p,t;r=u;u=this.rows[u];switch(s){case"text_changed":if(m=="amount"){this.update_total()}if(q.keyCode==8){this.backspace_pressed(u,r,m,q);this.update_total()}break;case"enterkey_press":if(this.focusColumn(u,m,"next",true,{select:true})==false){this.validate_row(u,true);this.update_total()}break}}});j.merge(app.IPS_ext,true);this.adv_ip_sheet=new j({head:"Advance",ips_id:"",appendTo:this.$el.find(".popup_body"),parent:this});this.ip_sheet=new h({head:"References",ips_id:"",appendTo:this.$el.find(".popup_body"),parent:this});this.listenTo(this.form,"all",this.form_ev_handler)}var i;i=this.options;l=this.options.data;this.setMode("idle");this.current_tab=null;this.ip_sheet.release();this.ip_sheet.$el.hide();this.adv_ip_sheet.release();this.adv_ip_sheet.$el.hide();if(this.options.ptype=="advance"){this.adv_ip_sheet.render();this.adv_ip_sheet.$el.show();if(l&&!_.isEmpty(l.ref_items)){this.adv_ip_sheet.set_value_list(l.ref_items)}else{this.adv_ip_sheet.insertRow({dr_cr:"Dr"})}this.adv_ip_sheet.update_total()}else{this.ip_sheet.vald_options={is_opening:i.is_opening};this.ip_sheet.render();this.ip_sheet.$el.show();if(l&&!_.isEmpty(l.ref_items)){this.ip_sheet.set_value_list(l.ref_items)}else{this.ip_sheet.insertRow({dr_cr:"Dr"})}this.ip_sheet.update_total()}},submit_form:function(k){var g,i,j,h;g=this.options;i=this.options.ptype=="advance"?this.adv_ip_sheet:this.ip_sheet;if(!(i.rows.length==1&&_.every(i.get_values(0,null,["dr_cr"]),function(l){return l==""}))&&!i.validate_rows()){return false}if(!i.validate_rows()){}h=i.get_value_list();j=_.reduce(h,function(l,n,m){return l+(Number(n.amount)*(n.dr_cr=="Dr"?1:-1))},0);res=g.callback.call(g.invoker,{ref_items:h,total_amount:j});if(res!=false){this.close()}}}))();app.popups.RefAdj=new (app.Popup.extend({id:"refadj_popup",class_name:"_mw500x",head:"Settlements and References",btn_map:{set:["OK","OK"]},events:{"click .op_btn":"submit_form","click ._tc_settle_btn":"settle_btn_clicked","click ._tc_ref_btn":"ref_btn_clicked"},beforeInit:function(){return true},render:function(k){var n,h,j,g,m,l,i;g=this;i=g.options;m=i.data;if(!k){g.$el.find(".popup_body").append("<div class='tbl_cnt'><div class='tbl_row'><div class='tbl_col _w20em'>Settlements</div><div class='tbl_col _tc_settle _ralign _w10em'><span>0.00</span></div><div class='tbl_col _w2em'><button class='component btn _type1 _sm _tc_settle_btn'>...</button></div></div><div class='tbl_row'><div class='tbl_col _w20em'>New References</div><div class='tbl_col _tc_ref _ralign _w10em'><span>0.00</span></div><div class='tbl_col _w2em'><button class='component btn _type1 _sm _tc_ref_btn'>...</button></div></div><div class='tbl_row'><div class='tbl_col _w20em'>On Account</div><div class='tbl_col _tc_onacc _ralign _w10em'><span>0.00</span></div><div class='tbl_col _w2em'><button class='component btn _type1' style='visibility:hidden' disabled>...</button></div></div><div class='tbl_row'><div class='tbl_col _w20em'><strong>Balance</strong></div><div class='tbl_col _tc_blc _ralign _w10em'><strong><span>0.00</span></strong></div><div class='tbl_col _w2em'></div></div></div>")}this.update_balance();this.setMode("idle");if(m.new_ref_data){l=m.new_ref_data;l.total_amount=_.reduce(l.ref_items,function(o,q,p){return o+(Number(q.amount)*(q.dr_cr=="Dr"?1:-1))},0)}if(m.ref_data){l=m.ref_data;l.total_amount=_.reduce(_.values(l.ref_items),function(o,q,p){return o+(Number(q.amount)*(q.dr_cr))},0);l.dr_cr=l.total_amount>=0?1:-1;l.total_amount=Math.abs(l.total_amount)}this.update_balance();return},get_balance:function(){var j,h,i,g,l,k;h=this;i=h.options;g=i.data.ref_data?i.data.ref_data.total_amount*(-i.data.ref_data.dr_cr):0;l=i.data.new_ref_data?i.data.new_ref_data.total_amount:0;k=i.amount-g-l;return[g,l,k]},update_balance:function(){var j,h,i,g,m,l,k;h=this;i=h.options;k=h.get_balance();g=k[0];m=k[1];l=k[2];h.$el.find("._tc_settle").find("span").text(to_money(Math.abs(g))+(g>=0?" Dr":" Cr"));h.$el.find("._tc_ref").find("span").text(to_money(Math.abs(m))+(m>=0?" Dr":" Cr"));h.$el.find("._tc_onacc").find("span").text(to_money(Math.abs(l))+(l>=0?" Dr":" Cr"));h.$el.find("._tc_blc").find("span").text(to_money(Math.abs(i.amount))+(i.amount>=0?" Dr":" Cr"))},settle_btn_clicked:function(i){var g,j,h;g=this;h=g.options;app.popups.MethodAdjSelPopup.show({method:"read",scope:g,row:h.row,pending_sel:"amount_due",params:h.params,ds_options:{total_drcr:true},ref_type:"against_ref",data:{adj_data:h.data.ref_data},callback:function(k){h.data.ref_data=k;this.update_balance()},account_name:h.acc_name})},ref_btn_clicked:function(i){var h,g;h=this;g=this.options.err_response;app.popups.BillWiseDetails.show({invoker:h,data:h.options.data.new_ref_data,errors:traverse(g,"responseJSON.ref_item_errors"),callback:function(j){h.options.data.new_ref_data=j;this.update_balance()}})},submit_form:function(j){var g,i,h;g=this;h=g.options;if(h.exct_amount){i=g.get_balance();if(i[2]!=0){app.notifications.add("Info","The amount should be equal to the document amount","info");return}h.data.total_amount=i[0]+i[1]}res=h.callback.call(h.invoker,h.data);if(res!=false){this.close()}}}))();var f={default_attr:{class_name:"_type1 _md _mgbt_1em"},fields:{opening_stock:{type:"inputbox",id:"_w15em",label:"Opening Stock"}},validation:{}};var b={balance_date:{head_label:"Date",width:15,index:20,ip_options:{type:"datefield",id:"",label:"Date"}},c_stock:{head_label:"Closing Stock",width:20,index:30,ip_options:{type:"inputbox",id:"_ralign",label:"Closing Stock"}},action:{width:10,index:30,head_label:"Action",ip_options:{type:"button",id:"al_btn",class_name:"_type1 _md _theme1",label:"Delete"}}};app.popups.InventoryPopup=new (app.Popup.extend({id:"inventory_popup",head:"Inventory Details",events:{submit:"submit_form","click .op_btn":"submit_form","click ._ipsheet_add_new_btn":"add_new_clicked","click .al_btn":"delete_clicked"},render:function(k,m){var n,l,i,j,h,g;g=this;if(!k){this.form=new app.Form(_.extend({appendTo:this.$el.find(".popup_body")},f));this.form.renderInputs();this.ip_sheet=new app.IPS({ips_id:"inventory_ipsheet",head:"Closing Stock",ip_defaults:{class_name:"_md _type2"},appendTo:this.$el.find(".popup_body"),insertButton:true,schema:b});this.model=Backbone.Model.extend({urlRoot:"/company/inventory_details/"})}i=this.options;n=i.data;this.setMode("idle");this.form.reset();this.ip_sheet.release();this.ip_sheet.render();h=new this.model;h.fetch({success:function(p,o){var q,r;g.form.set_values(_.pick(o,["opening_stock"]));for(q in o.balances){g.ip_sheet.insertRow(o.balances[q])}},error:function(o,p){app.notifications.add("Error","Error while loading inventory info","error")}})},after_get_values:function(g){g.balances=this.ip_sheet.get_value_list()},add_new_clicked:function(h){var g;this.ip_sheet.insertRow({});this.ip_sheet.scrollToTop();this.ip_sheet.focusRow(this.ip_sheet.getLastRow())},delete_clicked:function(h){var g,i;g=$(h.target);i=g.closest(".table_list > li");this.ip_sheet.deleteRow(i.index())}}))();var e={default_attr:{class_name:"_type1 _md _mgbt_1em"},fields:{acc_en:{type:"checkbox",id:"_w1em _mgrt_1em _mgtp_1em _comp_inline",value:"true",label:""},account_name:{type:"combobox",id:"_comp_inline _w25em",label:"Account Name"},output_format:{type:"selectbox",id:"_w8em",label:"Output Format",default_option:"",options:{html:"HTML",excel:"Excel Sheet"}},from_date:{type:"datefield",name:"from_date",id:"_mgbt_1em _w8em",label:"From Date"},to_date:{type:"datefield",name:"to_date",label:"To Date",id:"_mgbt_1em _w8em"}}};app.popups.AccountReportPopup=new (app.Popup.extend({id:"acc_report_popup",head:function(g){return g&&g.acc_type=="reconcile"?"Reconciliation statement":"Account Report"},events:{submit:"submit_form","click .op_btn":"submit_form"},no_set_mode:true,render:function(j){var i,h,g;if(!j){g=_.extend({},e);g.fields=_.omit(g.fields,["acc_en"]);this.form=new app.Form(_.extend({appendTo:this.$el.find(".popup_body")},g));this.form.renderInputs();this.$el.find(".op_btn.op_btn_snnx").remove();this.$el.find(".op_btn").text("Generate")}this.set_head();i=this.options;h=this.form.components.account_name;if(!i.account_id){if(i.acc_type=="control"){h.url="/accounts/?name={{value}}&is_cntlacc=true&pagination=false&_select_fields=name"}else{if(i.acc_type=="general"){h.url="/accounts/?name={{value}}&is_cntlacc=false&pagination=false&_select_fields=name"}else{if(i.acc_type=="group"){h.url="/account_groups/?name={{value}}&is_cntlacc=false&pagination=false&_select_fields=name"}else{if(i.acc_type=="reconcile"){h.url="/account_groups/?name={{value}}&is_cntlacc=false&pagination=false&_select_fields=name"}}}}h.show()}else{h.hide()}this.form[i.acc_type=="reconcile"?"hide_comps":"show_comps"](["from_date"]);this.form.components.to_date.set_label(i.acc_type=="reconcile"?"as on Date":"To Date");this.form.set_values({account_name:"",from_date:app.appdata.finperiod_start,to_date:app.appdata.finperiod_end});this.form.renderErrors()},submit_form:function(l){var j,k,h,m,i,g;g=this;j=this.options;i=new Backbone.Model;i.url=j.acc_type=="reconcile"?"/reports/bank_reconciliation":"/reports/account/";l.preventDefault();k=this.form;h=k.get_values();m=k.validate();if(j.account_id){h.account_id=j.account_id}h.is_cntlacc=j.acc_type=="control";h.is_group=j.acc_type=="group";h.validate=true;k.renderErrors(m);if(!m){i.fetch({data:$.param(h),success:function(p,n){var q,o;app.notifications.add("Report Generated Successfully","Report Generated","success");o=app.generate_ext_url("/reports",j.acc_type=="reconcile"?"bank_reconciliation":"account",_.pick(n,["from_date","output_format","to_date","is_group","account_id"]));$("#dump_workspace").append($("<a href='"+o+"' target='_blank'>lnk</a>"));$("#dump_workspace").find("a")[0].click();$("#dump_workspace").html("");g.close()},error:function(n,o){k.renderServerErrors(o)}})}}}))();app.popups.OutstandingReportPopup=new (app.Popup.extend({id:"acc_report_popup",head:"Outstading Report",events:{submit:"submit_form","click .op_btn":"submit_form"},no_set_mode:true,render:function(i){var h,g,j;if(!i){j=this.form=new app.Form(_.extend({appendTo:this.$el.find(".popup_body")},e));j.renderInputs();this.listenTo(this.form.components.acc_en,"clicked",function(l,m){var k=j.components.account_name,n=l.get_value();if(n==""){k.set_value("")}k[n==""?"disable":"enable"]()});this.$el.find(".op_btn.op_btn_snnx").remove();this.$el.find(".op_btn").text("Generate")}j=this.form;h=this.options;g=j.components.account_name;g.disable();g.url="/accounts/?name={{value}}&is_cntlacc=false&under_defacc=receivable,payable&pagination=false&_select_fields=name";this.$el.find(".popup_head").text(h.acc_type=="receivable"?"Receivable Reports":"Payable Reports");j.set_values({from_date:app.appdata.finperiod_start,to_date:app.appdata.finperiod_end,account_name:"",acc_en:""});j.renderErrors()},submit_form:function(l){var j,k,h,m,i,g;g=this;i=new Backbone.Model;i.url="/reports/account/";l.preventDefault();j=this.options;k=this.form;h=k.get_values();m=k.validate();h.validate=true;h.acc_type=j.acc_type;h.op="outstanding_report";k.renderErrors(m);if(!m){i.fetch({data:$.param(h),success:function(p,n){var q,o;app.notifications.add("Report Generated Successfully","Report Generated","success");o=app.generate_ext_url("/reports","account",_.pick(n,["from_date","op","output_format","acc_type","to_date","account_id"]));$("#dump_workspace").append($("<a href='"+o+"' target='_blank'>lnk</a>"));$("#dump_workspace").find("a")[0].click();$("#dump_workspace").html("");g.close()},error:function(n,o){k.renderServerErrors(o)}})}}}))();var a={default_attr:{class_name:"_type1 _md"},fields:{name:{type:"inputbox",id:"_mgbt_05em",label:"Group Name"},group_id:{type:"inputbox",id:"_mgbt_05em",label:"Group ID"},_ipsheet_cnt:{tagName:"div",className:"_ipsheet_cnt"},description:{type:"textarea",id:"",label:"Description"}},validation:{name:{required:true}}};var c={name:{head_label:"Name",width:80,index:10,ip_options:{type:"combobox",id:"",label:"Name",url:"/accounts?name={{value}}&pagination=false&is_cntlacc=false&_select_fields=name"}},action:{width:20,index:30,head_label:"Action",ip_options:{type:"button",id:"al_btn",class_name:"_type1 _sm2 _theme1",label:"Delete"}}};app.popups.AccountGroupPopup=new (app.Popup.extend({id:"accountgroup_popup",head:"Account Group",model:app.models.AccountGroup,events:{submit:"submit_form","click .op_btn":"submit_form","click .dept_pop_tab":"tab_clicked","click ._ipsheet_add_new_btn":"add_new_clicked","click .al_btn":"delete_clicked"},beforeInit:function(){return true},onshow:function(g){this.options=g.el.data("trigger_data");this._render()},render:function(g){var h;if(!g){this.form=new app.Form(_.extend({appendTo:this.$el.find(".popup_body")},a));this.form.renderInputs();this.ip_sheet=new app.IPS({ips_id:"alisheet",class_name:"_mgbt_1em",ip_defaults:{class_name:"_md _type2 _nouline"},appendTo:this.$el.find("._ipsheet_cnt"),schema:c,insertButton:true});this.listenTo(this.ip_sheet,"all",this.ip_sheet_handler)}h=this.options.data;this.setMode("idle");this.current_tab=null;this.ip_sheet.release();this.ip_sheet.render();if(h){this.form.set_values(h);this.ip_sheet.set_value_list(h.item_list)}else{this.form.reset()}},validate_last_row:function(){var j,h,k,g;j=this.ip_sheet.rows;if(j.length==0){return{success:"success"}}else{if(j.length>=500){return{error:"Maximum limit of 500 items is exceeded!"}}}if(j.length){k=j.length;g=this.ip_sheet.get_values(j[k-1]);if(g.name==""){return{error:"Error: Incomplete Field!"}}}for(h=0;h<k-1;h++){if(_.isEqual(this.ip_sheet.get_values(j[h]),g)){return{error:"Error : Member is repeated!"}}}return{success:"success"}},after_get_values:function(g){g.item_list=this.ip_sheet.get_value_list()},add_new_clicked:function(i){var h;h=this.validate_last_row();if(h.error){app.notifications.add("List Error",h.error,"error")}else{this.ip_sheet.insertRow({});var g=this.ip_sheet.$el.find(".table_listcnt")[0];g.scrollTop=g.scrollHeight}this.ip_sheet.focusRow(this.ip_sheet.getLastRow())},ip_sheet_handler:function(j,h,i,k,g){var l,m},delete_clicked:function(h){var g,i;g=$(h.target);i=g.closest(".table_list > li");this.ip_sheet.deleteRow(i.index())}}))()});FB_Module.register({index:2},function(){var a={default_attr:{class_name:"_type1 _md"},fields:{_client_det:{tagName:"div",className:"float_left _w40pc",fields:{more_btn:{type:"button",label:"More...",class_name:"_type1 _sm _theme1 float_right _mgrt_2em",attrs:{type:"button"},index:0,dlgTo:"scope"},m_type:{type:"selectbox",id:"_mgbt_05em _w10em",options:[{cust:"Customer"},{vndr:"Supplier"},{subc:"Sub Contractor"}],label:"Type",index:0},cust_type:{type:"selectbox",id:"_mgbt_05em _w10em",default_option:"",options:[{trade:"Trading"},{contr:"Contract"}],label:"Customer Type",index:0},_seperator0:{tagName:"div",index:9,className:"_mgtp_2em"},name:{type:"inputbox",id:"_mgbt_05em _w20em _comp_inline _mgrt_1em",label:"Name",index:10},suffix:{type:"inputbox",id:"_mgbt_05em _w5em _comp_inline",label:"Suffix",index:10},_seperator3:{tagName:"div",index:10.5},alias:{type:"inputbox",id:"_mgbt_1em _w20em _comp_inline _mgrt_1em",label:"Alias",index:11},alias_suffix:{type:"inputbox",id:"_mgbt_05em _w5em _comp_inline",label:"Suffix",index:12},code:{type:"inputbox",id:"_mgbt_05em _w12em",label:"Account Code",index:12.6},_seperator4:{tagName:"div",index:12.5},is_debcred:{type:"hidden_input",value:"true"},is_under:{type:"checkbox",id:"_mgbt_05em _mgtp_14x _mgrt_05em",label:"",value:"true",index:14,dlgTo:"scope"},under_name:{type:"combobox",id:"_mgbt_1em",label:"Under",class_name:"_type1 _md _comp_inline _w20em",url:"/cust_n_vendor/customers/?name={{value}}&is_under=false&pagination=false",index:15},credit_period:{type:"inputbox",id:"_w10em _mgbt_05em",label:"Credit Period (Days)",index:30},block_credit:{type:"checkbox",id:"_mgbt_05em _comp_block _mgtp_14x _mgrt_05em",label:"Block Credit Transactions",value:"true",index:30.5,dlgTo:"scope"},cr_limit_amnt:{type:"inputbox",id:"_w10em _mgbt_05em _comp_inline _mgrt_1em",label:"Credit Limit (Amount)",index:31},cr_limit_days:{type:"inputbox",id:"_w10em _mgbt_05em _comp_inline",label:"Credit Limit (Days)",index:31},_opening_balance:{tagName:"div",className:"_opening_balance_cnt _mgbt_1em _mgtp_1em",index:45,fields:{opening_balance:{type:"inputbox",id:"_w8em _mgrt_05em _comp_inline",label:"Opening Balance"},obalance_drcr:{type:"selectbox",class_name:"_md _type3",id:"_comp_inline _mgtp_14x _mgrt_05em _w4em",options:[{dr:"Dr"},{cr:"Cr"}]},bill_wise_btn:{type:"button",class_name:"_comp_inline _sm _w6em _type1 _theme1 _mgtp_12x",label:"Details",attrs:{type:"button"},dlgTo:"scope"}}},sales_rep_id:{type:"combobox",id:"_w15em",label:"Sales Man",url:"/accounts/?name={{value}}&is_cntlacc=false&under_defacc=market_exec_pybl&_select_fields=id,display_name&pagination=false",label_sel:"display_name",value_sel:"id",new_item_btn:true,dlgTo:"scope"}}},_contact_details:{tagName:"div",className:"float_right _w60pc",fields:{_head:{tagName:"h4",className:"_sechead",innerHTML:"Contact Details",index:0},contact_person:{type:"inputbox",id:"_w20em _mgbt_05em _comp_inline _mgrt_1em",label:"Contact Person",index:31},designation:{type:"inputbox",id:"_w15em _mgbt_05em _comp_inline",label:"Designation",index:32},contact_no:{type:"inputbox",id:"_mgbt_1em _w12em _comp_inline _mgrt_1em",label:"Contact No",index:32.01},contact_email:{type:"inputbox",id:"_mgbt_05em _comp_inline _w20em ",label:"Email",index:32.02},_sep43:{tagName:"div",index:32.02},contact_person_2:{type:"inputbox",id:"_w20em _mgbt_05em _comp_inline _mgrt_1em _break",label:"Contact Person (Secondary)",index:32.2},designation_2:{type:"inputbox",id:"_w15em _mgbt_05em _comp_inline",label:"Designation",index:32.3},contact_no_2:{type:"inputbox",id:"_mgbt_05em _w12em _comp_inline _mgrt_1em",label:"Contact No",index:32.4},contact_email_2:{type:"inputbox",id:"_mgbt_05em _comp_inline _w20em",label:"Email",index:32.5},_head2:{tagName:"h4",className:"_sechead",innerHTML:"Office Contact",index:40},tel:{type:"inputbox",id:"_mgbt_05em _mgrt_1em _comp_inline _w9em",label:"Tel",index:40},fax:{type:"inputbox",id:"_mgbt_05em _mgrt_1em _comp_inline _w9em",label:"Fax",index:40},email:{type:"inputbox",id:"_mgbt_05em _comp_inline _w15em _mgrt_1em",label:"Email",index:40},_head3:{tagName:"h4",className:"_sechead",innerHTML:"Address",index:40},address_area:{type:"inputbox",id:"_mgbt_05em _comp_inline _w15em _mgrt_1em",label:"Area Name",index:40},address_street:{type:"inputbox",id:"_mgbt_05em _comp_inline _w15em _mgrt_1em",label:"Street Name",index:40},address_building:{type:"inputbox",id:"_mgbt_05em _comp_inline _w15em _mgrt_1em",label:"Building",index:40},address_floor:{type:"inputbox",id:"_mgbt_05em _comp_inline _w15em _mgrt_1em",label:"Floor",index:40},address_office:{type:"inputbox",id:"_mgbt_05em _comp_inline _w15em _mgrt_1em",label:"Office",index:40},address_additional:{type:"inputbox",id:"_mgbt_05em _comp_inline _w15em _mgrt_1em",label:"Additional Directions",index:40},address_line1:{type:"inputbox",id:"_mgbt_05em _comp_inline _w30em _mgrt_1em",label:"Address Line 1",index:40},address_line2:{type:"inputbox",id:"_mgbt_05em _comp_inline _w30em _mgrt_1em",label:"Address Line 2",index:40},address_line3:{type:"inputbox",id:"_mgbt_05em _comp_inline _w30em _mgrt_1em",label:"Address Line 3",index:40}}},_clearfix:{tagName:"div",className:"clearfix"},print_btn:{type:"button",id:"float_left _theme1 _w6em",label:"Print",index:100,dlgTo:"scope"}},validation:{m_type:{required:true},name:{required:true},email:{required:false,pattern:"email"}}};app.popups.CustVendPopup=new (app.Popup.extend({id:"newcustvend_popup",class_name:"_mw1200x",head:"Customer/Supplier",events:{submit:"submit_form","click .op_btn":"submit_form"},show_save_n_next:true,fill_values:function(){var b=this,d,e,f;d=b.form.components;e=b.options.data=$.extend(true,{},b.options.data);b.form[e.m_type?"hide_comps":"show_comps"](["m_type"]);b.form.hide_comps(["suffix","alias","alias_suffix"]);d.cust_type[e.m_type=="cust"&&get_cfg("working_mode")=="trcnt"?"show":"hide"]();b.form.hide_comps(get_cfg("en_alt_address")=="true"?["address_area","address_street","address_building","address_floor","address_office","address_additional"]:["address_line1","address_line2","address_line3"]);if(e.m_type=="cust"&&b.options.method=="create"){d.under_name.disable()}else{d.is_under.set_value(e.under_name!=null)}b.clear_extra_fields();switch(b.options.method){case"create":b.form.reset();d.credit_period.show();d.under_name.disable();if(e){b.form.set_values(_.extend({obalance_drcr:"dr"},e))}setTimeout(function(){d.name.focus()},60);break;case"update":b.form.reset();d.credit_period.show();if(e&&e.name){var c;f={cust:"Customer",vndr:"Vendor",subc:"SubContr"};c=new app.models[f[b.options.data.m_type]]({id:b.options.id});c.fetch({success:function(h,g){e.ref_data={ref_items:g.ref_items};_.each(e.ref_data.ref_items,function(i){i.dr_cr=i.dr_cr==1?"Dr":"Cr";i.amount=i.amount})},error:function(){}});e.obalance_drcr=e.opening_balance<0?"cr":"dr";e.opening_balance=Math.abs(e.opening_balance);if(e.sales_rep_id){e.sales_rep_id=[e.sales_rep_id,e.sales_rep_name]}b.form.set_values(e);d.under_name[e.under_name&&e.under_name!=""?"enable":"disable"]()}else{var c;f={cust:"Customer",vndr:"Vendor",subc:"SubContr"};c=new app.models[f[b.options.m_type]]({id:b.options.id});b.form.disable();b.toogleButton(false);c.fetch({success:function(h,g){b.form.enable();_.extend(e,g);if(e.sales_rep_id){e.sales_rep_id=[e.sales_rep_id,e.sales_rep_name]}e.ref_data={ref_items:g.ref_items};e.obalance_drcr=g.opening_balance<0?"cr":"dr";e.opening_balance=Math.abs(g.opening_balance);_.each(e.ref_data.ref_items,function(i){i.dr_cr=i.dr_cr==1?"Dr":"Cr";i.amount=i.amount});b.toogleButton(true);b.form.set_values(e)},error:function(){}})}break}},render:function(e){var c,f,b,d;c=this;d=c.options;map={cust:"Customer",vndr:"Vendor",subc:"SubContr"};if(!e){_.extend(a.fields,app.globals.customer_vendor_form_ext);f=c.form=new app.Form(_.extend({appendTo:c.$el.find(".popup_body"),order_items:true},a));f.fields.print_btn.append_to=c.$el.find(".popup_footer");f.renderInputs();c.listenTo(f,"all",c.form_ev_handler)}b={subc:"Sub Contractor",cust:"Customer",vndr:"Supplier"};c.head=b[d.data.m_type];c.err_response=null;c.setMode("idle");c.fill_values()},clear_extra_fields:function(){var b;for(b in this.form.components){if(b.indexOf("size_cr_")!=-1){this.form.components[b].release();delete this.form.components[b]}}},form_ev_handler:function(l,j,k){var d,c,g,f,b,h,m;m=this;h=m.form.components;switch(l){case"clicked":if(j.name=="is_under"){d=h.under_name;d[j.get_value()=="true"?"enable":"disable"]();if(j.get_value()!="true"){d.set_value("")}}if(j.name=="bill_wise_btn"){d=h.opening_balance;c=d.get_value();if(c==""||isNaN(c)){d.render_error(c==""?"This field is required":"Invalid Value");return}b=m.err_response;app.popups.BillWiseDetails.show({invoker:m,data:m.options.data.ref_data,errors:traverse(b,"responseJSON.ref_item_errors"),is_opening:true,callback:function(e){this.options.data.ref_data=e;d.set_value(Math.abs(e.total_amount));h.obalance_drcr.set_value(e.total_amount>=0?"dr":"cr")}})}else{if(j.name=="more_btn"){d=j.get_value();m.form[j.get_value()==true?"hide_comps":"show_comps"](["suffix","alias","alias_suffix"]);j.set_label(d?"More...":"Less...");j.set_value(!d)}else{if(j.name=="print_btn"){m.print_data()}}}break;case"add_new_clicked":case"det_btn_clicked":if(j.name=="sales_rep_id"){app.popups.AccountPopup.show({method:"create",is_cntlacc:false,hide_cont_btn:true,disable_subacc:true,data:{name:j.get_value(true),subacc_of_defacc:"market_exec_pybl",is_cntlacc:false},invoker:this,hide_cont_btn:true,callback:function(i,e){j.set_value([e.id,e.name+e.suffix]);j.data={items:[{id:e.id,name:e.name+e.suffix,c_balance:0}]};setTimeout(function(){params.comp.focus()},800)}})}break}},print_data:function(e){var d,c,b;b=this;c=b.options;data=c.data;if(data.m_type=="cust"){d=new app.models.Customer({id:c.id})}else{d=new app.models.Vendor({id:c.id})}d.set({id:c.id});d.fetch({data:$.param({op:"print_preview"}),success:function(g,f){app.utils.print_content(f.print_html)},error:function(f,g){app.notifications.add("Print Failed","Unable to print Voucher","error")}})},submit_form:function(i){var g,c,j,b,h,f,d;g=this.form;c=g.get_values();j=g.validate();b=this;d=this.options;g.renderErrors(j);if(j){return}c.ref_data=this.options.data.ref_data;h={cust:"Customer",vndr:"Vendor",subc:"SubContr"};f=new app.models[h[c.m_type]];if(d.method=="update"){f.set("id",d.id)}f.set(c);b.setMode("working");Backbone.sync(d.method=="create"?"create":"update",f,{success:function(e){if(d.callback){d.callback.call(d.invoker,"save_success",c)}b.err_response=null;d.invoker.trigger("popup_event",d.method=="create"?"save_success":"update_success",e,"custvend");app.notifications.add(e.head,e.msg,"success");b.setMode("idle");if(d.method=="update"||d.hide_cont_btn||(i.type=="click"&&$(i.target).hasClass("op_btn_sncl"))){b.close()}else{b.fill_values();b.form.components.name.focus()}},error:function(e){var k;k=get_errors(e);if(k.__all__){app.notifications.add("Error",k.__all__,"error");delete k.__all__}g.renderServerErrors(e);b.setMode("idle");b.err_response=e}})}}))()});(function(){var a,c,d,b,e;a={product_code:{head_label:"Product Code",style:"width:20%",width:70,index:0},name:{head_label:"Product Name",style:"width:30%",width:200,index:0},unit_name:{head_label:"Unit",style:"width:10%",width:70,index:0},rate:{head_label:"Rate",style:"width:20%",width:70,index:0},tax:{head_label:"Tax",style:"width:20%",width:60}};c={product_code:{type:"inputbox",label:"Product Code",class_name:"_type2 _lg"},name:{type:"inputbox",label:"Product Name",class_name:"_type2 _lg"},category_name:{type:"inputbox",label:"Category",class_name:"_type2 _lg"},manufacturer_name:{type:"inputbox",label:"Manufacturer",class_name:"_type2 _lg"}};app.globals.inputsheet_schema={product_code:{head_label:"Product Code",style:"width:15%",width:90,index:10,ip_options:{type:"inputbox",label:"Product Code"}},name:{head_label:"Product Name",style:"width:25%",width:200,index:20,ip_options:{type:"inputbox",label:"Product Name"}},unit_name:{head_label:"Unit",style:"width:10%",width:70,index:25,ip_options:{type:"selectbox",class_name:"_type3 _lg",default_option:"",id:"naf_type",label:"Unit",dlgTo:"scope"}},quantity:{head_label:"Quantity",style:"width:20%",width:70,index:27,ip_options:{type:"inputbox",label:"Quantity"}},purchase_rate:{head_label:"Purchase Rate",style:"width:20%",width:100,index:30,ip_options:{type:"inputbox",label:"Purchase Rate"}},sale_rate:{head_label:"Sale Rate",style:"width:15%",width:100,index:40,ip_options:{type:"inputbox",label:"Sale Rate"}},tax:{head_label:"Tax",style:"width:15%",width:60,index:60,ip_options:{type:"inputbox",label:"Tax"}},price:{head_label:"Price",style:"width:15%",width:100,index:90,ip_options:{type:"inputbox",label:"Price",class_name:"_lg _type2",disabled:true}}};app.globals.ip_sheet_validation={product_code:{required:true},name:{required:true},rate:[{required:true},{greater_than:0,msg:"Cant be zero"}],quantity:[{required:true,type:"number"},{greater_than:0,msg:"Cant be zero"}]};app.popup_views.transactionPopup=Backbone.View.extend({is_base_inited:false,el:$("#base_popup"),init:function(g){var f=this.__proto__.__proto__;if(f.is_base_inited){return}f.form=new app.Form({el:this.$el.find("form")});f.vald_form=new app.Form({el:this.$el.find(".bspp__ipsheet")});f.ip_sheet=new app.IPS({el:this.$el.find(".bspp__ipsheet"),ips_id:"isheet1"});this.$el.on("keydown","input,select,button,textarea",function(h){if(h.keyCode==9&&$(h.target).hasClass("_last_item")){h.preventDefault();f.form.components.date.focus()}});this.$el.on("click",".submit_btn",function(h){f.save_click(h)});this.$el.on("click",".new_custvend_popup",function(h){f.inst.new_custvend_popup(h)});this.$el.on("click",".popup_close_btn",function(h){f.inst.hide(h)});f.listenTo(this.ip_sheet,"all",f.ipsheet_event);f.is_base_inited=true;this.$el.find(".price_unit_prefix").text(app.appdata.currency_symbol);this.$el.find(".price_unit_suffix").hide()},release:function(){if(this.form){this.form.release()}if(this.ip_sheet){this.ip_sheet.release()}},save_click:function(j){var g=this.inst,k,l,f,h;k=this.form.get_values();l=this.form.validate();this.form.renderErrors(l);if(l){g.form.components[Object.keys(l)[0]].focus();return}f=this.ip_sheet.get_value_list();for(i=f.length-1;i>=0;i--){if(f[i]["name"]==""){f.splice(i)}}k.product_list=f;h=new g.model(k);if(g.trigger_data.method=="edit"){h.set({id:g.trigger_data.id})}Backbone.sync(g.trigger_data.method=="edit"?"update":"create",h,{success:function(m){g.items_saved(j,m);if($(j.target).data("type")=="save"){g.hide()}else{g.ip_sheet.release();g.ip_sheet.render();g.ip_sheet.insertRow({});var n=new Date();g.form.set_values({date:n.getDate()+"/"+(n.getMonth()+1)+"/"+n.getFullYear()});g.form.components.date.focus()}},error:function(p){var q,m,n,o;if(p.responseJSON){q=p.responseJSON.errors;if(q.form_errors){g.form.renderServerErrors(p,q.form_errors);n=g.form.components[Object.keys(q.form_errors)[0]]}if(q.product_errors){for(m in q.product_errors){o=q.product_errors[m];g.vald_form.components=g.ip_sheet.get_components(Number(m));g.vald_form.renderServerErrors(p,o);if(!n){n=g.vald_form.components[Object.keys(o)[0]]}}}if(n){n.focus()}}else{app.notifications.add("Error","Error while Purchase bieng added to the books","error")}}})},show_popup:function(){var f=this.__proto__.__proto__,g,h;f.inst=this;g=new Date();h=this.$el;this.form.set_values({date:g.getDate()+"/"+(g.getMonth()+1)+"/"+g.getFullYear()});this.$el.find(".price_amount").text("0.00");h.find(".popup_head").text(this.title);h.show();this.form.components.date.focus();setTimeout(function(){h.addClass("mfp-ready")},10)},hide:function(){this.$el.removeClass("mfp-ready");this.$el.addClass("mfp-removing");var f=this.$el;setTimeout(function(){f.hide();f.removeClass("mfp-removing")},500)},update_total:function(f){var k=this.ip_sheet.rows,m,j=0,h,l=0,g;for(m in k){j+=Number(k[m].cols.price.ip.get_value());h=Number(k[m].data.sale_rate)-(Number(k[m].data.purchase_rate)+Number(k[m].data.tax));h=wacky_round(Number(k[m].cols.quantity.ip.get_value())*((70*h)/(100*80)),2);l+=h}g="";if(f.show_price!=false){g+="<div>Total Price : <span class='price'>"+j+"</span></div>"}if(f.show_points==true){g+="<div class='point_cnt'><br>Total Points : <span class='points'>"+l+"</span><div>"}this.$el.find(".bspp_price_box").html(g)},new_custvend_popup:function(j){var h=$(j.target),g,f=this.inst;values={};if(h.hasClass("customer")){g=f.form.components.customer_name;values.m_type="customer"}else{if(h.hasClass("vendor")){g=f.form.components.vendor_name;values.m_type="vendor"}else{g=f.form.components.client_name}}values.is_debcred=f.form.components.payment_method.get_value()=="credit"?"true":"";app.popups.CustVendPopup.show({invoker:f,popup_type:"create",data:values,callback:function(k){$.magnificPopup.close();g.set_value(k.name);g.focus()}})},fill_row_fields:function(l,f){var g,k,h;for(var j in f){if(j=="product_code"||j=="name"){l.cols[j].ip.set_value(f[j])}else{if(j=="units"){g=f[j];k={},units_by_id={};for(h in g){k[g[h]["id"]]=g[h]["unit_name"];units_by_id[g[h]["id"]]=g[h]}l.cols.unit_name.ip.set_options(k);l.cols.unit_name.units_data=units_by_id}}}},set_mode:function(f){if(f=="update"){this.$el.find(".submit_btn.save_n_close").text("Update");this.$el.find(".submit_btn.save_n_continue").hide()}else{if(f=="create"){this.$el.find(".submit_btn.save_n_close").text("Save");this.$el.find(".submit_btn.save_n_continue").show()}}},show_custvend_sel:function(f){app.popups.CustVendSelect.show({values:{name:f.component.get_value()},column:"name",client_type:f.client_type,is_debcred:f.is_debcred,callback:function(g){$.magnificPopup.instance.close();if(g){f.component.set_value(g.name);f.component.focus()}},context:self})},ipsheet_event:function(m,o,h,l){var n=this.inst,o=n.ip_sheet.rows[o],f,j,k,g;switch(m){case"changed":for(j in n.fill_rates){g=n.fill_rates[j];k=o.cols[h].ip.get_value();if(k!=""){o.cols[g].ip.set_value(o.cols[h].units_data[Number(k)][g])}else{o.cols[g].ip.set_value("0")}}break;case"text_changed":if(h=="product_code"||h=="name"){if(o.cols[h].ip.get_value()==""&&l.keyCode==8){if(o.dclick_flag==true){if(n.ip_sheet.rows.length>1){n.ip_sheet.deleteRow(o)}}else{for(f in o.cols){o.cols[f].ip.set_value("")}o.dclick_flag=true;setTimeout(function(){o.dclick_flag=false},200)}}}break;case"tabkey_press":if(h==n.ip_sheet.lastCol()){if(!n.validate_row(o,false)){l.preventDefault()}}break;case"enterkey_press":if(h=="product_code"||h=="name"){values={};values.name=o.cols.name.ip.get_value();values.product_code=o.cols.product_code.ip.get_value();app.popups.ProductSelectPopup.show({values:values,column:h,callback:function(q){var p;$.magnificPopup.instance.close();if(q){o.data=q;n.fill_row_fields(o,_.pick(q,n.fill_fields));o.cols[n.ip_sheet.nextCol("name")].ip.input_el.focus()}else{for(p in o.cols){o.cols[p].ip.set_value("")}o.cols.product_code.ip.input_el.focus()}},context:n})}else{if(h==n.ip_sheet.lastCol()){n.validate_row(o,true)}else{if(n.ip_sheet.focusColumn(o,h,"next",true)==false){n.validate_row(o,true)}}}break}this.inst.ip_sheet_event_handler(m,o,h,l);return},validate_row:function(j,g){var l=this.ip_sheet.get_components(j),f=this,h;this.vald_form.components=l;var k=this.vald_form.validate();this.vald_form.renderErrors(k);if(k){this.ip_sheet.focusColumn(j,Object.keys(k)[0]);return false}if(this.ip_sheet.isLast(j)&&g){h=this.ip_sheet.insertRow({})}else{h=this.ip_sheet.nextRow(j)}setTimeout(function(){f.ip_sheet.focusRow(h)},20);return true}});app.popup_views.ItemSelectPopup=Backbone.View.extend({events:{keyup:"keypress_handler",click:"click_handler"},render:function(f){if(this.beforeRender){this.beforeRender(f)}if(!this.is_rendered){this.ds=new app.DS({el:this.$el.find(".ds"),schema:this.ds_schema,ds_id:"ds_"+this.popup_id,rows:[]});this.ds.render();this.listenTo(this.ds,"li_clicked",this.li_clicked);this.form=new app.Form({fields:this.formfields,el:this.$el.find(".form_cnt")});this.form.renderInputs();this.is_rendered=true}this.form.set_values(f.values);this.form.focus(f.column);this.load_items()},show:function(g){var f=this;this.callback=g.callback;this.context=g.context;f.is_input_active=false;setTimeout(function(){f.is_input_active=true},200);$.magnificPopup.open({items:{src:this.dom_selector},type:"inline",callbacks:{beforeOpen:function(){this.st.mainClass="mfp-3d-unfold"}}});this.render(g)},load_items:function(){var g=this.form.get_values(),j,f=this,h;for(j in g){if(g[j]==""){delete g[j]}}if(this.context.popup_type=="sale_popup"){g.calc_tax=true}g.pagination=false;g.limit=5;h=new this.model;h.fetch({data:$.param(_.extend({},this.default_params,g)),success:function(l,k){f.ds.rows=k.items;f.ds.render();f.ds.$el.find(".tl_li:first").addClass("selected")},error:function(k,l){alert("Error Loading product")}})},submit:function(){var g,f,h;g=this.ds.$el.find(".tl_li.selected");f=g.data("id");h=this.ds.get_row(f);this.callback.call(this.context,h)},click_handler:function(g){var f=$(g.target);if(f.is(".ok_btn")){this.submit()}else{if(f.closest(".component.inputbox").length==0&&f.closest(".table_list").length==0){this.form.focus(Object.keys(this.form.components)[0])}}},li_clicked:function(f){var g=this.ds.get_row(f);this.callback.call(this.context,g)},keypress_handler:function(j){if(j.keyCode==13&&this.is_input_active){this.submit()}else{if(j.keyCode==40||j.keyCode==38){var h,g,f;h={40:"next",38:"prev"};g=h[j.keyCode];f=this.ds.$el.find(".tl_li.selected");if(f[g]().length){f.removeClass("selected")[g]().addClass("selected")}}else{this.load_items()}}}});app.popups.ProductSelectPopup=new (app.popup_views.ItemSelectPopup.extend({ds_schema:a,popup_id:"prodsel",default_params:{},model:app.models.InvItem,formfields:c,dom_selector:"#product_select_popup",el:$("#product_select_popup")}));b={name:{head_label:"Name",style:"width:30%",index:0},email:{head_label:"Email",style:"width:20%",index:1},address:{head_label:"Address",style:"width:30%",index:2},phone:{head_label:"Phone Number",style:"width:20%",index:4}};e={name:{type:"inputbox",label:"Name",class_name:"_type2 _lg"},phone:{type:"inputbox",label:"Phone",class_name:"_type2 _lg"}};app.popups.CustVendSelect=new (app.popup_views.ItemSelectPopup.extend({ds_schema:b,popup_id:"cusvensel",default_params:{is_debcred:"true"},formfields:e,dom_selector:"#custvend_select_popup",el:$("#custvend_select_popup"),beforeRender:function(f){this.default_params.is_debcred=f.is_debcred;this.model=f.client_type=="customer"?app.models.Customer:app.models.Vendor}}))})();FB_Module.register({index:2},function(){var c,b,e,a,d;c={fields:{name:{head_label:"Name",width:"20%"},code:{head_label:"Account Code",width:"8%"},under_name:{head_label:"Under",width:"12%",url:"/cust_n_vendor/customers/?name={{value}}&m_type=cust&pagination=false"},email:{head_label:"Email",width:"10%"},contact_person:{head_label:"Contact Person",width:"10%"},contact_no:{head_label:"Contact Number",width:"10%"},address:{head_label:"Address",width:"20%"},remarks:{head_label:"Remarks",width:"10%"},sales_rep_id:{head_label:"Sales Man",width:"10%",url:"/accounts/?name={{value}}&is_cntlacc=false&under_defacc=market_exec_pybl&_select_fields=id,display_name&pagination=false",label_sel:"display_name",value_sel:"id"}},show_items:["name","code","under_name","email","contact_person","contact_no","address","remarks"],filter_enable:["name","code","under_name","email","contact_person","contact_no","address","sales_rep_id"]};b={fields:{name:{head_label:"Name",width:"20%"},code:{head_label:"Account Code",width:"9%"},email:{head_label:"Email",width:"12%"},contact_person:{head_label:"Contact Person",width:"12%"},contact_no:{head_label:"Contact Number",width:"12%"},address:{head_label:"Address",width:"20%"},remarks:{head_label:"Remarks",width:"15%"},sales_rep_id:{head_label:"Sales Man",width:"10%",url:"/accounts/?name={{value}}&is_cntlacc=false&under_defacc=market_exec_pybl&_select_fields=id,display_name&pagination=false",label_sel:"display_name",value_sel:"id"}},show_items:["name","code","email","contact_person","contact_no","address","remarks"],filter_enable:["name","code","email","contact_person","contact_no","address","sales_rep_id"]};set_objs({customer_schema:c,vendor_schema:b});d={before_init:function(){var f;this.context_menu_items=f=_.clone(this.context_menu_items);if(get_cfg("en_association")){f.splice(1,0,{key:"associate",value:"Associations"})}swap_obj_keys(this,"_context_item_click","context_item_click")},initComponents:function(){var f=this;this.init();this.ds.before_render=this.ds_before_render;this.listenTo(this.$scope,"top_btn_click",this.top_btn_clicked)},top_btn_clicked:function(f){if(f[0]==this.$top_sec_el.find(".btn")[0]){this.show_popup()}},_context_item_click:function(h,f){var g;g=this;if(f=="associate"){app.popups.ASC.show({id:h,itype:"cust_vend"})}return g._context_item_click(h,f)},ds_before_render:function(h,g){var l,k,m,j,f,n;for(l=0;l<g.items.length;l++){m=g.items[l];f=[];n={Tel:m.tel,Fax:m.fax,Mobile:m.contact_no};for(k in n){if(n[k]!=""&&n!=undefined){f.push(k+" : "+n[k])}}m.phone=f.join(", ")}},ds_handler:function(f,j,g,h){var k;if(f=="rendered"){k=g.$el.find(".table_list > li");for(i in g.rows){}}else{return this._ds_handler(f,j,g,h)}},search_item:function(f){this.ds.load({params:f})},onshow:function(){if(!this.is_inited){this.initComponents();this.is_inited=true}this.$top_sec_el.show();this.ds.load()}};e=app.Tab.extend({label:"Customers",tab_id:"customers",model:app.models.Customer,is_tab_view:true,heading:"Customer",ds_options:{ds_id:"ds_customers",flex_schema:c,class_name:"ds_custvend ds_within_tab",enable_sorting:true,has_filter:true,default_params:{pending:true,get_ref_data:true,sort_by:"name"}},popup:app.popups.CustVendPopup,popup_options:{data:{m_type:"cust",is_debcred:"true"}}});e.merge(app.ListPageTemplate);e.merge(d);a=app.Tab.extend({label:"Suppliers",tab_id:"suppliers",model:app.models.Vendor,is_tab_view:true,heading:"Supplier",ds_options:{ds_id:"ds_suppliers",flex_schema:b,class_name:"ds_custvend ds_within_tab",has_filter:true,enable_sorting:true,default_params:{pending:true,get_ref_data:true,sort_by:"name"}},popup:app.popups.CustVendPopup,popup_options:{data:{m_type:"vndr",is_debcred:"true"}}});a.merge(app.ListPageTemplate);a.merge(d);app.p_views.Customers_n_Vendors=app.PageTemplate.extend({page_name:"customers_n_suppliers",header_btns:["print","export"],heading_plural:"Customers & Suppliers",events:{"click .new_item_btn":"show_popup"},initialize:function(){this.pre_init()},after_init:function(){if(!AL.any_access(["customers","suppliers"])){return}this.tabs=new app.Tabs({appendTo:this.$el,$scope:this});this.tabs.append([AL.any_access("customers")?new e():null,AL.any_access("suppliers")?new a():null]);this.search_box=new app.components.InputBox({options:{id:"top_right_srchbx",label:"Name",defaults:{class_name:"_type2 _lg"}},scope:this});this.$el.find(".float-right").append(this.search_box.$el);this.listenTo(this.search_box,"keydown",this.search_box_keydown);this.listenTo(this.tabs,"tab_show",this.tab_show)},search_box_keydown:function(f,g){if(g.keyCode==13){this.tabs.tabs[this.tabs.current_tab].search_item({name:f.get_value()})}},on_preshow:function(f,g){if(!this.is_inited){this.init({create_el:true});this.after_init()}},print_data:function(){var g,j,h,f;f=this;h=f.tabs.tabs[f.tabs.current_tab].ds;g=app.generate_ext_url("cust_n_vendor",f.tabs.current_tab,_.extend({op:"print_preview"},h.default_params,h.options.params));window.open(g,"_blank").addEventListener("load",function(){this.focus();this.print()},false)},export_data:function(){var g,f;f=this;g=f.tabs.tabs[f.tabs.current_tab].ds;$("#myiframwe").attr("src",app.generate_ext_url("cust_n_vendor",f.tabs.current_tab,_.extend({op:"export_to_excel"},g.default_params,g.options.params)))},onshow:function(f,g){if(!f){f="customers"}this.tabs.show_tab(f,{do_replace:true,args:g})},tab_show:function(f,g){this.$el.find(".top_buttons").hide();app.router.navigate(app.generate_url("customers_n_suppliers",f,g.args),{trigger:false,replace:g.do_replace})}});FB_Module.init_fn(function(){app.SideMenu.add_item({view:"customers_n_suppliers",item_id:"customers_n_suppliers",label:"Customers & Suppliers",index:2,is_disabled:!AL.any_access(["customers","suppliers"])})})});FB_Module.register({index:2},function(){var a,c,e,b,d,f,g;a={default_attr:{class_name:"_type1 _sm2 _comp_inline _mgrt_05em"},fields:{layout:{type:"selectbox",id:"_w8em",options:{t:"T Layout",vertical:"Vertical"},default_option:app.appdata.default_blsheet_display,label:"Layout"},display_type:{type:"selectbox",id:"_w8em",options:{condonsed:"Condonsed",detailed:"Detailed"},default_option:"condonsed",label:"Display Type"},to_date:{type:"datefield",name:"to_date",id:"_mgrt_05em _w7em",label:"To Date"},_submit_btn:{tagName:"button",className:"component _sm2 btn _type1 _theme1 _mgtp_9x",innerHTML:"Submit",attrs:{type:"submit"}}},validation:{}};c={default_attr:{class_name:"_type1 _sm2 _comp_inline _mgrt_05em"},fields:{layout:{type:"selectbox",id:"_w8em",options:{t:"T Layout",vertical:"Vertical"},dlgTo:"scope",default_option:app.appdata.default_prloss_display,label:"Layout"},display_type:{type:"selectbox",id:"_w8em",options:{condonsed:"Condonsed",detailed:"Detailed"},default_option:"condonsed",label:"Display Type"},cmpr:{type:"selectbox",id:"_w10em",label:"Comparison Type",dlgTo:"scope",options:{no_comp:"No comparison",split:"Split Period",prev_yr:"Prev Years"}},cmpr_split_period:{type:"selectbox",id:"_w10em",label:"Comparison Period",options:{months:"Monthly",quarters:"Quarterly",years:"Yearly"}},from_date:{type:"datefield",id:"_w7em prlsform_frdate",label:"From Date"},to_date:{type:"datefield",id:"_w7em prlsform_todate",label:"To Date"},_submit_btn:{tagName:"button",className:"component btn _sm2 _type1 _theme1 _mgtp_9x",innerHTML:"Submit",attrs:{type:"submit"}}},validation:{}};e={bls_t:"balance_sheet_template",bls_v:"balance_sheet_vtemplate",prl_t:"prloss_template",prl_v:"prloss_vtemplate",innr_t:"report_template1",innr_v:"report_vtemplate2"};_.each(e,function(i,h){e[h]=_.template($("#"+i).html())});b={gl_ev_handler:function(s,p){var l,j,r,v,t,q,o,n,m,h,k,u;v=this;if(s=="keydown"){u=v.layout=="t"?".rpview_li":".rpview_li_v";l=this.$el.find(u+".selected");if(v.layout=="vertical"){j=l.find(".rpview_bl.selected")}switch(p.keyCode){case 38:case 40:p.preventDefault();if(l.length==0){l=this.$el.find(u).first();l.addClass("selected")}else{l.removeClass("selected");if(v.layout=="t"){k=this.$el.find(l.closest(".rpview_left,.rpview_right").hasClass("rpview_left")?".rpview_left":".rpview_right").find(".rpview_li")}else{j.removeClass("selected");k=l.closest(".rpview_li_list").find(u)}n=k.index(l);if(p.keyCode==40){r=(n==k.length-1?k.eq(n):k.eq(n+1))}else{r=(n==0?k.eq(n):k.eq(n-1))}r.addClass("selected");m=r.offset().top;h=-1;if(p.keyCode==40&&m+r.height()+20>$(window).height()+$(document).scrollTop()){h=m+r.height()+20-$(window).height()}else{if(p.keyCode==38&&m<50+$(document).scrollTop()){h=m-50}}if(h!=-1){$(document).scrollTop(h)}if(v.layout=="vertical"){r.find(".rpview_bl").eq(j.length>0?j.index():0).addClass("selected")}}break;case 37:case 39:if(l.length>0){if(v.layout=="t"){t=l.closest(".rpview_left,.rpview_right");l.removeClass("selected");q=t.hasClass("rpview_left");o=l.index();r=t[q?"next":"prev"]().find(".rpview_li");r=o>r.length-1?r.last():r.eq(o);r.addClass("selected")}else{r=j.closest(".rpview_li_v").find(".rpview_bl");o=j.index()+(p.keyCode==37?-1:1);o=o<0?r.length-1:(o>r.length-1?0:o);l.find(".rpview_bl").eq(o).addClass("selected");j.removeClass("selected")}}break;case 13:if(l.length>0){this.li_item_clicked(null,l.find(".rpview_li_innr"))}}}},li_item_selected:function(h){if(this.layout=="vertical"){el=$(h.target).closest(".rpview_bl");this.$el.find(".rpview_li_v.selected").removeClass("selected").find(".rpview_bl.selected").removeClass("selected");el.addClass("selected").closest(".rpview_li_v").addClass("selected")}else{el=$(h.target).closest(".rpview_li");this.$el.find(".rpview_li.selected").removeClass("selected");el.addClass("selected")}}};f=app.Tab.extend(_.extend({label:"Balance Sheet",tab_id:"balance_sheet",events:{"click .rpview_li_innr":"li_item_selected","dblclick .rpview_li_innr":"li_item_clicked","click .rpview_bl":"li_item_selected","dblclick .rpview_bl":"li_item_clicked"},afterAppend:function(){var h=this;h.form=new app.Form(_.extend({appendTo:h.$scope.$el.find(".float-right"),class_name:"blsheet_filter"},a));h.url_params={};h.listenTo(h.form,"form_submit",h.form_submitted);el=$('<div class="balance_sheet_cnt component"></div>');el.data("backbone_view",h);h.$el.append(el)},print_data:function(){var h;h=this;app.popups.PrintExportOptions.show({method:"set",invoker:h,callback:function(j){var i;i=app.generate_ext_url("reports","balance_sheet",_.extend({op:"print_preview"},h.form.get_values(),j));window.open(i,"_blank").addEventListener("load",function(){this.focus();this.print()},false)}})},export_data:function(){var h=this.form.get_values(true);$("#myiframwe").attr("src",app.generate_ext_url("reports","balance_sheet",_.extend({op:"export_to_excel"},h,{layout:"vertical"})))},form_submitted:function(){var h=this.form.get_values();this.load_data(h)},gl_ev_handler:function(m,n){var h,o,k,j,l;if(m=="keypress"){h=this.$el.find(".rpview_li.selected");switch(n.keyCode){case 38:case 40:if(h.length==0){h=this.$el.find(".rpview_li").first();h.addClass("selected")}else{h.removeClass("selected");if(n.keyCode==40){o=h.is(":last-child")?h.parent().children().first():h.next()}else{o=h.is(":first-child")?h.parent().children().last():h.prev()}o.addClass("selected")}break;case 37:case 39:if(h.length>0){k=h.closest(".rpview_left,.rpview_right");h.removeClass("selected");j=k.hasClass("rpview_left");l=h.index();o=k[j?"next":"prev"]().find(".rpview_li");o=l>o.length-1?o.last():o.eq(l);o.addClass("selected")}break;case 13:if(h.length>0){this.li_item_clicked(null,h.find(".rpview_li_innr"))}}}},li_item_selected:function(k){var j,i,h;h=this;if(this.layout=="vertical"){j=$(k.target).closest(".rpview_bl");h.$el.find(".rpview_li_v.selected").removeClass("selected").find(".rpview_bl.selected").removeClass("selected");j.addClass("selected").closest(".rpview_li_v").addClass("selected")}else{j=$(k.target).closest(".rpview_li");h.$el.find(".rpview_li.selected").removeClass("selected");j.addClass("selected")}},li_item_clicked:function(m,l){var n,h,i,k,j;if(this.layout=="vertical"){l=l||$(m.target).closest(".rpview_bl");h=this.bl_dts[l.index()];l=l.closest(".rpview_li_v");i=l.data("type")}else{l=l||$(m.target).closest(".rpview_li_innr");h=this.bl_dts[0];i=l.data("type")}j={to_date:h};if(i=="account"){k=app.generate_url("accounts",l.data("id"),_.extend({show_zero_balance:false},j))}else{if(i=="stock"){k=app.generate_url("stock_reports","stock_summary",j)}else{if(i=="prloss"){k=app.generate_url("reports","profit_n_loss",j)}else{return}}}app.router.navigate(k,{trigger:true})},load_data:function(j){var h,i,k;i=this;i.layout=j.layout||(app.appdata.default_blsheet_display=="vertical"?"vertical":"t");h=new Backbone.Model;i.url_params=j||i.url_params;i.url_params.layout=i.layout;i.$el.find(".balance_sheet_cnt").html('<div class="sheet_loading">Loading...</div>');h.url="/reports/balance_sheet/";h.fetch({data:$.param(this.url_params),success:function(m,l){i.form.renderErrors({});_.extend(l,{symbol:app.appdata.currency_symbol,inner_template:e[i.layout=="vertical"?"innr_v":"innr_t"]});i.bl_dts=_.clone(l.balance_dates);i.form.set_values({to_date:l.to_date});var n=e[i.layout=="vertical"?"bls_v":"bls_t"](l);i.$el.find(".balance_sheet_cnt").html(n)},error:function(l,m){i.form.renderServerErrors(m)}})},onshow:function(){var h;h=this;app.TopButtons.set(["print","export"]);if(!h.form.is_rendered){h.form.renderInputs()}h.load_data(h.form.get_values(true));h.form.$el.show()}},b));g=app.Tab.extend(_.extend({label:"Profit and Loss",tab_id:"profit_n_loss",events:{"click .rpview_li_innr":"li_item_selected","dblclick .rpview_li_innr":"li_item_clicked","click .rpview_bl":"li_item_selected","dblclick .rpview_bl":"li_item_clicked"},afterAppend:function(){var h=this,i;h.form=new app.Form(_.extend({appendTo:h.$scope.$el.find(".float-right"),class_name:"prnloss_filter"},c));h.url_params={};h.listenTo(h.form,"all",h.form_ev_handler);i=$('<div class="profit_n_loss_cnt component"></div>');i.data("backbone_view",h);h.$el.append(i)},form_ev_handler:function(l,j,m){var i,k;i=this;k=i.form;if(l=="form_submit"){var h=k.get_values();this.load_data(h)}else{if(l=="changed"&&j.name=="layout"){if(j.get_value()=="vertical"){k.components.cmpr.set_value("no_comp").show()}else{k.hide_comps(["cmpr_split_period","cmpr"])}}else{if(l=="changed"&&j.name=="cmpr"){k.components.cmpr_split_period[j.get_value()=="no_comp"?"hide":"show"]()}}}},print_data:function(){app.popups.PrintExportOptions.show({method:"set",invoker:this,callback:function(i){var h;h=app.generate_ext_url("reports","profit_n_loss",_.extend({op:"print_preview"},this.form.get_values(),i));window.open(h,"_blank").addEventListener("load",function(){this.focus();this.print()},false)}})},export_data:function(){var h=this.form.get_values(true);$("#myiframwe").attr("src",app.generate_ext_url("reports","profit_n_loss",_.extend({op:"export_to_excel"},h,{layout:"vertical"})))},load_data:function(j){var i;i=this;i.url_params=j||i.url_params;i.layout=j.layout||(app.appdata.default_blsheet_display=="vertical"?"vertical":"t");i.$el.find(".profit_n_loss_cnt").html('<div class="sheet_loading">Loading...</div>');var h=new Backbone.Model;h.url="/reports/profit_n_loss/";h.fetch({data:$.param(i.url_params),success:function(l,k){i.form.renderErrors({});_.extend(k,{symbol:app.appdata.currency_symbol,inner_template:e[i.layout=="vertical"?"innr_v":"innr_t"]});i.from_date=k.from_date;i.to_date=k.to_date;i.bl_dts=_.clone(k.balance_dates);i.form.set_values(_.pick(k,["from_date","to_date"]));var m=e[i.layout=="vertical"?"prl_v":"prl_t"](k);i.$el.find(".profit_n_loss_cnt").html(m)},error:function(l,k){i.form.renderServerErrors(k)}})},li_item_clicked:function(m,l){var h,k,j,i;i=this;if(this.layout=="vertical"){l=l||$(m.target).closest(".rpview_bl");from_date=i.bl_dts[l.index()][0];to_date=i.bl_dts[l.index()][1];l=l.closest(".rpview_li_v");h=l.data("type")}else{l=l||$(m.target).closest(".rpview_li_innr");to_date=i.to_date;from_date=i.from_date;h=l.data("type")}j={from_date:from_date,to_date:to_date};if(h=="account"){k=app.generate_url("accounts",l.data("id"),_.extend({show_zero_balance:false,add_cogs:i.layout=="vertical"||get_cfg("add_stock_to_cos")=="true"?true:false},j))}else{if(h=="stock"){k=app.generate_url("stock_reports","stock_summary",j)}else{return}}app.router.navigate(k,{trigger:true})},onshow:function(){if(!this.form.is_rendered){this.form.renderInputs();this.form.hide_comps(["cmpr","cmpr_split_period"])}app.TopButtons.set(["print","export"]);this.load_data(this.form.get_values(true));this.form.$el.show()}},b));if(AL.any_access("profit_n_loss")){set_object("reports_tabs","prloss_tab",g)}if(AL.any_access("balance_sheet")){set_object("reports_tabs","blsheet_tab",f)}FB_Module.init_fn(function(){if(AL.any_access(["balance_sheet.display","profit_n_loss.display"])){app.SideMenu.add_item({item_id:"reports",label:"Reports",index:5})}app.SideMenu.add_item({view:"reports/profit_n_loss",item_id:"prloss",under:"reports",label:"Profit and Loss",is_disabled:!AL.any_access("profit_n_loss.display")});app.SideMenu.add_item({view:"reports/balance_sheet",item_id:"blsheet",under:"reports",label:"Balance Sheet",is_disabled:!AL.any_access("balance_sheet.display")})})});FB_Module.register({index:2},function(){var a,d,c,b;a={default_attr:{class_name:"_type1 _sm2 _comp_inline _mgrt_05em"},fields:{layout:{type:"selectbox",id:"_w8em",options:{t:"T Layout",vertical:"Vertical"},default_option:app.appdata.default_prloss_display,label:"Layout"},display_type:{type:"selectbox",id:"_w8em",options:{condonsed:"Condonsed",detailed:"Detailed"},default_option:"condonsed",label:"Display Type"},from_date:{type:"datefield",id:"_w7em prlsform_frdate",label:"From Date"},to_date:{type:"datefield",id:"_w7em prlsform_todate",label:"To Date"},_submit_btn:{tagName:"button",className:"component btn _sm2 _type1 _theme1 _mgtp_9x",innerHTML:"Submit",attrs:{type:"submit"}}},validation:{}};d={t:"cashflow_template",v:"cashflow_vtemplate",innr_t:"report_template1",innr_v:"report_vtemplate3"};_.each(d,function(f,e){d[e]=_.template($("#"+f).html())});b=app.Tab.extend({label:"Cash Flow",tab_id:"cash_flow",events:{"click .rpview_li_innr":"li_item_selected","dblclick .rpview_li_innr":"li_item_clicked","click .rpview_bl":"li_item_selected","dblclick .rpview_bl":"li_item_clicked"},afterAppend:function(){var e=this,f;e.form=new app.Form(_.extend({appendTo:e.$scope.$el.find(".float-right"),class_name:"cashflow_filter"},a));e.url_params={};e.listenTo(e.form,"form_submit",e.form_submitted);f=$('<div class="report_cnt component"></div>');f.data("backbone_view",e);e.$el.append(f)},form_submitted:function(){var e=this.form.get_values();this.load_data(e)},print_data:function(){app.popups.PrintExportOptions.show({method:"set",invoker:this,callback:function(f){var e;e=app.generate_ext_url("reports","cash_flow",_.extend({op:"print_preview"},this.form.get_values(),f));window.open(e,"_blank").addEventListener("load",function(){this.focus();this.print()},false)}})},export_data:function(){var e=this.form.get_values(true);$("#myiframwe").attr("src",app.generate_ext_url("reports","cash_flow",_.extend({op:"export_to_excel"},e,{layout:"vertical"})))},load_data:function(g){var f;f=this;f.url_params=g||f.url_params;f.layout=g.layout||(app.appdata.default_blsheet_display=="vertical"?"vertical":"t");f.$el.find(".report_cnt").html('<div class="sheet_loading">Loading...</div>');var e=new Backbone.Model;e.url="/reports/cash_flow/";e.fetch({data:$.param(f.url_params),success:function(i,h){f.form.renderErrors({});_.extend(h,{symbol:app.appdata.currency_symbol,inner_template:d.innr_v});f.from_date=h.from_date;f.bl_dts=_.clone(h.balance_dates);f.form.set_values({from_date:h.from_date,to_date:h.to_date});var j=d[f.layout=="vertical"?"v":"t"](h);f.$el.find(".report_cnt").html(j)},error:function(i,h){f.form.renderServerErrors(h)}})},gl_ev_handler:function(n,k){var g,m,o,l,h,j,f;if(n=="keypress"){g=this.$el.find(".rpview_li.selected");switch(k.keyCode){case 38:case 40:if(g.length==0){g=this.$el.find(".rpview_li").first();g.addClass("selected")}else{g.removeClass("selected");f=this.$el.find("."+(g.closest(".rpview_left,.rpview_right").hasClass("rpview_left")?"rpview_left":"rpview_right")+" .rpview_li");j=f.index(g);if(k.keyCode==40){m=(j==f.length-1?f.eq(0):f.eq(j+1))}else{m=(j==0?f.eq(-1):f.eq(j-1))}m.addClass("selected")}break;case 37:case 39:if(g.length>0){o=g.closest(".rpview_left,.rpview_right");g.removeClass("selected");l=o.hasClass("rpview_left");h=g.index();m=o[l?"next":"prev"]().find(".rpview_li");m=h>m.length-1?m.last():m.eq(h);m.addClass("selected")}break;case 13:if(g.length>0){this.li_item_clicked(null,g.find(".rpview_li_innr"))}}}},li_item_selected:function(f){if(this.layout=="vertical"){el=$(f.target).closest(".rpview_bl");this.$el.find(".rpview_li_v.selected").removeClass("selected").find(".rpview_bl.selected").removeClass("selected");el.addClass("selected").closest(".rpview_li_v").addClass("selected")}else{el=$(f.target).closest(".rpview_li");this.$el.find(".rpview_li.selected").removeClass("selected");el.addClass("selected")}},li_item_clicked:function(k,j){var f,i,h,g;g=this;if(this.layout=="vertical"){j=j||$(k.target).closest(".rpview_bl");to_date=g.bl_dts[j.index()];from_date=(!j.is(":last-child"))?(Date.fromString(g.bl_dts[j.index()+1]).addDays(1).toString("d-m-Y")):g.from_date;j=j.closest(".rpview_li_v");f=j.data("type")}else{j=$(k.target).closest(".rpview_li_v");to_date=g.bl_dts[0];from_date=g.from_date;f=j.data("type")}h={from_date:from_date,to_date:to_date};if(true){i=app.generate_url("accounts",j.data("id"),_.extend({show_zero_balance:false,from_cf:true,flow:j.closest(".cfsec_out").length?"out":"in"},h))}else{if(f=="stock"){i=app.generate_url("stock_reports","stock_summary",h)}else{return}}app.router.navigate(i,{trigger:true})},onshow:function(){if(!this.form.is_rendered){this.form.renderInputs()}app.TopButtons.set(["print","export"]);this.load_data(this.form.get_values(true));this.form.$el.show()}});if(AL.any_access("cash_flow")){set_object("reports_tabs","cashflow_tab",b)}FB_Module.init_fn(function(){if(AL.any_access(["cash_flow.display"])){app.SideMenu.add_item({item_id:"reports",label:"Reports",index:5});app.SideMenu.add_item({view:"reports/cash_flow",item_id:"cash_flow",under:"reports",label:"Cash Flow",is_disabled:!AL.any_access("cash_flow.display")})}})});FB_Module.register({index:2},function(){var b,a,c;b={default_attr:{class_name:"_type1 _md"},fields:{from_date:{type:"datefield",name:"from_date",id:"_w7em _mg_rt_05em _nobg",label:"From Date"},to_date:{type:"datefield",name:"to_date",label:"To Date",id:"_w7em _nobg _mg_rt_05em"},_submit_btn:{tagName:"button",className:"component btn _type1 _md _theme1 _mgtp_9x",innerHTML:"Submit",attrs:{type:"submit"}}},validation:{from_date:{pattern:"date"},to_date:{pattern:"date"}}};a={fields:{date:{head_label:"Date",width:"90px"},particulars:{head_label:"Particulars",width:"80%"},vtype:{head_label:"Voucher Type",key:"vtype_txt",width:"20%",choices:_.map(app.fb_doc_types,function(e){var d={};d[e.abbr]=e.heading;return d})},vchr_no:{head_label:"Voucher No",width:"135px"},amount:{head_label:"Amount",width:"120px",align:"right",type:"money",wrapSPAN:true}},show_items:["date","particulars","vtype","vchr_no","amount"],filter_enable:["date","vtype","vchr_no","amount"],ips_filter_enable:["date","amount"]};app.p_views.DayBook=app.ListPageTemplate.extend({page_name:"daybook",model:gen_model("/reports/daybook/"),no_newbtn:true,popup:app.popups.JournalPopup,ds_options:{flex_schema:a,ds_id:"ds_daybook",class_name:"hoverable",handle_pagination:true,has_filter:true},header_btns:["print","export"],drill_to_view:"voucher",heading:"Daybook",heading_plural:"DayBook",initialize:function(){this.init({create_el:true})},before_init:function(){var d=this;d.form=new app.Form(_.extend({appendTo:this.$el.find(".content-topsec > .float-right"),class_name:"daybook_form _mgbt_1em"},b));d.form.renderInputs();d.listenTo(d.form,"form_submit",function(){d.ds.load({params:d.form.get_values(true)})})},ds_handler:function(f,j,g,h){var d;d=this;if(f=="before_render"){tmp1=j.items;for(i in tmp1){tmp1[i].amount_txt=to_money(tmp1[i].amount,true)}d.form.set_values(_.pick(j,["from_date","to_date"]))}return this._ds_handler(f,j,g,h)},export_data:function(f){var e,d;d=this;e=d.ds;app.popups.ExportOptions.show({invoker:d,method:"set",callback:function(g){$("#myiframwe").attr("src",app.generate_ext_url(e.model.urlRoot,(f||null),_.extend({op:"export_to_excel"},e.default_params,_.omit(e.options.params,[]),g)))}})}});if(AL.any_access("daybook")){FB_Module.init_fn(function(){app.SideMenu.add_item({item_id:"vouchers_cnt",label:"Voucher Registers",index:5.5,is_disabled:!AL.any_access("daybook.display")});app.SideMenu.add_item({view:"daybook",item_id:"daybook",index:10,under:"vouchers_cnt",label:"Day Book",is_disabled:!AL.any_access("daybook.display")})})}});FB_Module.register({index:2},function(){var c,b,a;c={default_attr:{class_name:"_type1 _sm2 _comp_inline"},fields:{from_date:{type:"datefield",label:"From Date",id:"_w7em _mgrt_05em"},to_date:{type:"datefield",label:"To Date",id:"_w7em _mgrt_05em"},account_name:{type:"combobox",label:"Account Name",id:"_w25em _mgrt_05em",url:"/accounts/?name={{value}}&pagination=false&is_cntlacc=false&_select_fields=name"},subacc_of_name:{type:"combobox",label:"Parent Account",id:"_w25em _mgrt_05em",url:"/accounts/?name={{value}}&pagination=false&is_cntlacc=true&_select_fields=name"},_submit_btn:{tagName:"button",className:"component btn _type1 _md _theme1 _mg_rt_05em _mgtp_9x",innerHTML:"Submit",attrs:{type:"submit"}}},validation:{from_date:{pattern:"date",required:false},to_date:{pattern:"date",required:false}}};tb_ds_schema={fields:{display_name:{head_label:"Account Name",width:"23%",index:0},subacc_of_name:{head_label:"Parent Account",width:"23%",index:0},o_balance_dr:{head_label:"Debit",width:"9%",align:"right",index:1,type:"money",wrapSPAN:"_amount_bl"},o_balance_cr:{head_label:"Credit",width:"9%",align:"right",index:1,type:"money",wrapSPAN:"_amount_bl"},trans_dr:{head_label:"Debit",width:"9%",align:"right",index:1,type:"money"},trans_cr:{head_label:"Credit",width:"9%",align:"right",index:1,type:"money"},c_balance_dr:{head_label:"Debit",width:"9%",align:"right",index:1,type:"money",wrapSPAN:true},c_balance_cr:{head_label:"Credit",width:"9%",align:"right",index:1,type:"money",wrapSPAN:true}},show_items:["display_name","subacc_of_name","o_balance_dr","o_balance_cr","trans_dr","trans_cr","c_balance_dr","c_balance_cr"],head_group:{display_name:{head_label:"&nbsp;",cspan:2},o_balance:{cspan:2,head_label:"Opening Balance",align:"center"},trans:{cspan:2,head_label:"Transactions",align:"center"},c_balance:{cspan:2,head_label:"Closing Balance",align:"center"}}};a=app.Tab.extend({label:"Trial Balance",tab_id:"trial_balance",model:app.models.TrialBalance,afterAppend:function(){var d;d=this;d.form=new app.Form(_.extend({appendTo:this.$el,class_name:"trialbalance_form"},c));d.ds=new app.DS({flex_schema:tb_ds_schema,ds_id:"ds_trialbalance",class_name:"hoverable",default_params:{sort_by:"name"},handle_pagination:true,has_pagination:true,model:new d.model,appendTo:d.$el});d.ds.before_render=function(h,g){var f,k,j,m,l,e;f=g.items;for(j in f){k=f[j];l=k.opening_balance;if(l&&l[0]!=0){k[l[0]>=0?"o_balance_dr":"o_balance_cr"]=Math.abs(l[0])}e=k.c_balance-(l&&l[0]!=0?l[0]:0);if(e!=0){k[e>=0?"trans_dr":"trans_cr"]=Math.abs(e)}k[k.c_balance>=0?"c_balance_dr":"c_balance_cr"]=Math.abs(k.c_balance)}d.form.set_values({from_date:g.from_date,to_date:g.to_date})};d.listenTo(d.ds,"all",this.ds_event_handler);d.listenTo(d.form,"form_submit",function(g){var f=this.form.get_values();this.load_ds(f);app.router.navigate(app.generate_url("reports","trial_balance",f,{replace:true,trigger:false}))})},ds_event_handler:function(g,h,d,f){if(g=="li_clicked"){app.router.navigate(app.generate_url("accounts",h,_.pick(this.form.get_values(),["from_date","to_date"])),{trigger:true})}},load_ds:function(d){d=d||{};this.form.renderServerErrors();this.ds.load({params:d,invoker:this,error:function(e,f){this.form.renderServerErrors(f)}})},print_data:function(){var d,e;app.popups.PrintExportOptions.show({invoker:this,callback:function(g){var f,h;f=app.generate_ext_url("reports","trial_balance",_.extend({op:"print_preview"},this.form.get_values(),g));window.open(f,"_blank").addEventListener("load",function(){this.focus();this.print()},false)}})},export_data:function(){var d=this.form.get_values(true);app.popups.PrintExportOptions.show({invoker:this,callback:function(e){$("#myiframwe").attr("src",app.generate_ext_url("reports","trial_balance",_.extend({op:"export_to_excel"},d,e)))}})},onshow:function(){var e,d;d=this;if(!d.form.is_rendered){d.form.renderInputs()}app.TopButtons.set(["print","export"]);e=d.args;d.form.set_values(_.pick(e,["account_name"]));d.load_ds(_.pick(e,["from_date","to_date","account_name"]))}});if(AL.any_access("trial_balance")){set_object("reports_tabs","trialbalance_tab",a);FB_Module.init_fn(function(){app.SideMenu.add_item({item_id:"reports",label:"Reports",index:5});app.SideMenu.add_item({view:"reports/trial_balance",item_id:"tb",under:"reports",label:"Trial Balance",is_disabled:!AL.any_access("trial_balance.display")})})}});FB_Module.register({index:2},function(){var a,c,b;a={default_attr:{class_name:"_type1 _md"},fields:{account:{type:"combobox",id:"_comp_inline _w30em _mgrt_1em",url:"/accounts/?name={{value}}&is_cntlacc=false&pagination=false&_select_fields=name,id",label:"Account Name",label_sel:"name",value_sel:"id",list_selector:"items",embedd_list_el:false},from_date:{type:"datefield",name:"from_date",id:" _comp_inline _nobg _w7em _mg_rt_05em",label:"From Date"},to_date:{type:"datefield",name:"to_date",label:"To Date",id:" _comp_inline _nobg _w7em _mg_rt_05em"},_submit_btn:{tagName:"button",className:"component btn _type1 _md _theme1 _mgtp_9x",innerHTML:"Submit",attrs:{type:"submit"}}},validation:{from_date:{required:false,pattern:"date"},to_date:{required:false,pattern:"date"},account:{required:true}}};set_objs({account_report_form:a});c={date:{head_label:"Date",style:"width:9.5%",index:0},particulars:{head_label:"Particulars",style:"width:19%",index:0},vtype_txt:{head_label:"Vchr Type",style:"width:9%",index:0},vchr_ref_no:{head_label:"Doc Ref No",style:"width:15%",index:0},description:{head_label:"Description",style:"width:11.5%",index:1},debit_txt:{head_label:"Debit",style:"width:12%;text-align:right",index:0},credit_txt:{head_label:"Credit",style:"width:12%;text-align:right",index:0},balance_txt:{head_label:"Balance",style:"width:12%;text-align:right",index:0}};b=app.Tab.extend({label:"Account Books",tab_id:"account_books",model:app.models.Transaction,afterAppend:function(){this.form=new app.Form(_.extend({appendTo:this.$el,class_name:"account_books_form _mg_bt_1em"},a));this.ds=new app.DS({schema:c,ds_id:"ds_acc_statment",class_name:"hoverable",handle_pagination:true,has_pagination:true,idAttr:"voucher_id",model:new this.model,default_params:{is_cntlacc:false,inc_vchr_ref_no:true},appendTo:this.$el});this.listenTo(this.ds,"all",this.ds_event_handler);this.listenTo(this.form,"form_submit",function(f){var d=this.form.get_values();this.load_ds(d)})},ds_event_handler:function(g,h,d,f){if(g=="li_clicked"){app.router.navigate(app.generate_url("voucher",h),{trigger:true})}},load_ds:function(d){d=d||{};this.form.renderServerErrors();this.ds.load({params:d,invoker:this,success:function(f,e){this.form.set_values({from_date:e.from_date,to_date:e.to_date})},error:function(e,f){this.form.renderServerErrors(f)}})},print_data:function(){var e,f,d;d=this.form.get_values(true);tmp=this.form.components.account.get_selected_data();if(!tmp){return}d.account_id=tmp.id;e=app.generate_ext_url("reports","account",_.extend({op:"print_preview",_print:"true"},d));window.open(e,"_blank")},export_data:function(){var e,d;d=this.form.get_values(true);e=this.form.components.account.get_selected_data();if(!e){return}d.account_id=e.id;$("#myiframwe").attr("src",app.generate_ext_url("reports","account",_.extend({output_format:"excel"},d)))},onshow:function(d,e){if(!this.form.is_rendered){this.form.renderInputs()}app.TopButtons.set(["export","print"]);if(d&&d.account){this.load_ds(_.pick(d,["from_date","to_date","account"]))}}});if(AL.any_access("general_acc_report")){set_object("reports_tabs","account_books_tab",b);FB_Module.init_fn(function(){app.SideMenu.add_item({item_id:"reports",label:"Reports",index:5});app.SideMenu.add_item({view:"reports/account_books",item_id:"accountbooks",under:"reports",label:"Account Books",is_disabled:false})})}});FB_Module.register({index:2},function(){var a,d,b,c;a={default_attr:{class_name:"_type1 _comp_inline _sm2"},fields:{sv:{type:"selectbox",options:{group:"Group",detail:"Detail"},label:"Report Type",id:"_w8em _mgrt_1em",dlgTo:"scope"},rtype:{type:"selectbox",options:{receivable:"Receivable",payable:"Payable"},label:"Group Type",id:"_w8em _mgrt_1em",dlgTo:"scope"},to_date:{type:"datefield",label:"To Date",id:"_w7em _mg_rt_05em"},account_id:{type:"combobox",id:"_comp_inline _w30em _mgrt_1em",label:"Account Name",url:"/accounts/?name={{value}}&is_cntlacc=false&under_defacc={{parent_key}}&pagination=false&_select_fields=name,id",value_sel:"id",label_sel:"name"},overdue_only:{type:"checkbox",label:"Overdue Only",value:"true",class_name:"_type1 _sm2 _mgrt_1em _mgtp_1em"},excl_settle:{type:"checkbox",label:'Exclude Settlements after "to date"',value:"true",class_name:"_type1 _sm2 _mgrt_1em _mgtp_1em"},_submit_btn:{tagName:"button",className:"component btn _type1 _md _theme1 _mg_rt_05em _mgtp_9x",innerHTML:"Submit",attrs:{type:"submit"}}},validation:{to_date:{pattern:"date"}}};d={fields:{display_name:{head_label:"Party",width:"40%",index:0},gross_amount:{head_label:"Amount",width:"10%",align:"right",type:"money",wrapSPAN:true,index:1}},show_items:["display_name","gross_amount"]};b={fields:{date:{head_label:"Date",width:"85px",index:0},ref_no:{head_label:"Doc No",width:"100px",index:0},ref_no1:{head_label:"Ref No",width:"100px",index:0},account_name:{head_label:"Party",width:"30%",index:0},narration:{head_label:"Narration",width:"60%",index:0},amount_due:{head_label:"Amount Due",width:"100px",align:"right",type:"money",wrapSPAN:false,index:0},settled_amount:{head_label:"Settled Amount",width:"100px",align:"right",type:"money",wrapSPAN:false,index:0},pending_amount:{head_label:"Pending Amount",width:"100px",align:"right",type:"money",wrapSPAN:true,index:0},due_on:{head_label:"Due on",width:"85px",index:0},overdue_txt:{head_label:"Overdue",width:"80px",align:"right"},cum_pending:{head_label:"Running Total",width:"100px",align:"right",type:"money",index:0}},show_items:["date","ref_no","ref_no1","account_name","narration","amount_due","settled_amount","pending_amount","due_on","overdue_txt","cum_pending"]};c=app.Tab.extend({label:"Outstanding",tab_id:"outstanding",model:gen_model("/reports/outstanding/"),initComps:function(){var g,f,k,j,l,h,e;g=this;g.form=new app.Form(_.extend({appendTo:this.$el,class_name:"outstanding_form _mgbt_1em"},a));g.form.renderInputs();f=get_cfg("ageing_fmt");if(!f){f="0-30,31-60,61-90,91-120,121+"}f=f.replace("+","").split(",");g.ageing_periods=[];for(k=0,e=f.length;k<e;k++){h=f[k].split("-");g.ageing_periods.push(k<e-1?"amount"+h[0]+h[1]:"amount"+h[0]+"p")}for(k=0,e=g.ageing_periods.length;k<e;k++){j=g.ageing_periods[k];d.fields[j]={head_label:f[k]+(k==e-1?"+":"")+" Days",width:"10%",align:"right",type:"money",hide_zero:true,index:1},d.show_items.splice(1+k,0,j)}g.ds=new app.DS({flex_schema:d,ds_id:"ds_outstanding",class_name:"hoverable",default_params:{sort_by:"name"},handle_pagination:true,has_pagination:true,model:new g.model,appendTo:g.$el});g.ds.$el.find(".ds_topcnt").prepend('<span class="total_amount"></span>');g.inner_ds=new app.DS({idAttr:"voucher_id",flex_schema:b,ds_id:"ds_outstanding_innr",class_name:"hoverable",default_params:{sv:"detail"},handle_pagination:true,has_pagination:true,model:new g.model,appendTo:g.$el});g.inner_ds.$el.find(".ds_topcnt").prepend('<span class="total_amount"></span>');g.listenTo(g.ds,"all",g.ds_event_handler);g.listenTo(g.inner_ds,"all",g.inner_ds_handler);g.listenTo(g.form,"all",g.form_ev_handler);g.is_rendered=true},form_ev_handler:function(j,h,k){var g,f,l,i;g=this;l=g.form.components;if(j=="changed"&&h.name=="sv"){i=h.get_value();if(i=="detail"){l.account_id.url_args={parent_key:"receivable,payable"}}else{l.account_id.url_args={parent_key:l.rtype.get_value()}}}else{if(j=="changed"&&h.name=="rtype"){l.account_id.url_args={parent_key:h.get_value()}}else{if(j=="form_submit"){f=g.form.get_values(true);g.inner_ds.$el[f.sv=="detail"?"show":"hide"]();g.ds.$el[!(f.sv=="detail")?"show":"hide"]();g.load_ds(f.sv!="detail"?"ds":"inner_ds",f,true)}}}},ds_event_handler:function(r,h,g,p){var t,q,n,m,o,s,f,l,k;t=this;if(r=="li_clicked"){if(h){app.router.navigate(app.generate_url("reports","outstanding",_.extend({sv:"detail",account_id:h},_.pick(this.form.get_values(true),["to_date","rtype","excl_settle"]))),{trigger:true})}}else{if(r=="before_render"){t.form.set_values(_.pick(h,["sv","rtype","to_date","account_id"]));t.form_ev_handler("changed",t.form.components.rtype,null);g.$el.find(".ds_topcnt .total_amount").html("Total Amount : "+to_money(h.total_amount,true))}else{if(r=="rendered"){li_list=g.$el.find(".table_list > li");for(n in g.rows){l=g.rows[n];for(m in t.ageing_periods){key=t.ageing_periods[m];k=l[key];if(k!=""&&k!=0){li_list.eq(n).find(">ul>._c"+key).addClass("_silver")}}}if(g.navigation&&g.navigation.current_page==g.navigation.page_count){li_list.last().addClass("_b _silver")}}}}},inner_ds_handler:function(o,g,f,m){var q,n,k,h,l,p,r;q=this;if(o=="li_clicked"){r=f.get_row(g);if(r.vtype=="ov"){app.notifications.add("Info","Cannot drill into opening voucher","info")}else{if(g){app.router.navigate(app.generate_url("voucher",g,null),{trigger:true})}}}else{if(o=="before_render"){q.form.set_values(_.pick(g,["sv","rtype","to_date","account_id","overdue_only"]));n=g.items;for(k=0;k<n.length;k++){n[k].overdue_txt=n[k].overdue>0?n[k].overdue+" days":""}f.$el.find(".ds_topcnt .total_amount").html("Total Pending : "+to_money(g.totals.total_pending,true))}else{if(o=="rendered"){if(f.navigation&&f.navigation.current_page==f.navigation.page_count){li_list=f.$el.find(".table_list > li");li_list.last().addClass("_b _silver")}}}}},load_ds:function(e,g,f){app.router.navigate(app.generate_url("reports","outstanding",_.extend({},_.pick(g,["sv","rtype","account_id","excl_settle","to_date","overdue_only"]))),{trigger:false,replace:true});this[e].$el.find(".ds_topcnt .total_amount").html("");g=g||{};this.form.renderServerErrors();this[e].load({params:g,presv_flt:!f,invoker:this,error:function(h,i){this.form.renderServerErrors(i)}})},print_data:function(){var e,f;e=app.generate_ext_url("reports","outstanding",_.extend({op:"print_preview"},this.form.get_values(true)));window.open(e,"_blank").addEventListener("load",function(){this.focus();this.print()},false)},export_data:function(){var e=this.form.get_values(true);$("#myiframwe").attr("src",app.generate_ext_url("reports","outstanding",_.extend({op:"export_to_excel"},e)))},onshow:function(f){var e,g;e=this;if(!e.is_rendered){e.initComps()}g=e.form.components;app.TopButtons.set(["print","export"]);e.inner_ds.$el[f.args&&f.args.sv=="detail"?"show":"hide"]();e.ds.$el[!(f.args&&f.args.sv=="detail")?"show":"hide"]();e.load_ds(f.args&&f.args.sv=="detail"?"inner_ds":"ds",_.pick(f.args,["sv","rtype","account_id","to_date","excl_settle","overdue_only"]),f.is_navigate)}});if(AL.any_access(["receivables.display","payables.display"])){set_object("reports_tabs","outstanding_tab",c);FB_Module.init_fn(function(){app.SideMenu.add_item({item_id:"reports",label:"Reports",index:5});app.SideMenu.add_item({view:"reports/outstanding",item_id:"outstanding",under:"reports",label:"Outstanding",is_disabled:!AL.any_access(["receivables.display","payables.display"])})})}});FB_Module.register({index:2},function(){var a,d,b,c;a={default_attr:{class_name:"_type1 _comp_inline _sm2"},fields:{sv:{type:"selectbox",options:{group:"Group",detail:"Detail"},label:"Report Type",id:"_w8em _mgrt_1em",dlgTo:"scope"},rtype:{type:"selectbox",options:{receivable:"Receivable",payable:"Payable"},label:"Group Type",id:"_w8em _mgrt_1em",dlgTo:"scope"},from_date:{type:"datefield",label:"From Date",id:"_w7em _mg_rt_05em"},to_date:{type:"datefield",label:"To Date",id:"_w7em _mg_rt_05em"},account_id:{type:"combobox",id:"_comp_inline _w30em _mgrt_1em",label:"Account Name",url:"/accounts/?name={{value}}&is_cntlacc=false&under_defacc={{parent_key}}&pagination=false&_select_fields=name,id",value_sel:"id",label_sel:"name"},_submit_btn:{tagName:"button",className:"component btn _type1 _md _theme1 _mg_rt_05em _mgtp_9x",innerHTML:"Submit",attrs:{type:"submit"}}},validation:{from_date:{pattern:"date"},to_date:{pattern:"date"}}};d={fields:{display_name:{head_label:"Party",width:"40%",index:0},total_due:{head_label:"Total due",width:"10%",align:"right",type:"money",index:1},paid_within_due:{head_label:"Paid within due",width:"10%",align:"right",type:"money",index:1},paid_after_due:{head_label:"Paid after due",width:"10%",align:"right",type:"money",index:1},outstanding:{head_label:"Outstanding",width:"10%",align:"right",type:"money",index:1},avg_credit_period:{head_label:"Avg Credit Period",width:"10%",align:"right",suffix:"days",index:1},avg_overdue:{head_label:"Avg Overdue",width:"10%",align:"right",suffix:"days",index:1},credit_rating:{head_label:"Credit Rating",width:"105px",align:"right",index:1},credit_score:{head_label:"Credit Score",width:"85px",align:"right",index:1}},show_items:["display_name","total_due","paid_within_due","paid_after_due","outstanding","avg_credit_period","avg_overdue","credit_rating","credit_score"]};b={fields:{date:{head_label:"Date",width:"85px",index:0},ref_no:{head_label:"Ref No",width:"100px",index:0},account_name:{head_label:"Party",width:"20%",index:0},narration:{head_label:"Narration",width:"20%",index:0},amount_due:{head_label:"Amount Due",width:"90px",align:"right",type:"money",wrapSPAN:false,index:0},due_on:{head_label:"Due on",width:"85px",index:0},settlement_txt:{head_label:"Settlments",width:"50%",index:0},settled_amount:{head_label:"Settled Amount",width:"100px",align:"right",type:"money",wrapSPAN:false,index:0},pending_amount:{head_label:"Pending Amount",width:"100px",align:"right",type:"money",wrapSPAN:true,index:0}},_show_items:["date","ref_no","account_name","narration","amount_due","due_on","settlement_txt","settled_amount","pending_amount"]};c=app.Tab.extend({label:"Credit Performance Report",tab_id:"credit_report",model:gen_model("/reports/credit_report/"),initComps:function(){var g,f,k,j,l,h,e;g=this;g.form=new app.Form(_.extend({appendTo:this.$el,class_name:"credit_report_form _mgbt_1em"},a));g.form.renderInputs();g.ds=new app.DS({flex_schema:d,ds_id:"ds_creditrating",class_name:"hoverable",default_params:{sort_by:"name"},handle_pagination:true,has_pagination:true,model:new g.model,appendTo:g.$el});g.inner_ds=new app.DS({idAttr:"voucher_id",flex_schema:b,ds_id:"ds_creditrating_innr",class_name:"hoverable",default_params:{sv:"detail"},handle_pagination:true,has_pagination:true,model:new g.model,appendTo:g.$el});g.ds.before_render=function(m,i){};g.listenTo(g.ds,"all",g.ds_event_handler);g.listenTo(g.inner_ds,"all",g.inner_ds_handler);g.listenTo(g.form,"all",g.form_ev_handler);g.is_rendered=true},form_ev_handler:function(j,h,k){var g,f,l,i;g=this;l=g.form.components;if(j=="changed"&&h.name=="sv"){i=h.get_value();if(i=="detail"){l.account_id.url_args={parent_key:"receivable,payable"}}else{l.account_id.url_args={parent_key:l.rtype.get_value()}}}else{if(j=="changed"&&h.name=="rtype"){l.account_id.url_args={parent_key:h.get_value()}}else{if(j=="form_submit"){f=g.form.get_values(true);g.inner_ds.$el[f.sv=="detail"?"show":"hide"]();g.ds.$el[!(f.sv=="detail")?"show":"hide"]();g.load_ds(f.sv!="detail"?"ds":"inner_ds",f,true)}}}},ds_event_handler:function(s,h,g,q){var u,r,n,m,p,t,f,l,k,o;u=this;o=[["Excellent","0f8d44","fff"],["Very good","6dc234","000"],["Good","c2e0ae","000"],["Below Average","bee3d3","000"],["Poor","fce09b","000"],["Bad","f8a761","000"],["Very Bad","e60f0f","fff"]];if(s=="li_clicked"){if(h){app.router.navigate(app.generate_url("reports","credit_report",_.extend({sv:"detail",account_id:h},_.pick(this.form.get_values(true),["from_date","to_date","rtype"]))),{trigger:true})}}else{if(s=="before_render"){for(n=0,p=h.items.length;n<p;n++){l=h.items[n];h.items[n].credit_score=to_money(Math.floor(h.items[n].credit_score),null,0,0);h.items[n].credit_rating=o[l.credit_score<1000?6-Math.floor(l.credit_score*(7/1000)):0][0]}u.form.set_values(_.pick(h,["sv","rtype","from_date","to_date","account_id"]));u.form_ev_handler("changed",u.form.components.rtype,null)}else{if(s=="rendered"){li_list=g.$el.find(".table_list > li");for(n in g.rows){l=g.rows[n];k=o[l.credit_score<1000?6-Math.floor(l.credit_score*(7/1000)):0];li_list.eq(n).find(">ul>._ccredit_rating").css({backgroundColor:"#"+k[1],color:"#"+k[2]});for(m in u.ageing_periods){key=u.ageing_periods[m];k=l[key];if(k!=""&&k!=0){li_list.eq(n).find(">ul>._c"+key).addClass("_silver")}}}if(g.navigation&&g.navigation.current_page==g.navigation.page_count){li_list.last().addClass("_b _silver")}}}}},inner_ds_handler:function(o,g,f,m){var q,n,k,h,l,p,r;q=this;if(o=="li_clicked"){r=f.get_row(g);if(r.vtype=="ov"){app.notifications.add("Info","Cannot drill into opening voucher","info")}else{if(g){app.router.navigate(app.generate_url("voucher",g,null),{trigger:true})}}}else{if(o=="before_render"){q.form.set_values(_.pick(g,["sv","rtype","from_date","to_date","account_id"]));n=g.items;for(k=0;k<n.length;k++){n[k].overdue_txt=n[k].overdue>0?n[k].overdue+" days":""}}else{if(o=="rendered"){if(f.navigation&&f.navigation.current_page==f.navigation.page_count){li_list=f.$el.find(".table_list > li");li_list.last().addClass("_b _silver")}}}}},load_ds:function(e,g,f){app.router.navigate(app.generate_url("reports","credit_report",_.extend({},_.pick(g,["sv","rtype","account_id","from_date","to_date"]))),{trigger:false,replace:true});g=g||{};if(e=="inner_ds"){this.inner_ds.flex_schema.show_items=_.without(this.inner_ds.flex_schema._show_items,g.account_id?"account_name":"")}this.form.renderServerErrors();this[e].load({params:g,presv_flt:!f,invoker:this,error:function(h,i){this.form.renderServerErrors(i)}})},print_data:function(){var e,f;e=app.generate_ext_url("reports","credit_report",_.extend({op:"print_preview"},this.form.get_values(true)));window.open(e,"_blank").addEventListener("load",function(){this.focus();this.print()},false)},export_data:function(){var e=this.form.get_values(true);$("#myiframwe").attr("src",app.generate_ext_url("reports","credit_report",_.extend({op:"export_to_excel"},e)))},onshow:function(f){var e,g;e=this;if(!e.is_rendered){e.initComps()}g=e.form.components;app.TopButtons.set(["print","export"]);e.inner_ds.$el[f.args&&f.args.sv=="detail"?"show":"hide"]();e.ds.$el[!(f.args&&f.args.sv=="detail")?"show":"hide"]();e.load_ds(f.args&&f.args.sv=="detail"?"inner_ds":"ds",_.pick(f.args,["sv","rtype","account_id","from_date","to_date","excl_settle","overdue_only"]),f.is_navigate)}});if(AL.any_access(["receivables.display","payables.display"])){set_object("reports_tabs","creditreport_tab",c);FB_Module.init_fn(function(){app.SideMenu.add_item({item_id:"reports",label:"Reports",index:5});app.SideMenu.add_item({view:"reports/credit_report",item_id:"credit_report",under:"reports",label:"Credit Performance Report",is_disabled:!AL.any_access(["receivables.display","payables.display"])})})}});FB_Module.register({index:2},function(){var a,c,b;if(AL.any_access("revenue_tracker")){a={default_attr:{class_name:"_type1 _md _mgbt_1em"},fields:{output_format:{type:"selectbox",id:"naf_type",label:"Output Format",default_option:"",options:{excel:"Excel Sheet"}},from_date:{type:"datefield",name:"from_date",id:"colfromdate",label:"From Date"},to_date:{type:"datefield",name:"to_date",label:"To Date",id:"coltodate"}}};c=new (app.Popup.extend({id:"revtracker_popup",head:"Revenue Tracker",events:{submit:"submit_form","click .op_btn":"submit_form"},no_set_mode:true,render:function(f){var e,d;if(!f){this.form=new app.Form(_.extend({appendTo:this.$el.find(".popup_body")},a));this.form.renderInputs();this.$el.find(".op_btn.op_btn_snnx").remove();this.$el.find(".op_btn").text("Generate")}e=this.options;this.form.set_values({account_name:"",from_date:app.appdata.finperiod_start,to_date:app.appdata.finperiod_end});this.form.renderErrors()},submit_form:function(j){var h,i,f,k,g,d;d=this;g=new Backbone.Model;g.url="/reports/tracker_report/";j.preventDefault();h=this.options;i=this.form;f=i.get_values();k=i.validate();f.validate=true;i.renderErrors(k);if(!k){g.fetch({data:$.param(f),success:function(m,e){var n,l;app.notifications.add("Report Generated Successfully","Report Generated","success");l=app.generate_ext_url("/reports","tracker_report",_.pick(e,["from_date","output_format","to_date","account_id"]));$("#dump_workspace").append($("<a href='"+l+"' target='_blank'>lnk</a>"));$("#dump_workspace").find("a")[0].click();$("#dump_workspace").html("");d.close()},error:function(e,l){i.renderServerErrors(l)}})}}}))()}b=app.Tab.extend({label:"Other Reports",tab_id:"other_reports",events:{"click ._acc_report_btn":"account_report_clicked"},afterAppend:function(){this.$el.append("<div class='_margin_bt_1em'><h2 class='acc_report_head'>General Account</h2><button class='component btn _type1 _md _acc_report_btn _gen_acc_report'>Report</button></div>");this.$el.append("<div class='_margin_bt_1em'><h2 class='acc_report_head'>Control Account</h2><button class='component btn _type1 _md _acc_report_btn _cnt_acc_report'>Report</button></div>");this.$el.append("<div class='_margin_bt_1em'><h2 class='acc_report_head'>Account Group</h2><button class='component btn _type1 _md _acc_report_btn _acc_grp_report'>Report</button></div>");if(AL.any_access("revenue_tracker")){this.$el.append("<div class='_margin_bt_1em'><h2 class='acc_report_head'>Revenue Tracker</h2><button class='component btn _type1 _md _acc_report_btn _tracker_report'>Report</button></div>")}},account_report_clicked:function(g){var f,d;d={};f=$(g.target);if(f.hasClass("_gen_acc_report")){d.acc_type="general";app.popups.AccountReportPopup.show(d)}else{if(f.hasClass("_cnt_acc_report")){d.acc_type="control";app.popups.AccountReportPopup.show(d)}else{if(f.hasClass("_acc_grp_report")){d.acc_type="group";app.popups.AccountReportPopup.show(d)}else{if(f.hasClass("_tracker_report")){c.show(d)}else{alert("Invalid Choice");return}}}}},onshow:function(){app.TopButtons.set()}});if(AL.any_access(["general_acc_report","control_acc_report","revenue_tracker"])){set_object("reports_tabs","other_reports_tab",b);FB_Module.init_fn(function(){app.SideMenu.add_item({item_id:"reports",label:"Reports",index:5});app.SideMenu.add_item({view:"reports/other_reports",item_id:"oth_report",under:"reports",label:"Other Reports",is_disabled:false})})}});FB_Module.register({index:2},function(){app.p_views.Reports=app.PageTemplate.extend({page_name:"reports",heading_plural:"Reports",initialize:function(){var c,a,d,b;b=this;b.init({create_el:true});this.tabs=new app.Tabs({appendTo:this.$el,$scope:this});c=get_object("reports_tabs");d=[];for(a in c){d.push(new c[a]())}this.tabs.append(d);this.listenTo(this.tabs,"tab_show",this.tab_show)},onshow:function(a,b,c){if(!a){a=this.tabs.current_tab||this.tabs.get_tab(0).tab_id}this.tabs.show_tab(a,{do_replace:true,args:b,is_navigate:c})},export_data:function(a){var b;b=this.tabs.current_tab;this.tabs.tabs[b].export_data()},print_data:function(a){var b;b=this.tabs.current_tab;this.tabs.tabs[b].print_data()},tab_show:function(b,c,e){var a=this,d=this.tabs.tabs;e.args=c.args;app.router.navigate(app.generate_url(this.page_name,b,c.args),{trigger:false,replace:c.do_replace});var f=this.$el.find(".float-right > *");f.hide()}});FB_Module.init_fn(function(){})});FB_Module.register({index:2},function(){var b,a,h;a={default_attr:{class_name:"_type1 _sm2 _mgbt_05em _w15em"},fields:{_sec1:{tagName:"div",className:"float_left _mgrt_1em",fields:{_head0:{tagName:"h3",className:"head5 _mgbt_05em",innerHTML:"Employee Details"},name:{type:"inputbox",id:"",label:"Name"},alias:{type:"inputbox",id:"",label:"Name (Secondary Language)"},employee_code:{type:"inputbox",id:"",label:"Employee ID"},admin_wing_name:{type:"combobox",id:"",label:"Administative Wing",dlgTo:"scope",url:"/admin_wings/?name={{value}}&pagination=false",new_item_btn:true},department_name:{type:"combobox",id:"",label:"Department",dlgTo:"scope",url:"/departments/?name={{value}}&pagination=false",new_item_btn:true},designation_name:{type:"combobox",id:"",label:"Designation",dlgTo:"scope",url:"/designations/?name={{value}}&pagination=false",new_item_btn:true},date_of_join:{type:"datefield",id:"",label:"Date of Joining"},_resign_grp:{tagName:"div",fields:{has_resigned:{type:"checkbox",value:"true",class_name:"_type1 _sm2 _mgbt_05em _mgtp_12x _mgrt_05em _comp_inline",dlgTo:"scope",label:""},date_of_resign:{type:"datefield",class_name:"_type1 _sm2 _mgbt_05em _w12em",label:"Date of Resign"}}},gender:{type:"selectbox",id:"",default_option:"",label:"Gender",options:[{male:"Male"},{female:"Female"}]},nationality:{type:"combobox",id:"",label:"Nationality",url:"/list/nationalities/?q={{value}}",label_sel:"nationality"},_head7:{tagName:"h3",className:"head5 _mgbt_05em",innerHTML:"Personal Info"},date_of_birth:{type:"datefield",class_name:"_type1 _sm2 _comp_inline _mgbt_05em _mgrt_1em _w7em",label:"Date of Birth"},blood_group:{type:"selectbox",label:"Blood Group",class_name:"_type1 _sm2 _comp_inline _mgbt_05em _w8em",default_option:"",options:[{o_neg:"O-"},{o_pos:"O+"},{a_neg:"A-"},{a_pos:"A+"},{b_neg:"B-"},{b_pos:"B+"},{ab_neg:"AB-"},{ab_pos:"AB+"}]}}},_sec2:{tagName:"div",className:"float_left _mgrt_1em",fields:{_head4:{tagName:"h3",className:"head5 _mgbt_05em",innerHTML:"Bank Details"},_bank_details1:{tagName:"div",className:"_comp_inline _mgrt_1em",fields:{_head:{tagName:"h3",className:"head6 _mgbt_1em",innerHTML:"Primary"},bank_acc_no:{type:"inputbox",id:"",label:"Bank Account No"},bank_name:{type:"combobox",id:"",label:"Bank Name",url:"/employees/?op=get_lists&list_name=bank_accounts&q={value}",label_sel:"b_name",value:"b_name",dlgTo:"scope",new_item_btn:true},branch:{type:"inputbox",id:"",label:"Branch"},ifsc_code:{type:"inputbox",id:"",label:"IFSC Code"},iban:{type:"inputbox",id:"",label:"IBAN"}}},_bank_details2:{tagName:"div",className:"_comp_inline",fields:{_head:{tagName:"h3",className:"head6 _mgbt_1em",innerHTML:"Secondary"},bank_acc_no_2:{type:"inputbox",id:"",label:"Bank Account No"},bank_name_2:{type:"combobox",id:"",label:"Bank Name",url:"/employees/?op=get_lists&list_name=bank_accounts&q={value}",label_sel:"b_name",value:"b_name",dlgTo:"scope",new_item_btn:true},branch_2:{type:"inputbox",id:"",label:"Branch"},ifsc_code_2:{type:"inputbox",id:"",label:"IFSC Code"},iban_2:{type:"inputbox",id:"",label:"IBAN"}}},_head2:{tagName:"h3",className:"head5 _mgbt_1em",innerHTML:"Contact Details"},contact_no:{type:"inputbox",id:"_comp_inline _mgrt_1em",label:"Primary Contact No"},contact_no2:{type:"inputbox",id:"_comp_inline _mgrt_1em",label:"Secondary Contact No"},email:{type:"inputbox",id:"",label:"Email"},present_address:{type:"textarea",id:"_comp_inline _mgrt_1em",label:"Present Address"},permanant_address:{type:"textarea",id:"_comp_inline",label:"Permanent Address"}}},_sec3:{tagName:"div",className:"float_left",fields:{_head3:{tagName:"h3",className:"head5 _mgbt_1em",innerHTML:"Staff related Documents"},_documents_cnt:{tagName:"div",className:"_documents_cnt"}}},_clearfix:{tagName:"div",className:"clearboth"}},validation:{}};app.popups.Employee=new (app.Popup.extend({id:"employee_popup",head:"Employee",class_name:"_mw1200x",events:{submit:"submit_form","click .op_btn":"submit_form"},model:app.models.Employee,beforeInit:function(){return true},render:function(j){var i,k;if(!j){this.form=new app.Form(_.extend({appendTo:this.$el.find(".popup_body")},a));this.form.renderInputs();this.listenTo(this.form,"all",this.form_ev_handler);k=app.IPS_ext.extend({ip_defaults:{class_name:"_sm2 _type2 _nouline _pdlt0"},class_name:"employee_ips _w28em",schema:{document_type_name:{head_label:"Document Type",width:40,ip_options:{type:"combobox",id:"",label:"Document Type",url:"/doc_man/doc_types/?doc_cat=ed&q={{value}}&excl_names={{excl_names}}&pagination=false"}},document_no:{head_label:"Document No",width:35,ip_options:{type:"inputbox",id:"",label:"Document No"}},expiry_date:{head_label:"Expiry Date",width:25,ip_options:{type:"datefield",id:"",label:"Expiry Date"}}},validation:{document_type_name:{required:true},document_no:{required:true},expiry_date:{required:false,pattern:"date"}},after_init:function(m){this.listenTo(this,"all",this.ips_event_handler);this.vald_form=new app.Form({el:this.$el,validation:this.validation});this.parent=m.parent},post_validate:function(n,m){return true},update_excl_names:function(p,o){var q,m,r,n;m=_.map(this.rows,function(t){var s=t.cols.document_type_name.ip.get_value();if(s!=""){return s}else{return null}});q=o?this.rows:[this.rows[p]];for(n=0;n<q.length;n++){r=_.filter(m,function(s,t){return s!=null&&t!=p});q[n].cols.document_type_name.ip.url_args={excl_names:r.join("|")}}},ips_event_handler:function(s,u,m,q,n){var r,o,p,t;r=u;u=this.rows[u];switch(s){case"row_insert":this.update_excl_names(r);break;case"item_selected":case"keydown":if(m=="document_type_name"){this.update_excl_names(r,true)}break;case"text_changed":if(q.keyCode==8){this.backspace_pressed(u,r,m)}break;case"enterkey_press":q.preventDefault();if(this.focusColumn(u,m,"next",true,{select:true})==false){this.validate_row(u,true)}break}}});this.ip_sheet=new k({appendTo:this.form.$el.find("._documents_cnt")});this.ip_sheet.render()}var l=this.options.data;this.setMode("idle");this.current_tab=null;this.ip_sheet.release(true);this.form.reset();this.form[l?"show_comps":"hide_comps"](["has_resigned","date_of_resign"]);if(l){i=new this.model({id:l.id});i.inst=this;i.fetch({success:function(n,m){m.has_resigned==m.date_of_resign!=null;i.inst.form.set_values(m);i.inst.form_ev_handler("clicked",i.inst.form.components.has_resigned);if(m.document_list&&m.document_list.length){i.inst.ip_sheet.set_value_list(m.document_list)}else{i.inst.ip_sheet.insertRow({})}},error:function(m){app.notifications.add("Loading Failed","Unable to load the data, please try again","error")}})}else{this.ip_sheet.insertRow({})}},form_ev_handler:function(j,i,l){var m,k;m=this.form.components;if(j=="clicked"&&i.name=="has_resigned"){m.date_of_resign[i.get_value()=="true"?"enable":"disable"]()}else{if(j=="add_new_clicked"){k={admin_wing_name:"AdminWingPopup",department_name:"DepartmentPopup",designation_name:"DesignationPopup"};if(i.name=="bank_name"||i.name=="bank_name_2"){app.popups.COMP_VAL.show({method:"set",invoker:this,val:i.get_value(true),comp:i,head:"Bank Name"})}else{app.popups[k[i.name]].show({method:"create",invoker:this,data:{name:i.get_value(true)},callback:function(n,p,o){i.set_value(o.name)}})}}}},after_get_values:function(i){i.document_list=this.ip_sheet.get_value_list()},after_request:function(k,i,j,l){var m=k.responseJSON;if(i=="success"){if($(l.target).hasClass("op_btn_snnx")){this.render(true);this.form.components.date.focus()}}else{if(i=="error"){this.form.renderServerErrors(k);if(m&&m.errors&&m.errors.doc_list_errors){this.ip_sheet.renderErrors(null,m.errors.doc_list_errors)}}}return false}}))();var g={default_attr:{class_name:"_type1 _md "},fields:{employee_name:{type:"combobox",id:"",label:"Employee",url:"/employees/?name={{value}}&pagination=false"}},validation:{}};var d={date:{head_label:"Applicable From",width:18,index:5,ip_options:{type:"datefield",id:"",label:"Applicable From",dlgTo:"scope"}},payhead_name:{head_label:"Pay Head",width:50,index:10,ip_options:{type:"combobox",id:"jpp_accname",label:"Pay Head",url:"/payheads/?name={{value}}&excl_names={{excl_names}}&phtype_item_type=earning&excl_manual=true&pagination=false",eol_btn:true,dlgTo:"scope"}},amount:{head_label:"Amount",width:18,index:20,ip_options:{type:"inputbox",id:"_ralign",label:"Amount",dlgTo:"scope",thousand_sep:true}},on_period:{head_label:"Per",width:18,index:30,ip_options:{type:"inputbox",id:"",label:"Per",disabled:true,dlgTo:"scope"}}};var c=app.IPS.extend({head:"Salary Details",ips_id:"salarydet_ips",schema:d,validation:{},ip_defaults:{class_name:"_md _type2 _nouline"},after_init:function(i){this.listenTo(this,"all",this.ips_event_handler);this.parent=i.parent;this.vald_form=new app.Form({el:this.$el,validation:this.validation})},load_data:function(k){var l,j,m;if(k.length){for(l=0;l<k.length;l++){k[l].on_period=this.get_uname(k[l]);m=this.insertRow(k[l]);if(j&&k[l].date==j){m.cols.date.ip.disable().hide(true)}j=k[l].date}}else{this.insertRow({})}},get_uname:function(k){var i,j;i={months:"Month",days:"Day"};j=k.calculation_type;if(j=="on_attendance"){return i[k.calculation_period]}else{if(j=="fixed"){return"Fixed"}else{return k.unit_name||""}}},update_excl_names:function(n,m){var p,j,q,k,o,l;for(k=n;k>=0;k--){if(!this.rows[k].cols.date.ip.disabled){o=k;break}}l=n;for(k=n+1;k<this.rows.length;k++){if(!this.rows[k].cols.date.ip.disabled||k==this.rows.length-1){l=k;break}}j=_.map(this.rows.slice(o,l+1),function(r){var i=r.cols.payhead_name.ip.get_value();if(i!=""){return i}else{return null}});p=m?this.rows:[this.rows[n]];for(k=0;k<p.length;k++){q=_.filter(j,function(r,s){return r!=null&&s!=n});p[k].cols.payhead_name.ip.url_args={excl_names:q.join("|")}}},ips_event_handler:function(q,r,k,o,l){var p,m,n,j;p=r;r=this.rows[r];switch(q){case"row_insert":this.update_excl_names(p);break;case"item_selected":n=l.comp.get_selected_data();if(n){r.cols.on_period.ip.set_value(this.get_uname(n))}if(this.focusColumn(r,k,"next",true,{select:true})==false){this.validate_row(r,true)}case"keydown":if(k=="payhead_name"){this.update_excl_names(p,true)}break;case"eol_clicked":r.cols.date.ip.enable().show(true).focus();break;case"text_changed":if(o.keyCode==8){this.backspace_pressed(r,p,k,o)}break;case"enterkey_press":if(this.focusColumn(r,k,"next",true,{select:true})==false){this.validate_row(r,true)}break}},validate_row:function(r,j){var i,n,q,p,l,m,o,k;q=this;i=this.get_components(r);this.vald_form.components=i;m=this.vald_form.validate();if(!m&&this.pre_validate){m=this.pre_validate(r)}this.vald_form.renderErrors(m);if(m){this.focusColumn(r,Object.keys(m)[0]);return false}if(this.post_validate&&!this.post_validate(r,false)){return false}if(this.isLast(r)&&j){p=this.insertRow({});p.cols.date.ip.disable().hide(true)}else{p=this.nextRow(r)}setTimeout(function(){q.focusRow(p,"payhead_name")},20);return true}});c.merge(app.IPS_ext,true);var f=new (app.Popup.extend({id:"salary_details_popup",head:"Salary Details",class_name:"_mw800x",events:{submit:"submit_form","click .op_btn":"submit_form"},model:app.models.Employee,beforeInit:function(){return true},render:function(j){var i;if(!j){this.form=new app.Form(_.extend({appendTo:this.$el.find(".popup_body"),class_name:"_mgbt_1em"},g));this.form.renderInputs();this.ip_sheet=new c({appendTo:this.$el.find(".popup_body")});this.ip_sheet.render()}var k=this.options.data;this.setMode("idle");this.current_tab=null;this.ip_sheet.release(true);this.form.reset();this.form.components.employee_name[k?"disable":"enable"]();if(k){this.form.set_values({employee_name:k.name});i=new app.models.Employee;i.inst=this;i.fetch({data:$.param({op:"get_salary_details",id:k.id}),success:function(l,n){l.inst.ip_sheet.load_data(n.items)}})}else{this.ip_sheet.insertRow({})}},after_get_values:function(i){var j;i.op="set_salary_det";i.items=this.ip_sheet.get_value_list()},after_request:function(k,i,j,l){var m=k.responseJSON;if(i=="success"){if($(l.target).hasClass("op_btn_snnx")){this.render(true);this.form.components.date.focus()}}this.ip_sheet.renderErrors(k)}}))();h={fields:{name:{head_label:"Name",width:"25%"},employee_code:{head_label:"Employee ID",width:"7%"},designation_name:{head_label:"Designation",width:"11%",url:"/designations/?name={{value}}&pagination=false"},department_name:{head_label:"Department",width:"12%",index:3,url:"/departments/?name={{value}}&pagination=false"},nationality:{head_label:"Nationality",width:"8%",url:"/list/nationalities/?q={{value}}",label_sel:"nationality"},date_of_join:{head_label:"Date of joining",width:"7%",index:5},contact_no:{head_label:"Contact No",width:"10%",index:5},email:{head_label:"Email",width:"20%",index:6}},show_items:["name","employee_code","designation_name","department_name","nationality","date_of_join","contact_no","email"],filter_enable:["name","employee_code","designation_name","department_name","nationality","date_of_join","contact_no","email"],ips_filter_enable:["employee_code","date_of_join"]};var e=app.Tab.extend({label:"Employees",tab_id:"employees",model:app.models.Employee,is_tab_view:true,heading:"Employee",ds_options:{flex_schema:h,ds_id:"ds_employees",enable_sorting:true,has_filter:true},popup:app.popups.Employee,initComponents:function(){var i=this,k,j;var k;this.context_menu_items=k=_.clone(this.context_menu_items);k.splice(1,0,{key:"set_salary_det",value:"Set Salary Details"});swap_obj_keys(this,"_context_item_click","context_item_click");this.init()},onshow:function(){if(!this.is_inited){this.initComponents();this.is_inited=true}this.$top_sec_el.show();app.TopButtons.set(["export"]);this.ds.load()},_context_item_click:function(k,i){var j;if(i=="set_salary_det"){j=this.ds.get_row(k);f.show({method:"create",invoker:this,callback:this.popup_callback,employee_id:k,data:j})}return this._context_item_click(k,i)}});e.merge(app.ListPageTemplate);if(AL.any_access("employees")){set_object("employee_man_tabs","employees_tab",e);FB_Module.init_fn(function(){app.SideMenu.add_item({item_id:"payroll",label:"Payroll",index:5});app.SideMenu.add_item({view:"employee_managment/employees",item_id:"employees",under:"payroll",label:"Employees"})})}});FB_Module.register({index:2},function(){var a={default_attr:{class_name:"_type1 _lg"},fields:{name:{type:"inputbox",id:"_mgbt_1em",label:"Name"},is_under:{type:"checkbox",id:"_mgbt_1em _comp_inline _mgrt_05em",label:"",value:"true",index:14,dlgTo:"scope"},under_name:{type:"combobox",id:"",label:"Under",class_name:"_type2 _lg _comp_inline _w20em _mgbt_1em",url:"/admin_wings/?name={{value}}&pagination=false",index:15},description:{type:"textarea",id:"",label:"Description"}},validation:{name:{required:true}}};app.popups.AdminWingPopup=new (app.Popup.extend({id:"admin_wing_popup",head:"Administrative Wing",class_name:"_w600px",model:app.models.AdminWing,events:{submit:"submit_form","click .op_btn":"submit_form","click .dept_pop_tab":"tab_clicked"},beforeInit:function(){return true},render:function(d){var e;if(!d){this.form=new app.Form(_.extend({appendTo:this.$el.find(".popup_body")},a));this.form.renderInputs();this.listenTo(this.form,"all",this.form_ev_handler)}e=this.options.data;this.setMode("idle");this.current_tab=null;if(e){e.is_under=(e.under_name!=null);this.form.set_values(e)}else{this.form.reset()}this.form_ev_handler("clicked",this.form.components.is_under,null)},form_ev_handler:function(f,d,g){if(f=="clicked"&&d.name=="is_under"){this.form.components.under_name[d.get_value()=="true"?"enable":"disable"]()}}}))();var c={name:{head_label:"Name",style:"width:35%",index:0},under_name:{head_label:"Under",style:"width:35%",index:0},description:{head_label:"Description",style:"width:30%",index:0}};var b=app.Tab.extend({label:"Administrative Wings",tab_id:"administrative_wings",model:app.models.AdminWing,is_tab_view:true,heading:"Administrative Wing",ds_options:{schema:c,ds_id:"ds_adminwing"},popup:app.popups.AdminWingPopup,initComponents:function(){var d=this;this.init()},onshow:function(){if(!this.is_inited){this.initComponents();this.is_inited=true}this.$top_sec_el.show();this.ds.load()}});b.merge(app.ListPageTemplate);if(AL.any_access("admin_wings")){set_object("employee_man_tabs","adminwing_tab",b)}});FB_Module.register({index:2},function(){var a={default_attr:{class_name:"_type1 _lg"},fields:{name:{type:"inputbox",id:"_mgbt_1em",label:"Department Name"},description:{type:"textarea",id:"_w30em",label:"Description"}},validation:{name:{required:true}}};app.popups.DepartmentPopup=new (app.Popup.extend({id:"department_popup",head:"Department",class_name:"_w600px",model:app.models.Department,events:{submit:"submit_form","click .op_btn":"submit_form","click .dept_pop_tab":"tab_clicked"},beforeInit:function(){return true},onshow:function(d){this.options=d.el.data("trigger_data");this._render()},render:function(d){var e;if(!d){this.form=new app.Form(_.extend({appendTo:this.$el.find(".popup_body")},a));this.form.renderInputs();this.listenTo(this.form,"all",this.form_ev_handler)}e=this.options.data;this.setMode("idle");this.current_tab=null;if(e){this.form.set_values(e)}else{this.form.reset()}}}))();var b={name:{head_label:"Name",style:"width:70%",index:0},description:{head_label:"Description",style:"width:30%",index:0}};var c=app.Tab.extend({label:"Departments",tab_id:"departments",model:app.models.Department,is_tab_view:true,heading:"Department",ds_options:{schema:b,ds_id:"ds_departments"},popup:app.popups.DepartmentPopup,initComponents:function(){var d=this;this.init()},onshow:function(){if(!this.is_inited){this.initComponents();this.is_inited=true}this.$top_sec_el.show();this.ds.load()}});c.merge(app.ListPageTemplate);if(AL.any_access("payroll")){set_object("employee_man_tabs","department_tab",c)}});FB_Module.register({index:2},function(){var a={default_attr:{class_name:"_type1 _lg"},fields:{name:{type:"inputbox",id:"_mgbt_1em",label:"Designation"},description:{type:"textarea",id:"_w20em",label:"Description"}},validation:{name:{required:true}}};app.popups.DesignationPopup=new (app.Popup.extend({id:"designation_popup",class_name:"_w600px",head:"Designation",model:app.models.Designation,events:{submit:"submit_form","click .op_btn":"submit_form","click .dept_pop_tab":"tab_clicked"},beforeInit:function(){return true},render:function(d){var e;if(!d){this.form=new app.Form(_.extend({appendTo:this.$el.find(".popup_body")},a));this.form.renderInputs();this.listenTo(this.form,"all",this.form_ev_handler)}e=this.options.data;this.setMode("idle");this.current_tab=null;if(e){this.form.set_values(e)}else{this.form.reset()}}}))();var c={name:{head_label:"Name",style:"width:20%",index:0},description:{head_label:"Description",style:"width:80%",index:0}};var b=app.Tab.extend({label:"Designations",tab_id:"designations",model:app.models.Designation,is_tab_view:true,heading:"Designation",ds_options:{schema:c,ds_id:"ds_designations"},popup:app.popups.DesignationPopup,initComponents:function(){var d=this;this.init()},onshow:function(){if(!this.is_inited){this.initComponents();this.is_inited=true}this.$top_sec_el.show();this.ds.load()}});b.merge(app.ListPageTemplate);if(AL.any_access("designations")){set_object("employee_man_tabs","designation_tab",b)}});FB_Module.register({index:2},function(){var d={default_attr:{class_name:"_type1 _lg _mgbt_1em"},fields:{name:{type:"inputbox",id:"",label:"Payhead Name"},item_type:{type:"selectbox",id:"_w8em",label:"Payhead Type",options:[{earning:"Earning"},{deduct:"Deduction"}],default_option:"",dlgTo:"scope"},la_group_account_name:{type:"combobox",id:"",label:"Liability Group Account",url:"/accounts/?name={{value}}&is_cntlacc=true&acc_type_in={{acc_type}}&pagination=false"},ex_group_account_name:{type:"combobox",id:"",label:"Expense Group Account",url:"/accounts/?name={{value}}&is_cntlacc=true&acc_type=expense&pagination=false"},grp_payheads:{type:"checkbox",id:"_comp_block",value:"true",label:"Group Payheads under this type when exported"},process_list_name:{type:"combobox",id:"",label:"Process List",url:"/payroll_process_lists/?name={{value}}&pagination=false"},description:{type:"textarea",id:"_w20em",label:"Description"}},validation:{name:{required:true}}};var h=gen_model("/payhead_types/");app.popups.PayheadType=new (app.Popup.extend({id:"payheadtype_popup",class_name:"_w600px",head:"Payhead Type",model:h,events:{"click .op_btn":"submit_form"},beforeInit:function(){return true},render:function(i){var j;if(!i){this.form=new app.Form(_.extend({appendTo:this.$el.find(".popup_body")},d));this.form.renderInputs();this.listenTo(this.form,"all",this.form_ev_handler)}j=this.options.data;this.setMode("idle");this.current_tab=null;if(j){this.form.set_values(j);this.form_ev_handler("changed",this.form.components.item_type,null)}else{this.form.reset();this.form.hide_comps(["ex_group_account_name","la_group_account_name"])}},form_ev_handler:function(j,i,k){var l;l=this.form.components;if(j=="changed"&&i.name=="item_type"){l.la_group_account_name.set_label(i.get_value()=="earning"?"Asset/Liability Group Account":"Asset/Liability Group Account");l.la_group_account_name.url_args={acc_type:i.get_value()=="earning"?"liability,asset":"liability,asset"};this.form[i.get_value()=="earning"?"show_comps":"hide_comps"](["ex_group_account_name"]);this.form.show_comps(["la_group_account_name"])}}}))();var g={name:{head_label:"Name",style:"width:20%",index:0},description:{head_label:"Description",style:"width:80%",index:0}};var b=app.Tab.extend({label:"Payhead Types",tab_id:"payhead_types",model:h,is_tab_view:true,heading:"Payhead Type",ds_options:{schema:g,ds_id:"ds_payheadtype"},popup:app.popups.PayheadType,initComponents:function(){var i=this;this.init()},onshow:function(){if(!this.is_inited){this.initComponents();this.is_inited=true}this.$top_sec_el.show();this.ds.load()}});b.merge(app.ListPageTemplate);var e={default_attr:{class_name:"_type1 _lg _mgbt_1em"},fields:{name:{type:"inputbox",id:"",label:"Payhead Name"},payhead_type_name:{type:"combobox",id:"_w20em",label:"Payhead Type",dlgTo:"scope",url:"/payhead_types/?name={{value}}&pagination=false"},use_for_gratuity:{type:"checkbox",id:"_comp_block",label:"Use for Calculation of Gratuity",value:"true"},calculation_type:{type:"selectbox",id:"_w10em",label:"Calculation type",default_option:"",dlgTo:"scope",options:[{fixed:"Fixed"},{on_attendance:"On Attendance"},{on_production:"On Production"},{manual:"Manual"}]},ap_type_name:{type:"combobox",id:"_w15em",label:"Production Type",url:"/ap_types/?name={{value}}&item_type=prod&pagination=false"},calculation_period:{type:"selectbox",id:"_w10em",label:"Calculation period",default_option:"",options:[{months:"Months"},{days:"Days"}]},is_mandatory:{type:"checkbox",value:"true",id:"_comp_block",label:"Is this Payhead mandatory?"},display_order:{type:"inputbox",id:"_w12em",label:"Display order"},description:{type:"textarea",id:"_w20em",label:"Description"}},validation:{}};var a=gen_model("/payheads/");app.popups.Payhead=new (app.Popup.extend({id:"payhead_popup",class_name:"_w600px",head:"Payhead",model:a,events:{"click .op_btn":"submit_form"},beforeInit:function(){return true},render:function(i){var j;if(!i){this.form=new app.Form(_.extend({appendTo:this.$el.find(".popup_body")},e));this.form.renderInputs();this.listenTo(this.form,"all",this.form_ev_handler)}j=this.options.data;this.setMode("idle");this.current_tab=null;if(j){this.form.set_values(j)}else{this.form.reset()}this.form_ev_handler("changed",this.form.components.calculation_type)},form_ev_handler:function(l,i,m){var k,j;k=this.form.components;if(l=="item_selected"&&i.name=="payhead_type_name"){j=i.get_selected_data();k.calculation_type[j.item_type=="deduct"?"hide":"show"]()}else{if(l=="changed"&&i.name=="calculation_type"){k.ap_type_name[i.get_value()=="on_production"?"show":"hide"]();k.calculation_period[i.get_value()=="on_attendance"?"show":"hide"]()}}}}))();var f={name:{head_label:"Name",style:"width:20%",index:0},description:{head_label:"Description",style:"width:80%",index:0}};var c=app.Tab.extend({label:"Payheads",tab_id:"payheads",model:a,is_tab_view:true,heading:"Payhead",ds_options:{schema:f,ds_id:"ds_payhead"},popup:app.popups.Payhead,initComponents:function(){var i=this;this.init()},onshow:function(){if(!this.is_inited){this.initComponents();this.is_inited=true}this.$top_sec_el.show();this.ds.load()}});c.merge(app.ListPageTemplate);if(AL.any_access("payroll")){set_object("payrollmasters_tabs","payheadtype_tab",b);set_object("payrollmasters_tabs","payhead_tab",c)}});FB_Module.register({index:2},function(){var b={default_attr:{class_name:"_type1 _lg"},fields:{name:{type:"inputbox",id:"_mgbt_1em",label:"Name"},description:{type:"textarea",id:"_w20em",label:"Description"}},validation:{name:{required:true}}};var e=gen_model("/workunits/");var a=new (app.Popup.extend({id:"workunits_popup",class_name:"_w600px",head:"Units of Work",model:e,events:{submit:"submit_form","click .op_btn":"submit_form","click .dept_pop_tab":"tab_clicked"},beforeInit:function(){return true},render:function(f){var g;if(!f){this.form=new app.Form(_.extend({appendTo:this.$el.find(".popup_body")},b));this.form.renderInputs();this.listenTo(this.form,"all",this.form_ev_handler)}g=this.options.data;this.setMode("idle");this.current_tab=null;if(g){this.form.set_values(g)}else{this.form.reset()}}}))();var d={name:{head_label:"Name",style:"width:20%",index:0},description:{head_label:"Description",style:"width:80%",index:0}};var c=app.Tab.extend({label:"Units of Work",tab_id:"units_of_work",model:e,is_tab_view:true,heading:"Unit",ds_options:{schema:d,ds_id:"ds_workunits"},popup:a,initComponents:function(){var f=this;this.init()},onshow:function(){if(!this.is_inited){this.initComponents();this.is_inited=true}this.$top_sec_el.show();this.ds.load()}});c.merge(app.ListPageTemplate);if(AL.any_access("payroll")){set_object("payrollmasters_tabs","workunits_tab",c)}});FB_Module.register({index:2},function(){var b={default_attr:{class_name:"_type1 _lg"},fields:{name:{type:"inputbox",id:"_mgbt_1em",label:"Name"},item_type:{type:"selectbox",label:"Type",id:"_w15em _mgbt_1em",default_option:"",options:[{attn:"Attendance"},{lwpy:"Leave with pay"},{lwop:"Leave without pay"},{prod:"Production"}],dlgTo:"scope"},unit_name:{type:"combobox",url:"/workunits/?name={{value}}&pagination=false",label:"Unit",id:"_w10em _mgbt_1em"},description:{type:"textarea",id:"_w20em",label:"Description"}},validation:{name:{required:true}}};var c=gen_model("/ap_types/");var a=new (app.Popup.extend({id:"aptype_popup",class_name:"_w600px",head:"Attendance/Production Type",model:c,events:{submit:"submit_form","click .op_btn":"submit_form","click .dept_pop_tab":"tab_clicked"},beforeInit:function(){return true},render:function(g){var h,f;if(!g){this.form=new app.Form(_.extend({appendTo:this.$el.find(".popup_body")},b));this.form.renderInputs();this.listenTo(this.form,"all",this.form_ev_handler)}h=this.options.data;this.setMode("idle");this.current_tab=null;f=this.form.components.unit_name;if(h){f[h.item_type=="prod"?"show":"hide"]();this.form.set_values(h)}else{this.form.reset();f.hide()}},form_ev_handler:function(g,f,h){if(g=="changed"){this.form.components.unit_name[f.get_value()=="prod"?"show":"hide"]()}}}))();var e={name:{head_label:"Name",style:"width:20%",index:0},description:{head_label:"Description",style:"width:80%",index:0}};var d=app.Tab.extend({label:"Attendance/Production Types",tab_id:"attendace_types",model:c,is_tab_view:true,heading:"Attendance/Production Type",ds_options:{schema:e,ds_id:"ds_aptypes"},popup:a,initComponents:function(){var f=this;this.init()},onshow:function(){if(!this.is_inited){this.initComponents();this.is_inited=true}this.$top_sec_el.show();this.ds.load()}});d.merge(app.ListPageTemplate);if(AL.any_access("attendance")){set_object("payrollmasters_tabs","aptypes_tab",d)}});FB_Module.register({index:2},function(){var d={employee_name:{head_label:"Employee Name",width:40,index:10,ip_options:{type:"combobox",id:"",label:"Employee Name",dlgTo:"scope",url:"/employees/?name={{value}}&pagination=false"}},employee_code:{head_label:"Employee ID",width:15,index:10,ip_options:{type:"inputbox",id:"",label:"Employee ID",dlgTo:"scope",disabled:true}},ap_type_name:{head_label:"Attendance/Production Type",width:30,index:10,ip_options:{type:"combobox",id:"",label:"Attendance/Production Type",dlgTo:"scope",url:"/ap_types/?name={{value}}&pagination=false"}},value:{head_label:"Value",width:10,index:10,ip_options:{type:"inputbox",id:"",label:"Value",dlgTo:"scope"}},unit_name:{head_label:"Unit",width:10,ip_options:{type:"inputbox",id:"",label:"Unit",dlgTo:"scope",disabled:true}},attendance_dates:{head_label:"Dates",width:50,ip_options:{type:"inputbox",id:"",label:"Dates",dlgTo:"scope",disabled:true}}};var b={};var c={default_attr:{class_name:"_type1 _sm2 _comp_inline _mgrt_1em"},fields:{doc_no:{type:"inputbox",id:"_w10em _mgtp_3x",label:"Doc No"},date:{type:"datefield",id:"_w7em _mgtp_2x",label:"Date",dlgTo:"scope"},autofill_btn:{type:"button",class_name:"_type1 _theme1 _sm2 _comp_inline",id:"_w10em _mgtp_10x",dlgTo:"scope",label:"Autofill"}},validation:{}};var e=gen_model("/attendance/");app.popups.Att_AutoFill=new (app.Popup.extend({id:"att_autofill_popup",class_name:"_w600px",head:"Attendance Auto Fill",events:{"click .op_btn":"submit_form"},beforeInit:function(){return true},render:function(h){var j,g;g={default_attr:{class_name:"_type1 _md _mgbt_1em"},fields:{all_depts:{type:"checkbox",id:"",label:"All Departments",value:"true",dlgTo:"scope"},department_name:{type:"combobox",id:"",label:"Department",url:"/departments/?name={{value}}&pagination=false"},ap_type_name:{type:"combobox",id:"",label:"Attendance/Production Type",dlgTo:"scope",url:"/ap_types/?name={{value}}&pagination=false"}},validation:{ap_type_name:{required:true}}};if(!h){this.form=new app.Form(_.extend({appendTo:this.$el.find(".popup_body")},g));this.form.renderInputs();this.$el.find(".popup_body").append('<div class="error_cnt"></div>');this.listenTo(this.form,"all",this.form_ev_handler)}this.setMode("idle");this.$el.find(".error_cnt").html("");this.form.set_values({all_depts:true});this.form_ev_handler("clicked",this.form.components.all_depts)},form_ev_handler:function(h,g,j){if(g.name=="all_depts"&&h=="clicked"){this.form.components.department_name[g.get_value()=="true"?"hide":"show"]()}},submit_form:function(h){var g,j;g=this.options;j=this.form.validate();if(!_.isEmpty(j)){this.form.renderErrors(j,true);return}g.callback.call(g.invoker,this,this.form.get_values(true))}}))();var f=app.IPS.extend({after_init:function(g){this.listenTo(this,"all",this.ips_event_handler);this.parent=g.parent;this.vald_form=new app.Form({el:this.$el,validation:g.validation})},set_height:function(j){var h,g,m,l,k;h=this.$el.closest(".component.popup");g=h.outerHeight();m=0;k=h.children();for(l=0;l<k.length;l++){if($(k[l]).prop("tagName")!="BUTTON"){m+=$(k[l]).outerHeight()}}k={height:g-(m-this.$el.find(".table_listcnt").outerHeight()),overflowY:"auto"};if(j&&j.callback){j.callback(k)}else{this.$el.find(".table_listcnt").css(k)}},set_schema:function(l,k){var j;var g=new (gen_model("/ap_types/"));var h=this;k=k||h;g.fetch({success:function(p,o){var n,q,m,s,r;r=_.pick(d,["employee_code","employee_name"]);n=o.items;for(q=0,m=n.length;q<m;q++){s=n[q];r["c_"+s.id]={head_label:s.name,width:10,index:10+q,ip_options:{type:"inputbox",id:"",label:"Value",dlgTo:"scope"}}}h.schema=r;l.call(k,o)},error:function(m,n){}})},load_data:function(g){var h,k,j;if(g.length){for(h in g){j=g[h];k=this.insertRow({});k.data=j;this.set_values(k,j,["employee_name","employee_code","ap_type_name","value","unit_name","attendance_dates"]);k.cols.attendance_dates.ip[j.ap_type_itype=="prod"?"disable":"enable"]()}}else{this.insertRow({})}},release:function(){this.__proto__.__proto__.release.apply(this,arguments)},backspace_pressed:function(j,h,g){if(j.cols[g].ip.type=="combobox"){j.cols[g].ip.hide_dropdown()}if(j.cols[g].ip.get_value()==""){if(j.dclick_flag==true){if(this.rows.length>1){this.deleteRow(j)}this.rows[h!=0?h-1:0].cols[g].ip.focus()}else{this.reset_row(j);j.dclick_flag=true;setTimeout(function(){j.dclick_flag=false},200)}}},validate_row:function(k,h){var m=this.get_components(k),g=this,j,l;this.vald_form.components=m;if(m.employee_name.get_value()==""&&this.rows.length>1&&this.isLast(k)){this.parent.$el.find(".op_btn_snnx").focus();return"outfocus"}else{l=this.vald_form.validate();this.vald_form.renderErrors(l);if(l){this.focusColumn(k,Object.keys(l)[0]);return false}if(this.isLast(k)&&h){j=this.insertRow({})}else{j=this.nextRow(k)}setTimeout(function(){g.focusRow(j)},20)}return true},updown_arrow_pressed:function(j,g,h){if(h.keyCode==40&&!this.isLast(j)){this.nextRow(j).cols[g].ip.focus(true)}else{if(h.keyCode==38&&this.getRowIndex(j)>0){this.prevRow(j).cols[g].ip.focus(true)}}},renderErrors:function(g){var k,j,h;for(i in g){h=this.rows[i];k=this.get_components(h);h.errors=g[i];this.vald_form.components=k;this.vald_form.renderServerErrors(null,g[i])}},ips_event_handler:function(k,j,h,l,n){var m,g;m=this.rows[j];switch(k){case"popup_show":this.set_height(n);break;case"keydown":if((l.keyCode==38||l.keyCode==40)){this.updown_arrow_pressed(m,h,l)}break;case"text_changed":if(h=="employee_name"){g=l.keyCode;if(g==8){this.backspace_pressed(m,j,h)}}break;case"enterkey_press":if(this.focusColumn(m,h,"next",true,{select:true})==false){this.validate_row(m,true)}break;case"item_selected":if(h=="employee_name"){g=n.comp.get_selected_data();m.cols.employee_code.ip.set_value(g.employee_code)}else{if(h=="ap_type_name"){g=n.comp.get_selected_data();m.cols.unit_name.ip.set_value(g.unit_name);m.cols.attendance_dates.ip[g.item_type=="prod"?"disable":"enable"]()}}break}}});app.popups.Attendance=new (app.Popup.extend({id:"attendance_popup",wrap_class:"ps_popup_wrap",doc_type:"attendance",head:"Attendance",show_save_n_next:true,model:e,events:{submit:"submit_form","click .op_btn":"submit_form"},beforeInit:function(){return true},reset:function(){this.form.reset();this.ip_sheet.release(true)},render:function(h){var j,g;g=this;if(!h){g.form=new app.Form(_.extend({appendTo:g.$el.find(".popup_body"),class_name:"sp_popup_form"},c));g.form.renderInputs();g.ip_sheet=new f({ips_id:"item_attenips",class_name:"item_ip_sheet _type3",ip_defaults:{class_name:"_sm _type2"},appendTo:g.$el.find(".popup_body"),schema:d,validation:b,parent:g});if(get_cfg("attendance_mode")=="daily"){g.ip_sheet.set_schema(function(){g.post_render(h)},g)}else{g.post_render(h)}}else{g.post_render(h)}},post_render:function(k){var l,h;h=this;if(!k){h.ip_sheet.render();h.on("after_show",function(){h.ip_sheet.trigger("popup_show")});h.listenTo(h.ip_sheet,"all",h.ips_event_handler);h.listenTo(h.form,"all",h.form_ev_handler)}l=h.options.data;h.setMode("idle");h.current_tab=null;h.reset();app.set_docno_field(h.doc_type,h.form);var j,g;if(h.options.method=="update"){h.form.set_values(_.pick(l,["doc_no","date"]));h.ip_sheet.load_data(l.item_data)}else{tmp2=h.form.components.doc_no;tmp1=app.get_new_voucher_date();if(tmp2.disabled){tmp2.set_value()}h.ip_sheet.insertRow({});h.form.reset(null,["doc_no"]);h.form.set_values({doc_no:app.generate_doc_no(this.doc_type,tmp1,1,true),date:tmp1})}},after_get_values:function(h){var g;g=this;h.items=g.ip_sheet.get_value_list();_.extend(h,g.extra_det);if(g.options.method=="update"){h.voucher_id=h.id=g.options.data.voucher_id}},after_request:function(j,g,h,k){var l=j.responseJSON;if(g=="success"){app.set_last_no(j);if($(k.target).hasClass("op_btn_snnx")){this.render(true);this.form.components.date.focus()}}if(g=="error"&&l&&l.errors&&l.errors.item_errors){this.ip_sheet.renderErrors(l.errors.item_errors)}},autofill_callback:function(g){this.ip_sheet.set_value_list(g.items)},form_ev_handler:function(p,l,n){var k,s,j,h,g,r,o,t;t=this;k=t.form.components;if(p=="keyup"&&l.name=="date"){var q,m;if(k.doc_no.disabled){o=app.generate_doc_no;h=t.doc_type;m=t.options.data;q=l.get_value();g=t.options.method=="create"?o(h,q,1,true):m.doc_no;k.doc_no.set_value(g)}}else{if(p=="clicked"&&l.name=="autofill_btn"){app.popups.Att_AutoFill.show({invoker:t,callback:function(y,x){var v,w,u;x.op="get_autofill_data";u=this.form.get_values(null,["date"]);x.date=u.date;w=this;v=new Backbone.Model;v.url="/attendance/";v.fetch({data:$.param(x),success:function(A,z){y.$el.find(".error_cnt").html();w.autofill_callback(z);y.close()},error:function(A,D){var F,z,B,E,C;F=get_error_obj(D);y.$el.find(".error_cnt").html();if(F&&(F.item_errors||F.department_name)){if(F.item_errors){z="<ul>";E=F.item_errors;for(B in E){z+='<li class="error_item _'+E[B][1]+'">'+E[B][0]+"</li>"}y.$el.find(".error_cnt").html(z)}if(F.department_name){y.form.renderServerErrors(F)}}else{y.close();w.form.renderServerErrors(D)}}})}})}}},ips_event_handler:function(k,j,h,l,g){}}))();var a={doc_no:{head_label:"Inv #",style:"width:15%",index:0},date:{head_label:"Date",style:"width:10%",index:0},description:{head_label:"Description",style:"width:75%",index:0}};app.p_views.AttendanceRegister=app.ListPageTemplate.extend({page_name:"attendance_register",model:e,ds_options:{head:"Attendance Register",class_name:"hoverable ds_with_head",ds_id:"attendance_ds",schema:a,default_params:{inc_item_data:true}},header_btns:[],popup:app.popups.Attendance,heading:"Attendance",heading_plural:"Attendance Register",edit_voucher:function(g,h){this.popup.show({method:"update",invoker:this,callback:h,data:g})},initialize:function(){this.init({create_el:true})}});if(AL.any_access("attendance")){FB_Module.init_fn(function(){app.SideMenu.add_item({item_id:"payroll",label:"Payroll",index:5,is_disabled:!AL.any_access("admin_wings","designations","attendance","payroll","payroll_payment","employees")});app.SideMenu.add_item({view:"attendance_register",item_id:"attendance_reg",index:90,under:"payroll",label:"Attendance Register",replace:true,is_disabled:!AL.any_access("payroll")})})}});FB_Module.register({index:2},function(){var b={default_attr:{class_name:"_type1 _lg"},fields:{name:{type:"inputbox",id:"_mgbt_1em",label:"Name"},calculation_period:{type:"selectbox",id:"_mgbt_1em",label:"Calculation Period",options:[{daily:"Daily"},{weekly:"Weekly"},{monthly:"Monthly"}],default_option:""},description:{type:"textarea",id:"_w20em",label:"Description"}},validation:{name:{required:true}}};var d=gen_model("/payroll_process_lists/");var a=new (app.Popup.extend({id:"proll_plist_popup",class_name:"_w600px",head:"Payroll Process List",model:d,events:{submit:"submit_form","click .op_btn":"submit_form"},beforeInit:function(){return true},render:function(f){var g;if(!f){this.form=new app.Form(_.extend({appendTo:this.$el.find(".popup_body")},b));this.form.renderInputs();this.listenTo(this.form,"all",this.form_ev_handler)}g=this.options.data;this.setMode("idle");this.current_tab=null;if(g){this.form.set_values(g)}else{this.form.reset()}}}))();var e={name:{head_label:"Name",style:"width:20%",index:0},description:{head_label:"Description",style:"width:80%",index:0}};var c=app.Tab.extend({label:"Process Lists",tab_id:"process_lists",model:d,is_tab_view:true,heading:"Process List",ds_options:{schema:e,ds_id:"ds_payroll_plist"},popup:a,initComponents:function(){var f=this;this.init()},onshow:function(){if(!this.is_inited){this.initComponents();this.is_inited=true}this.$top_sec_el.show();this.ds.load()}});c.merge(app.ListPageTemplate);if(AL.any_access("payroll")){set_object("payrollmasters_tabs","process_list_tab",c)}});FB_Module.register({index:2},function(){var h={employee_name:{head_label:"Employee Name",width:20,index:1,ip_options:{type:"combobox",id:"_comp_employee_name",label:"Employee Name",dlgTo:"scope",url:"/employees/?name={{value}}&excl_names={{excl_names}}&pagination=false"}},employee_code:{head_label:"Employee ID",width:10,index:2,ip_options:{type:"inputbox",id:"",label:"Employee Id",disabled:true,dlgTo:"scope"}},gross_total:{head_label:"Gross Total",width:8,index:50,ip_options:{type:"inputbox",id:"",label:"Gross Total",disabled:true,dlgTo:"scope"}},total_deduction:{head_label:"Total Deduction",width:8,index:100,ip_options:{type:"inputbox",id:"",label:"Total Deductions",disabled:true,dlgTo:"scope"}},net_total:{head_label:"Net Total",width:8,index:101,ip_options:{type:"inputbox",id:"",label:"Net Total",disabled:true,dlgTo:"scope"}}};var a={};var b={default_attr:{class_name:"_type1 _sm2 _comp_inline _mgrt_1em"},fields:{doc_no:{type:"inputbox",id:"_w8em _mgtp_3x",label:"Doc No"},from_date:{type:"datefield",id:"_w7em _mgrt_1em _mgtp_2x",label:"From Date"},date:{type:"datefield",id:"_w7em _mgrt_1em _mgtp_2x",label:"To Date",dlgTo:"scope"},process_list_name:{type:"combobox",label:"Process List",url:"/payroll_process_lists/",dlgTo:"scope",id:"_w10em _mgrt_1em"},autofill_btn:{type:"button",class_name:"_type1 _theme1 _sm2 _comp_inline",id:"_w10em _mgtp_10x",dlgTo:"scope",label:"Autofill Payroll"}},validation:{}};var c=gen_model("/payrolls/");var g=app.IPS.extend({after_init:function(j){this.listenTo(this,"all",this.ips_event_handler);this.parent=j.parent;this.vald_form=new app.Form({el:this.$el,validation:j.validation})},set_schema:function(n,o,l){var j=new (gen_model("/payheads/"));var k=this;l=l||k;j.fetch({data:$.param({plist_name:n}),success:function(r,q){var p,s,m,u,t;t=_.clone(h);p=q.items.sort(function(w,v){return w.display_order-v.display_order});for(s=0,m=p.length;s<m;s++){u=p[s];if(u.item_type=="deduct"){t["la_"+u.id]={head_label:u.payhead_type_name,width:10,index:3+50+s,ip_options:{type:"inputbox",id:"",label:"",dlgTo:"scope",extra:u.item_type,disabled:true}}}t["ph_"+u.id]={head_label:u.name,width:10,index:3+(u.item_type=="deduct"?50+s*2:s),ip_options:{type:"inputbox",id:"",label:"",dlgTo:"scope",extra:u.item_type}}}k.schema=t;o.call(l,q)},error:function(m,p){}})},set_height:function(l){var k,j,o,n,m;k=this.$el.closest(".component.popup");j=k.outerHeight();o=0;m=k.children();for(n=0;n<m.length;n++){if($(m[n]).prop("tagName")!="BUTTON"){o+=$(m[n]).outerHeight()}}m={height:j-20-(o-this.$el.find(".table_listcnt").outerHeight()),overflowY:"auto"};if(l&&l.callback){l.callback(m)}else{this.$el.find(".table_listcnt").css(m)}},load_data:function(k){var l,n,m,j;if(k.length){for(l in k){m=k[l];this.insertRow(m)}}else{this.insertRow({})}},release:function(){this.__proto__.__proto__.release.apply(this,arguments)},backspace_pressed:function(o,l){var m=[],j,k,n;if(o.cols[l].ip.type=="combobox"){o.cols[l].ip.hide_dropdown()}if(o.cols[l].ip.get_value()==""){if(o.dclick_flag==true){if(this.rows.length>1){this.deleteRow(o)}}else{this.reset_row(o);o.dclick_flag=true;setTimeout(function(){o.dclick_flag=false},200)}}},validate_row:function(m,k){var o=this.get_components(m),j=this,l,n;this.vald_form.components=o;if(o.employee_name.get_value()==""&&this.rows.length>1&&this.isLast(m)){this.parent.$el.find(".op_btn_snnx").focus();return"outfocus"}else{n=this.vald_form.validate();this.vald_form.renderErrors(n);if(n){this.focusColumn(m,Object.keys(n)[0]);return false}if(this.isLast(m)&&k){l=this.insertRow({})}else{l=this.nextRow(m)}setTimeout(function(){j.focusRow(l,"employee_name")},20)}return true},updown_arrow_pressed:function(l,j,k){if(k.keyCode==40&&!this.isLast(l)){this.nextRow(l).cols[j].ip.focus(true)}else{if(k.keyCode==38&&this.getRowIndex(l)>0){this.prevRow(l).cols[j].ip.focus(true)}}},renderErrors:function(j){var m,l,k;for(i in j){k=this.rows[i];m=this.get_components(k);k.errors=j[i];this.vald_form.components=m;this.vald_form.renderServerErrors(null,j[i])}},update_amount:function(l){var n,j,k,m;n=this.rows[l];k=[0,0];for(j in n.cols){if(j.lastIndexOf("ph_",0)==0){m=n.cols[j].ip.extra=="deduct"?1:0;k[m]+=Number(n.cols[j].ip.get_value())}}n.cols.gross_total.ip.set_value(k[0]);n.cols.total_deduction.ip.set_value(k[1]);n.cols.net_total.ip.set_value(k[0]-k[1])},update_excl_names:function(l,k){var m,j,n;j=_.map(this.rows,function(p){var o=p.cols.employee_name.ip.get_value();if(o!=""){return o}else{return null}});m=k?this.rows:[this.rows[l]];for(i=0;i<m.length;i++){n=_.filter(j,function(o,p){return o!=null&&p!=l});m[i].cols.employee_name.ip.url_args={excl_names:n.join("|")}}},ips_event_handler:function(r,q,l,p,n){var t,o,m,j,k,s;t=this.rows[q];switch(r){case"row_insert":this.update_excl_names(q);this.update_amount(q);break;case"popup_show":this.set_height(n);break;case"keydown":if((p.keyCode==38||p.keyCode==40)){this.updown_arrow_pressed(t,l,p)}break;case"text_changed":if(l=="employee_name"||l=="employee_code"){o=p.keyCode;if(o==8){this.backspace_pressed(t,l)}}else{if(l.lastIndexOf("ph_",0)===0){this.update_amount(q);this.parent.update_total()}}break;case"enterkey_press":if(l=="value"){o=this.validate_row(t,true);if(o=="outfocus"){p.preventDefault()}}else{if(this.focusColumn(t,l,"next",true,{select:true})==false){this.validate_row(t,true)}}break;case"item_selected":if(l=="employee_name"){this.update_excl_names(q,true);m=n.comp.get_selected_data();t.cols.employee_code.ip.set_value(m.employee_code);o=new c;k=this.parent.form.components;s=this;o.fetch({data:$.param({op:"get_autofill_data",from_date:k.from_date.get_value(),to_date:k.date.get_value(),process_list_name:k.process_list_name.get_value(),employee_code:m.employee_code}),success:function(u,v){var y,w,x;y=v.items[0].payheads;for(w in y){x=y[w];t.cols[(x.item_type=="deduct"?"la_":"ph_")+y[w].payhead_id].ip.set_value(y[w].amount)}s.update_amount(q)}})}break}}});app.popups.Payroll=new (app.Popup.extend({id:"payroll_popup",wrap_class:"ps_popup_wrap",doc_type:"payroll",head:"Payroll",show_save_n_next:true,model:c,events:{"click .op_btn":"submit_form"},beforeInit:function(){return true},reset:function(){this.form.reset();this.ip_sheet.release()},extra_det_clicked:function(j){ExtraDetPopup.show({invoker:this})},render:function(k){var l,m,j;j=this;if(!k){this.form=new app.Form(_.extend({appendTo:this.$el.find(".popup_body"),class_name:"sp_popup_form"},b));this.form.renderInputs();this.ip_sheet=new g({ips_id:"item_payrollips",class_name:"item_ip_sheet _type3",ip_defaults:{class_name:"_sm _type2"},appendTo:this.$el.find(".popup_body"),validation:a,parent:this});this.$el.find(".popup_body").append('<div class="price_cnt"><div class="price_cnt_innr"><div class="price_cnt_left"></div><div class="price_cnt_right"><span class="price_cnt_li _grosstotal"><span class="price_cnt_label">Gross Total : </span><span class="price_cnt_amount">0.00</span></span><br><span class="price_cnt_li _discount"><span class="price_cnt_label">Total Deductions : </span><span class="price_cnt_amount">0.00</span></span><br><span class="_total">Net Total : <span>0.00</span></span></div></div></div>');this.$el.find(".popup_footer").prepend('<button class="component btn _md _type1 _theme1 float_left extra_det_btn" type="button">Additional Details</button>');this.on("after_show",function(){this.ip_sheet.trigger("popup_show")});this.listenTo(this.ip_sheet,"all",this.ips_event_handler);this.listenTo(this.form,"all",this.form_ev_handler)}l=this.options.data;this.setMode("idle");this.current_tab=null;this.reset();app.set_docno_field(this.doc_type,this.form);if(this.options.method=="update"){m=_.mapObject(l.data,function(o,n){return o.value});this.form.set_values(_.pick(m,["doc_no","from_date","date","process_list_name"]));this.ip_sheet.set_schema(m.process_list_name,function(){j.post_render(l)})}else{tmp2=this.form.components.doc_no;tmp1=app.get_new_voucher_date();if(tmp2.disabled){tmp2.set_value()}this.form.reset(null,["doc_no"]);this.form.set_values({doc_no:app.generate_doc_no(this.doc_type,tmp1,1,true),date:tmp1})}},update_total:function(){var k,n,l,o,m,j;k=this;m=0;j=0;for(l in k.ip_sheet.rows){o=k.ip_sheet.rows[l];amount=Number(o.cols.gross_total.ip.get_value());if(!isNaN(amount)){m+=amount}amount=Number(o.cols.total_deduction.ip.get_value());if(!isNaN(amount)){j+=amount}}n=k.$el.find(".price_cnt");n.find("._grosstotal > .price_cnt_amount").text(to_money(m));n.find("._discount > .price_cnt_amount").text(to_money(j));n.find("._total > span").text(to_money(m-j))},post_render:function(l){var k,j;this.ip_sheet.render();if(this.options.method=="update"){this.ip_sheet.load_data(l.items)}else{this.ip_sheet.insertRow({})}},after_get_values:function(j){j.items=this.ip_sheet.get_value_list();_.extend(j,this.extra_det);if(this.options.method=="update"){j.voucher_id=j.id=this.options.data.voucher_id}},after_request:function(l,j,k,m){var n=l.responseJSON;if(j=="success"){app.set_last_no(l);if($(m.target).hasClass("op_btn_snnx")){this.render(true);this.form.components.date.focus()}}if(j=="error"&&n&&n.errors&&n.errors.item_errors){this.ip_sheet.renderErrors(n.errors.item_errors)}},autofill_callback:function(l){var n,m,k,o,p;this.ip_sheet.release(true);k=l.items;for(n=0;n<k.length;n++){o=k[n];for(m in o.payheads){p=o.payheads[m];o[(p.item_type=="deduct"?"la_":"ph_")+p.payhead_id]=p.amount}this.ip_sheet.insertRow(o)}},form_ev_handler:function(r,n,p){var m,u,l,k,j,t,q;m=this.form.components;if(r=="clicked"){app.popups.AutoFill.show({invoker:this,callback:function(z,y){var w,x,v;y.op="get_autofill_data";v=this.form.get_values(null,["from_date","date","process_list_name"]);y.process_list_name=v.process_list_name;y.from_date=v.from_date;y.to_date=v.date;x=this;w=new Backbone.Model;w.url="/payrolls/";w.fetch({data:$.param(y),success:function(B,A){z.$el.find(".error_cnt").html();x.autofill_callback(A);z.close()},error:function(B,E){var G,A,C,F,D;G=get_error_obj(E);z.$el.find(".error_cnt").html();if(G&&(G.item_errors||G.department_name)){if(G.item_errors){A="<ul>";F=G.item_errors;for(C in F){A+='<li class="error_item _'+F[C][1]+'">'+F[C][0]+"</li>"}z.$el.find(".error_cnt").html(A)}if(G.department_name){z.form.renderServerErrors(G)}}else{z.close();x.form.renderServerErrors(E)}}})}})}else{if(r=="item_selected"&&n.name=="process_list_name"){this.ip_sheet.release();this.ip_sheet.set_schema(n.get_value(),function(){this.ip_sheet.render();this.ip_sheet.insertRow({});this.ip_sheet.set_height({})},this)}else{if(r=="keyup"&&n.name=="date"){var s,o;if(m.doc_no.disabled){q=app.generate_doc_no;k=this.doc_type;o=this.options.data;s=n.get_value();j=this.options.method=="create"?q(k,s,1,true):o.doc_no;m.doc_no.set_value(j)}}}}},ips_event_handler:function(m,l,k,n,j){}}))();var e={default_attr:{class_name:"_type1 _md _mgbt_1em"},fields:{all_depts:{type:"checkbox",id:"",label:"All Departments",value:"true",dlgTo:"scope"},department_name:{type:"combobox",id:"",label:"Department",url:"/departments/?name={{value}}&pagination=false"}},validation:{}};app.popups.AutoFill=new (app.Popup.extend({id:"autofill_popup",class_name:"_w600px",head:"Auto Fill",events:{submit:"submit_form","click .op_btn":"submit_form"},beforeInit:function(){return true},render:function(j){var k;if(!j){this.form=new app.Form(_.extend({appendTo:this.$el.find(".popup_body")},e));this.form.renderInputs();this.$el.find(".popup_body").append('<div class="error_cnt"></div>');this.listenTo(this.form,"all",this.form_ev_handler)}this.setMode("idle");this.$el.find(".error_cnt").html("");this.form.set_values({all_depts:true});this.form_ev_handler("clicked",this.form.components.all_depts)},form_ev_handler:function(k,j,l){if(j.name=="all_depts"&&k=="clicked"){this.form.components.department_name[j.get_value()=="true"?"hide":"show"]()}},submit_form:function(k){var j,l;j=this.options;l=this.form.validate();if(!_.isEmpty(l)){this.form.renderErrors(l,true);return}j.callback.call(j.invoker,this,this.form.get_values(true))}}))();var f={doc_no:{head_label:"Doc #",style:"width:8%",index:0},from_date:{head_label:"From Date",style:"width:9%",index:0},date:{head_label:"To Date",style:"width:9%",index:0},particulars:{head_label:"Particulars",style:"width:64%",index:0},amount:{head_label:"Amount",type:"money",style:"width:10%;text-align:right",index:0,prefix:app.appdata.currency_symbol}};var d={employee_name:{head_label:"Employee Name",style:"width:20%",index:1},employee_code:{head_label:"Employee Code",style:"width:10%",index:2},amount:{head_label:"Amount",type:"money",style:"width:10%;text-align:right",index:100,prefix:"{currency}"}};app.p_views.PayrollRegister=app.ListPageTemplate.extend({page_name:"payroll_register",model:c,disable_menu:true,ds_options:{idAttr:"voucher_id",head:"Payroll Register",class_name:"hoverable ds_with_head",ds_id:"payroll_ds",schema:f},drill_to_view:"voucher",popup:app.popups.Payroll,header_btns:[],heading:"Payroll",heading_plural:"Payroll Register",edit_voucher:function(j,k){this.popup.show({method:"update",invoker:this,callback:k,data:j})},render_voucher:function(o,u){var q,t,j,v,r,p,k,s,n,m,l;s=u.item_ds.schema=_.clone(d);q=2;for(t in o.payheads){s[t]={head_label:o.payheads[t],type:"money",style:"width:10%;text-align:right",index:q,prefix:"{currency}"},q++}s.employee_name.style="width:"+(100-(20+(q-2)*10))+"%";k=u.item_ds;k.rows=o.items;k.$el.show();k.render();l=k.$el.find(".table_list > li");for(q in k.rows){n=k.rows[q];m=l.eq(q).addClass(n.item_type)}if(o.transactions){u.transaction_ds.$el.show();u.transaction_ds.rows=o.transactions;u.transaction_ds.render()}},initialize:function(){this.init({create_el:true})}});if(AL.any_access("payroll")){FB_Module.init_fn(function(){app.SideMenu.add_item({item_id:"payroll",label:"Payroll",index:5});app.SideMenu.add_item({view:"payroll_register",item_id:"payroll_reg",index:100,under:"payroll",label:"Payroll Register",replace:true})})}});FB_Module.register({index:2},function(){var a;var b={initialize:function(){var e,c,f,d;d=this;d.init({create_el:true});this.tabs=new app.Tabs({appendTo:this.$el,$scope:this});e=get_object(this.tab_objs_key);f=[];for(c in e){f.push(new e[c]())}this.tabs.append(f);this.listenTo(this.tabs,"tab_show",this.tab_show)},onshow:function(c,d){if(!c){c=this.tabs.current_tab||this.tabs.get_tab(0).tab_id}this.tabs.show_tab(c,{do_replace:true,args:d})},export_data:function(c){var d;d=this.tabs.current_tab;this.tabs.tabs[d].export_data()},print_data:function(c){var d;d=this.tabs.current_tab;this.tabs.tabs[d].print_data()},tab_show:function(d,e,g){var c=this,f=this.tabs.tabs;g.args=e.args;app.router.navigate(app.generate_url(this.page_name,d,e.args),{trigger:false,replace:e.do_replace});var h=this.$el.find(".float-right > *");h.hide()}};page_view=app.p_views.EmployeeMan=app.PageTemplate.extend({page_name:"employee_managment",heading_plural:"Employee Management",tab_objs_key:"employee_man_tabs"});page_view.merge(b);page_view=app.p_views.PayrollMasters=app.PageTemplate.extend({page_name:"payroll_masters",heading_plural:"Payroll Masters",tab_objs_key:"payrollmasters_tabs"});page_view.merge(b);FB_Module.init_fn(function(){if(AL.any_access("employees","admin_wings","departments","designations","payroll_masters")){app.SideMenu.add_item({item_id:"payroll",label:"Payroll",index:5});if(AL.any_access("payroll_masters")){app.SideMenu.add_item({view:"payroll_masters",item_id:"payroll_masters",under:"payroll",label:"Payroll Masters"})}if(AL.any_access("employees","admin_wings","departments","designations")){app.SideMenu.add_item({view:"employee_managment",item_id:"employee_managment",under:"payroll",label:"Employee Management"})}}})});FB_Module.register({index:2},function(){var g={employee_name:{head_label:"Employee Name",width:40,index:10,ip_options:{type:"combobox",id:"",label:"Employee Name",dlgTo:"scope",url:"/employees/?name={{value}}&pagination=false"}},employee_code:{head_label:"Employee ID",width:15,index:10,ip_options:{type:"inputbox",id:"",label:"Employee ID",dlgTo:"scope",disabled:true}},amount_due:{head_label:"Amount Due",width:10,index:10,ip_options:{type:"inputbox",id:"",label:"Amount Due",disabled:true,dlgTo:"scope"}},amount:{head_label:"Amount",width:10,index:10,ip_options:{type:"inputbox",id:"",label:"Amount",dlgTo:"scope"}}};var a={};var b={default_attr:{class_name:"_type1 _sm2 _comp_inline _mgrt_1em"},fields:{doc_no:{type:"inputbox",id:"_w10em",label:"Doc No"},date:{type:"datefield",id:"_w7em",label:"Date",dlgTo:"scope"},payroll_no:{type:"combobox",id:"",label:"Payroll No",dlgTo:"scope",url:"/payrolls/?doc_no={{value}}&pagination=false",label_sel:"doc_no",value_sel:"doc_no"},account_name:{type:"combobox",label:"Account",id:"_type1 _w14em",dlgTo:"scope",url:"/accounts/?pagination=false&is_cntlacc=false&under_defacc=cash_n_eq,bank_accounts&receivable_amount=true&payable_amount=true&net_balance=true&name={{value}}"},transaction_ref:{type:"inputbox",id:"_w10em",label:"Transaction Ref"},autofill:{type:"button",id:"_w8em _mgtp_05em",label:"Autofill Data",dlgTo:"scope"}},validation:{}};var c=gen_model("/payroll_payments/");var f=app.IPS.extend({after_init:function(h){this.listenTo(this,"all",this.ips_event_handler);this.parent=h.parent;this.vald_form=new app.Form({el:this.$el,validation:h.validation})},set_height:function(k){var j,h,n,m,l;j=this.$el.closest(".component.popup");h=j.outerHeight();n=0;l=j.children();for(m=0;m<l.length;m++){if($(l[m]).prop("tagName")!="BUTTON"){n+=$(l[m]).outerHeight()}}l={height:h-(n-this.$el.find(".table_listcnt").outerHeight()),overflowY:"auto"};if(k&&k.callback){k.callback(l)}else{this.$el.find(".table_listcnt").css(l)}},load_data:function(h){var j,l,k;if(h.length){for(j in h){k=h[j];l=this.insertRow({});l.data=k;this.set_values(l,k,["employee_name","employee_code","amount_due","amount"])}}else{this.insertRow({})}},release:function(){this.__proto__.__proto__.release.apply(this,arguments)},backspace_pressed:function(k,j,h){if(k.cols[h].ip.type=="combobox"){k.cols[h].ip.hide_dropdown()}if(k.cols[h].ip.get_value()==""){if(k.dclick_flag==true){if(this.rows.length>1){this.deleteRow(k)}this.rows[j!=0?j-1:0].cols[h].ip.focus()}else{this.reset_row(k);k.dclick_flag=true;setTimeout(function(){k.dclick_flag=false},200)}}},validate_row:function(l,j){var n=this.get_components(l),h=this,k,m;this.vald_form.components=n;if(n.employee_name.get_value()==""&&this.rows.length>1&&this.isLast(l)){this.parent.$el.find(".op_btn_snnx").focus();return"outfocus"}else{m=this.vald_form.validate();this.vald_form.renderErrors(m);if(m){this.focusColumn(l,Object.keys(m)[0]);return false}if(this.isLast(l)&&j){k=this.insertRow({})}else{k=this.nextRow(l)}setTimeout(function(){h.focusRow(k)},20)}return true},updown_arrow_pressed:function(k,h,j){if(j.keyCode==40&&!this.isLast(k)){this.nextRow(k).cols[h].ip.focus(true)}else{if(j.keyCode==38&&this.getRowIndex(k)>0){this.prevRow(k).cols[h].ip.focus(true)}}},renderErrors:function(h){var l,k,j;for(i in h){j=this.rows[i];l=this.get_components(j);j.errors=h[i];this.vald_form.components=l;this.vald_form.renderServerErrors(null,h[i])}},ips_event_handler:function(l,k,j,m,o){var n,h;n=this.rows[k];switch(l){case"popup_show":this.set_height(o);break;case"keydown":if((m.keyCode==38||m.keyCode==40)){this.updown_arrow_pressed(n,j,m)}break;case"text_changed":if(j=="employee_name"){h=m.keyCode;if(h==8){this.backspace_pressed(n,k,j)}}break;case"enterkey_press":if(this.focusColumn(n,j,"next",true,{select:true})==false){this.validate_row(n,true)}break;case"item_selected":if(j=="employee_name"){h=o.comp.get_selected_data();n.cols.employee_code.ip.set_value(h.employee_code)}break}}});app.popups.PayrollPay=new (app.Popup.extend({id:"payrollpay_popup",wrap_class:"ps_popup_wrap",doc_type:"payroll_pay",head:"Payroll Payment",show_save_n_next:true,model:c,events:{"click .op_btn":"submit_form"},beforeInit:function(){return true},reset:function(){this.form.reset();this.ip_sheet.release(true)},render:function(n){var o,k;k=this;if(!n){k.form=new app.Form(_.extend({appendTo:k.$el.find(".popup_body"),class_name:"sp_popup_form"},b));k.form.renderInputs();k.ip_sheet=new f({ips_id:"item_prpayips",class_name:"item_ip_sheet _type3",ip_defaults:{class_name:"_sm2 _type2"},appendTo:k.$el.find(".popup_body"),schema:g,validation:a,parent:k});k.ip_sheet.render();k.on("after_show",function(){k.ip_sheet.trigger("popup_show")});k.listenTo(k.ip_sheet,"all",k.ips_event_handler);k.listenTo(k.form,"all",k.form_ev_handler)}o=k.options.data;k.setMode("idle");k.current_tab=null;k.reset();app.set_docno_field(k.doc_type,k.form);k.form.disable(["autofill"]);var l,j,h;if(k.options.method=="update"){h=new k.model;h.set({id:o.voucher_id}).fetch({success:function(p,m){var q;q=_.mapObject(m.data,function(r){return r.value});k.form.set_values(_.pick(q,["doc_no","date","payroll_no","account_name","transaction_ref"]));k.ip_sheet.load_data(m.items)},error:function(){app.notifications.add("Error while loading","Error while loading data","error")}})}else{tmp2=this.form.components.doc_no;tmp1=app.get_new_voucher_date();if(tmp2.disabled){tmp2.set_value()}this.ip_sheet.insertRow({});this.form.reset(null,["doc_no"]);this.form.set_values({doc_no:app.generate_doc_no(this.doc_type,tmp1,1,true),date:tmp1})}},after_get_values:function(h){h.items=this.ip_sheet.get_value_list();_.extend(h,this.extra_det);if(this.options.method=="update"){h.voucher_id=h.id=this.options.data.voucher_id}},after_request:function(k,h,j,l){var m=k.responseJSON;if(h=="success"){app.set_last_no(k);if($(l.target).hasClass("op_btn_snnx")){this.render(true);this.form.components.date.focus()}}if(h=="error"&&m&&m.errors&&m.errors.item_errors){this.ip_sheet.renderErrors(m.errors.item_errors)}},toogle_autofill_btn:function(j){var h;h=parse_date(j.date.get_value())&&j.payroll_no.get_value()!="";j.autofill[h?"enable":"disable"]()},form_ev_handler:function(q,m,o){var l,t,k,j,h,s,p,u;u=this;l=u.form.components;if(q=="keyup"&&m.name=="date"){var r,n;if(l.doc_no.disabled){p=app.generate_doc_no;j=u.doc_type;n=u.options.data;r=m.get_value();h=u.options.method=="create"?p(j,r,1,true):n.doc_no;l.doc_no.set_value(h)}u.toogle_autofill_btn(l)}else{if(q=="focusout"&&m.name=="date"){if(!m.enterpressed){}}else{if(q=="item_selected"&&m.name=="payroll_no"){u.toogle_autofill_btn(l)}else{if(q=="clicked"&&m.name=="autofill"){(new c).fetch({data:$.param({op:"get_autofill_data",payroll_no:l.payroll_no.get_value(),to_date:l.date.get_value()}),success:function(v,w){u.ip_sheet.release(true);u.ip_sheet.set_value_list(w.items)}})}}}}},ips_event_handler:function(l,k,j,m,h){}}))();var e={doc_no:{head_label:"Inv #",style:"width:10%",index:0},date:{head_label:"Date",style:"width:10%",index:0},account_name:{head_label:"Account",style:"width:15%",index:0},particulars:{head_label:"Particulars",style:"width:45%",index:0},transaction_ref:{head_label:"Transaction Ref",style:"width:10%",index:0},amount:{head_label:"Amount",type:"money",wrapSPAN:true,style:"width:10%;text-align:right",index:0}};var d={employee_name:{head_label:"Employee Name",style:"width:80%",index:1},employee_code:{head_label:"Employee Code",style:"width:10%",index:2},amount:{head_label:"Amount",type:"money",style:"width:10%;text-align:right",index:100,prefix:"{currency}"}};app.p_views.PayrollPayRegister=app.ListPageTemplate.extend({page_name:"payroll_payment",model:c,ds_options:{head:"Payroll Payment Register",class_name:"hoverable ds_with_head",ds_id:"prpay_ds",idAttr:"voucher_id",schema:e,default_params:{}},header_btns:[],popup:app.popups.PayrollPay,drill_to_view:"voucher",heading:"Payroll Payment",heading_plural:"Payroll Payment Register",edit_voucher:function(h,j){this.popup.show({method:"update",invoker:this,callback:j,data:h})},render_voucher:function(n,t){var p,s,h,u,q,o,j,r,m,l,k;r=t.item_ds.schema=_.clone(d);j=t.item_ds;j.rows=n.items;j.$el.show();j.render();k=j.$el.find(".table_list > li");for(p in j.rows){m=j.rows[p];l=k.eq(p).addClass(m.item_type)}if(n.transactions){t.transaction_ds.$el.show();t.transaction_ds.rows=n.transactions;t.transaction_ds.render()}},initialize:function(){this.init({create_el:true})}});if(AL.any_access("payroll_payment")){FB_Module.init_fn(function(){app.SideMenu.add_item({item_id:"payroll",label:"Payroll",index:5});app.SideMenu.add_item({view:"payroll_payment",item_id:"prpay_reg",index:90,under:"payroll",label:"Payroll Payment Register",replace:true})})}});FB_Module.register({index:2},function(){var a;a={fields:{doc_no:{head_label:"Vchr#",width:"135px"},date:{head_label:"Date",width:"90px"},particulars:{head_label:"Particulars",width:"70%",url:"/accounts/?name={{value}}&is_cntlacc=false&pagination=false",list_selector:"items",label_sel:"name"},description:{head_label:"Description",width:"30%"},drcr_amount:{head_label:"Debit/Credit Amount",width:"120px",align:"right",type:"money",wrapSPAN:true},amount:{head_label:"Total Amount",width:"120px",align:"right",type:"money",wrapSPAN:true}},show_items:["doc_no","date","particulars","description","amount"],filter_enable:["doc_no","date","particulars","description","drcr_amount","amount"]};app.p_views.JournalVouchers=app.ListPageTemplate.extend({page_name:"journal_vouchers",model:app.models.JournalVoucher,no_newbtn:true,doc_type:"journal_voucher",popup:app.popups.JournalPopup,popup_options:{doc_type:"journal_voucher"},ds_options:{idAttr:"voucher_id",head:"Journal Voucher List",class_name:"hoverable ds_with_head",ds_id:"journal_vouchers_ds",default_params:{doc_type:"jv"},flex_schema:a,has_filter:true},header_btns:["print","export"],heading:"Journal Voucher",heading_plural:"Journal Vouchers",initialize:function(){this.pre_init()},initComps:function(){var b;this.context_menu_items=b=_.clone(this.context_menu_items);b.splice(0,0,{key:"gotovoucher",value:"Go to Voucher"});if(get_cfg("en_journal_reversing")){b.splice(2,0,{key:"reverse_voucher",value:"Create Reverse Journal"})}b.splice(2,0,{key:"associate",value:"Associations"});swap_obj_keys(this,"_context_item_click","context_item_click");this.init({create_el:true})},ds_handler:function(b,f,c,d){if(b=="before_render"){}else{return this._ds_handler(b,f,c,d)}},edit_voucher:function(d,f){var e={},c,b;b.popup.show({method:"update",invoker:b,callback:f,data:d})},_context_item_click:function(d,b){var c;c=this;if(b=="gotovoucher"){app.router.navigate(app.generate_url("voucher",d,null),{trigger:true});return}else{if(b=="associate"){app.popups.ASC.show({id:d,itype:"vchr"})}else{if(b=="reverse_voucher"){data=c.ds.get_row(d);this.popup.show({method:"create",invoker:c,doc_type:c.doc_type,callback:c.popup_callback,id:d,reverse:true,data:data});return}else{if(b=="delete"){return c._context_item_click(d,b,{model:app.models.Voucher})}}}}return c._context_item_click(d,b)},pre_show:function(){if(!this.is_inited){this.initComps()}}});app.p_views.PettyCash=app.ListPageTemplate.extend({page_name:"pettycash",model:app.models.JournalVoucher,no_newbtn:true,popup:app.popups.JournalPopup,doc_type:"pettycash_voucher",popup_options:{doc_type:"pettycash_voucher"},ds_options:{idAttr:"voucher_id",head:"Petty Cash Voucher List",class_name:"hoverable ds_with_head",ds_id:"pettycash_voucher_ds",default_params:{doc_type:"pc"},flex_schema:a,has_filter:true},header_btns:["print","export"],heading:"Petty Cash Voucher",heading_plural:"Petty Cash Vouchers",initialize:function(){this.pre_init()},initComps:function(){var b;this.context_menu_items=b=_.clone(this.context_menu_items);b.splice(0,0,{key:"gotovoucher",value:"Go to Voucher"});swap_obj_keys(this,"_context_item_click","context_item_click");this.init({create_el:true})},ds_handler:function(b,f,c,d){if(b=="before_render"){}else{return this._ds_handler(b,f,c,d)}},_context_item_click:function(c,b){if(b=="gotovoucher"){app.router.navigate(app.generate_url("voucher",c,null),{trigger:true});return}else{if(b=="delete"){return this._context_item_click(c,b,{model:app.models.Voucher})}}return this._context_item_click(c,b)},pre_show:function(){if(!this.is_inited){this.initComps()}}});app.p_views.BankVoucher=app.ListPageTemplate.extend({page_name:"bank_vouchers",model:app.models.JournalVoucher,no_newbtn:true,popup:app.popups.JournalPopup,doc_type:"contra_voucher",popup_options:{doc_type:"contra_voucher"},ds_options:{idAttr:"voucher_id",head:"Bank Voucher List",class_name:"hoverable ds_with_head",ds_id:"bank_voucher_ds",default_params:{doc_type:"ct"},flex_schema:a,has_filter:true},header_btns:["print","export"],heading:"Bank Voucher",heading_plural:"Bank Vouchers",initialize:function(){this.pre_init()},initComps:function(){var b;this.context_menu_items=b=_.clone(this.context_menu_items);b.splice(0,0,{key:"gotovoucher",value:"Go to Voucher"});swap_obj_keys(this,"_context_item_click","context_item_click");this.init({create_el:true})},ds_handler:function(b,f,c,d){if(b=="before_render"){}else{return this._ds_handler(b,f,c,d)}},_context_item_click:function(c,b){if(b=="gotovoucher"){app.router.navigate(app.generate_url("voucher",c,null),{trigger:true});return}else{if(b=="delete"){return this._context_item_click(c,b,{model:app.models.Voucher})}}return this._context_item_click(c,b)},pre_show:function(){if(!this.is_inited){this.initComps()}}});FB_Module.init_fn(function(){app.SideMenu.add_item({item_id:"vouchers_cnt",label:"Voucher Registers",index:5.5,is_disabled:!AL.any_access("journal_voucher.list")});app.SideMenu.add_item({item_id:"accvouchers_cnt",label:"New Voucher",index:4,is_disabled:!AL.any_access("journal_voucher.create")});app.SideMenu.add_item({view:"journal_vouchers",item_id:"journal_voucher_reports",index:45,under:"vouchers_cnt",label:"Journals",is_disabled:!AL.any_access("journal_voucher.list")});app.SideMenu.add_item({item_id:"journal",under:"accvouchers_cnt",label:"Journal",index:45,is_disabled:!AL.any_access("journal_voucher.create"),callback:function(){app.popups.JournalPopup.show({method:"create",doc_type:"journal_voucher"})}});app.SideMenu.add_item({view:"pettycash",item_id:"pettycash_reports",index:45,under:"vouchers_cnt",label:"Petty Cash Register",is_disabled:!AL.any_access("pettycash_voucher.list")});app.SideMenu.add_item({item_id:"pettycash",under:"accvouchers_cnt",label:"Petty Cash Voucher",index:45,is_disabled:!AL.any_access("pettycash_voucher.create"),callback:function(){app.popups.JournalPopup.show({method:"create",doc_type:"pettycash_voucher"})}});app.SideMenu.add_item({view:"bank_vouchers",item_id:"bankvoucher_reports",index:45,under:"vouchers_cnt",label:"Bank Voucher Register",is_disabled:!AL.any_access("contra_voucher.list")});app.SideMenu.add_item({item_id:"bank_voucher",under:"accvouchers_cnt",label:"Bank Voucher",index:45,is_disabled:!AL.any_access("contra_voucher.create"),callback:function(){app.popups.JournalPopup.show({method:"create",doc_type:"contra_voucher"})}})})});FB_Module.register({index:2},function(){var c,f,g,h,d,j,b,e;c={fields:{doc_no:{head_label:"Doc No",width:"100px"},date:{head_label:"Date",width:"95px"},transaction_vchr_no:{head_label:"Receipt No",width:"95px"},mode_of_payment:{head_label:"Mode of Payment",width:"120px"},transaction_ref:{head_label:"Transaction Ref",width:"120px"},dr_account_name:{head_label:"Account",width:"20%",index:0,url:"/accounts/?pagination=false&is_cntlacc=false&under_defacc=cash_n_eq,bank_accounts,branches&name={{value}}&_select_fields=name"},cr_accounts:{head_label:"Received From",width:"45%",index:0,url:"/accounts/?pagination=false&is_cntlacc=false&name={{value}}&acc_type_in=asset,liability&_select_fields=name"},settled_refs:{head_label:"Settled Refs",width:"35%"},settl_ref_no:{head_label:"Settled Ref No",width:"100px"},total_amount:{head_label:"Amount",width:"100px",type:"money",wrapSPAN:true,align:"right"}},show_items:["doc_no","date","transaction_vchr_no","mode_of_payment","transaction_ref","dr_account_name","cr_accounts","settled_refs","total_amount"],filter_enable:["doc_no","date","transaction_vchr_no","mode_of_payment","transaction_ref","settl_ref_no","dr_account_name","cr_accounts","total_amount"]};f={fields:{doc_no:{head_label:"Doc No",width:"100px"},date:{head_label:"Date",width:"95px"},transaction_vchr_no:{head_label:"Payment No",width:"95px"},mode_of_payment:{head_label:"Mode of Payment",width:"120px"},transaction_ref:{head_label:"Transaction Ref",width:"120px"},cr_account_name:{head_label:"Account",width:"20%",index:0,url:"/accounts/?pagination=false&is_cntlacc=false&under_defacc=cash_n_eq,bank_accounts,branches&name={{value}}&_select_fields=name"},dr_accounts:{head_label:"Paid To",width:"45%",index:0,url:"/accounts/?pagination=false&is_cntlacc=false&name={{value}}&acc_type_in=liability,asset,expense&_select_fields=name"},settled_refs:{head_label:"Settled Refs",width:"35%"},settl_ref_no:{head_label:"Settled Ref No",width:"100px"},total_amount:{head_label:"Amount",width:"100px",type:"money",wrapSPAN:true,align:"right"}},show_items:["doc_no","date","transaction_vchr_no","mode_of_payment","transaction_ref","cr_account_name","dr_accounts","settled_refs","total_amount"],filter_enable:["doc_no","date","transaction_vchr_no","mode_of_payment","transaction_ref","settl_ref_no","cr_account_name","dr_accounts","total_amount"]};app.p_views.Receipt=app.ListPageTemplate.extend({page_name:"receipts",model:app.models.Receipt,no_newbtn:true,ds_options:{head:"Receipts",idAttr:"voucher_id",class_name:"hoverable ds_with_head",ds_id:"ds_receipt",enable_sorting:true,sort_disabled_to:["dr_accounts"],has_filter:true,flex_schema:c},header_btns:["export","print"],heading_plural:"Receipts",initialize:function(){var l,k;k=this;this.popup=app.popups.Receipt;this.context_menu_items=l=_.clone(this.context_menu_items);l.splice(0,0,{key:"gotovoucher",value:"Go to Voucher"});l.splice(2,0,{key:"associate",value:"Associations"});swap_obj_keys(this,"_context_item_click","context_item_click");this.init({create_el:true})},edit_voucher:function(m,o){var n,l,k;k=this;n={};for(l in m.data){n[l]=m.data[l]["value"]}n.voucher_id=m.voucher_id;n.item_data=m.item_data;n.pay_data=m.pay_data;k.popup.show({method:"update",invoker:k,callback:o,data:n})},_context_item_click:function(l,k){if(k=="gotovoucher"){app.router.navigate(app.generate_url("voucher",l,null),{trigger:true});return}else{if(k=="delete"){return this._context_item_click(l,k,{model:app.models.Voucher})}}return this._context_item_click(l,k)},export_data:function(){var k;k=this.ds.current_filter;$("#myiframwe").attr("src",app.generate_ext_url("receipts",null,_.extend({op:"export_to_excel",sort_by:"date"},k)))}});app.p_views.PaymentVoucher=app.ListPageTemplate.extend({page_name:"payment_vouchers",model:app.models.PaymentVoucher,no_newbtn:true,ds_options:{head:"Payment Vouchers",idAttr:"voucher_id",class_name:"hoverable ds_with_head",ds_id:"ds_payment",enable_sorting:true,sort_disabled_to:["cr_accounts"],has_filter:true,flex_schema:f},header_btns:["export","print"],heading_plural:"Payment Vouchers",initialize:function(){var l,k;k=this;this.popup=app.popups.PaymentVoucher;this.context_menu_items=l=_.clone(this.context_menu_items);l.splice(0,0,{key:"gotovoucher",value:"Go to Voucher"});l.splice(2,0,{key:"associate",value:"Associations"});swap_obj_keys(this,"_context_item_click","context_item_click");this.init({create_el:true})},edit_voucher:function(l,n){var m={},k;for(k in l.data){m[k]=l.data[k]["value"]}m.voucher_id=l.voucher_id;m.item_data=l.item_data;m.pay_data=l.pay_data;this.popup.show({method:"update",invoker:this,callback:n,data:m})},_context_item_click:function(l,k){if(k=="gotovoucher"){app.router.navigate(app.generate_url("voucher",l,null),{trigger:true});return}else{if(k=="associate"){app.popups.ASC.show({id:l,itype:"vchr"})}else{if(k=="delete"){return this._context_item_click(l,k,{model:app.models.Voucher})}}}return this._context_item_click(l,k)},export_data:function(){var k;k=this.ds.current_filter;$("#myiframwe").attr("src",app.generate_ext_url("payment_vouchers",null,_.extend({op:"export_to_excel",sort_by:"date"},k)))}});rv_ds_schema={doc_no:{head_label:"Doc No",style:"width:10%",index:0},date:{head_label:"Date",style:"width:10%",index:0},transaction_vchr_no:{head_label:"Receipt No",style:"width:10%",index:0},transaction_ref:{head_label:"Transaction Ref",style:"width:14%",index:0},dr_account_name:{head_label:"Account",style:"width:14%",index:0},cr_accounts:{head_label:"Receved From",style:"width:28%",index:0},total_amount_txt:{head_label:"Amount",style:"width:14%;text-align:right",index:1,prefix:app.appdata.currency_symbol}};ref_ds_schema={check_box:{head_label:"&nbsp;",style:"width:3.5%",index:0},date:{head_label:"Date",style:"width:8%",index:0},ref_no:{head_label:"Doc No",style:"width:18%",index:0},ref_no1:{head_label:"Ref No",style:"width:12%",index:0},narration:{head_label:"Description",style:"width:10.5%",index:0},gross_amount:{head_label:"Amount Due",type:"money1",style:"width:10%;text-align:right",index:1},prev_settled:{head_label:"Prev. Settled",type:"money1",style:"width:10%;text-align:right",index:1},pending_amount:{head_label:"Pending Amount",type:"money1",wrapSPAN:true,style:"width:10%;text-align:right",index:1},settled_amount:{head_label:"Settled Amount",style:"width:14%;text-align:right",index:1,type:"html"},dr_cr_txt:{head_label:"&nbsp;",style:"width:4%;text-align:center"}};h={cr_account_name:{head_label:"Received From",width:67,index:10,ip_options:{type:"combobox",id:"nitem_vendor",label:"Received From",url:"/accounts/?pagination=false&get_l2_parent=true&acc_type_in=asset,liability"+(get_cfg("rc_use_income")=="true"?",income":"")+"&is_cntlacc=false&to_date={{to_date}}&name={{value}}",keydown_pretrigger:true,class_name:"_sm2 _type2",dlgTo:"scope",new_item_btn:true}},dr_account_name:{head_label:"Paid To",width:67,index:10,ip_options:{type:"combobox",id:"nitem_vendor",label:"Paid To",url:"/accounts/?pagination=false&is_cntlacc=false&acc_type_in=asset,liability"+(get_cfg("py_use_expense")=="true"?",expense":"")+"&to_date={{to_date}}&name={{value}}",keydown_pretrigger:true,class_name:"_sm2 _type2",dlgTo:"scope",new_item_btn:true}},ref_type:{head_label:"Method of Adj",width:18,index:15,ip_options:{type:"selectbox",default_option:"",dlgTo:"scope",class_name:"_sm2 _type3 rpp_adj_method",options2:{onaccount:"On Account",against_ref:"Settled Against",advance:"Advance"}}},amount:{head_label:"Amount",width:15,index:20,ip_options:{type:"inputbox",class_name:"_mg _type2 _ralign",dlgTo:"scope",label:"Amount",thousand_sep:true}}};rp_paymethod_ips_schema={mode_of_payment:{head_label:"Mode of payment",width:20,ip_options:{type:"selectbox",default_option:"",label:"Mode of Payment",id:"_type3",dlgTo:"scope",options:{cash:"Cash",cheq:"Cheque",dd:"DD",bnkt:"Wire Transfer"}}},transaction_ref:{head_label:"Transaction Ref",width:30,ip_options:{type:"inputbox",id:"_type2",label:"Transaction Ref"}},amount:{head_label:"Amount",width:20,ip_options:{type:"inputbox",id:"_type2 _ralign",label:"Amount",thousand_sep:true}},instr_acc_no:{head_label:"Instr Acc No",width:30,ip_options:{type:"inputbox",id:"_type2",label:"Instr Acc No"}},due_date:{head_label:"Due Date",width:20,ip_options:{type:"datefield",id:"_type2",label:"Due Date"}},status:{head_label:"Status",width:20,ip_options:{type:"selectbox",default_option:"pd",label:"Status",id:"_type3",options2:{pd:"Uncleared",cl:"Cleared"},dlgTo:"scope"}},status_date:{head_label:"Cleared Date",width:20,ip_options:{type:"datefield",id:"_type2",label:"Cleared Date"}}};d={fields:{_form_top_cnt:{tagName:"div",className:"rpp_form_top_cnt",index:10,fields:{doc_no:{type:"inputbox",id:"_w8em _sm2 _type3",label:"Doc #",always_disable:true},date:{type:"datefield",name:"date",id:"_w8em _sm2 _type1",label:"Date",dlgTo:"scope"},transaction_vchr_no:{type:"inputbox",id:"_w10em _type1 rp_transaction_no",label:"Transaction Vchr No"},dr_account_name:{type:"combobox",label:"Account",url:"/accounts/?pagination=false&is_cntlacc=false&under_defacc=cash_n_eq,bank_accounts,branches&to_date={{to_date}}&receivable_amount=true&payable_amount=true&net_balance=true&name={{value}}",id:"_type1 _w20em",dlgTo:"scope"},cr_account_name:{type:"combobox",id:"rp_cvname",label:"Account",url:"/accounts/?pagination=false&is_cntlacc=false&under_defacc=cash_n_eq,bank_accounts,branches&excl_defacc=cheq_in_hand&to_date={{to_date}}&receivable_amount=true&payable_amount=true&net_balance=true&name={{value}}",id:"_type1 _w20em",dlgTo:"scope"},job_name:{type:"combobox",label:"Job ID",id:"_w15em",url:"/jobs/?name={{value}}&pagination=false&is_group=false",dlgTo:"scope",label_sel:"name",value_sel:"name"}}},_top_ips_cnt:{tagName:"div",className:"rpp_topips_cnt _mgtp_1em",index:20},_extra_cnt:{tagName:"div",index:30},_ipsheet_cnt:{tagName:"div",className:"rpp_ipsheet_cnt",index:50},_bottom_cnt:{tagName:"div",className:"_bottom_cnt _mgtp_1em",index:60,fields:{description:{type:"inputbox",class_name:"_type4 _sm2",label:"Description :",id:"jrfrm_desc"}}},save_changes:{type:"checkbox",class_name:"_type1 _mgrt_1em _mgtp_3x _comp_inline",value:"true",dlgTo:"scope",label:"Save Changes"},print_btn:{type:"button",id:"float_left _theme1 _w6em",label:"Print",index:100,dlgTo:"scope"}},validation:{date:{required:true},transaction_vchr_no:{required:true},dr_account_name:{required:true},cr_account_name:{required:true},mode_of_payment:{required:true},due_date:{required:true},instr_acc_no:{required:true},transaction_ref:{required:true}}};rp_ipsheet_validation={cr_account_name:{required:true},dr_account_name:{required:true},ref_type:{required:function(o,m,l){var k,n;k=o.cr_account_name||o.dr_account_name;n=k.get_selected_data();return _.in_list(n.acc_type,["asset","liability"])}},amount:{required:true}};j={reference:{type:"inputbox",class_name:"_type1 _sm2",id:"rp_transaction_no",label:"Reference"}};var a={date:{type:"datefield",id:"_type1 _w7em",label:"Date",dlgTo:"scope"},ref_no:{type:"inputbox",id:"_type1 _w8em",label:"Ref No",dlgTo:"scope"},narration:{type:"inputbox",id:"_type1 _w12em",label:"Description",dlgTo:"scope"},amount:{type:"inputbox",id:"_type1 _w8em",label:"Amount Due",dlgTo:"scope"},dr_cr:{type:"selectbox",id:"_type1 _w7em",default_option:"",options:[{"-1":"Dr"},{"1":"Cr"}],label:"Dr/Cr",dlgTo:"scope"}};app.RefDS=app.DS.extend({schema:ref_ds_schema,init:function(l){var k=this;this.listenTo(this,"all",this.ds_event_handler);this.$el.on("keyup","input",function(m){if($(m.target).hasClass("ipbx_ip")){k.trigger("amount_changed",this.value,k,m)}});_.extend(this,l);this.$el.append("<div style='position:absolute;bottom:0;left:0;right:0'><div class='selected_count float_left _mgtp_10x'>Total Selected Items : <span></span></div> "+(this.is_settle_voucher?"<p class='rpp_settle_total'><span style='display:inline-block;width:12em'>Total Debit : <span class='_tdr _amount'>0.00</span></span><span style='display:inline-block;width:12em'>Total Credit : <span class='_tcr _amount'>0.00</span></span></p></div>":"<p class='rpp_settle_total'>Total Amount : <span class='_amount'>0.00</span></p></div>"))},ds_event_handler:function(w,o,m,u){var A=this.options;var k,x,t,s,v,l,n,r,q,z,y,p;z=this;if(w=="before_render"){q=o.items;if(o.current_page==o.page_count){for(r in this.new_refs){l=this.new_refs[r];m.rows.push({id:l.id||-(r+1),date:l.date,dr_cr:l.dr_cr=="Dr"?1:-1,ref_no:l.ref_no,amount_due:l.amount,settled_amount:"",narration:l.narration})}}for(r in q){q[r].settled_amount={html:"<div class='component inputbox _type2 _nouline _xs2' style='width:99%'><input type='text' style='text-align:right' class='cmp_ip ipbx_ip' /></div>"};q[r].prev_settled=q[r].gross_amount-Math.abs(q[r].amount_due);q[r].pending_amount=q[r].gross_amount-q[r].prev_settled}if(this.ds_options.total_drcr){for(r in q){q[r].dr_cr_txt=q[r].dr_cr*(this.options.params.negate_due?-1:1)==1?"Dr":"Cr"}}else{for(r in q){q[r].dr_cr_txt=q[r].dr_cr*(this.options.params.negate_due?-1:1)==1?"+":"(-)"}}}if(w=="checkbox_cliked"||w=="amount_changed"){k=$(u.target).closest(".tl_li");y=m.get_row(k.data("id"));t=k.find("ul > li._csettled_amount input")}if(w=="checkbox_cliked"){if(o==false){t.val("");z.remove_from_sel(y.id)}else{q=Math.abs(Number(y.amount_due));t.val(q);z.add_to_sel(y.id,q,y.dr_cr)}}else{if(w=="amount_changed"){if(u.keyCode==13){}x=k.find("ul > li:first input");if(o!=""&&!isNaN(o)){x.prop("checked",true);q=Number(t.val());if(!isNaN(q)){z.add_to_sel(y.id,q,y.dr_cr)}}else{x.prop("checked",false);z.remove_from_sel(y.id)}}}if(w=="checkbox_cliked"||w=="amount_changed"){this.calculate_total()}},load_data:function(l){var k=this;k.sel_ref_items=l.ref_items;k.new_refs=[];if(k.new_refs){for(i=0;i<k.new_refs.length;i++){c_item=k.new_refs[i];cid=c_item.id;if(cid in k.sel_ref_items){tmp=k.sel_ref_items[cid];delete k.sel_ref_items[cid];k.sel_ref_items[-(i+1)]=tmp}c_item.id=-(i+1)}}},clear:function(){this.sel_ref_items={};this.new_refs=[];this.rows=[];this.render()},load_ds:function(k,n,m){var l=this;l.load({params:_.extend({op:"get_list",inc_ref_ids:(_.isEmpty(n))?_.keys(l.sel_ref_items).join(","):"",per_page:l.per_page},k,n),use_post:true,invoker:l,success:function(p,o){var r,t,s,q;r=l.$el.find(".ds_container>.table_list_cnt>.table_list>li");for(q=0;q<r.length;q++){s=r.eq(q);t=Number(s.data("id"));if(l.sel_ref_items&&l.sel_ref_items[t]){s.find(">ul>li._csettled_amount input").val(Math.abs(l.sel_ref_items[t].amount));s.find(">ul>li:first input").prop("checked",true)}if(q==0&&!m){s.find(">ul>li:first input").focus()}}this.calculate_total()},error:function(o,p){}})},add_to_sel:function(m,k,l){this.sel_ref_items[m]={amount:k,dr_cr:l}},remove_from_sel:function(k){delete this.sel_ref_items[k]},calculate_total:function(){var m,l,p,k,o,n;m=0;if(!this.is_settle_voucher){for(l in this.sel_ref_items){k=this.sel_ref_items[l];m+=(k.amount*k.dr_cr)}n=m}else{m={debit:0,credit:0};for(l in this.sel_ref_items){k=this.sel_ref_items[l];m[k.dr_cr==1?"debit":"credit"]+=Math.abs(k.amount)}}if(this.is_settle_voucher){o={debit:to_money(m.debit),credit:to_money(m.credit)};this.$el.find(".rpp_settle_total ._tdr").text(o.debit);this.$el.find(".rpp_settle_total ._tcr").text(o.credit)}else{if(this.ds_options.total_drcr){o=to_money(Math.abs(n))+(n*(this.options.params.negate_due?-1:1)<0?" Cr":" Dr")}else{o=to_money(n*(this.options.params.negate_due?-1:1))}this.$el.find(".rpp_settle_total>span").text(o)}this.$el.find(".selected_count>span").text(Object.keys(this.sel_ref_items).length)}});app.popups.MethodAdjSelPopup=new (app.Popup.extend({head:"Bill Wise Details for ",id:"methodadj_popup",doc_model:app.models.Reference,btn_map:{read:["OK","OK"]},events:{"click .op_btn":"select_clicked","click .new_refs_btn":"new_refs_clicked",submit:"select_clicked"},beforeInit:function(){this.on("after_show",this.after_show);return true},after_show:function(){var k=this;k.ds.$el.css("height","auto");k.ds.$el.find(".ds_container").css("height","auto");setTimeout(function(){k._after_show()})},_after_show:function(){var k,m,l;l=[this.ds.$el.find(".ds_container"),this.ds.$el];for(m in l){k=l[m];k.css({height:$(window).height()-(k.closest(".popup").outerHeight()-k.outerHeight())-20})}this.ds.per_page=Math.floor((this.ds.$el.find(".ds_container").height()-32-40)/23);this.center()},render:function(l,q){var s,r,m,k,n,p,o;r=this;s=r.options;if(!l){r.ref_filter_form=new app.Form({class_name:"_mgbt_1em",appendTo:r.$el.find(".popup_body"),default_attr:{class_name:"_comp_inline _mgrt_1em _sm2 "},fields:a});r.ref_filter_form.renderInputs();r.listenTo(r.ref_filter_form,"all",this.settle_form_handler);r.ds=new app.RefDS({appendTo:r.$el.find(".popup_body"),head:"Unsettled/Partially Settled References",idAttr:"id",has_pagination:true,handle_pagination:true,class_name:"ds_pagin_pullup",ds_id:"ds_invoices2",model:new r.doc_model});r.ds.init({is_settle_voucher:false,ds_options:s.ds_options});r.advance_form=new app.Form({appendTo:r.$el.find(".popup_body"),fields:j});r.advance_form.renderInputs()}o=(s.ref_type=="advance");r.ds.$el[o?"hide":"show"]();r.advance_form.$el[!o?"hide":"show"]();r.ref_filter_form.$el[o?"hide":"show"]();r.setMode("idle");if(!this.is_settle_voucher){r.$el.find(".popup_head").html(r.head+'<i>"'+s.account_name+'"</i>')}else{r.$el.find(".popup_head").html("Settlement Voucher")}if(s.ref_type=="advance"){if(s.data){r.form.set_values(s.data)}}else{r.ds.clear();if(s.data&&s.data.adj_data){r.ds.load_data(s.data.adj_data)}setTimeout(function(){r.ds.load_ds(r.options.params)},300)}},new_refs_clicked:function(k){app.popups.BillWiseDetails.show({invoker:this,data:this.new_refs,callback:function(m){var l;for(l=0;l<m.length;l++){m[l]["id"]=-(l+1)}this.ds=m;this.ref_ds.load_ds()}})},settle_form_handler:function(m,l,n){var k;k=this;if((m=="keyup"&&is_charkey(n)&&l.name!="account_name")||m=="changed"||m=="item_selected"){this.ds.load_ds(k.options.params,k.ref_filter_form.get_values(true),true)}else{if(m=="keydown"&&_.in_list(n.keyCode,[38,40])){this.ds.gl_ev_handler("keypress",n)}}},select_clicked:function(q){var n,p,m,r,l,o,k;if(this.options.ref_type=="against_ref"){n={ref_items:this.ds.sel_ref_items,new_refs:this.new_refs,total_amount:0};for(m in n.ref_items){n.total_amount+=n.ref_items[m]["amount"]*n.ref_items[m].dr_cr}n.dr_cr=n.total_amount<0?-1:1;n.total_amount=wacky_round(Math.abs(n.total_amount),2);if(n.total_amount<0){app.notifications.add("Error","Negative Sum Not Allowed","error");return}}else{n=this.form.get_values()}this.close();this.options.callback.call(this.options.scope,n)}}))();e=app.Popup.extend({events:{"click .op_btn":"submit_form","popup:open":"onshow","click ._tbl_checkbox_col input":"checkbox_clicked"},class_name:"rp_popup",show_save_n_next:true,init:function(n){var l,m,k,o;l=this;k=this.form_fields(n.form_schema.fields);k._form_top_cnt.fields.transaction_vchr_no.label=this.tr_vchr_no_label;this.form=new app.Form({appendTo:this.$el.find(".popup_body"),default_attr:{class_name:"_sm2 _type1 _comp_inline _mgrt_1em"},fields:k,order_items:true,validation:n.form_schema.validation});o=l.$el.find(".popup_footer").prepend("<div class='float_left'></div><span class='ip_cnt _mgrt_3em'></span>");l.form.fields.print_btn.append_to=o.find(">.float_left");l.form.fields.save_changes.append_to=o.find(">.ip_cnt");this.listenTo(this.form,"all",this.form_event_handler);this.form.renderInputs();this.form.$el.find("._bottom_cnt").prepend('<div class="jrform_total"><span class="jrform_titem total_amount">Total: <span class="_tamount"></span></span></div>').append("<div class='clearfix'></div>");this.top_ips=new (app.IPS_ext.extend({pre_validate:function(s,p,r,q){if(_.in_list(p.mode_of_payment,["cheq","dd"])){r.validation={transaction_ref:{required:true},instr_acc_no:{required:get_cfg("instr_acc_no_req")=="true"},due_date:{required:true,pattern:"date"},amount:{required:true,type:"number"},status:{required:get_cfg("rcpy_set_status")=="true"}};return r.validate()}else{if(p.mode_of_payment=="bnkt"){r.validation={transaction_ref:{required:false},amount:{required:true,type:"number"}};return r.validate()}else{r.validation={transaction_ref:{required:false},amount:{required:true,type:"number"}};return r.validate()}}}}))({ips_id:"rpp_topips",head:"Payment Details",ip_defaults:{class_name:"_sm _nouline"},appendTo:this.$el.find(".rpp_topips_cnt"),en_click_event:true,schema:rp_paymethod_ips_schema,validation:{mode_of_payment:{required:true}}});this.top_ips.render();this.listenTo(this.top_ips,"all",this.topips_event);this.ip_sheet=new app.IPS_ext({ips_id:"rpp_ipsheet",head:"Account Details",ip_defaults:{class_name:"_sm2"},appendTo:this.$el.find(".rpp_ipsheet_cnt"),en_click_event:true,schema:_.pick(n.ips_schema,this.ip_sheet_schema_keys)});this.vald_form=new app.Form({el:this.$el.find(".rpp_ipsheet_cnt"),validation:n.ips_validation});this.listenTo(this.ip_sheet,"all",this.ipsheet_event)},render:function(o,p){var l=this,n,k,m;if(!o){m={form_schema:d,ips_schema:h,ips_validation:rp_ipsheet_validation};l.init(m)}l.form.components[l.first_account_sel].render_error();app.set_docno_field(l.doc_type,l.form);l.form.reset();l.ip_sheet.release();l.top_ips.release(true);l.ip_sheet.rowHeight=null;l.setMode("idle");l.form[l.options.method=="update"?"show_comps":"hide_comps"](["print_btn","save_changes"]);if(!this.defaccs){n=new Backbone.Model;n.url="/default_accounts?keys=receivable,cheque_cnt_acc,branches,cheq_in_hand,payable,cash_n_eq,bank_accounts,unearned_income,unexpired_expense";n.fetch({success:function(r,q){l.defaccs=_.mapObject(q,function(t,s){return t.id});l.set_form_data()},error:function(q,r){console.error("Failed to load defaccs")}})}else{l.set_form_data()}},set_max_height:function(){var m,l,n,k;m=this.top_ips.$el.find(".table_listcnt");l=this.ip_sheet.$el.find(".table_listcnt");k=this.top_ips.$el.find(".table_list_ul > li").outerHeight();n=$(window).height()-(this.$el.outerHeight()-m.outerHeight()-l.outerHeight())-10;m.css({maxHeight:(n/2)-((n/2)%k),overflowY:"auto"});l.css({maxHeight:(n/2)-((n/2)%this.ip_sheet.rowHeight),overflowY:"auto"})},set_colhead_padding:function(){var k,m,l;k=this.ip_sheet.$el.find(".table_listcnt");m=k.width();l=k.find(">ul").width();k.parent().find(".table_head_ul").css({paddingRight:m-l>3?(m-l)+"px":0})},set_row_balance:function(m,l){var k=this;m.$el.parent().find(">.ip_sheet_balance_txt").removeClass("_negative").addClass("filled"+(l<0?" _negative":"")).html("Closing Balance : "+to_money(l))},get_total:function(k){return _.reduce(this[k?"top_ips":"ip_sheet"].get_value_list(["amount"]),function(l,m){return l+Number(m.amount)},0)},set_total:function(l,k){if(k){l=this.get_total()}this.form.$el.find(".jrform_titem.total_amount > span").text(to_money(l))},set_form_data:function(){var n,l,k;l=this;n=l.options;if(n.item_data||n.method=="create"){this._set_form_data()}else{k=new app.models.Voucher;k.context=l;k.set({id:l.options.data.voucher_id});k.fetch({success:function(o,m){n.data=m;o.context._set_form_data()},error:function(m,o){alert("Error")}})}},_set_form_data:function(){var r,y,w,v,u={},k,o,s,p,n,m,l,t,x;w=this;y=w.options;if(w.defaccs){w.ip_sheet.render();t=w.form.components;if(y.method=="update"){v=y.data;s=_.mapObject(v.data,function(z){return z.value});w.form.set_values(_.pick(s,["doc_no","date","transaction_vchr_no","job_name",this.first_account_sel,"description"]));w.form.trigger("keydown",t.date,{keyCode:13});t.date.trigger_event("keyup",t.date,null);n=t[w.first_account_sel];n.data={items:[{name:s[this.first_account_sel],subacc_of:(w.doc_type=="receipt"?s.dr_account_subacc_of:s.cr_account_subacc_of),id:s[this.first_account_sel2],c_balance:s.account_balance}]};n.trigger_event("item_selected",n,null,{});var q;q=this.top_ips;if(q.$el.parent().is(":visible")){s=v.pay_data;for(i in s){if(s[i].mode_of_payment=="cheq"){s[i].transaction_ref=s[i].transaction_ref.replace(get_cfg("cheq_prefix")+": ","")}this.top_ips.insertRow(s[i]);m=this.top_ips.lastRow().cols.mode_of_payment.ip;m.trigger_event("changed",m,null,{is_load:true})}}s=v.item_data;for(i in s){x=w.ip_sheet.insertRow(_.pick(s[i],[w.ips_account_sel,"amount"]));p=w.ip_sheet.rows.length-1;m=s[i];l=x.cols[this.ips_account_sel].ip;l.data={items:[{name:m[w.ips_account_sel],c_balance:m.c_balance,acc_type:m.acc_type,id:m[w.ips_account_sel2]}]};l.trigger_event("item_selected",l,null,{});ref_col=x.cols.ref_type;ref_col.ip.$el.parent().find(".v_reftype")[m.ref_type=="against_ref"||m.ref_type=="advance"?"show":"hide"]();if(m.ref_type){ref_col.ip.set_value(m.ref_type);if(m.ref_type=="against_ref"){for(i in m.new_refs){m.new_refs[i].dr_cr=m.new_refs[i].dr_cr==1?"Dr":"Cr"}x.extra_values.adj_data={ref_items:_.indexBy(m.rs_items,"ref_id"),new_refs:m.new_refs}}else{if(m.ref_type=="advance"){x.extra_values.adj_data={ref_items:m.new_refs}}}}if(m.sch_data){x.extra_values.sch_data={items:m.sch_data,account_name:m.sch_data[0].account_name}}if(m.cost_alloc){x.extra_values.cost_alloc=m.cost_alloc}if(m.job_alloc){x.extra_values.job_alloc=m.job_alloc}}w.set_total(null,true)}else{o=new Date();w.form.set_values({date:o.getDate()+"/"+(o.getMonth()+1)+"/"+o.getFullYear()});w.top_ips.insertRow({});w.top_ips.$el.parent().hide();w.ip_sheet.insertRow({});w.set_total(0);w.form.trigger("keydown",t.date,{keyCode:13});t.date.trigger_event("keyup",t.date,null)}}},check_balance:function(){var p,m,s,t,n,o,l,q,r,k;r=this;t=r.ip_sheet.rows;n=r.form.components[r.first_account_sel];q=r.form.components.date.get_value();k=r.defaccs;l=n.get_selected_data();if(!l){return}if(_.in_list(l.id,[k.cheque_cnt_acc,k.cheq_in_hand])){o="cash"}else{o=_.reduce(r.top_ips.get_value_list(["mode_of_payment","due_date"]),function(u,w){var v=w.mode_of_payment;if(u=="pd"){return u}u=v=="cheq"&&parse_date(w.due_date)>parse_date(q)?"pd":"cd";return u},"")}s=0;for(m in t){s+=Number(t[m].cols.amount.ip.get_value())}if(o!="cash"){p=Number(l.c_balance)-Number(l.payable_amount);if(this.doc_type=="payment_voucher"&&o=="cd"&&s>p){n.render_error("Insufficient Fund: Available Account Balance = "+to_money(p))}else{n.render_info("<span class='balance_info "+(l.c_balance<=0?"_zero":"")+"'>Balance as per bank book: "+to_money(l.c_balance)+"</span><br> (Avaiable Account balance: "+to_money(p)+")")}}else{p=Number(l.c_balance);if(this.doc_type=="payment_voucher"&&s>p){n.render_error("Insufficient Fund: Current Balance = "+to_money(p))}else{n.render_info("<span class='balance_info "+(l.c_balance<=0?"_zero":"")+"'>Curr Balance : "+to_money(l.c_balance)+"</span>")}}},show_adj_popup:function(m,k,l,n){m.extra_values=m.extra_values||{};if(k=="against_ref"){app.popups.MethodAdjSelPopup.show({method:"read",scope:this,row:m,params:l,pending_sel:"amount_due",ds_options:{},ref_type:k,data:{adj_data:m.extra_values.adj_data},callback:n,account_name:m.cols[this.ips_account_sel].ip.get_value(true)})}else{app.popups.BillWiseDetails.show({method:"set",invoker:this,callback:n,ptype:"advance",data:m.extra_values.adj_data})}},validate_date:function(k,n){var m,l,o,o=this.form.components;m=k.get_value();l=app.validate_vchr_date(m);if(!l){o[this.first_account_sel].url_args={to_date:m};o[this.first_account_sel][m?"enable":"disable"]();if(n.type=="keydown"){this.form.focus(k,"next");k.enterpressed=true;setTimeout(function(){k.enterpressed=false},100)}for(i in this.ip_sheet.rows){this.ip_sheet.rows[i].cols[this.ips_account_sel].ip.url_args={to_date:m}}}else{k.render_error(l)}},form_event_handler:function(v,r,t){var p,o,n,m,l,u,s,w,x,q,k;w=this;l=this.form.components;if(v=="keydown"&&t.keyCode==13){p=this.form.validate(r,true);if(p){r.render_error(p.msg)}else{if(r.name=="date"){this.validate_date(r,t)}else{if(r.$el.is(":last-child")){if(w.top_ips.$el.is(":visible")){w.top_ips.focusRow(0)}else{w.ip_sheet.focusRow(0)}}else{o=w.form.focus(r,"next");if(!o){w.$el.find(".popup_footer ."+(w.options.method=="create"?"op_btn_snnx":"op_btn_sncl")).focus()}}}}if(t.preventDefault){t.preventDefault();t.stopPropagation()}}else{if(v=="focusout"&&r.name=="date"){if(!r.enterpressed){this.validate_date(r,t)}}else{if(v=="keyup"&&r.name=="date"&&l.doc_no.disabled){n=r.get_value();u=app.generate_doc_no;p=w.doc_type;s=w.options.data;o=w.options.method=="create"?u(p,n,1,true):s.doc_no;l.doc_no.set_value(o)}else{if((v=="item_selected"||v=="keyup")&&(r.name=="cr_account_name"||r.name=="dr_account_name")){p=r.get_selected_data();if(p){k=w.defaccs;r.render_info("<span class='balance_info "+(p.c_balance<=0?"_zero":"")+"'>Curr Balance : "+to_money(p.c_balance)+"</span>");o=(_.in_list(p.subacc_of,[k.bank_accounts,k.branches])||_.in_list(p.id,[k.cheque_cnt_acc,k.cheq_in_hand]))}else{o=false;r.render_info()}if(v=="item_selected"){this.top_ips.release(true);if(o&&t){this.top_ips.insertRow({})}this.top_ips.$el.parent()[o?"show":"hide"]()}}else{if(v=="clicked"&&r.name=="print_btn"){app.p_view_inst.Voucher.print_data(w.options.data.voucher_id)}}}}}},topips_event:function(u,t,m,s,p){var q,n,l,r,v,k,o;var w=this;o=w.top_ips;row=o.getRow(t);if(p){r=p.comp;k=o.get_components(row)}if(u=="row_insert"){q=get_cfg("rcpy_set_status")=="true";l=w.form.components[w.first_account_sel].get_selected_data();if(t==0){n="._caccount_name,._cmode_of_payment"}else{if(!l){n="._caccount_name,._cmode_of_payment,._ctransaction_ref,._cdue_date,._cinstr_acc_no,._camount"+(w.options.method=="create"&&get_cfg("rcpy_set_status")=="true"?",._cstatus,._cstatus_date":"")}}if(t>0){o.$el.find(".table_head_ul >*,.table_list_ul>*").show()}if(n){o.$el.find(".table_head_ul >:not("+n+"),.table_list_ul>:not("+n+")").hide()}if(q){v=row.cols.status.ip;console.log(l);v.set_options(_.omit(v.options2,l&&l.subacc_of==w.defaccs.branches?["cl"]:["ut"]));w.topips_event("changed",t,"status",null,{comp:v,is_load:true})}if(t==0){w.set_max_height()}w.center();if(l&&l.id==w.defaccs.cheq_in_hand){v=row.cols.mode_of_payment.ip;v.set_options([{cheq:"Cheque"}]);v.set_value("cheq",true)}}else{if(u=="changed"&&m=="status"){tmp1=r.get_value();k.status_date[tmp1=="cl"?"show":"hide"](true);k.status_date[tmp1=="cl"?"enable":"disable"]();if(tmp1=="cl"&&!p.is_load){k.status_date.set_value("")}}else{if(u=="changed"&&m=="mode_of_payment"){tmp1=p.comp.get_value();row.el.find(".table_head_ul >*,.table_list_ul>*").removeClass("_hidden");if(o.rows.length==1){o.$el.find(".table_head_ul >*,.table_list_ul>*").show()}if(tmp1=="cash"){n="._caccount_name,._cmode_of_payment,._ctransaction_ref,._camount"}else{if(tmp1=="bnkt"){n="._caccount_name,._cmode_of_payment,._ctransaction_ref,._camount"}else{if(tmp1=="cheq"||tmp1=="dd"){l=w.form.components[w.first_account_sel].get_selected_data();n="._caccount_name,._cmode_of_payment,._ctransaction_ref,._cdue_date,._cinstr_acc_no,._camount"+(get_cfg("rcpy_set_status")=="true"&&(!_.in_list(l.id,[w.defaccs.cheque_cnt_acc,w.defaccs.cheq_in_hand]))&&w.options.method=="create"?",._cstatus,._cstatus_date":"")}else{n="._cmode_of_payment"}}}if(n){row.el.find(".table_head_ul >:not("+n+"),.table_list_ul>:not("+n+")").addClass("_hidden");if(o.rows.length==1){o.$el.find(".table_head_ul >:not("+n+"),.table_list_ul>:not("+n+")").hide()}}if(tmp1!=""){n=k.transaction_ref;n.set_label(tmp1=="cheq"?"Cheque No":"Transaction Ref");n.$el.attr("data-cheq_prefix",get_cfg("cheq_prefix")+":");n.$el[tmp1=="cheq"?"addClass":"removeClass"]("_cheq_no _cheq_nolen_"+(get_cfg("cheq_prefix").length))}if(!p.is_load){w.check_balance()}}else{if(u=="text_changed"&&s.keyCode==8&&s.shiftKey){o.backspace_pressed(row,t,m,s)}else{if(u=="before_keydown"||u=="enterkey_press"){s.preventDefault();if(o.focusColumn(row,m,"next",true,{select:false})==false){if(u=="enterkey_press"&&o.isRowEmpty(row,null,["status"])){w.ip_sheet.focusRow(0);return}tmp1=o.validate_row(row,true)}}}}}}},ipsheet_event:function(r,t,l,q,n){var o,m,u,k;var s=this;var p=t;t=this.ip_sheet.getRow(t);switch(r){case"keydown":if((this.ip_sheet.dlt_lock&&q.keyCode==8)||(l=="amount"&&t.cols.ref_type.ip.get_value()=="against_ref"&&is_charkey(q))){q.preventDefault()}break;case"item_selected":case"changed":if(l==this.ips_account_sel){o=n.comp.get_selected_data();s.set_row_balance(n.comp,o.c_balance);u=t.cols.ref_type.ip;if(o.acc_type=="asset"||o.acc_type=="liability"){m=["onaccount","against_ref","advance"];u.show();u.set_options(_.pick(this.ip_sheet.schema.ref_type.ip_options.options2,m))}else{u.hide()}t.cols.ref_type.adj_data=undefined}else{if(l=="ref_type"){u=t.cols.ref_type.ip;if(n.value=="against_ref"||n.value=="advance"){this.active_row=t;tmp3=app.validate_vchr_date(this.form.components.date.get_value());if(tmp3){this.form.components.date.render_error(tmp3);return}o=t.cols[this.ips_account_sel].ip.get_selected_data();m=this.get_params(o.id,n.value);if(m.has_error){return}if(!n.no_reset){u.set_value("");t.extra_values.adj_data=null;u.$el.parent().find(".v_reftype").hide()}this.show_adj_popup(t,n.value,m,function(w){var v;u.set_value(n.value);t.extra_values=t.extra_values||{};t.extra_values.adj_data=w;t.cols.amount.ip.set_value(Math.abs(w.total_amount));u.$el.parent().find(".v_reftype").show();this.set_total(null,true);this.check_balance()})}else{u.$el.parent().find(".v_reftype").hide();t.extra_values=t.extra_values||{};t.extra_values.adj_data=undefined}}}break;case"add_new_clicked":if(l=="cr_account_name"||l=="dr_account_name"){app.popups.AccountPopup.show({method:"create",is_cntlacc:false,data:{name:n.comp.get_value(true),is_cntlacc:false},hide_cont_btn:true,invoker:this,callback:function(w,v){n.comp.set_value(v.name+v.suffix);n.comp.data={items:[{name:v.name+v.suffix,c_balance:v.c_balance,acc_type:v.acc_type}]};n.comp.trigger_event("item_selected",n.comp)}})}break;case"text_changed":if(l==this.ips_account_sel&&q.keyCode==8){if(this.ip_sheet.backspace_pressed(t,p,l,q)){t.cols.ref_type.ip.set_options({});t.cols.ref_type.adj_data=undefined;n.comp.$el.parent().find(">.ip_sheet_balance_txt").removeClass("filled").html("")}}else{if(l=="amount"){this.set_total(null,true);this.check_balance()}}break;case"before_keydown":case"enterkey_press":if((r=="before_keydown"&&(q.keyCode!=13||n.comp.menu_open))||(r=="enterkey_press"&&l==this.ips_account_sel)){break}k=s.form.components;q.preventDefault();if(this.ip_sheet.focusColumn(t,l,"next",true)===false){tmp1=t.cols[this.ips_account_sel].ip.get_selected_data();if((get_cfg("en_jobs")=="true"&&k.job_name.get_value()=="")||(get_cfg("en_costcenter")=="true"&&tmp1&&tmp1.acc_type=="expense"&&tmp1.cost_appl)){app.popups.AllocationPopup.show({invoker:s,method:"set",qty_based:false,show_tabs:["cost_alloc",get_cfg("en_jobs")=="true"&&k.job_name.get_value()==""?"job_alloc":null],amount:Number(t.cols.amount.ip.get_value()),row:t,callback:function(w,v){w.extra_values=w.extra_values||{};_.extend(w.extra_values,v);setTimeout(function(){s.validate_row(w,true)},200)}});return}else{this.validate_row(t,true)}}break;case"row_insert":tmp1=t.cols[this.ips_account_sel].ip;m=tmp1.$el.parent();tmp3=this.form.components.date.get_value();s.center();if(!app.validate_vchr_date(tmp3)){tmp1.url_args={to_date:tmp3}}if(m.find(">.balance_txt").length==0){m.append("<span class='ip_sheet_balance_txt'></span>")}tmp1.$el.parent().find(">.ip_sheet_balance_txt").html("-");if(!s.ip_sheet.rowHeight){s.ip_sheet.rowHeight=tmp1.$el.closest(".tl_li").outerHeight();s.set_max_height()}tmp1=t.cols.ref_type.ip.$el.parent();$('<span class="component btn _type1 _theme1 v_reftype">Show</span>').appendTo(tmp1).hide();break;case"clicked":if($(q.target).hasClass("v_reftype")){tmp1=t.cols[l].ip;if(_.in_list(tmp1.get_value(),["advance","against_ref"])){this.ipsheet_event("changed",p,l,q,{value:tmp1.get_value(),no_reset:true})}}break}},validate_row:function(v,l,n){var u=this,o,q,t,p,k,r,m,s;k=this.ip_sheet.get_components(v);this.vald_form.components=k;r=this.vald_form.validate()||{};o=this.get_total(true);q=this.get_total();this.vald_form.renderErrors(r);if(!_.isEmpty(r)){this.ip_sheet.focusColumn(v,Object.keys(r)[0]);return false}this.set_total(q);if(this.ip_sheet.isLast(v)&&l){if(o==q||this.ip_sheet.isRowEmpty(v)){this.form.components.description.focus();return true}t=this.insertRow(n)}else{t=this.ip_sheet.nextRow(v)}setTimeout(function(){u.ip_sheet.focusRow(t)},20);return true},insertRow:function(k){return this.ip_sheet.insertRow({},k)},submit_form:function(l){var k=this;if(k.options.method=="update"&&k.form.components.save_changes.get_value()!="true"){app.notifications.add("Info",'Please put check mark on "Save changes" before saving',"info",800);return false}if(this.doc_type=="payment_voucher"){asset_comp=this.form.components[this.first_account_sel];asset_data=asset_comp.get_selected_data();if(!asset_data){return}total_amount=this.get_total();if(!_.in_list(asset_data.id,[k.defaccs.cheque_cnt_acc,k.defaccs.cheq_in_hand])){asset_balance=Number(asset_data.c_balance)-Number(asset_data.payable_amount)}else{asset_balance=Number(asset_data.c_balance)}if(total_amount>asset_balance){app.Prompt.show({context:this,data:l,type:"warning",head:"Insufficient Account Balance",text:"Do you want to continue with insufficient account balance?",prompt_type:"yes_no",callback:function(m,n){if(m=="yes"){this._submit_form(n)}}})}else{return this._submit_form(l)}}else{return this._submit_form(l)}},_submit_form:function(r){var l,n,k=this,q,p,o,m;m=this.options;l=this.form.get_values();q=this.ip_sheet.get_value_list();l.pay_data=this.top_ips.get_value_list();l.acc_list=q;if(k.options.method=="update"){l.voucher_id=l.id=k.options.data.voucher_id}n=new this.model;n.set(l);k.form.renderErrors();n.sync(k.options.method=="update"?"update":"create",n,{success:function(s){if(m.callback&&m.invoker){m.callback.call(m.invoker,"save_success",s)}app.set_last_no(s);app.notifications.add(s.head,s.msg,"success");if(m.method=="update"||(r.type=="click"&&$(r.target).hasClass("op_btn_sncl"))){k.close()}else{k.render(true,true);k.form.components.date.focus()}},error:function(w){var x,s,v,u,t;if(w.responseJSON){x=w.responseJSON.errors;if(x){if(x.form_errors){k.form.renderServerErrors(w,x.form_errors);u=k.form.components[Object.keys(x)[0]];t=x.form_errors[Object.keys(x.form_errors)[0]]}if(x.pay_data_errors){console.log(x.pay_data_errors);k.top_ips.renderErrors(null,x.pay_data_errors,{focus_first:true})}if(x.acclist_errors){k.ip_sheet.renderErrors(null,x.acclist_errors,{focus_first:true})}if(!t){t=x[Object.keys(x)[0]]}}if(u){u.focus()}}app.notifications.add("",t?t:"Unable to save the document please review the details provided","error")}})},form_reset:function(){var k=new Date(),l;l=this.form.components.date;this.form.set_values({date:k.getDate()+"/"+(k.getMonth()+1)+"/"+k.getFullYear()});l.trigger_event("keyup",l,null)}});app.popup_views.Receipt=e.extend({doc_type:"receipt",head:"Receipt",id:"receipt_popup",invoker:null,model:app.models.Receipt,form_fields:function(l){var k;k={};k=_.extend({},_.pick(l,["_top_ips_cnt","_ipsheet_cnt","_ds_cnt","_bottom_cnt","print_btn","save_changes"]));k._form_top_cnt=_.extend({},l._form_top_cnt);k._form_top_cnt.fields=_.pick(l._form_top_cnt.fields,["doc_no","date","transaction_vchr_no","dr_account_name",get_cfg("en_jobs")=="true"?"job_name":null]);return k},tr_vchr_no_label:"Receipt Vchr No",ip_sheet_schema_keys:["cr_account_name","ref_type","amount"],first_account_sel:"dr_account_name",first_account_sel2:"dr_account_id",ips_account_sel:"cr_account_name",ips_account_sel2:"cr_account_id",doc_no_type:"doc_no",acc_sel2:"receivable",get_params:function(l,k){var m;m={account_id:l,negate_due:false,to_date:this.form.components.date.get_value(),unresolved:true,calculate_total:true};if(this.options.method=="update"){m.ignore_unresolved_from=this.options.data.voucher_id;m.exclude_ref_from=this.options.data.voucher_id}return m}});app.popups.Receipt=new app.popup_views.Receipt();app.popup_views.PaymentVoucher=e.extend({doc_type:"payment_voucher",head:"Payment Voucher",id:"payment_voucher_popup",invoker:null,model:app.models.PaymentVoucher,form_fields:function(l){var k;k={};k=_.extend({},_.pick(l,["_form_top_cnt","_top_ips_cnt","_ipsheet_cnt","_ds_cnt","_bottom_cnt","print_btn","save_changes"]));k._form_top_cnt=_.extend({},l._form_top_cnt);k._form_top_cnt.fields=_.pick(l._form_top_cnt.fields,["doc_no","date","transaction_vchr_no","cr_account_name",get_cfg("en_jobs")=="true"?"job_name":null]);return k},tr_vchr_no_label:"Payment Vchr No",ip_sheet_schema_keys:["dr_account_name","ref_type","amount"],first_account_sel:"cr_account_name",first_account_sel2:"cr_account_id",ips_account_sel:"dr_account_name",ips_account_sel2:"dr_account_id",doc_no_type:"doc_no",acc_sel2:"payable",get_params:function(l,k){var m,n;n={account_id:l,negate_due:true,to_date:this.form.components.date.get_value(),unresolved:true,calculate_total:true};if(this.form.components.cr_account_name.data){n.amount_sel=this.form.components.cr_account_name.get_selected_data().id==this.defaccs.cheque_cnt_acc?"gross_amount":"net_amount"}else{this.form.renderErrors({cr_account_name:{msg:"This field is required"}});return{has_error:true}}if(this.options.method=="update"){n.ignore_unresolved_from=this.options.data.voucher_id;n.exclude_ref_from=this.options.data.voucher_id}return n}});app.popups.PaymentVoucher=new app.popup_views.PaymentVoucher();FB_Module.init_fn(function(){app.SideMenu.add_item({item_id:"vouchers_cnt",label:"Voucher Registers",index:5.5,is_disabled:!AL.any_access(["receipt.list","payment.list"])});app.SideMenu.add_item({view:"receipts",item_id:"receipt_reports",index:30,under:"vouchers_cnt",label:"Receipts",is_disabled:!AL.any_access("receipt.list")});app.SideMenu.add_item({view:"payment_vouchers",item_id:"payment_voucher_reports",index:40,under:"vouchers_cnt",label:"Payments",is_disabled:!AL.any_access("payment.list")});app.SideMenu.add_item({item_id:"accvouchers_cnt",label:"New Voucher",index:4,is_disabled:!AL.any_access(["receipt.create","payment.create"])});app.SideMenu.add_item({item_id:"receipt",index:30,under:"accvouchers_cnt",label:"Receipt",is_disabled:!AL.any_access("receipt.create"),callback:function(){app.popups.Receipt.show({method:"create"})}});app.SideMenu.add_item({item_id:"payment_voucher",index:40,under:"accvouchers_cnt",label:"Payment",is_disabled:!AL.any_access("payment.create"),callback:function(){app.popups.PaymentVoucher.show({method:"create"})}})})});FB_Module.register({index:2},function(){var a;var d={fields:{doc_no:{head_label:"Doc No",width:"130px"},date:{head_label:"Date",width:"95px"},account_name:{head_label:"Account",width:"15%",url:"/accounts/?name={{value}}&is_cntlacc=false&pagination=false"},particulars:{head_label:"Particulars",width:"25%"},policy_no:{head_label:"Policy No",width:"20",f_key:"ref_no"},description:{head_label:"Description",width:"10%"},amount:{head_label:"Amount",type:"money",wrapSPAN:true,align:"right",width:"120px",prefix:"{currency}"}},show_items:["doc_no","date","account_name","particulars","description","amount"],filter_enable:["doc_no","date","account_name","policy_no","description"]};a=gen_model("/settlements/");var c={ref_no:{type:"inputbox",id:"_type1 _w8em",label:"Ref No",dlgTo:"scope"},narration:{type:"inputbox",id:"_type1 _w12em",label:"Description",dlgTo:"scope"},amount:{type:"inputbox",id:"_type1 _w8em",label:"Amount Due",dlgTo:"scope"},dr_cr:{type:"selectbox",id:"_type1 _w7em",default_option:"",options:[{"-1":"Dr"},{"1":"Cr"}],label:"Dr/Cr",dlgTo:"scope"}};var b={doc_no:{type:"inputbox",id:"_w8em _md _type3",label:"Doc #",always_disable:true},date:{type:"datefield",id:"_type1 _w7em",label:"Date",dlgTo:"scope"},account_name:{type:"combobox",label:"Account Name",url:"/accounts/?pagination=false&is_cntlacc=false&under_defacc=receivable,payable&name={{value}}",id:"_type1 _w20em",dlgTo:"scope"},description:{type:"inputbox",id:"_w30em _md _type1",label:"Narration"}};app.popups.SettlementPopup=new (app.Popup.extend({head:"Settlement",id:"settlement_popup",class_name:"_mw1100x",doc_model:app.models.Reference,doc_type:"settlement",model:a,events:{"click .op_btn":"submit_form"},afterShow:function(){var e=this;e.ds.$el.css("height","auto");e.ds.$el.find(".ds_container").css("height","auto");setTimeout(function(){e._after_show()})},_after_show:function(){var e,h,g,f;f=this;g=[f.ds.$el.find(".ds_container"),f.ds.$el];for(h in g){e=g[h];e.css({height:$(window).height()-(e.closest(".popup").outerHeight()-e.outerHeight())-20-(h==0?28:0)})}f.ds.per_page=Math.floor((f.ds.$el.find(".ds_container").height()-32)/23);f.center()},render:function(f,l){var o,n,g,e,h,k,j;n=this;o=n.options;if(!f){n.form=new app.Form({class_name:"_mgbt_1em _brd_btm",appendTo:n.$el.find(".popup_body"),default_attr:{class_name:"_comp_inline _mgrt_1em _sm2 "},fields:b});n.form.renderInputs();n.listenTo(n.form,"all",n.doc_form_ev_handler);n.ref_filter_form=new app.Form({class_name:"_mgbt_1em",appendTo:n.$el.find(".popup_body"),default_attr:{class_name:"_comp_inline _mgrt_1em _sm2 "},fields:c});n.ref_filter_form.renderInputs();n.listenTo(n.ref_filter_form,"all",this.settle_form_handler);n.ds=new app.RefDS({appendTo:n.$el.find(".popup_body"),head:"Unsettled/Partially Settled References",idAttr:"id",has_pagination:true,handle_pagination:true,class_name:"ds_pagin_pullup",ds_id:"ds_invoices2",model:new n.doc_model});n.ds.init({params:{},is_settle_voucher:true,ds_options:{total_drcr:true}})}n.setMode("idle");app.set_docno_field(this.doc_type,this.form);n.ds.clear();if(this.options.method=="update"){if(o.data){m=new n.model;m.context=n;m.set({id:this.options.data.voucher_id});m.fetch({success:function(p,i){adj_data={ref_items:_.indexBy(i.ref_items,"ref_id")};p.context.form.set_values(_.pick(i,["doc_no","date","account_name"]));p.context.ds.load_data(adj_data);setTimeout(function(){p.context.ds.load_ds({account_name:i.account_name,to_date:i.date,unresolved:true,ignore_unresolved_from:p.get("id")})},300)},error:function(i,p){alert("Error")}})}}else{tmp2=this.form.components.doc_no;tmp1=app.get_new_voucher_date();if(tmp2.disabled){tmp2.set_value(app.generate_doc_no(this.doc_type,tmp1,1,true))}this.form.set_values({date:tmp1});n.ds.load_ds({account_name:""})}},doc_form_ev_handler:function(j,h,i){var l,k,h,o,f,g,n;n=this;if(j=="keyup"&&h.name=="date"){dn_comp=this.form.components.doc_no;i.preventDefault();o=this.options;k=app.generate_doc_no;if(dn_comp.disabled){l=o.method=="create"?k(this.doc_type,h.get_value(),1,true):o.data.doc_no;this.form.components.doc_no.set_value(l)}}else{if(j=="item_selected"&&h.name=="account_name"){n.load_ds()}}},load_ds:function(){var e=this;options=e.options;tmp=e.form.get_values(["account_name","date"]);e.ds.load_ds(_.extend({account_name:tmp.account_name,to_date:tmp.date,unresolved:true},(options.method=="update"?{ignore_unresolved_from:options.data.voucher_id}:null)),e.ref_filter_form.get_values(true),true)},settle_form_handler:function(i,g,j){var f,h;f=this;if((i=="keyup"&&is_charkey(j)&&g.name!="account_name")||i=="changed"||i=="item_selected"){f.load_ds()}else{if(i=="keydown"&&_.in_list(j.keyCode,[38,40])){this.ds.gl_ev_handler("keypress",j)}}},after_get_values:function(g,n){var k,j,i,l,h,f;f=this;h=f.options;k=[0,0];g.ref_items=j=f.ds.sel_ref_items;if(h.method=="update"){g.voucher_id=h.data.voucher_id}for(i in j){l=j[i];k[l.dr_cr==1?0:1]+=Number(l.amount)}if(wacky_round(k[0],2)!=wacky_round(k[1],2)){app.Prompt.show({context:this,data:null,type:"warning",head:"Debits and Credits do not tally",text:"Debits and Credits do not tally, do you want to continue?",prompt_type:"yes_no",callback:function(e){if(e=="yes"){this.post_submit(g,n)}}});return false}}}))();app.p_views.SettlementRegister=app.ListPageTemplate.extend({page_name:"settlement_register",model:a,no_newbtn:true,ds_options:{head:"Settlement Register",class_name:"hoverable ds_with_head",ds_id:"settlement_ds",idAttr:"voucher_id",flex_schema:d,has_filter:true,default_params:{}},header_btns:["print","export"],popup:app.popups.SettlementPopup,heading_plural:"Settlement Register",edit_voucher:function(e,f){this.popup.show({method:"update",invoker:this,callback:f,data:e})},initialize:function(){var e;this.context_menu_items=e=_.clone(this.context_menu_items);e.splice(0,0,{key:"export",value:"Export"});swap_obj_keys(this,"_context_item_click","context_item_click");this.init({create_el:true})},_context_item_click:function(f,e){if(e=="delete"){return this._context_item_click(f,e,{model:app.models.Voucher})}else{if(e=="export"){return this.export_data(f)}}return this._context_item_click(f,e)}});FB_Module.init_fn(function(){app.SideMenu.add_item({item_id:"vouchers_cnt",label:"Voucher Registers",index:5.5,is_disabled:!AL.any_access(["settlement.list"])});app.SideMenu.add_item({view:"settlement_register",item_id:"settlement_reg",index:90,under:"vouchers_cnt",label:"Settlement Register",replace:true,is_disabled:!AL.any_access("settlement.list")});app.SideMenu.add_item({item_id:"accvouchers_cnt",label:"New Voucher",index:4,is_disabled:!AL.any_access(["settlement.create"])});app.SideMenu.add_item({item_id:"settlement",under:"accvouchers_cnt",label:"Settlement",index:20,is_disabled:!AL.any_access("settlement.create"),callback:function(){app.popups.SettlementPopup.show({method:"create",params:{}})}})})});FB_Module.register({index:2},function(){var d,f,a,b,e,c;d={schema:[{class_name:"_w3 _theme1 _lg key_col"},{class_name:"_w3 _theme2 _lg name_col"}],data:[]};a={default_attr:{class_name:"_type1 _md _mgbt_1em"},fields:{name:{type:"inputbox",id:"prman_name",label:"Name"},font_size:{type:"selectbox",id:"_mgbt_05em _w10em",label:"Font Size",default_option:"",index:1,options:[{xs:"Extra Small"},{sm:"Small"},{md:"Medium"},{lg:"Large"}],label:"Font Size"}},validation:{name:{required:true}}};set_objs({uset_form_schema:a});f=Backbone.Model.extend({url:"/usersettings/"});app.popups.UserSettingPopup=new (app.Popup.extend({id:"usersettings_popup",head:"User Settings",events:{submit:"submit_form","click .op_btn":"submit_form"},model:f,render:function(j){var h,g,i;h=this;if(!j){h.form=new app.Form(_.extend({appendTo:h.$el.find(".popup_body")},a));h.form.renderInputs();h.listenTo(h.form,"all",h.form_ev_handler)}i=h.options;h.setMode("idle");h.form.reset();if(i.data){h.form.set_values(i.data)}else{if(h.options.member_id){g=new h.model;g.fetch({data:$.param({member_id:i.member_id}),success:function(l,k){h.form.set_values(k.data)},error:function(k){}})}}},after_get_values:function(g){g.member_id=this.options.member_id},form_ev_handler:function(h,g,i){}}))();c={default_attr:{class_name:"_type1 _md _mgbt_1em"},fields:{password1:{type:"inputbox",ip_type:"password",id:"chpass_pass1",label:"New Password"},password2:{type:"inputbox",ip_type:"password",id:"chpass_pass2",label:"Retype New Password"}},validation:{name:{required:true}}};app.popups.ChangePasswordPopup=new (app.Popup.extend({id:"changepass_popup",head:"Change Password",events:{submit:"submit_form","click .op_btn":"submit_form"},model:f,render:function(g){if(!g){this.form=new app.Form(_.extend({appendTo:this.$el.find(".popup_body")},c));this.$el.find(".op_btn").text("Change");this.form.renderInputs()}this.setMode("idle")},submit_form:function(l){var j,k,h,m,i,g;g=this;i=new Backbone.Model;i.url="/usersettings/change_password/";l.preventDefault();j=this.options;k=this.form;h=k.get_values();m=k.validate();k.renderErrors(m);h.no_lnk=j.no_lnk;if(!m){if(!j.member_id&&!j.use_logged_user){alert("invalid input");return}if(j.member_id){h.member_id=j.member_id}i.set(h);this.setMode("working");Backbone.sync("create",i,{success:function(n){g.setMode("idle");if(j.callback){j.callback.call(j.invoker||this,"save_success",n)}if(j.invoker){j.invoker.trigger("popup_event","save_success",n)}if(!g.no_close_after_submit){g.close()}},error:function(n){g.setMode("idle");k.renderServerErrors(n)}})}}}))();app.p_views.UserSettings=Backbone.View.extend({el:$(".mcarv_usersettings"),events:{"click .edit_btn":"edit_popup_show","click .change_pass_btn":"change_pass_popup_show"},initialize:function(){this.table=new app.Table({data:d,appendTo:this.$el});app.eventBus.on("show:usersettings",this.show,this)},edit_popup_show:function(){app.popups.UserSettingPopup.show({popup_type:"update",invoker:this,no_lnk:true,data:this.data,callback:function(){this.render()}})},change_pass_popup_show:function(){app.popups.ChangePasswordPopup.show({popup_type:"update",invoker:this,use_logged_user:true,data:null,callback:function(){app.notifications.add("Password Changed","The password has been changed successfully","success")}})},render:function(h){var l={},j,k,i,g=this;i=new f;i.fetch({success:function(n,m){g.data=m.data;for(j in m.datatable){k=m.datatable[j];l[j]=[k.key,k.value]}d.data=l;g.table.render(d)},error:function(m,n){}})},show:function(){app.pages.show_page(this);this.render()}})});FB_Module.register({index:2},function(){var a,c,d,f,e,g;c={fields:{due_date:{head_label:"Inst Date",width:"90px"},dr_accounts:{head_label:"Paid To",width:"40%",index:0,url:"/accounts/?pagination=false&is_cntlacc=false&acc_type_in=liability,asset&name={{value}}"},cr_account_name:{head_label:"Account",width:"40%",index:0,url:"/accounts/?pagination=false&is_cntlacc=false&under_defacc=bank_accounts&name={{value}}"},transaction_ref:{head_label:"Insrument No",width:"20%",index:0},total_amount:{head_label:"Amount",align:"right",width:"100px",type:"money",prefix:"{currency}"},vchr_date:{head_label:"Vchr Date",width:"90px"},cncl_bnc_date:{head_label:"Cncl/Bnc Date",width:"90px"},cleared_date:{head_label:"Cleared Date",width:"90px"},status:{head_label:"Status",key:"status_txt",width:"90px",choices:[{pd:"Pending"},{cl:"Cleared"},{bc:"Bounced"},{cn:"Replaced"}]},action:{head_label:"Action",width:"110px"}},show_items:["due_date","dr_accounts","cr_account_name","transaction_ref","total_amount","vchr_date","cncl_bnc_date","cleared_date","status","action"],filter_enable:["due_date","cr_account_name","dr_accounts","status","cleared_date"]};a={fields:{due_date:{head_label:"Inst Date",width:"90px"},cr_accounts:{head_label:"Received From",width:"40%",index:0,url:"/accounts/?pagination=false&is_cntlacc=false&acc_type_in=liability,asset&name={{value}}"},dr_account_name:{head_label:"Account",width:"40%",index:0,url:"/accounts/?pagination=false&is_cntlacc=false&under_defacc=bank_accounts&name={{value}}"},transaction_ref:{head_label:"Insrument No",width:"20%",index:0},total_amount:{head_label:"Amount",align:"right",width:"100px",type:"money",prefix:"{currency}"},vchr_date:{head_label:"Vchr Date",width:"90px"},deposit_date:{head_label:"Deposited Date",width:"90px"},cncl_bnc_date:{head_label:"Cncl/Bnc Date",width:"90px"},cleared_date:{head_label:"Cleared Date",width:"90px"},status:{head_label:"Status",key:"status_txt",width:"90px",choices:[{pd:"Pending"},{dp:"Deposited"},{cl:"Cleared"},{bc:"Bounced"},{cn:"Replaced"}]},action:{head_label:"Action",width:"110px"}},show_items:["due_date","cr_accounts","dr_account_name","transaction_ref","total_amount","vchr_date","deposit_date","cncl_bnc_date","cleared_date","status","action"],filter_enable:["due_date","dr_account_name","cr_accounts","status","cleared_date"]};f={default_attr:{class_name:"_type1 _md _mgbt_1em"},fields:{status:{type:"selectbox",label:"Status",id:"_w10em",dlgTo:"scope",options2:{pd:"Pending",dp:"Deposited",cl:"Cleared",bc:"Bounced",cn:"Replaced"}},account_name:{type:"combobox",label:"Bank Account",url:"/accounts/?pagination=false&is_cntlacc=false&under_defacc=bank_accounts&excl_defacc=cheq_in_hand,cheque_cnt_acc&name={{value}}",id:"_w25em",dlgTo:"scope"},status_date:{type:"datefield",id:"svipp_date",label:"Date"}}};ChequeStatusPopup=new (app.Popup.extend({id:"pd_clear_popup",head:"",events:{submit:"submit_form","click .op_btn":"submit_form"},btn_map:{update:["Update","Updating"]},head_map:{update:["Change status","Changing status"]},after_get_values:function(j){j.op="change_instr_status"},render:function(l){var n,j,m,k;k=this;if(!l){k._templ=_.template($("#cheque_clearing_template").html());k.$el.find(".popup_body").append('<div class="_mgbt_1em _lh15 _pdb5x _hr _chq_det"></div>');k.form=new app.Form(_.extend({appendTo:k.$el.find(".popup_body")},f));k.form.renderInputs();k.listenTo(k.form,"all",k.form_ev_handler)}k.form.reset();k.form.renderErrors();k.setMode("idle");n=k.options.data.data;j={cash:"Cash",cheq:"Cheque",dd:"DD",bnkt:"Bank Transfer"};m=k.form.components;m.status.set_options(_.omit(m.status.options2,k.options.vtype=="notes_payable"?["dp"]:null));this.form_ev_handler("changed",m.status,null,{value:n.status});this.form.set_values(_.pick(n,["status","status_date","account_name"]));this.$el.find(".popup_body > ._chq_det").html(this._templ(_.extend({amount:to_money(n.total_amount,2),party:n.cr_accounts||n.dr_accounts,mop:j[n.mode_of_payment]},n)))},form_ev_handler:function(l,j,n,o){var k,m;k=this.form.components;m=this.options.data.data;if(l=="changed"&&j.name=="status"){k.status_date[o.value=="pd"?"hide":"show"]();k.status_date.set_value("");k.account_name[m.dr_account_defkey=="cheq_in_hand"&&((o.value=="cl"&&m.status!="dp")||o.value=="dp")?"show":"hide"]()}}}))();var b={after_init:function(){this.form=new app.Form({default_attr:{class_name:"_type1 _md"},fields:{from_date:{type:"datefield",id:"_nobg _w8em _mgrt_05em",label:"From Date"},to_date:{type:"datefield",label:"To Date",id:"_nobg _w8em _mgrt_05em"},submit:{type:"button",attrs:{type:"submit"},id:"_mgtp_10x",label:"Submit"}},validation:{from_date:{required:true},to_date:{required:true}},appendTo:this.$el.find(".float-right")});this.form.renderInputs();this.listenTo(this.form,"all",this.form_ev_handler)},ds_handler:function(u,n,l,s){var q,r,k,j,t,m,p,o;if(u=="before_render"){j={pd:["Pending","dd"],dp:["Deposited","deposit_date"],cl:["Cleared","cleared_date"],bc:["Bounced","cncl_bnc_date"],cn:["Replaced","cncl_bnc_date"]};q=n;this.form.set_values(_.pick(q,["from_date","to_date"]));for(r=0;r<q.items.length;r++){k=q.items[r];k.status_txt=j[k.status][0];if(_.in_list(k.status,["cl","bc","cn"])){k[j[k.status][1]]=k.status_date}else{if(k.status=="dp"){k.status_date=k.deposit_date}}k.action={html:"<button class='component btn _type1 _theme1 _xs2 status_change_btn'>Change Status</button>"}}}else{if(u=="rendered"){m=l.$el.find(".table_list > li");j={pd:"_yellow",dp:"_blue",cl:"_green",bc:"_red",cn:"_orange"};for(r in l.rows){p=l.rows[r];o=m.eq(r).find(">ul>._cstatus_txt");if(p.status=="tr"){m.eq(r).find(".status_change_btn").addClass("disabled")}o.addClass(j[p.status])}}else{if(u=="li_selected"&&$(s.target).hasClass("btn")){s.stopPropagation();this.context_item_click(n)}else{if(u=="li_clicked"){row=l.get_row(n);app.router.navigate(app.generate_url("voucher",row.voucher_id,null),{trigger:true})}else{return this._ds_handler(u,n,l,s)}}}}},form_ev_handler:function(k,j,l){if(k=="form_submit"){app.router.navigate(app.generate_url(this.page_name,this.form.get_values(true)),{trigger:false,replace:true});this.ds.load({params:this.form.get_values(true),presv_flt:false})}},context_item_click:function(l,j){var k;k=this.ds.get_row(l);ChequeStatusPopup.show({method:"update",invoker:this,callback:this.popup_callback,model:this.model,vtype:this.page_name,data:{id:l,data:k}})},popup_callback:function(){this.ds.load({presv_flt:true})}};app.p_views.NotesReceivable=app.ListPageTemplate.extend({page_name:"notes_receivable",model:app.models.Receipt,disable_menu:true,ds_options:{idAttr:"id",head:"&nbsp;",default_params:{sv:"notes_rcv"},class_name:"hoverable ds_with_head",ds_id:"bills_receivable_ds",enable_sorting:true,sort_disabled_to:["cr_accounts"],has_filter:true,flex_schema:a},header_btns:["export"],drill_to_view:"voucher",no_newbtn:true,heading_plural:"Notes Receivable",initialize:function(){this.init({create_el:true});this.after_init()}});app.p_views.NotesReceivable.merge(b);app.p_views.NotesPayable=app.ListPageTemplate.extend({page_name:"notes_payable",model:app.models.PaymentVoucher,context_menu_items:[{key:"unclear",value:"Unclear"}],ds_options:{idAttr:"id",head:"&nbsp;",class_name:"hoverable ds_with_head",default_params:{sv:"notes_pybl"},ds_id:"bills_payable_ds",enable_sorting:true,has_filter:true,sort_disabled_to:["dr_accounts"],flex_schema:c},header_btns:["export"],drill_to_view:"voucher",no_newbtn:true,heading_plural:"Notes Payable",initialize:function(){this.init({create_el:true});this.after_init()}});app.p_views.NotesPayable.merge(b);d={name:{head_label:"Account Name",style:"width:28%",index:0},description:{head_label:"Description",style:"width:20%",index:1},c_balance:{head_label:"Closing Balance",type:"money",wrapSPAN:true,prefix:"{currency}",style:"width:13%;text-align:right",index:2},receivable_amount:{head_label:"PD Receivable",type:"money",wrapSPAN:true,prefix:"{currency}",style:"width:13%;text-align:right",index:2},payable_amount:{head_label:"PD Payable",type:"money",wrapSPAN:true,prefix:"{currency}",style:"width:13%;text-align:right",index:2},net_balance:{head_label:"Net Balance",type:"money",wrapSPAN:true,prefix:"{currency}",style:"width:13%;text-align:right",index:2}};g={default_attr:{class_name:"_type1 _md _mgrt_05em"},fields:{to_date:{type:"datefield",id:"_w8em",label:"To Date"},submit:{type:"button",id:" _md _mgtp_10x",label:"Submit",attrs:{type:"submit"}}},validation:{}};app.p_views.BankAccounts=app.ListPageTemplate.extend({page_name:"bank_summary",model:app.models.Account,disable_menu:true,ds_options:{idAttr:"id",head:"&nbsp;",class_name:"hoverable ds_with_head",ds_id:"banks_accounts_ds",enable_sorting:true,default_params:{under_defacc:"bank_accounts",receivable_amount:true,payable_amount:true,payable_amount:true,net_balance:true},schema:d},header_btns:["export"],no_newbtn:true,heading_plural:"Bank Summary",initialize:function(){this.init({create_el:true})},before_init:function(j){this.form=new app.Form(_.extend({appendTo:this.$el.find(".float-right"),class_name:"bankaccounts_filter"},g));this.form.renderInputs();this.listenTo(this.form,"form_submit",this.load_ds)},load_ds:function(){var j=this;this.ds.load({params:this.form.get_values(),success:function(l,k){j.form.set_values({to_date:k.to_date})},error:function(k,l){}})},ds_handler:function(l,p,m,n){var o,k,j;if(l=="li_clicked"){o=$(n.target).closest("li");j={};if(o.hasClass("banks_accounts_ds_tbl_creceivable_amount")){k="notes_receivable";j.dr_account_id=p}else{if(o.hasClass("banks_accounts_ds_tbl_cpayable_amount")){k="notes_payable";j.cr_account_id=p}}j.to_date=this.form.get_values()["to_date"];if(k){app.router.navigate(app.generate_url(k,null,j),{trigger:true})}else{app.router.navigate(app.generate_url("bank_accounts",p,j),{trigger:true})}}},edit_voucher:function(k,l){var j;j=k.source_vtype=="rc"?"Recepit":"PaymentVoucher";app.p_view_inst[j].edit_voucher(k,l)},on_page_url:function(k,j){if(k!=null){app.eventBus.trigger("show:bank_accountdetails",k,j);return}app.pages.show_page(this);app.TopButtons.set(this.header_btns);this.load_ds()}});var h={fields:{inst_date:{head_label:"Date",width:"100px"},particulars:{head_label:"Particulars",width:"50%"},vtype:{head_label:"Vchr Type",key:"vtype_txt",width:"100px"},instr_date:{head_label:"Inst Date",width:"100px"},vchr_ref_no:{head_label:"Transaction Ref No",width:"30%"},cheq_status:{head_label:"Status",width:"20%"},debit:{head_label:"Debit",type:"money",wrapSPAN:true,width:"120px",align:"right"},credit:{head_label:"Credit",type:"money",wrapSPAN:true,width:"120px",align:"right"},balance:{head_label:"Balance",type:"money",wrapSPAN:true,width:"150px",align:"right"}},show_items:["inst_date","particulars","vtype","instr_date","vchr_ref_no","cheq_status","debit","credit","balance"],filter_enable:["customer_name","policy_no","inst_date"]};app.p_views.BankAccountDetails=app.ListPageTemplate.extend({page_name:"bank_statements",disable_menu:true,ds_options:{idAttr:"id",head:"Statement",idAttr:"voucher_id",drill_to_view:"voucher",class_name:"hoverable ds_with_head",default_params:{inc_rcpv_details:true},flex_schema:h,ds_id:"banks_accountdet_ds",enable_sorting:true},header_btns:["export","print"],no_newbtn:true,heading_plural:"Bank Account Details",drill_to_view:"voucher",initialize:function(){var j=Backbone.Model.extend({urlRoot:"/transactions/"});this.model=j;this.init({create_el:true})},before_init:function(k){var j;j=$.extend(true,{appendTo:this.$el,class_name:"account_books_form1 _mg_bt_1em"},get_obj("account_report_form"));_.extend(j.fields.account,{label:"Select Bank Account",id:"_comp_inline _w30em _mgrt_1em _mgtp_1em",class_name:"_type2 _md"});this.ds_show_items_org=_.clone(this.ds_options.flex_schema.show_items);this.form=new app.Form(j);this.form.renderInputs();this.listenTo(this.form,"form_submit",function(m){var l,n;l=this.form.get_values();n=this.form.validate();if(n){this.form.renderErrors(n);return}this.load_ds(l)})},ds_handler:function(t,n,l,r){var q,k,m,s,o,p,j;j={pd:"Pending",dp:"Deposited",cl:"Cleared",bc:"Bounced",cn:"Replaced"};if(t=="before_render"){for(q=0;q<n.items.length;q++){k=n.items[q];if(k.rcpv_details){tmp=k.rcpv_details;k.instr_date=tmp.due_date;k.vchr_ref_no=tmp.tr_ref_no;if(tmp.mop){k.status=tmp.status;k.cheq_status=j[tmp.status]}}}}else{if(t=="rendered"){m=l.$el.find(".table_list > li");j={pd:"_yellow",dp:"_blue",cl:"_green",bc:"_red",cn:"_orange"};for(q in l.rows){p=l.rows[q];if(p.status){o=m.eq(q).find(">ul>._ccheq_status");o.addClass(j[p.status])}}}else{return this._ds_handler.apply(this,arguments)}}},load_ds:function(k){var j=this;app.router.navigate(app.generate_url(j.page_name,null,_.extend({},this.args,k)),{trigger:false,replace:true});this.ds.load({params:_.extend({},this.args,k),success:function(m,l){j.form.set_values(_.pick(l,["account","from_date","to_date"]))}})},print_data:function(){var j,k;j=app.generate_ext_url("transactions",null,_.extend({op:"print_preview",inc_rcpv_details:true},this.args,this.form.get_values()));window.open(j,"_blank").addEventListener("load",function(){this.focus();this.print()},false)},export_data:function(){$("#myiframwe").attr("src",app.generate_ext_url("transactions",null,_.extend({op:"export_to_excel"},null)))},on_page_url:function(j,k){app.pages.show_page(this);app.TopButtons.set(this.header_btns);this.args=k||{};this.args.is_group=(j=="our_book");if(j=="our_book"){this.args.excl_bv_excpt_chq_in_hand=true}this.ds.flex_schema.show_items=_.without(this.ds_show_items_org,j=="bank_book"?"cheq_status":null);this.$el.find(".content-topsec>.page_head").text("Bank Statement "+(j=="our_book"?"as per our book":"as per Bank book"));if(this.args.is_group){this.form.components.account.url="/account_groups/?name={{value}}&pagination=false&_select_fields=name,id&under_defacc=bank_accounts&excl_defacc=cheque_cnt_acc,cheq_in_hand"}else{this.form.components.account.url="/accounts/?name={{value}}&is_cntlacc=false&pagination=false&_select_fields=name,id&under_defacc=bank_accounts&excl_defacc=cheque_cnt_acc,cheq_in_hand"}this.form.reset();this.ds.release();if(k.account){this.load_ds(k)}}});var i={fields:{date:{head_label:"Vchr Date",width:"100px"},particulars:{head_label:"Particulars",width:"50%"},vtype:{head_label:"Vchr Type",key:"vtype_txt",width:"100px"},instr_date:{head_label:"Inst Date",width:"100px"},vchr_ref_no:{head_label:"Transaction Ref No",width:"30%"},cheq_status:{head_label:"Status",width:"20%"},debit:{head_label:"Debit",type:"money",wrapSPAN:true,width:"120px",align:"right"},credit:{head_label:"Credit",type:"money",wrapSPAN:true,width:"120px",align:"right"},balance:{head_label:"Balance",type:"money",wrapSPAN:true,width:"150px",align:"right"}},show_items:["inst_date","particulars","vtype","instr_date","vchr_ref_no","cheq_status","debit","credit","balance"],filter_enable:["customer_name","policy_no","inst_date"]};FB_Module.init_fn(function(){app.SideMenu.add_item({item_id:"bank_reports",label:"Bank Reports",index:7.2,is_disabled:!AL.any_access(["bank_reports","bank_reconciliation"])});app.SideMenu.add_item({view:"bank_statements/our_book",item_id:"bankstat_our",under:"bank_reports",label:"Statement as per our book",is_disabled:!AL.any_access(["bank_reports"])});app.SideMenu.add_item({view:"bank_statements/bank_book",item_id:"bankstat_bank",under:"bank_reports",label:"Statement as per bank book",is_disabled:!AL.any_access(["bank_reports"])});app.SideMenu.add_item({view:"bank_summary",item_id:"bankaccs_cnt2",under:"bank_reports",label:"Bank Summary",is_disabled:!AL.any_access(["bank_reports"])});app.SideMenu.add_item({view:"notes_receivable",item_id:"notes_cnt1",under:"bank_reports",label:"Notes Receivable",is_disabled:!AL.any_access("bank_reconciliation")});app.SideMenu.add_item({view:"notes_payable",item_id:"notes_cnt2",under:"bank_reports",label:"Notes Payable",is_disabled:!AL.any_access("bank_reconciliation")});app.SideMenu.add_item({item_id:"bank_reconc",index:40,under:"bank_reports",label:"Reconciliation statement",is_disabled:!AL.any_access("bank_reports"),callback:function(){options={acc_type:"reconcile"};app.popups.AccountReportPopup.show(options)}})})});FB_Module.register({index:2},function(){if(get_cfg("en_p_division")=="true"||get_cfg("en_s_division")=="true"){var b={default_attr:{class_name:"_type1 _sm2"},fields:{name:{type:"inputbox",id:"_mgbt_1em",label:"Name"},code:{type:"inputbox",id:"_mgbt_1em _w10em",label:"Code"},use_cs_acc:{type:"checkbox",id:"_mgbt_1em _comp_block",value:"true",label:"Use custom Sale Accounts"},use_cp_acc:{type:"checkbox",id:"_mgbt_1em _comp_block",value:"true",label:"Use custom Purchase Accounts"},description:{type:"textarea",id:"_w30em",label:"Description"}},validation:{name:{required:true}}};var a=gen_model("/ps_divisions/");app.popups.PSDivisionPopup=new (app.Popup.extend({id:"psdiv_popup",head:"Division",class_name:"_w600px",model:a,events:{"click .op_btn":"submit_form"},beforeInit:function(){return true},render:function(i){var k,h,j;h=this;if(!i){j=h.form=new app.Form(_.extend({appendTo:h.$el.find(".popup_body")},b));j.renderInputs();h.listenTo(j,"all",h.form_ev_handler)}j=h.form;k=this.options.data;h.setMode("idle");j.reset();if(k){j.set_values(k)}}}))();var d={name:{head_label:"Name",style:"width:50%",index:0},code:{head_label:"Code",style:"width:20%",index:0},description:{head_label:"Description",style:"width:30%",index:0}};var g;g=app.Tab.extend({label:"Divisions",tab_id:"divisions",model:a,is_tab_view:true,heading:"Division",ds_options:{schema:d,ds_id:"ds_ps_div"},popup:app.popups.PSDivisionPopup,initComponents:function(){var h=this;this.init()},onshow:function(){var h=this;if(!h.is_inited){h.initComponents();h.is_inited=true}h.$top_sec_el.show();h.ds.load()}});g.merge(app.ListPageTemplate);if(AL.any_access("ps_division.list")){set_object("company_tabs","division_tab",g)}}if(get_cfg("en_sale_loc")=="true"){var f={default_attr:{class_name:"_type1 _sm2"},fields:{name:{type:"inputbox",id:"_mgbt_1em",label:"Name"},code:{type:"inputbox",id:"_mgbt_1em _w10em",label:"Code"},_cnt1:{tagName:"div",fields:{lnk_cash:{type:"checkbox",id:"_mgbt_1em _mgtp_1em _mgrt_1em",dlgTo:"scope",value:"true",label:"Use Custom Cash Account"},cash_acc_name:{type:"combobox",label:"Cash Account",url:"/accounts/?pagination=false&is_cntlacc=false&under_defacc=cash_n_eq&name={{value}}",id:"_w20em _mgbt_1em _comp_inline",dlgTo:"scope"}}},_cnt2:{tagName:"div",fields:{lnk_pcash:{type:"checkbox",id:"_mgbt_1em _mgtp_1em _mgrt_1em",value:"true",dlgTo:"scope",label:"Use Custom Petty Cash Account"},pcash_acc_name:{type:"combobox",label:"Petty Cash Account",url:"/accounts/?pagination=false&is_cntlacc=false&under_defacc=cash_n_eq&name={{value}}",id:"_w20em _mgbt_1em _comp_inline",dlgTo:"scope"}}},_cnt3:{tagName:"div",fields:{lnk_gdn:{type:"checkbox",id:"_mgbt_1em _mgtp_1em _mgrt_1em",value:"true",dlgTo:"scope",label:"Link Godown"},godown_name:{type:"combobox",label:"Godown",url:"/godowns/?pagination=false&name={{value}}",id:"_w20em _mgbt_1em _comp_inline",dlgTo:"scope"}}},description:{type:"textarea",id:"_w30em",label:"Description"}},validation:{name:{required:true}}};var a=gen_model("/sale_loc/");app.popups.SLoc=new (app.Popup.extend({id:"sloc_popup",head:"Location",class_name:"_w600px",model:a,events:{"click .op_btn":"submit_form"},beforeInit:function(){return true},render:function(i){var k,h,j;h=this;if(!i){j=h.form=new app.Form(_.extend({appendTo:h.$el.find(".popup_body")},f));j.renderInputs();h.listenTo(j,"all",h.form_ev_handler)}j=h.form;k=this.options.data;h.setMode("idle");j.reset();if(k){j.set_values(k)}},form_ev_handler:function(k,i,m,n){var h,j,l;h=this;j=h.form.components;l={cash_acc_name:"lnk_cash",pcash_acc_name:"lnk_pcash",godown_name:"lnk_gdn"};if(k=="before_set_values"){_.each(l,function(p,o){n[p]=n[o]!=""&&n[o]!=undefined})}else{if(k=="reset"||k=="values_set"||(k=="clicked"&&_.in_list(i.name,_.values(l)))){_.each(l,function(p,o){j[o][j[p].get_value()!="true"?"hide":"show"]()})}}}}))();var c={name:{head_label:"Name",style:"width:50%",index:0},code:{head_label:"Code",style:"width:20%",index:0},description:{head_label:"Description",style:"width:30%",index:0}};var e;e=app.Tab.extend({label:"Locations",tab_id:"locations",model:a,is_tab_view:true,heading:"Location",ds_options:{schema:c,ds_id:"ds_loc"},popup:app.popups.SLoc,initComponents:function(){var h=this;h.init()},onshow:function(){var h=this;if(!h.is_inited){h.initComponents();h.is_inited=true}h.$top_sec_el.show();h.ds.load()}});e.merge(app.ListPageTemplate);if(AL.any_access("sale_loc.list")){set_object("company_tabs","s_loc_tab",e)}}FB_Module.init_fn(function(){var h=get_obj("uset_form_schema");_.extend(h.fields,{_d1:{tagName:"div",fields:{lnk_psd:{type:"checkbox",label:"Link Division",id:"_mgtp_1em _mgrt_2em _comp_inline",value:"true",dlgTo:"scope"},ps_division_name:{type:"combobox",id:"_w20em _comp_inline",label:"Division",index:50,url:"/ps_divisions/?name={{value}}&pagination=false",dlgTo:"scope"}}},_d2:{tagName:"div",fields:{lnk_gdn:{type:"checkbox",label:"Bind Godown",id:"_mgtp_1em _mgrt_4em _comp_inline",value:"true",dlgTo:"scope"},godown_name:{type:"combobox",id:"_w20em _comp_inline",label:"Godown",url:"/godowns/?pagination=false&name={{value}}",dlgTo:"scope"}}},_d3:{tagName:"div",fields:{lnk_loc:{type:"checkbox",label:"Bind Location",id:"_mgtp_1em _mgrt_4em _comp_inline",value:"true",dlgTo:"scope"},sale_loc_name:{type:"combobox",id:"_w20em _comp_inline",label:"Location",url:"/sale_loc/?pagination=false&name={{value}}",dlgTo:"scope"}}}});var i=_.proto(app.popups.UserSettingPopup,0);i.form_ev_handler=function(n,k,p,q){var j,m,l,o;j=this;l=j.options;m=j.form.components;o={ps_division_name:"lnk_psd",godown_name:"lnk_gdn",sale_loc_name:"lnk_loc"};if(n=="before_set_values"){if(l.no_lnk){_.each(o,function(s,r){q[s]=false;m[s].hide()})}else{j.form.show_comps(_.values(o));_.each(o,function(s,r){q[s]=q[r]!=""&&q[r]!=undefined})}}else{if(n=="reset"||n=="values_set"||(n=="clicked"&&_.in_list(k.name,_.values(o)))){_.each(o,function(s,r){m[r][m[s].get_value()!="true"?"hide":"show"]()})}}}})});FB_Module.register({index:23},function(){var c;var b,a;b="_comp_inline _w30pc _mgrt_2em";a=function(e,d){return{type:"checkbox",value:"true",index:d,id:b,label:e}};c={_sep_stock:{tagName:"h1",className:"tbl_head _mgtp_1em",innerHTML:"Stock Settings",index:2},en_inventory:{type:"selectbox",class_name:"_type4 _sm2 _mgbt_1em",value:"true",index:2,default_option:"true",options:[{"true":"Yes"},{"false":"No"}],id:b,label:"Enable Inventory"},stock_method:{type:"selectbox",class_name:"_type4 _sm2 _mgbt_1em",id:b+" _type4",index:2,default_option:"",options:[{fifo:"FIFO"},{avg:"Average Cost"}],label:"Stock Cost Calculation Method"},alt_unit_setting:a("Alternative unit setting",2),en_godown:a("Maintain Multiple Godowns",2),en_altunit:a("Enable Alternative Units",3),lnk_item_acc:a("Link Account with Item",3),default_stock_display:{type:"selectbox",class_name:"_type4 _sm2 _mgbt_1em",id:b+" _type4",index:4,default_option:"",options:[{condensed:"Condensed"},{detailed:"Detailed"},{item_wise:"ItemWise"}],label:"Default Stock Summmary Display"},en_batch:a("Maintain Batches",2),en_serial:a("Enable Serial Nos for items",2),item_num_method:{type:"selectbox",class_name:"_type4 _sm2 _mgbt_1em",id:b,index:5,default_option:"",options:[{auto:"Auto"},{manl:"Manual"}],label:"Item Code Numbering Method"},last_item_code:{type:"inputbox",class_name:"_type4 _sm2 _comp_inline _w8em _pdlt_7em _mgrt_2em ",index:6,label:"Last Item Code:"},alw_edt_iu_trns_itm:a("Allow updating item units having transactions",2),_sep_sp:{tagName:"h1",className:"tbl_head _mgtp_1em",innerHTML:"Purchase/Sales Settings",index:7},use_cash_cust_def:a("Use Cash Customer as default",8),en_salesrep:a("Enable Sales Representative",2),en_pur_man:a("Maintain Purchase Manager Info",2),ignore_stock:a("Allow Sale/Debit Note without stock",2),en_p_division:a("Enable Purchase Divisions",2),en_s_division:a("Enable Sale Divisions",2),en_sale_loc:a("Enable Sale Locations",2),en_cash_ps_drcr:a("Enable Entry for Customer/Supplier for Cash Sale/Purchase",2),use_custom_desc:a("Enable custom description in items",2),no_sale_wo_sor:a("Do not allow sale without sale order",9),mult_iv_per_po:a("Allow multiple invoice per P/O",9),en_ref_rate:a("Enable Ref. Rate in Quotation",9),en_extra_info:a("Enable additional info per line in docs",9),no_pur_wo_po:a("Do not allow purchase without P/O",9),mult_bl_per_po:a("Allow multiple purchase per P/O",9),notif_cogs_sale:a("Notify of sale below COGS",9),icode_direct:a("POS Mode while adding items using item_code/barcode",9),en_holding:a("Enable holding transactions",9),ds_pay_cash:a("Disable Cash Payment in Purchase/Sale",9),en_draft:a("Enable Save as Draft",9),prev_rates:a("Show Previous Rates",9),last_date_stock_vld:a("Use last date stock when validating for invoice,etc..",9),prvnt_pur_over_boq:a("Prevent purchase more than BOQ",9),en_dailyreport:a("Enable Daily Sales Report",9),en_pur_for_consume:a("Enable Purchase for consumption",9),card_acc_name:{type:"combobox",id:"_w25em _mgbt_05em",label:"Card Account",class_name:"_type1 _md",url:"/accounts/?name={{value}}&under_defacc=bank_accounts&pagination=false&is_cntlacc=false&_select_fields=name,acc_type",dlgTo:"scope",index:10}};set_objs({extra_settings:c})});FB_Module.register({index:21},function(){var a;if(get_cfg("tax_method")!="no_tax"){app.popups.ItemGroupTaxPopup=new (app.Popup.extend(get_obj("tax_methods")[get_cfg("tax_method")].item_group_tax_popup_schema))({})}app.popups.PricePopup=new (app.Popup.extend({id:"price_popup",head:"Buying and Selling Rates",model:app.models.Item,show_save_n_next:false,class_name:"_mw900x",events:{"click .op_btn":"submit_form"},reset:function(){var b;b=this.ip_sheets;b[0].release(true);b[1].release(true)},render:function(b){var k,p,o;p=this;if(!b){p.form=new app.Form({appendTo:p.$el.find(".popup_body"),class_name:"_brdbt_t2 _mgbt_1em",fields:{item_id:{type:"combobox",id:"",label:"Item Name",class_name:"_type1 _sm2 _comp_inline _w40em _mgrt_1em _mgbt_05em",label_sel:"name",value_sel:"id",info_sel:"item_code",url:"/items/?name={{value}}&is_service=false&pagination=false",dlgTo:"scope"}}});p.form.renderInputs();p.listenTo(p.form,"all",p.form_ev_handler);o=app.IPS.extend({ip_defaults:{class_name:"_sm2 _type2 _nouline"},class_name:"pricing_ips",row_delete_key_col:"date",schema:{date:{head_label:"Applicable From",width:30,ip_options:{type:"datefield",id:"",label:"Applicable From",dlgTo:"scope"}},unit_name:{head_label:"Unit",width:30,class_name:"ips_selbx_padding",ip_options:{type:"selectbox",id:"",class_name:"_sm2 _nouline _type3",default_option:"",dlgTo:"scope"}},rate:{head_label:"Rate",width:20,ip_options:{type:"inputbox",id:"_ralign",thousand_sep:true,label:"Rate",dlgTo:"scope"}}},validation:{date:{required:true},unit_name:{required:true},rate:{required:true}},after_init:function(m){this.listenTo(this,"all",this.ips_event_handler);this.vald_form=new app.Form({el:this.$el,validation:this.validation})},ips_event_handler:function(v,u,m,t,q){var x,r,s,w;x=this.rows[u];switch(v){case"text_changed":if(t.keyCode==8){this.backspace_pressed(x,u,m)}break;case"enterkey_press":s=this.isLast(x)&&m==this.lastCol()&&!_.some(_.values(this.get_values(x)));if(this.ips_id=="item_unitsheet1"&&s){p.ip_sheets[1].focusRow(0);return}else{if(this.ips_id=="item_unitsheet2"&&s){w=p.ip_sheets[0];if(!(this.rows.length==1&&w.rows.length==1&&!_.some(_.values(w.get_values(0))))){p.$el.find(".op_btn_sncl").focus();return}}}if(this.focusColumn(x,m,"next",true,{select:true})==false){this.validate_row(x,true)}break}}});o.merge(app.IPS_ext);p.ip_sheets=[new o({head:"Buying Rates",ips_id:"item_unitsheet1",appendTo:p.$el.find(".popup_body")}),new o({head:"Selling Rates",ips_id:"item_unitsheet2",appendTo:p.$el.find(".popup_body")})];p.ip_sheets[0].render();p.ip_sheets[1].render()}k=p.options.data;p.setMode("idle");p.reset();var g,j,l,d,h,f,c,e,n;p.form.components.item_id[k?"disable":"enable"]();if(k){p.load_pricing_data(k.item_id,k.item_name)}else{p.form.reset();p.reset()}},load_pricing_data:function(c,d){var b;b=this;b.reset();b.form.set_values({item_id:[c,d]});(new b.model).fetch({data:$.param({op:"get_buying_selling_rates",get_udata:true,item_id:c}),success:function(f,e){var h,g;b.ip_sheets[0].schema.unit_name.ip_options.options=_.map(e.unit_data,function(l){var k,j;j=l.compound1_name||l.unit_name;k={};k[j]=j;return k});h=["buying_rates","selling_rates"];for(g=0;g<h.length;g++){if(e[h[g]]&&!_.isEmpty(e[h[g]])){b.ip_sheets[g].set_value_list(e[h[g]])}else{b.ip_sheets[g].insertRow({})}}},error:function(){app.notifications.add("Loading Issue","Unable to load the rates, please try later","error")}})},form_ev_handler:function(d,c,f){var b=this;if(d=="item_selected"&&c.name=="item_id"){b.load_pricing_data(c.get_value(),c.get_value(true))}},after_get_values:function(b){var c;c=this.ip_sheets;b.op="set_buying_selling_rates";_.extend(b,this.form.get_values());b.pricing_data=[c[0].get_value_list(),c[1].get_value_list()]},after_request:function(d,f,k,h){var c,b,g,j,m,l;l=this;m=l.options;c=d.responseJSON;b=["buying_rate_errors","selling_rate_errors"];if(f=="error"&&c&&c.errors){for(g=0;g<b.length;g++){if(c.errors[b[g]]){l.ip_sheets[g].renderErrors(null,c.errors[b[g]])}}j=c.errors.__all__;return false}else{if(f=="error"){j="Error while saving data"}}if(j){app.notifications.add("Loading Issue",j,"error")}}}))({});app.popups.ItemPopup=new (app.Popup.extend({id:"item_popup",head:"Product",model:app.models.Item,show_save_n_next:true,handle_snnx:true,class_name:"_mw1200x",events:{"click .op_btn":"submit_form"},beforeInit:function(){return true},onshow:function(b){this.options=b.el.data("trigger_data");this._render()},init_comps:function(){var j,f,e,g,d;var h,b,c,e;e=this;h=app.Tab.extend({label:"General",tab_id:"general",afterAppend:function(){var k;k=this;k.no_alt_usett=get_cfg("alt_unit_setting")!="true";d=get_obj("inv_popup_form");d.fields._cnt00.fields=_.omit(d.fields._cnt00.fields,!k.no_alt_usett?["_cnt0"]:null);k.$scope.form=k.form=new app.Form(_.extend({appendTo:k.$el},d));k.form.fields.prsv_fld.append_to=k.$scope.$el.find(".popup_footer");k.form.renderInputs();if(k.no_alt_usett){k.unit_ips=new app.IPS({ips_id:"item_unitsheet",ip_defaults:{class_name:"_sm2 _type2 _nouline"},appendTo:k.form.$el.find(".unit_cnt"),schema:get_obj("inv_popup_units")});k.unit_ips.render();k.listenTo(k.unit_ips,"all",k.ips_event_handler)}k.unit_ips_ext=new app.IPS_ext({head:k.no_alt_usett?"Opening Stock":"Units",ips_id:"item_openingsheet",ip_defaults:{class_name:"_sm _type2 _nouline"},appendTo:k.form.$el.find(".opening_stock_ips_cnt"),schema:_.omit(get_obj("inv_popup_opips"),k.no_alt_usett?["unit_name","base_unit_name","mx1","mx2"]:["unit_name_txt"])});if(!k.no_alt_usett){k.unit_ips_ext.validation={unit_name:{required:true},base_unit_name:{required:true},mx:{required:true}}}k.unit_ips_ext.render();k.listenTo(k.unit_ips_ext,"all",k.unit_ips_ext_event_handler);k.listenTo(k.form,"all",k.form_ev_handler)},reset:function(k,m){var l=this;if(m.prsv_fld.get_value()!="true"){if(l.no_alt_usett){l.unit_ips.release(true)}l.form.reset();l.unit_ips_ext.release(true)}else{l.form.reset(["name","alias"])}},afterShow:function(m){var o,r,s,k,w,q,n,l,v,t,p;var u=this;w=u.options;j=w.data;u.current_tab=null;g=u.form.components;if(!m){g.prsv_fld.set_value("")}u.reset(m,g);if(!m){if(u.no_alt_usett){u.tgl_alt_unit(false);g.has_alt_unit[get_cfg("en_altunit")=="true"?"show":"hide"]()}else{u.form.$el.find(".opening_stock_ips_cnt").addClass("_w100pc")}u.form.hide_comps([get_cfg("en_batch")!="true"?"mnt_batch":null,get_cfg("en_serial")!="true"?"maintain_serial":null]);if(get_cfg("lnk_item_acc")!="true"){u.form.hide_comps(["has_acc","account_name"])}v=get_cfg("working_mode");if(v=="contr"){u.form.hide_comps(["barcode","bcode_print_btn"]);g.has_acc.set_value("true").hide();u.form_ev_handler("clicked",g.has_acc)}u.form[w.method=="create"?"show_comps":"hide_comps"](["purchase_rate","margin","sale_rate"]);u.form[w.method=="create"?"hide_comps":"show_comps"](["set_rate_btn"]);g.set_tax_det[get_cfg("tax_method")!="no_tax"?"show":"hide"]()}g.item_code[get_cfg("item_num_method")=="auto"?"disable":"enable"]();if(j&&(j.name||j.id)){if(j.name){u.set_form_data(j)}else{p=new u.$scope.model;p.set({id:j.id});p.fetch({data:$.param({get_units_pkd:true}),success:function(y,x){j=x;w.data.attach_docid=x.attach_docid;u.set_form_data(j);u.form.focus()},error:function(x,y){app.notifications.add("Loading Failed","Unable to load data","error")}})}}else{if(g.prsv_fld.get_value()!="true"){u.unit_ips_ext.insertRow({})}if(get_cfg("item_num_method")=="auto"){u.form.set_values({item_code:u.$scope.gs_item_no()})}u.form_ev_handler("clicked",g.has_acc);u.form_ev_handler("clicked",g.stock_excluded);u.form.focus()}u.$scope.center()},tgl_ips_ext:function(l){var m,k,n;m=this.unit_ips_ext;k=m.rows.length;for(i=0;i<k;i++){n=m.rows[i];n.cols.op_q.ip.set_value("")[l?"disable":"enable"]();n.cols.op_r.ip.set_value("")[l?"disable":"enable"]();n.cols.op_bl.ip.set_value("")[l?"disable":"enable"]()}},set_form_data:function(s){var v;var p,r,t,l,k,q,o,n,u;v=this;g=v.form.components;s.stock_excluded=!(s.stock_enabled);s.has_acc=!!(s.account_name);v.tax_det=s.tax_det;if(this.no_alt_usett){v.unit_ips_ext[s.stock_excluded?"hide":"show"]()}else{this.tgl_ips_ext(s.stock_excluded)}if(s.unit_data){if(v.no_alt_usett){q=_.find(s.unit_data,function(m){return m.unit_name==m.base_unit_name});s.unit_name=q.unit_name}for(p=0;p<s.unit_data.length;p++){k=s.unit_data[p];if(!v.no_alt_usett||!s.stock_excluded){v.unit_ips_ext.insertRow(_.extend(_.pick(k,["unit_name","op_q","op_r"]),(!v.no_alt_usett?_.pick(k,["base_unit_name","mx1","mx2"]):null)));u=v.unit_ips_ext.getRow(-1);r=u.cols.op_q.ip;r.trigger_event("text_changed",r);u.extra_values={stock_alloc:k.stock_alloc}}if(v.no_alt_usett&&k.unit_name!=q.unit_name){v.unit_ips.insertRow({unit_name:k.unit_name,mx1:k.mx1,mx2:k.mx2,_bunit:q.unit_name});r=v.unit_ips.getRow(-1).cols.unit_name.ip;r.data=[k];r.trigger_event("item_selected",r)}}if(v.no_alt_usett&&s.unit_data.length>1){s.has_alt_unit=true;v.tgl_alt_unit(true,true)}}v.form.set_values(s);if(v.no_alt_usett){g.unit_name.emul_itemselect()}v.form_ev_handler("keyup",g.sale_rate);v.form_ev_handler("clicked",g.has_acc);l=new app.models.Attachment;l.doc_id=s.attach_docid;l.doc_type="invitem";l.fetch({params:{get_default:true},success:function(w,m){if(m.items.length){v.form.components.image.set_value(m.items[0].url)}}})},tgl_alt_unit:function(l,p){var o,n,m,k;k=this;o=k.form;o.$el.find(".unit_cnt")[l?"show":"hide"]();o.components.unit_name[l?"disable":"enable"]();if(l&&!p){n=o.components.unit_name.get_selected_data();if(n.unit_type=="compound"){m=n.compound1_name}else{m=n.name}k.unit_ips.release(true);k.unit_ips.insertRow({_bunit:m})}if(l){if(!p){k.unit_ips_ext.insertRow({})}}else{if(k.unit_ips_ext.rows.length>1){k.unit_ips_ext.deleteRow(1)}}k.$scope.center()},form_ev_handler:function(s,q,r,u){var n,m,l,k,p,t,u,o;k=this.form.components;t=this;if(q&&s=="clicked"&&q.name=="has_alt_unit"){this.tgl_alt_unit(q.get_value()=="true")}else{if(q&&s=="clicked"&&q.name=="has_acc"){if(r){k.account_name.set_value("")}t.form[q.get_value()=="true"?"hide_comps":"show_comps"](["stock_excluded"]);k.account_name[q.get_value()=="true"?"show":"hide"]()}else{if(s=="item_selected"&&q.name=="unit_name"){if(!(u&&u.no_en_altunit)){k.has_alt_unit.enable()}n=q.get_selected_data();if(n){if(n.unit_type=="compound"){m=n.compound1_name}else{m=n.name}this.unit_ips_ext.rows[0].cols.unit_name.ip.set_value(m)}this.unit_ips.schema.unit_name.ip_options.url_args={excl_names:q.get_value()}}else{if(s=="keyup"&&q.name=="unit_name"){if(!r||r.keyCode!=13){k.has_alt_unit.set_value("");k.has_alt_unit.disable();t.tgl_alt_unit(false)}}else{if(s=="keyup"&&_.contains(["purchase_rate","margin","sale_rate"],q.name)){n=k.purchase_rate.get_value();if(q.name=="sale_rate"){m=q.get_value();if(m!=""){k.margin.set_value(wacky_round((Number(m)-Number(n))*100/Number(n),2)||"")}}else{m=k.margin.get_value();if(m!=""){k.sale_rate.set_value(wacky_round(Number(n)+(Number(n)*(Number(m)/100)),2)||"")}}}else{if(s=="clicked"&&q.name=="stock_excluded"){n=t.unit_ips_ext;if(t.no_alt_usett){n[q.get_value()!=""?"hide":"show"]()}else{t.tgl_ips_ext(q.get_value()!="")}t.form[q.get_value()!=""?"hide_comps":"show_comps"]([get_cfg("en_batch")=="true"?"mnt_batch":null,get_cfg("en_serial")=="true"?"maintain_serial":null]);if(q.get_value()==""){if(n.rows.length==0){n.insertRow({})}if(t.no_alt_usett){t.form_ev_handler("item_selected",k.unit_name,null,{no_en_altunit:true});if(k.has_alt_unit.get_value()=="true"){n.insertRow({});t.ips_event_handler("item_selected",0,"unit_name",null,{comp:t.unit_ips.rows[0].cols.unit_name.ip})}}}else{if(t.no_alt_usett){n.release(true)}}t.$scope.center()}else{if(s=="clicked"&&q.name=="set_rate_btn"){o=t.options.data;app.popups.PricePopup.show({data:{item_name:o.name,item_id:o.id},invoker:t,callback:function(v,w){if(o){o.purchase_rate=w.last_buying_rate;o.sale_rate=w.last_selling_rate}}})}else{if(s=="add_new_clicked"){if(q.name=="category_name"){app.popups.ItemCategoryPopup.show({method:"create",invoker:this,data:{name:q.get_value(true)},hide_cont_btn:true,callback:function(x,w,v){setTimeout(function(){q.set_value(v.name).focus()},350)}})}else{if(q.name=="brand_name"){app.popups.ItemBrandPopup.show({method:"create",invoker:t,data:{name:q.get_value(true)},hide_cont_btn:true,callback:function(x,w,v){setTimeout(function(){q.set_value(v.name).focus()},350)}})}else{if(q.name=="account_name"){app.popups.AccountPopup.show({method:"create",is_cntlacc:false,hide_cont_btn:true,invoker:this,data:{name:q.get_value(true),subacc_of_defacc:"expense_direct",cost_appl:true,is_cntlacc:false},callback:function(w,v){q.set_value(v.name+v.suffix);q.data={items:[{id:v.id,name:v.name+v.suffix,c_balance:0}]};setTimeout(function(){q.focus()},800)}})}}}}else{if(s=="clicked"&&q.name=="set_tax_det"){app.popups.ItemGroupTaxPopup.show({invoker:t,method:"set",data:this.tax_det,callback:function(v){t.tax_det=v}})}else{if(s=="clicked"&&q.name=="bcode_print_btn"){tmp=k.barcode.get_value();if(tmp==""){k.barcode.render_error("This field is required");return}u=t.options;window.open(app.generate_ext_url("http://localhost:8000","bcode_print.py",_.extend({op:"options",price:u.method=="create"?k.sale_rate.get_value():(u.data?u.data.sale_rate||"":"")},t.form.get_values(false,["item_code","name","alias","barcode"]))),"targetWindow","menubar=no,toolbar=no,location=no,directories=no,status=no,scrollbars=no,resizable=no,dependent,width=400,height=320")}}}}}}}}}}},ips_event_handler:function(p,r,n,q,k){var m,o,l;m=r;r=this.unit_ips.rows[r];if(n=="unit_name"){if(p=="item_selected"){k.comp.$el.closest(".table_list_ul").addClass("active");o=k.comp.get_selected_data();if(o){if(o.unit_type=="compound"){l=o.compound1_name}else{l=o.name}this.unit_ips_ext.rows[m+1].cols.unit_name.ip.set_value(l);r.cols._unit.ip.set_value(l+"s")}}else{if(p=="keyup"){if(q.keyCode!=13){k.comp.$el.closest(".table_list_ul").removeClass("active")}}}}},after_get_values:function(l){var n,m,k;n=this.unit_ips_ext.get_value_list();if(this.no_alt_usett){if(l.has_alt_unit=="true"){l.unit_data=this.unit_ips.get_value_list()}else{l.unit_data=[]}l.unit_data.unshift({unit_name:l.unit_name,mx1:1,mx2:1});for(m=0,k=l.unit_data.length;m<k;m++){_.extend(l.unit_data[m],{base_unit_name:l.unit_name},n[m])}}else{l.unit_data=n}l.tax_det=this.tax_det},stock_alloc_callback:function(m,l){var k=this;if(l){m.extra_values=m.extra_values||{};m.extra_values.stock_alloc=l;setTimeout(function(){k.unit_ips_ext.focusColumn(m,"quantity","next",true,{select:true})},200)}else{setTimeout(function(){k.unit_ips_ext.focusColumn(m,"quantity")},200)}},unit_ips_ext_event_handler:function(q,r,l,o,s){var p,n,m,k;p=r;r=this.unit_ips_ext.rows[r];if(q=="text_changed"&&(l=="op_q"||l=="op_r")){n=r.cols.op_q.ip.get_value();m=r.cols.op_r.ip.get_value();if(l=="op_q"&&get_cfg("en_godown")=="true"&&(is_charkey(o)||o.keyCode==8)){if(r.extra_values){r.extra_values.stock_alloc=undefined}}r.cols.op_bl.ip.set_value(wacky_round(Number(n)*Number(m),2)||"")}else{if(q=="text_changed"&&_.contains(["purchase_rate","margin","sale_rate"],l)){n=r.cols.purchase_rate.ip.get_value();m=r.cols[l=="sale_rate"?"sale_rate":"margin"].ip.get_value();if(l=="sale_rate"){r.cols.margin.ip.set_value(wacky_round((Number(m)-Number(n))*100/Number(n),4)||"")}else{r.cols.sale_rate.ip.set_value(wacky_round(Number(n)+(Number(n)*(Number(m)/100)),4)||"")}}else{if(q=="keydown"&&l=="op_q"&&o.keyCode==13&&get_cfg("en_godown")=="true"&&s.comp.get_value()!=""){app.popups.ItemAllocationPopup.show({invoker:this,quantity:s.comp.get_value(),callback:this.stock_alloc_callback,row:r});o.preventDefault()}else{if(q=="focusout"&&l=="op_q"&&get_cfg("en_godown")=="true"&&Number(s.comp.get_value())&&!(r.extra_values&&r.extra_values.stock_alloc)){setTimeout(function(){if(!$(document.activeElement).closest(".item_allocsheet").length){s.comp.render_error("Stock allocation is required");s.comp.focus()}})}else{if(q=="keydown"&&o.keyCode==8&&o.shiftKey){this.unit_ips_ext.backspace_pressed(r,p,l,o)}else{if(q=="keydown"&&!this.no_alt_usett&&o.keyCode==13){if(this.unit_ips_ext.focusColumn(r,l,"next",true,{select:true})==false){this.unit_ips_ext.validate_row(r,true,{dr_cr:"Dr"})}}}}}}}}});b=app.Tab.extend({label:"Transaction History",tab_id:"trans_history",afterAppend:function(){this.form=new app.Form({appendTo:this.$el,fields:{vtype:{type:"selectbox",class_name:"_type1 _comp_inline _mgrt_1em _sm2 _mgbt_05em",default_option:"",options:_.map(get_obj("ps_popup_configs"),function(m){var k;k=get_doctype(null,m.doc_type);if(k&&AL.has_access(k.name,"list")){var l={};l[k.abbr]=m.head;return l}}),label:"Doc Type",dlgTo:"scope"}}});this.form.renderInputs();this.listenTo(this.form,"all",function(l,k,m){if(l=="changed"&&k.name=="vtype"){this.load_ds(this.form.get_values(true))}});this.ds=new app.DS({idAttr:"voucher_id",class_name:"hoverable _fz14",ds_id:"ds_stock_report",has_pagination:true,handle_pagination:true,schema:get_obj("item_history_ds"),model:new app.models.Item,default_params:{op:"get_history",per_page:"20"},ds_id:"ds_trans_history",appendTo:this.$el});this.listenTo(this.ds,"all",function(k,n,l,m){if(k=="li_clicked"){window.open(app.generate_url("voucher",n,null,true),"_blank").focus()}})},load_ds:function(k){this.ds.load({params:_.extend({item_id:this.$scope.options.data.id},k)})},onshow:function(){this.form.set_values({vtype:""});if(this.$scope.options.data&&this.$scope.options.data.id){this.load_ds()}else{this.ds.render()}}});c=app.Tab.extend({label:"Attachments",tab_id:"attachments",afterAppend:function(){this.grid_view=new app.FileGridView({doc_type:"invitem",item_type:"img",appendTo:this.$el,id:"gd1"})},onshow:function(){var k;k=this.$scope.options;this.grid_view.doc_id=k.data.attach_docid;this.grid_view.is_bind=(k.method=="update");this.grid_view.release();this.grid_view.load_data()},onhide:function(){this.grid_view.release()}});e.tabs=new app.Tabs({appendTo:this.$el.find(".popup_body"),$scope:this});e.tabs.append([new h,new b,new c])},render:function(f,b){var h,e,d,g,c;d=this;e=d.options;if(!f){d.init_comps()}d.setMode("idle");if(!e.data){e.data={}}if(e.method=="create"){e.data.attach_docid=uuidv4()}d.tabs.tabs.general.options=d.options;d.tabs.show_tab("general",{});d.tabs.tabs.general.afterShow(b);e.data=e.data||{}},after_get_values:function(b){this.tabs.tabs.general.after_get_values(b);b.attach_docid=this.options.data.attach_docid},gs_item_no:function(b){if(b){set_cfg("last_item_code",b)}else{return Number(get_cfg("last_item_code"))+1}},after_request:function(c,d,k,g){var b=c.responseJSON,f,h,j,l;l=this;if(d=="success"){if(get_cfg("item_num_method")=="auto"){l.gs_item_no(c.last_item_code)}}h=l.tabs.tabs.general;if(d=="error"&&b&&b.errors){j=b.errors;f=j.unit_errors_ext;if(f){h.unit_ips_ext.renderErrors(null,f);return false}f=j.unit_errors;if(f){if(h.form.components.has_alt_unit.get_value()=="true"&&f[1]){h.unit_ips.renderErrors(null,b.errors.unit_errors)}if(f[0]){h.form.renderServerErrors(null,b.errors.unit_errors[0])}return false}}}}))();a=app.Tab.extend({label:"Products",tab_id:"products",model:app.models.Item,is_tab_view:true,heading:"Product",ds_options:{flex_schema:get_obj("invitm_ds"),has_filter:true,enable_sorting:true,class_name:"ds_within_tab",ds_id:"ds_items",default_params:{is_service:false,purchase_rate:true,sale_rate:true,get_op_data:true,get_units_pkd:true,inc_account:true}},popup:app.popups.ItemPopup,initComponents:function(){var b=this,c;b.context_menu_items=c=_.clone(b.context_menu_items);c.splice(1,0,{key:"buysell_rates",value:"Set Buying and Selling Rates"});swap_obj_keys(b,"_context_item_click","context_item_click");b.init()},onshow:function(){var b;b=this;if(!b.is_inited){b.initComponents();b.is_inited=true;b.search_ip=new app.component_types.inputbox.view({options:{id:"_mgtp_3x _mgbt_05em _mgrt_1em _w10em",label:"Search",class_name:"_type2 _md _comp_inline"},scope:this});b.listenTo(b.search_ip,"all",function(d,c,f){if(d=="keyup"&&f.keyCode==13){b.ds.load({params:{name_code:c.get_value()}})}});b.$top_sec_el.prepend(b.search_ip.$el)}b.$top_sec_el.show();app.TopButtons.set(["export"]);b.ds.load()},_context_item_click:function(e,b){var d,c;c=this;if(b=="buysell_rates"){d=c.ds.get_row(e);app.popups.PricePopup.show({data:{item_name:d.name,item_id:e},callback:function(g,f,h){c.ds.load({presv_flt:true})}});return}return this._context_item_click(e,b)},ds_handler:function(g,k,h,j){var c,d,b,f;if(g=="before_render"){c=k.items;for(d=0;d<c.length;d++){f=c[d];f.purchase_rate=f.purchase_rate?f.purchase_rate.rate:null;f.sale_rate=f.sale_rate?f.sale_rate[0].rate:null}}else{return this._ds_handler(g,k,h,j)}}});a.merge(app.ListPageTemplate,true);if(AL.any_access("item_categories")){set_object("item_man_tabs","products",a);FB_Module.init_fn(function(){app.SideMenu.add_item({item_id:"products_n_services",label:"Products and Services",index:4});app.SideMenu.add_item({view:"products_n_services/products",item_id:"products",under:"products_n_services",label:"Products"});app.SideMenu.add_item({item_id:"set_bsr",under:"products_n_services",label:"Set Buying and selling rates",index:45,is_disabled:!AL.any_access("pettycash_voucher.create"),callback:function(){app.popups.PricePopup.show({})}})})}});FB_Module.register({index:22},function(){var a;app.popups.ServiceItemPopup=new (app.Popup.extend({id:"service_item_popup",head:"Service",model:app.models.ServiceItem,show_save_n_next:true,handle_snnx:true,events:{"click .op_btn":"submit_form"},beforeInit:function(){return true},reset:function(){this.form.reset()},render:function(f){var g,c,d;c=this;if(!f){c.form=new app.Form(_.extend({appendTo:c.$el.find(".popup_body")},get_obj("svitem_popup_form")));c.form.renderInputs();c.listenTo(c.form,"all",c.form_ev_handler)}d=c.options;g=d.data;if(!g){g=d.data={}}g.has_acc=!!(g.account_name);c.setMode("idle");c.current_tab=null;c.reset();var e,b;if(get_cfg("lnk_item_acc")!="true"){c.form.$el.find("._lnk_acc_cnt").hide()}if(g){c.form.set_values(g)}if(d.method=="create"&&!(g.attach_docid)){g.attach_docid=uuidv4()}c.form_ev_handler("clicked",c.form.components.is_under,null)},after_get_values:function(b){b.attach_docid=this.options.data.attach_docid},form_ev_handler:function(c,b,d){if(c=="changed"&&b.name=="unit_type"){self.form.$el.find("._derived_cnt")[b.get_value()=="derived"?"show":"hide"]()}else{if(c=="add_new_clicked"){if(b.name=="category_name"){app.popups.ItemCategoryPopup.show({method:"create",invoker:this,hide_cont_btn:true,callback:function(g,f,e){b.set_value(e.name)}})}}}}}))();a=app.Tab.extend({label:"Services",tab_id:"services",model:app.models.ServiceItem,is_tab_view:true,heading:"Service",ds_options:{schema:get_obj("svitem_ds"),ds_id:"ds_service_items",default_params:{is_service:true,sale_rate:true,inc_account:get_cfg("lnk_item_acc")=="true"}},popup:app.popups.ServiceItemPopup,initComponents:function(){var b;b=this;b.init();b.ds.before_render=function(d,c){var e,f;for(e in c.items){f=c.items[e];if(f.sale_rate){f.sale_rate=f.sale_rate.rate}}}},onshow:function(){var b;b=this;if(!b.is_inited){b.initComponents();b.is_inited=true}b.$top_sec_el.show();b.ds.load()}});a.merge(app.ListPageTemplate);if(AL.any_access("item_categories")){set_object("item_man_tabs","services",a);FB_Module.init_fn(function(){app.SideMenu.add_item({item_id:"products_n_services",label:"Products and Services",index:4});app.SideMenu.add_item({view:"products_n_services/services",item_id:"services",under:"products_n_services",label:"Services"})})}});FB_Module.register({index:22},function(){var a;app.p_view_inst.StockOpening={popup:app.popups.PS_Popup,edit_voucher:function(c,e){var d={},b;this.popup.show({method:"update",doc_type:"stock_opening",invoker:this,callback:e,data:c})}};a=app.Tab.extend({label:"Stock Opening",tab_id:"stock_opening",model:app.models.StockOpening,is_tab_view:true,heading:"Stock Opening",ds_options:{idAttr:"voucher_id",schema:get_obj("stockopen_ds"),ds_id:"ds_stock_opening",default_params:{}},popup:app.popups.PS_Popup,drill_to_view:"voucher",popup_options:{doc_type:"stock_opening"},initComponents:function(){var b;b=this;b.init()},onshow:function(){var b;b=this;if(!b.is_inited){b.initComponents();b.is_inited=true}b.$top_sec_el.show();b.ds.load()}});a.merge(app.ListPageTemplate);if(AL.any_access("inventory_items")){set_object("item_man_tabs","stock_opening",a);FB_Module.init_fn(function(){app.SideMenu.add_item({item_id:"products_n_services",label:"Products and Services",index:4});app.SideMenu.add_item({view:"products_n_services/stock_opening",item_id:"stock_opening",under:"products_n_services",label:"Stock Opening"})})}});FB_Module.register({index:23},function(){var a;app.popups.ItemUnitPopup=new (app.Popup.extend({id:"itemunit_popup",head:"Item Unit",show_save_n_next:true,handle_snnx:true,model:app.models.ItemUnit,events:{"click .op_btn":"submit_form"},beforeInit:function(){return true},onshow:function(b){this.options=b.el.data("trigger_data");this._render()},render:function(c){var d,b;b=this;if(!c){b.form=new app.Form(_.extend({appendTo:b.$el.find(".popup_body")},get_obj("unit_popup_form")));b.form.renderInputs();b.listenTo(b.form,"all",b.form_ev_handler)}d=b.options.data;b.setMode("idle");b.current_tab=null;if(d){b.form.$el.find("._derived_cnt")[d.unit_type=="compound"?"show":"hide"]();b.form[d.unit_type=="compound"?"hide_comps":"show_comps"](["abbr"]);b.form.set_values(d)}else{b.form.$el.find("._derived_cnt").hide();b.form.reset()}b.form_ev_handler("clicked",b.form.components.is_under,null)},form_ev_handler:function(d,c,f){var b;b=this;if(d=="changed"&&c.name=="unit_type"){b.form.$el.find("._derived_cnt")[c.get_value()=="compound"?"show":"hide"]();b.form[c.get_value()=="compound"?"hide_comps":"show_comps"](["abbr"])}}}))();a=app.Tab.extend({label:"Units",tab_id:"item_units",model:app.models.ItemUnit,is_tab_view:true,heading:"Unit",ds_options:{schema:get_obj("unit_ds_schema"),ds_id:"ds_units"},popup:app.popups.ItemUnitPopup,initComponents:function(){var b=this;this.init()},onshow:function(){var b;b=this;if(!b.is_inited){b.initComponents();b.is_inited=true}b.$top_sec_el.show();b.ds.load()}});a.merge(app.ListPageTemplate);if(AL.any_access("item_categories")){set_object("item_man_tabs","item_units",a);FB_Module.init_fn(function(){app.SideMenu.add_item({item_id:"products_n_services",label:"Products and Services",index:4});app.SideMenu.add_item({view:"products_n_services/item_units",item_id:"item_units",under:"products_n_services",label:"Units"})})}});FB_Module.register({index:26},function(){var b,a;if(AL.any_access("godowns")&&get_cfg("en_godown")=="true"){app.popups.GodownPopup=new (app.Popup.extend({id:"godown_popup",head:"Godown",show_save_n_next:true,handle_snnx:true,model:app.models.Godown,events:{submit:"submit_form","click .op_btn":"submit_form"},beforeInit:function(){return true},render:function(d){var e,c;c=this;if(!d){c.form=new app.Form(_.extend({appendTo:c.$el.find(".popup_body")},get_obj("godown_form")));c.form.renderInputs();c.listenTo(c.form,"all",c.form_ev_handler)}e=c.options.data;c.setMode("idle");c.current_tab=null;if(e){c.form.components.under_name[e.under_name!=""?"enable":"disable"]();c.form.set_values(e)}else{c.form.components.under_name.disable();c.form.reset()}c.form_ev_handler("clicked",c.form.components.is_under,null)},form_ev_handler:function(f,d,g){var c;c=this;if(f=="clicked"&&d.name=="is_under"){c.form.components.under_name[d.get_value()!=""?"enable":"disable"]()}}}))();b=app.Tab.extend({label:"Godowns",tab_id:"godowns",model:app.models.Godown,is_tab_view:true,heading:"Godown",ds_options:{schema:get_obj("godown_ds_schema"),ds_id:"ds_godowns"},popup:app.popups.GodownPopup,initComponents:function(){var c=this;this.init()},onshow:function(){var c;c=this;if(!c.is_inited){c.initComponents();c.is_inited=true}c.$top_sec_el.show();c.ds.load()}});b.merge(app.ListPageTemplate);set_object("item_man_tabs","godowns",b);FB_Module.init_fn(function(){app.SideMenu.add_item({item_id:"products_n_services",label:"Products and Services",index:4});app.SideMenu.add_item({view:"products_n_services/godowns",item_id:"godowns",under:"products_n_services",label:"Godowns"})})}if(AL.any_access("batches")&&get_cfg("en_batch")=="true"){app.popups.BatchPopup=new (app.Popup.extend({id:"new_batch_pp",class_name:"_mw300x",head:"New Batch",model:gen_model("/batches/"),events:{submit:"submit_form","click .op_btn":"submit_form"},render:function(f){var g,c,e,d;c=this;if(!f){c.form=new app.Form({appendTo:this.$el.find(".popup_body"),class_name:"",default_attr:{class_name:"_type1 _sm2 _mgbt_05em"},fields:{name:{type:"inputbox",id:"_w10em",label:"Batch/Lot No"},expiry_date:{type:"datefield",id:"_w7em",label:"Expiry Date"},description:{type:"textarea",id:"_w7em",label:"Description"}},validation:{name:{required:true},expiry_date:{required:false,pattern:"date"}}});c.form.renderInputs();c.listenTo(c.form,"all",c.form_ev_handler)}c.setMode("idle");c.form.reset();d=c.options;if(d.method=="update"){e=new c.model;e.fetch({data:$.param({name:d.data.name}),success:function(h,i){if(i.items){d.data=i.items[0];c.form.set_values(d.data)}}})}},after_request:function(f,c,d,h){var g;g=this.options;if(g.row){g.row.cols.batch_name.ip.set_value(f.name,f);g.row.cols.batch_expiry.ip.set_value(f.expiry_date)}}}))();var a=app.Tab.extend({label:"Batches",tab_id:"batches",model:gen_model("/batches/"),is_tab_view:true,heading:"Batch",ds_options:{schema:get_obj("batch_ds_schema"),ds_id:"ds_batch"},popup:app.popups.BatchPopup,initComponents:function(){var c=this;this.init()},onshow:function(){var c;c=this;if(!c.is_inited){c.initComponents();c.is_inited=true}c.$top_sec_el.show();c.ds.load()}});a.merge(app.ListPageTemplate);set_object("item_man_tabs","batches",a);FB_Module.init_fn(function(){app.SideMenu.add_item({item_id:"products_n_services",label:"Products and Services",index:4});app.SideMenu.add_item({view:"products_n_services/batches",item_id:"batches",under:"products_n_services",label:"Batches"})})}});FB_Module.register({index:25},function(){var c,a,b;c=app.Popup.extend({show_save_n_next:true,handle_snnx:true,manual_focus:true,events:{"click .op_btn":"submit_form"},beforeInit:function(){return true},onshow:function(d){},render:function(f){var i,h,g,e,d;d=this;if(!f){g=get_obj("catbrand_popup_form");h=d.form=new app.Form(_.extend({appendTo:d.$el.find(".popup_body")},g));h.renderInputs();e=g.fields.under_name;h.components.under_name.url=e[d.id=="cat_popup"?"cat_url":"brand_url"];d.listenTo(h,"all",d.form_ev_handler)}i=d.options.data;d.setMode("idle");d.current_tab=null;d.form.reset();if(i){i.is_under=(i.under_name!=null);d.form.set_values(i)}d.form_ev_handler("clicked",d.form.components.is_under,null)},form_ev_handler:function(f,d,g){if(f=="clicked"&&d.name=="is_under"){this.form.components.under_name[d.get_value()=="true"?"enable":"disable"]()}}});app.popups.ItemBrandPopup=new (c.extend({id:"brand_popup",head:"Brands",model:app.models.ItemBrand}))();app.popups.ItemCategoryPopup=new (c.extend({id:"cat_popup",head:"Item Category",model:app.models.ItemCategory}))();a=app.Tab.extend({label:"Brands",tab_id:"brands",model:app.models.ItemBrand,is_tab_view:true,heading:"Brand",ds_options:{schema:get_obj("cat_brand_ds"),ds_id:"ds_brands"},popup:app.popups.ItemBrandPopup,initComponents:function(){this.init()},ds_handler:function(h,l,j,k){var m,g,f,d;if(h=="rendered"){m=j.$el.find(".table_list > li");for(d in j.rows){g=j.rows[d];f=m.eq(d).find(">ul>._tbl_cname");f.addClass("_level_"+g.level)}}return this._ds_handler(h,l,j,k)},onshow:function(){var d;d=this;if(!d.is_inited){d.initComponents();d.is_inited=true}d.$top_sec_el.show();d.ds.load()}});a.merge(app.ListPageTemplate);b=app.Tab.extend({label:"Categories",tab_id:"item_categories",model:app.models.ItemCategory,is_tab_view:true,heading:"Category",ds_options:{schema:get_obj("cat_brand_ds"),ds_id:"ds_categories",default_params:{group_by_name:true}},popup:app.popups.ItemCategoryPopup,initComponents:function(){this.init()},ds_handler:function(h,l,j,k){var m,g,f,d;if(h=="rendered"){m=j.$el.find(".table_list > li");for(d in j.rows){g=j.rows[d];f=m.eq(d).find(">ul>._tbl_cname");f.addClass("_level_"+g.level)}}return this._ds_handler(h,l,j,k)},onshow:function(){var d;d=this;if(!d.is_inited){d.initComponents();d.is_inited=true}d.$top_sec_el.show();d.ds.load()}});b.merge(app.ListPageTemplate,true);if(AL.any_access("item_categories")){set_object("item_man_tabs","item_categories",b);FB_Module.init_fn(function(){app.SideMenu.add_item({item_id:"products_n_services",label:"Products and Services",index:4});app.SideMenu.add_item({view:"products_n_services/item_categories",item_id:"item_categories",under:"products_n_services",label:"Categories"})})}if(AL.any_access("item_brands")){set_object("item_man_tabs","brands_tab",a);FB_Module.init_fn(function(){app.SideMenu.add_item({item_id:"products_n_services",label:"Products and Services",index:4});app.SideMenu.add_item({view:"products_n_services/brands",item_id:"brands",under:"products_n_services",label:"Brands"})})}});FB_Module.register({index:25},function(){app.p_views.ItemManagement=app.PageTemplate.extend({page_name:"products_n_services",heading_plural:"Item Management",initialize:function(){var a,b,c;a=this;a.init({create_el:true});a.tabs=new app.Tabs({appendTo:a.$el,$scope:a});b=[],tab_views=get_object("item_man_tabs");for(view in tab_views){b.push(new tab_views[view]())}a.tabs.append(b);a.listenTo(a.tabs,"tab_show",a.tab_show)},onshow:function(b,c){var a=this;if(!b){b=a.tabs.current_tab||Object.keys(a.tabs.tabs)[0];a.args=c||{}}a.tabs.show_tab(b,true)},print_data:function(){var b,e,d,a,c;a=this;c=a.tabs.tabs[a.tabs.current_tab];d=c.ds;b=app.generate_ext_url(d.model.urlRoot,null,_.extend({op:"print_preview"},d.default_params,d.options.params));window.open(b,"_blank").addEventListener("load",function(){this.focus();this.print()},false)},export_data:function(){var b,a;a=this;b=a.tabs.tabs[a.tabs.current_tab].ds;$("#myiframwe").attr("src",app.generate_ext_url(b.model.urlRoot,null,_.extend({op:"export_to_excel"},b.default_params,b.options.params)))},tab_show:function(a,c){var b;b=this.$el.find(".top_buttons");b.hide();app.router.navigate(app.generate_url(this.page_name,a,this.args),{trigger:false,replace:c})}})});FB_Module.register({index:2},function(){var b,d,a;b={fields:{doc_no:{head_label:"Doc#",width:"120px"},date:{head_label:"Date",width:"80px"},invoice_no:{head_label:"Invoice#",width:"135px"},bill_no:{head_label:"Bill#",width:"100px"},po_no:{head_label:"P/O No",width:"125px"},so_no:{head_label:"S/O No",width:"125px"},ps_type:{head_label:"Pay Type",choices:[{cash:"Cash"},{credit:"Credit"},{pettycash:"Petty Cash"},{card:"Card"},{multi:"Card/Cash"}]},p_division_name:{head_label:"Division",width:"40%",f_key:"ps_division_name",url:"/ps_divisions/?div_type=p&name={{value}}&pagination=false",list_selector:"items",label_sel:"name"},s_division_name:{head_label:"Division",width:"40%",f_key:"ps_division_name",url:"/ps_divisions/?div_type=s&name={{value}}&pagination=false",list_selector:"items",label_sel:"name"},customer_name:{head_label:"Customer",width:"40%",url:"/cust_n_vendor/customers/?name={{value}}&pagination=false",list_selector:"items",label_sel:"name"},customer_group_name:{head_label:"Customer Group",width:"auto",url:"/accounts/?name={{value}}&under_defacc=receivable&is_cntlacc=true&pagination=false",list_selector:"items",label_sel:"name"},supplier_name:{head_label:"Supplier",width:"40%",url:"/cust_n_vendor/suppliers/?name={{value}}&pagination=false",list_selector:"items",label_sel:"name"},supplier_group_name:{head_label:"Customer Group",width:"auto",url:"/accounts/?name={{value}}&under_defacc=receivable&is_cntlacc=true&pagination=false",list_selector:"items",label_sel:"name"},particulars:{head_label:"Particulars",width:"40%"},item_name:{head_label:"Item Name",width:"20%",url:"/items/?name={{value}}&pagination=false",list_selector:"items",label_sel:"name"},gross_amount:{head_label:"Gross Amount",width:"95px",align:"right",type:"money"},discount:{head_label:"Discount",width:"95px",align:"right",type:"money"},net_amount:{head_label:"Net Amount",width:"95px",align:"right",type:"money",wrapSPAN:true},return_amount:{head_label:"Rtn Amount",width:"95px",align:"right",type:"money"},total_received_amount:{head_label:"Received",width:"95px",align:"right",type:"money"},total_paid_amount:{head_label:"Paid",width:"95px",align:"right",type:"money"},balance_amount:{head_label:"Balance",width:"95px",align:"right",type:"money"},due_date:{head_label:"Due Date",width:"80px"},settled_in:{head_label:"Settled In",width:"80px"},overdue:{head_label:"Overdue",width:"65px",align:"right",key:"overdue_txt"},is_approved:{head_label:"Approval",width:"85px",key:"is_approved_txt",choices:[{"true":"Approved"},{"false":"Unapproved"}]},status:{head_label:"Status",width:"8%",key:"status_txt",choices:{pd:"Pending",pr:"Partial",dv:"Delivered"}}},show_items:["doc_no","bill_no","invoice_no","date","customer_name","supplier_name","particulars","gross_amount","discount","net_amount","total_received_amount","total_paid_amount","balance_amount","due_date","overdue","settled_in","is_approved","status"],filter_enable:["customer_name","supplier_name","customer_group_name","supplier_group_name","item_name","doc_no","date","ps_type","bill_no","invoice_no","po_no","so_no","due_date","overdue","is_approved"],ips_filter_enable:["date"]};a={fields:{subcontractor_name:{head_label:"Sub Contractor",width:"40%",url:"/cust_n_vendor/subcnt/?name={{value}}&pagination=false",list_selector:"items",label_sel:"name"}},show_items:["subcontractor_name"],filter_enable:["subcontractor_name"]};set_objs({iv_bl_schema:b});var e={fields:{doc_no:{head_label:"Doc#",width:"125px"},date:{head_label:"Date",width:"85px"},branch_name:{head_label:"Branch",width:"30%",url:"/accounts/?name={{value}}&pagination=false"},supplier_name:{head_label:"Supplier",width:"30%",url:"/cust_n_vendor/suppliers/?name={{value}}&pagination=false"},godown_name:{head_label:"Source Godown",width:"30%",url:"/godowns/?name={{value}}&pagination=false"},dst_godown_name:{head_label:"Dest. Godown",width:"30%",url:"/godowns/?name={{value}}&pagination=false"},particulars:{head_label:"Particulars",width:"40%"},amount:{head_label:"Amount",width:"110px",align:"right",type:"money",wrapSPAN:true},status:{head_label:"Status",key:"status_txt",width:"100px"},is_approved:{head_label:"Approval",width:"85px",key:"is_approved_txt",choices:[{"true":"Approved"},{"false":"Unapproved"}]}},show_items:["doc_no","date","branch_name","godown_name","dst_godown_name","supplier_name","particulars","amount","status","is_approved"],filter_enable:["doc_no","date","branch_name","godown_name","dst_godown_name","supplier_name","particulars","amount","status","is_approved"]};var c={no_newbtn:true,header_btns:["export","print"],drill_to_view:"voucher",ds_options:{idAttr:"voucher_id",class_name:"hoverable ds_with_head",default_params:{pending_status:"true"},enable_sorting:true,has_filter:true},initialize:function(){var f=this;this.before_init();var g;this.context_menu_items=g=_.clone(this.context_menu_items);g.splice(1,0,{key:"associate",value:"Associations"});swap_obj_keys(this,"_context_item_click","context_item_click");this.popup=get_obj("invoice_popup")||app.popups.Invoice;this.init({create_el:true})},_context_item_click:function(h,f){var g;g=this;if(f=="associate"){app.popups.ASC.show({id:h,itype:"vchr"})}return g._context_item_click(h,f)},edit_voucher:function(g,i){var h={},f;this.popup.show({method:"update",doc_type:this.doc_type,invoker:this,callback:i,data:g})},ds_handler:function(w,h,l,v){var p,s,q,o,n,g,m,x,y,t,r,k,f,u;k=this;if(w=="li_clicked"&&!this.is_broker){app.router.navigate(app.generate_url("voucher",h),{trigger:true})}else{if(w=="before_render"){r=get_doctype("iv").en_approval=="true";status_map={pd:"Pending",prd:"Partial Delivery",dv:"Delivered not Invoiced",pri:"Partially Invoiced",dvi:"Delivered and Invoiced"};for(s=0;s<h.items.length;s++){p=h.items[s];p.net_amount=Number(p.gross_amount)-(Number(p.discount)||0);p.balance_amount=Number(p.net_amount)-(_.in_list(this.doc_type,["invoice","debit_note"])?p.total_received_amount:p.total_paid_amount);if(p.balance_amount<0.01){p.balance_amount=0}p.overdue_txt=p.overdue<=0?"":(p.overdue+" days");if(p.is_delivered!=undefined){p.status_txt=p.is_delivered?"Delivered":"Pending"}if(r){p.is_approved_txt=p.is_approved?"Approved":"Unapproved"}if(p.status){if(k.doc_type=="grn_note"&&p.sub_type=="bt"){p.status_txt="Delivered"}else{p.status_txt=status_map[p.status]}}}}else{if(w=="rendered"){t=l.$el.find(".table_list > li");r=get_doctype("iv").en_approval=="true";for(s in l.rows){p=l.rows[s];x={balance_amount:">ul>._cbalance_amount",due_date:">ul>._cdue_date",is_approved:">ul>._cis_approved_txt",status:">ul>._cstatus_txt"};if(p.net_amount&&p.balance_amount==0){m="_green"}else{if(p.net_amount&&int64(p.balance_amount)<int64(p.net_amount)){m="_yellow"}else{if(p.net_amount){m="_red"}else{m=""}}}t.eq(s).find(x.balance_amount).addClass(m);n=p.overdue;m="";if(p.net_amount&&p.balance_amount>0){if(n==-99999){}else{if(n>-15&&n<0){m="_yellow"}else{if(n>=0){m="_red"}}}}t.eq(s).find(x.due_date).addClass(m);if(r){t.eq(s).find(x.is_approved).addClass(p.is_approved?"_green":"_red")}if(_.in_list(k.doc_type,["delivery_note","sale_order","grn_note","goods_issue"])){if(p.is_delivered!=undefined){p.status=p.is_delivered?"dvi":"pd"}if(p.status){if(k.doc_type=="grn_note"){status_map={dv:"_red",pri:"_yellow",dvi:"_green"};if(p.sub_type=="bt"){status_map.dv="_green"}}else{status_map={pd:"_red",prd:"_yellow",dv:"_blue",pri:"_blue",dvi:"_green"}}t.eq(s).find(x.status).addClass(status_map[p.status])}}}}else{if(w=="context_item_click"){g=l.get_row(h);k.popup.show({method:"update",voucher_id:g.voucher_id,approval:true})}}}}k._ds_handler.apply(k,arguments)},export_data:function(){var f;f=app.generate_ext_url(this.model.prototype.urlRoot,null,_.extend({op:"export_to_excel"},this.ds.default_params,this.ds.options.params));$("#myiframwe").attr("src",f)}};d=false;if(AL.any_access("invoice.list")&&get_doctype("iv").is_enabled=="true"){app.p_views.Invoices=app.ListPageTemplate.extend(_.extend({page_name:"invoices",model:app.models.Invoice,doc_type:"invoice",popup_options:{doc_type:"invoice"},heading_plural:"Invoice Register",before_init:function(){var f;f={};f.fields=_.omit(b.fields,["supplier_name","supplier_group_name","total_paid_amount","invoice_no","bill_no","status"]);f.show_items=_.without(b.show_items,"invoice_no","bill_no","total_paid_amount","supplier_name",get_doctype("iv").en_approval!="true"?"is_approved":null,"status");f.filter_enable=_.without(b.filter_enable,"invoice_no","bill_no","supplier_name","supplier_group_name");if(get_cfg("en_s_division")){f.filter_enable.push("s_division_name")}f.ips_filter_enable=b.ips_filter_enable;_.extend(this.ds_options,{head:"Sale/Invoice Register",ds_id:"ds_invoices",flex_schema:f})}},c))}if(AL.any_access("bill.list")&&get_doctype("bl").is_enabled=="true"){app.p_views.Bills=app.ListPageTemplate.extend(_.extend({page_name:"bills",model:app.models.Bill,doc_type:"bill",popup_options:{doc_type:"bill"},heading_plural:"Bill Register",header_btns:["print","export"],before_init:function(){var f;f={};f.fields=_.omit(b.fields,["customer_name","customer_group_name","total_received_amount","invoice_no","so_no","status"]);f.show_items=_.without(b.show_items,"invoice_no","total_received_amount","customer_name",get_doctype("bl").en_approval!="true"?"is_approved":null,"status");f.filter_enable=_.without(b.filter_enable,"invoice_no","so_no","customer_name","customer_group_name");f.ips_filter_enable=b.ips_filter_enable;if(get_cfg("en_p_division")=="true"){f.filter_enable.push("p_division_name")}_.extend(this.ds_options,{head:"Purchase/Bill Register",ds_id:"ds_bills",flex_schema:f})}},c))}if(AL.any_access("debit_note.list")&&get_doctype("dn").is_enabled=="true"){app.p_views.DebitNotes=app.ListPageTemplate.extend(_.extend({page_name:"debit_notes",model:app.models.DebitNote,doc_type:"debit_note",popup_options:{doc_type:"debit_note"},heading_plural:"Debit Note Register",header_btns:["print","export"],before_init:function(){var f;f={};f.fields=_.omit(b.fields,["customer_name","customer_group_name","total_paid_amount","so_no","invoice_no","status"]);f.show_items=_.without(b.show_items,"invoice_no","total_paid_amount","customer_name",get_doctype("dn").en_approval!="true"?"is_approved":null,"status");f.filter_enable=_.without(b.filter_enable,"invoice_no","po_no","so_no","customer_name","customer_group_name");f.ips_filter_enable=b.ips_filter_enable;if(get_cfg("en_p_division")){f.filter_enable.push("p_division_name")}_.extend(this.ds_options,{head:"Debit Note Register",ds_id:"ds_debitnotes",flex_schema:f})}},c))}if(AL.any_access("credit_note.list")&&get_doctype("cn").is_enabled=="true"){app.p_views.CreditNotes=app.ListPageTemplate.extend(_.extend({page_name:"credit_notes",model:app.models.CreditNote,doc_type:"credit_note",popup_options:{doc_type:"credit_note"},heading_plural:"Credit Note Register",header_btns:["print","export"],before_init:function(){var f;f={};f.fields=_.omit(b.fields,["supplier_name","supplier_group_name","total_received_amount","so_no","bill_no","status"]);f.show_items=_.without(b.show_items,"bill_no","total_received_amount","supplier_name",get_doctype("cn").en_approval!="true"?"is_approved":null,"status");f.filter_enable=_.without(b.filter_enable,"bill_no","po_no","so_no","supplier_name","supplier_group_name");f.ips_filter_enable=b.ips_filter_enable;if(get_cfg("en_s_division")){f.filter_enable.push("s_division_name")}_.extend(this.ds_options,{head:"Credit Note Register",ds_id:"ds_creditnotes",flex_schema:f})}},c))}if(AL.any_access("sales_quotation.list")&&get_doctype("sq").is_enabled=="true"){app.p_views.SalesQuotations=app.ListPageTemplate.extend(_.extend({page_name:"sales_quotations",model:app.models.SalesQuotation,doc_type:"sales_quotation",popup_options:{doc_type:"sales_quotation"},heading_plural:"Sales Quotation Register",header_btns:["print","export"],before_init:function(){var f;f={};f.fields=_.omit(b.fields,["supplier_name","supplier_group_name","total_received_amount","settled_in","balance_amount","so_no","total_paid_amount","due_date","overdue","invoice_no","bill_no","status"]);f.show_items=_.without(b.show_items,"invoice_no","bill_no","total_paid_amount","total_received_amount","settled_in","balance_amount","due_date","overdue","supplier_name",get_doctype("sq").en_approval!="true"?"is_approved":null,"status");f.filter_enable=_.without(b.filter_enable,"invoice_no","bill_no","po_no","supplier_name","supplier_group_name","so_no","due_date","overdue","ps_type");f.ips_filter_enable=b.ips_filter_enable;if(get_cfg("en_s_division")){f.filter_enable.push("s_division_name")}_.extend(this.ds_options,{head:"Sales Quotation Register",ds_id:"ds_salesquotations",flex_schema:f})}},c))}if(AL.any_access("profoma_invoice.list")&&get_doctype("prf").is_enabled=="true"){app.p_views.ProfomaInvoices=app.ListPageTemplate.extend(_.extend({page_name:"profoma_invoices",model:app.models.ProfomaInvoice,doc_type:"profoma_invoice",popup_options:{doc_type:"profoma_invoice"},heading_plural:"Profoma Invoice Register",header_btns:["print","export"],before_init:function(){var f;f={};f.fields=_.omit(b.fields,["supplier_name","supplier_group_name","total_received_amount","so_no","settled_in","balance_amount","total_paid_amount","due_date","overdue","invoice_no","bill_no","status"]);f.show_items=_.without(b.show_items,"invoice_no","bill_no","total_paid_amount","total_received_amount","settled_in","balance_amount","due_date","overdue","supplier_name",get_doctype("sq").en_approval!="true"?"is_approved":null,"status");f.filter_enable=_.without(b.filter_enable,"invoice_no","bill_no","supplier_name","so_no","supplier_group_name");f.ips_filter_enable=b.ips_filter_enable;if(get_cfg("en_s_division")){f.filter_enable.push("s_division_name")}_.extend(this.ds_options,{head:"Profoma Invoice Register",ds_id:"ds_profomainvs",flex_schema:f})}},c))}if(AL.any_access("purchase_order.list")&&get_doctype("po").is_enabled=="true"){app.p_views.PurchaseOrders=app.ListPageTemplate.extend(_.extend({page_name:"purchase_orders",model:app.models.PurchaseOrder,doc_type:"purchase_order",popup_options:{doc_type:"purchase_order"},heading_plural:"Purchase Order Register",header_btns:["print","export"],before_init:function(){var f;f={};f.fields=_.omit(b.fields,["customer_name","customer_group_name","total_received_amount","so_no","settled_in","balance_amount","total_paid_amount","due_date","overdue","invoice_no","bill_no"]);f.show_items=_.without(b.show_items,"invoice_no","bill_no","total_paid_amount","total_received_amount","settled_in","balance_amount","due_date","overdue","customer_name",get_doctype("po").en_approval!="true"?"is_approved":null);f.filter_enable=_.without(b.filter_enable,"invoice_no","bill_no","customer_name","due_date","so_no","overdue","customer_group_name");f.ips_filter_enable=b.ips_filter_enable;if(get_cfg("en_p_division")){f.filter_enable.push("p_division_name")}_.extend(this.ds_options,{head:"Purchase Order Register",ds_id:"ds_purchaseorders",flex_schema:f})}},c))}if(AL.any_access("sale_order.list")&&get_doctype("sor").is_enabled=="true"){app.p_views.SaleOrders=app.ListPageTemplate.extend(_.extend({page_name:"sale_orders",model:app.models.SaleOrder,doc_type:"sale_order",popup_options:{doc_type:"sale_order"},heading_plural:"Sales Order Register",header_btns:["print","export"],before_init:function(){var f;f={};f.fields=_.omit(b.fields,["supplier_name","supplier_group_name","total_received_amount","so_no","settled_in","balance_amount","total_paid_amount","due_date","overdue","invoice_no","bill_no"]);f.show_items=_.without(b.show_items,"invoice_no","bill_no","total_paid_amount","total_received_amount","settled_in","balance_amount","due_date","overdue","supplier_name",get_doctype("sor").en_approval!="true"?"is_approved":null);f.filter_enable=_.union(_.without(b.filter_enable,"invoice_no","bill_no","supplier_name","so_no","supplier_group_name","due_date","overdue"),["status"]);f.ips_filter_enable=b.ips_filter_enable;f.show_items.splice(2,0,"po_no");_.extend(this.ds_options,{head:"&nbsp;",ds_id:"ds_purchaseorders",flex_schema:f})}},c))}if(AL.any_access("delivery_note.list")&&get_doctype("gdn").is_enabled=="true"){app.p_views.DeliveryNotes=app.ListPageTemplate.extend(_.extend({page_name:"delivery_notes",model:app.models.DeliveryNote,doc_type:"delivery_note",popup_options:{doc_type:"delivery_note"},heading_plural:"Delivery Note Register",header_btns:["print","export"],before_init:function(){var f;f={};f.fields=_.omit(b.fields,["supplier_name","supplier_group_name","total_received_amount","so_no","settled_in","balance_amount","total_paid_amount","due_date","overdue","invoice_no","bill_no"]);f.show_items=_.without(b.show_items,"invoice_no","bill_no","total_paid_amount","total_received_amount","settled_in","balance_amount","due_date","overdue","supplier_name",get_doctype("gdn").en_approval!="true"?"is_approved":null);f.filter_enable=_.without(b.filter_enable,"invoice_no","bill_no","supplier_name","so_no","supplier_group_name");f.ips_filter_enable=b.ips_filter_enable;_.extend(this.ds_options,{head:"Delivery Note Register",ds_id:"ds_deliverynotes",flex_schema:f})}},c))}if(AL.any_access("grn_note.list")&&get_doctype("grn").is_enabled=="true"){app.p_views.GRN=app.ListPageTemplate.extend(_.extend({page_name:"grn_notes",model:app.models.GRN,doc_type:"grn_note",popup_options:{doc_type:"grn_note"},heading_plural:"Goods Received Note Register",header_btns:["print","export"],before_init:function(){var f;f={};f.fields=_.omit(e.fields,["godown_name","dst_godown_name"]);f.show_items=_.without(e.show_items,"godown_name","dst_godown_name",get_doctype("grn").en_approval!="true"?"is_approved":null);f.filter_enable=_.without(e.filter_enable,"godown_name","dst_godown_name");f.ips_filter_enable=b.ips_filter_enable;_.extend(this.ds_options,{head:"Goods Received Note",ds_id:"ds_grns",flex_schema:f})}},c))}if(AL.any_access("goods_issue.list")&&get_doctype("gi").is_enabled=="true"){app.p_views.GoodsIssue=app.ListPageTemplate.extend(_.extend({page_name:"goods_issue",model:app.models.GoodsIssue,doc_type:"goods_issue",popup_options:{doc_type:"goods_issue"},heading_plural:"Goods Issue Register",header_btns:["print","export"],before_init:function(){var f;f={};f.fields=_.omit(e.fields,["supplier_name","godown_name","dst_godown_name"]);f.show_items=_.without(e.show_items,"godown_name","dst_godown_name","supplier_name",get_doctype("gi").en_approval!="true"?"is_approved":null);f.filter_enable=_.without(e.filter_enable,"godown_name","dst_godown_name","supplier_name");f.ips_filter_enable=b.ips_filter_enable;_.extend(this.ds_options,{head:"Goods Issue",ds_id:"ds_gi_vchrs",flex_schema:f})}},c))}if(AL.any_access("goods_trans_order.list")&&get_doctype("gto").is_enabled=="true"){app.p_views.GTO=app.ListPageTemplate.extend(_.extend({page_name:"goods_trans_orders",model:app.models.GTO,doc_type:"goods_trans_order",popup_options:{doc_type:"goods_trans_order"},heading_plural:"Goods Transfer Order Register",header_btns:["print","export"],before_init:function(){var f;f={};f.fields=_.omit(e.fields,["supplier_name","godown_name","dst_godown_name","status"]);f.show_items=_.without(e.show_items,"godown_name","dst_godown_name","supplier_name","status",get_doctype("gto").en_approval!="true"?"is_approved":null);f.filter_enable=_.without(e.filter_enable,"godown_name","dst_godown_name","supplier_name","status");f.ips_filter_enable=b.ips_filter_enable;_.extend(this.ds_options,{head:"Goods Transfer Order",ds_id:"ds_gto",flex_schema:f})}},c))}if(AL.any_access("goods_trans.list")&&get_doctype("gt").is_enabled=="true"){app.p_views.GT=app.ListPageTemplate.extend(_.extend({page_name:"goods_trans",model:app.models.GT,doc_type:"goods_trans",popup_options:{doc_type:"goods_trans"},heading_plural:"Goods Transfer Register",header_btns:["print","export"],before_init:function(){var f;f={};f.fields=_.omit(e.fields,["branch_name","supplier_name","status"]);f.show_items=_.without(e.show_items,"branch_name","supplier_name","status",get_doctype("gto").en_approval!="true"?"is_approved":null);f.filter_enable=_.without(e.filter_enable,"branch_name","supplier_name","status");f.ips_filter_enable=b.ips_filter_enable;_.extend(this.ds_options,{head:"Goods Transfer",ds_id:"ds_gtrans",flex_schema:f})}},c))}FB_Module.init_fn(function(){app.SideMenu.add_item({item_id:"vouchers_cnt",label:"Voucher Registers",index:5.5,is_disabled:!AL.any_access(["invoice.list","bill.list","debitnote.list","creditnote.list"])});app.SideMenu.add_item({view:"invoices",item_id:"invoice_reports",index:5,under:"vouchers_cnt",label:"Invoices",is_disabled:!AL.any_access("invoice.list")||get_doctype("iv").is_enabled!="true"});app.SideMenu.add_item({view:"bills",item_id:"trans_reports",index:4,under:"vouchers_cnt",label:"Transactions",is_disabled:!AL.any_access("bill.list")||get_doctype("bl").is_enabled!="true"});app.SideMenu.add_item({view:"debit_notes",item_id:"dn_reports",index:11,under:"vouchers_cnt",label:"Debit Note/Purchase Return",is_disabled:!AL.any_access("debit_note.list")||get_doctype("dn").is_enabled!="true"});app.SideMenu.add_item({view:"credit_notes",item_id:"cn_reports",index:13,under:"vouchers_cnt",label:"Credit Note/Sale Return",is_disabled:!AL.any_access("credit_note.list")||get_doctype("cn").is_enabled!="true"});app.SideMenu.add_item({view:"sales_quotations",item_id:"sq_reports",index:13,under:"vouchers_cnt",label:"Sales Quotation",is_disabled:!AL.any_access("sales_quotation.list")||get_doctype("sq").is_enabled!="true"});app.SideMenu.add_item({view:"profoma_invoices",item_id:"prf_reports",index:13,under:"vouchers_cnt",label:"Profoma Invoice",is_disabled:!AL.any_access("profoma_invoice.list")||get_doctype("prf").is_enabled!="true"});app.SideMenu.add_item({view:"purchase_orders",item_id:"po_reports",index:13,under:"vouchers_cnt",label:"Purchase Order",is_disabled:!AL.any_access("purchase_order.list")||get_doctype("po").is_enabled!="true"});app.SideMenu.add_item({view:"sale_orders",item_id:"so_reports",index:13,under:"vouchers_cnt",label:"Sales Order",is_disabled:!AL.any_access("sale_order.list")||get_doctype("sor").is_enabled!="true"});app.SideMenu.add_item({view:"delivery_notes",item_id:"gdn_reports",index:13,under:"vouchers_cnt",label:"Delivery Note",is_disabled:!AL.any_access("delivery_note.list")||get_doctype("gdn").is_enabled!="true"});app.SideMenu.add_item({view:"grn_notes",item_id:"grn_reports",index:13,under:"vouchers_cnt",label:"Goods Received Note (GRN)",is_disabled:!AL.any_access("grn_note.list")||get_doctype("grn").is_enabled!="true"});app.SideMenu.add_item({view:"goods_issue",item_id:"goods_issues",index:13,under:"vouchers_cnt",label:"Goods Issue",is_disabled:!AL.any_access("goods_issue.list")||get_doctype("gi").is_enabled!="true"});app.SideMenu.add_item({view:"goods_trans_orders",item_id:"goods_trans_orders",index:13,under:"vouchers_cnt",label:"Goods Transfer Order (GTO)",is_disabled:!AL.any_access("goods_trans_order.list")||get_doctype("gto").is_enabled!="true"});app.SideMenu.add_item({view:"goods_trans",item_id:"goods_trans",index:13,under:"vouchers_cnt",label:"Goods Transfer",is_disabled:!AL.any_access("goods_trans.list")||get_doctype("gt").is_enabled!="true"})})});FB_Module.register({index:2},function(){var e={default_attr:{class_name:"_type1 _md _comp_inline _mgrt_1em"},fields:{name_code:{type:"inputbox",id:"_w25em _mgtp_3x",label:"Item Code/Name",dlgTo:"scope"},category_name:{type:"combobox",id:"_w10em _mgtp_5x",label:"Category",url:"/item_categories/?name={{value}}&pagination=false",dlgTo:"scope",no_menu_on_arrow:true},brand_name:{type:"combobox",id:"_w10em _mgtp_5x",label:"Brand",url:"/item_brands/?name={{value}}&pagination=false",dlgTo:"scope",no_menu_on_arrow:true},show_items:{type:"selectbox",id:"_w8em",label:"Products/Services ",default_option:"all",dlgTo:"scope",options:{product:"Products",service:"Services",all:"All"}},add_new_btn:{type:"button",label:"Add new Item",dlgTo:"scope",class_name:"_type1 _sm2 _w9em float_left"}},validation:{}};app.popups.PurchaseRatePopup=new (app.Popup.extend({id:"prate_popup",head:"Purchase Rate",center_on_init:false,disable_anim:true,removalDelay:100,class_name:"_mw300x",manual_focus:true,btn_map:{set:["OK","OK"]},events:{"click .op_btn":"submit_form",submit:"submit_form"},beforeInit:function(){return true},afterShow:function(){this.center()},render:function(l){var m,j;j=this;if(!l){j.form=new app.Form(_.extend({appendTo:j.$el.find(".popup_body"),class_name:"item_popup_form",fields:{purchase_rate:{type:"inputbox",id:"_mgbt_1em _mgrt_1em _comp_inline _w8em",label:"Purchase Rate"}},validation:{purchase_rate:{required:true,type:"number"}}}));j.form.renderInputs()}m=j.options.row.extra_values;j.setMode("idle");j.form.reset();var k,h;if(m.purchase_rate){j.form.set_values(m)}},submit_form:function(l){var j,m,h,k;h=this;k=h.options;m=h.form.validate();if(m){h.form.renderErrors(m);return}j=h.form.get_values();k.callback.call(k.invoker,k.row,j.purchase_rate);h.close()}}))();var d={item_code:{head_label:"Item Code",style:"width:10%",index:0},name:{head_label:"Name",style:"width:28%",index:0},category_name:{head_label:"Category",style:"width:18%",index:0},brand_name:{head_label:"Brand",style:"width:18%",index:0},rate:{head_label:"Rate",style:"width:10%;text-align:right",index:0,prefix:app.appdata.currency_symbol},bunit_name:{head_label:"Per",style:"width:5%",index:0},cl_stock_txt:{head_label:"Closing Stock",style:"width:11%",index:0}};var b=app.models.Item;app.popups.ItemSelPopup=new (app.Popup.extend({id:"item_select_popup",head:"Select Item",model:b,manual_focus:true,center_on_init:false,disable_anim:true,removalDelay:100,no_autofocus:true,btn_map:{set:["OK","OK"]},events:{"click .op_btn":"submit_form"},beforeInit:function(){return true},afterShow:function(){var j,l,k,h;k=[this.ds.$el.find(".ds_container"),this.ds.$el];h=$(window).height()-(this.ds.$el.closest(".popup").outerHeight()-this.ds.$el.outerHeight())-20;k[1].css({height:h});k[0].css({height:h-k[1].find(".ds_head").outerHeight(true)});this.center();this.form.components.name_code.focus()},reset:function(){this.form.reset(null,["show_items","godown_name"])},render:function(l){var m,j;j=this;if(!l){this.form=new app.Form(_.extend({appendTo:this.$el.find(".popup_body"),class_name:"item_popup_form",no_submit_btn:true},e));this.form.fields.add_new_btn.append_to=this.$el.find(".popup_footer");this.form.renderInputs();this.ds=new app.DS({head:"Items",class_name:"hoverable ds_with_head ds_scrollable",ds_id:"ds_item_list",schema:d,default_params:{limit:100},model:new this.model,appendTo:this.$el.find(".popup_body")});this.listenTo(this.ds,"all",this.ds_event_handler);this.listenTo(this.form,"all",this.form_ev_handler)}this.form.components.show_items[this.options.invoker.parent.doc_type=="invoice"?"show":"hide"]();m=this.options.data;this.setMode("idle");this.reset();var k,h;if(m){if(m.item_code){m["item_code.*"]=m.item_code}this.form.set_values(m)}setTimeout(function(){j.load_ds(j.form.get_values(true))},200)},get_q_opts:function(j,k){var m,h,l;m=k.invoker.parent;j.get_units=true;j.to_date=m.get_date();j.get_cstock=true;j.cost_appl=get_cfg("en_costcenter")=="true";j[k.invoker.rate_sel]=true;if(m.extra_item_filter){_.extend(j,m.extra_item_filter(m))}l=get_cfg("linked_gdn");h=m.form.components.godown_name;if(h){j.godown_name=h.get_value()}else{if(l){j.godown_id=l}}},load_ds:function(j){var k,h;h=this;k=h.options;h.get_q_opts(j,k);if(j.show_items!="all"){j.is_service=(j.show_items=="service")}h.ds.load({params:j})},load_item:function(k,l){var l,h,j;j=this;l=l||j.options;j.get_q_opts(k,l);h=new b;h.fetch({data:$.param(k),success:function(n,m){l.callback.call(l.invoker,m)},error:function(m,n){app.notifications.add("Error","Unable to load item","error")}})},form_ev_handler:function(o,j,p){var n,m,l,h,k;h=this;switch(o){case"keydown":if(p.keyCode==27&&!(j.type=="combobox")){k=this.options;k.callback.call(k.invoker,k.row,null);h.close()}else{if(p.keyCode==38||p.keyCode==40){h.ds.gl_ev_handler("keydown",p)}}break;case"keyup":case"changed":case"item_selected":if(o=="item_selected"||!(o=="keyup"&&p&&_.in_list(p.keyCode,[38,40,27,13]))){h.load_ds(h.form.get_values(true))}else{if(o=="keyup"&&p&&p.keyCode==13){rows=h.ds.$el.find(".table_list>li.selected");if(rows[0]){p.target=rows[0];this.ds.gl_ev_handler("keydown",p)}}}break;case"clicked":app.popups.ItemPopup.show({method:"create",invoker:this,hide_cont_btn:true,handle_snnx:false,callback:function(r,s){var v,t,u;v={};t=h.options;u=t.invoker.parent.form;v.get_units=true;v.to_date=u.get_values(null,["date"])["date"];v.get_cstock=true;v[t.invoker.rate_sel]=true;var q;q=new h.model;q.set("id",s.id);q.fetch({data:$.param(v),success:function(w,x){setTimeout(function(){h.submit_form(null,x)},100)},error:function(w,x){}})}});break}},ds_event_handler:function(q,l,j,p,t){var n,o,m,k,h,r,s,t;r=this;self_options=r.options;if(q=="li_clicked"&&!r.ds.has_menu){s=j.get_row(l);if(s.is_active){self_options.callback.call(self_options.invoker,self_options.row,s);r.close()}}else{if(q=="context_item_click"){s=j.get_row(l);self_options.row.extra_values={godown_name:t.value};self_options.callback.call(self_options.invoker,self_options.row,s);this.close()}else{if(q=="before_render"){for(o=0,n=l.items.length;o<n;o++){m=l.items[o];k=self_options.invoker.rate_sel;m.rate=m[k]?m[k].rate:"";m.cl_stock_txt=m.stock_enabled?m.cl_stock.quantity_txt:""}}else{if(q=="rendered"){r.ds_rendr(j)}}}}},ds_rendr:function(l){var h,k,j,m;m=l.$el.find(".table_list > li");for(h in l.rows){k=l.rows[h];if(!k.is_active){m.eq(h).addClass("_disabled")}}},submit_form:function(l,m){var h,k,j;j=this;k=j.options;if(!m){h=this.ds.$el.find(".table_list > li.selected").index();if(h!=-1){m=this.ds.rows[h]}}if(m&&m.is_active){k.callback.call(k.invoker,k.row,m);j.close()}},ips_ev_handler:function(j,l,h,k){}}))();app.popups.AddDetItems=new (app.Popup.extend({id:"add_det_popup",class_name:"_mw900",head:"Item Wise Details",events:{"keyup .inputbox":"update_total","click .op_btn":"submit_form"},render:function(n){var o,j,m,l,k,p,h;j=this;if(!n){j.ds=new app.DS(_.extend({has_pagination:false,appendTo:j.$el.find(".popup_body"),head:"Item Wise Details",class_name:"ds_with_head",ds_id:"ds_cost_itemwise",schema:{item_code:{head_label:"Item Code",style:"width:15%",index:0},item_name:{head_label:"Item Name",style:"width:50%",index:0},quantity:{head_label:"Quantity",style:"width:10%",index:0},unit_name:{head_label:"Supplier",style:"width:10%",index:0},amount:{head_label:"Amount",style:"width:15%;text-align:right",type:"money",index:1}}}));j.listenTo(j.ds,"all",j.ds_ev_handler);j.$el.find(".popup_body").append('<div class="total_sec">0.00</div>')}j.setMode("idle");k=j.options;j.load_ds()},update_total:function(){var n,h,m,k,l,j;h=this;m=0;n=h.ds.$el.find(".ds_container>.table_list_cnt>.table_list>li");for(k=0;k<n.length;k++){l=n.eq(k).find(">ul> ._camount input");j=Number(l.val());m+=(j!=NaN?j:0)}h.$el.find(".total_sec").html(to_money(m))},ds_ev_handler:function(u,m,k,s){var y,h,v,r,q,t,j,l,p,o,x,w,n;x=this;y=x.options;if(u=="before_render"){o=k.rows;for(p in o){o[p].amount={html:"<div class='component inputbox _type2 _nouline _xs2' style='width:99%;'><input type='text' style='text-align:right;padding: 3px 3px 3px;' class='cmp_ip ipbx_ip' /></div>"}}}else{if(u=="rendered"){x.ds_rendr()}}},ds_rendr:function(){var j,k,h;j=this;h=j.options.details;k=j.ds.$el.find(".ds_container>.table_list_cnt>.table_list>li");if(h){for(i=0;i<k.length;i++){amount_el=k.eq(i).find(">ul> ._camount input");amount_el.val(h[i].amount)}}},load_ds:function(n){var k,j,l,h;j=this;k=j.options;l=k.item_ips;if(!k.load_items){j.ds.rows=_.map(_.filter(l.rows,function(m){return m.extra_values.item_id!=undefined}),function(q){var p,o,m;p=["item_code","item_name","quantity","unit_name"];m={};for(o=0;o<p.length;o++){m[p[o]]=q.cols[p[o]].ip.get_value()}m.item_id=q.extra_values.item_id;return m});j.ds.trigger("before_render",null,j.ds,null);j.ds.render()}else{h=new app.models.Voucher;h.set("id",k.voucher_id);h.fetch({success:function(o,m){j.ds.rows=m.items;j.ds.trigger("before_render",null,j.ds,null);j.ds.render()},error:function(m,o){}})}},validate:function(){var r,q,k,j,o,p,n,m,l,h;q=this;k=q.ds;r=q.options;j=q.ds.$el.find(".ds_container>.table_list_cnt>.table_list>li");p=0;h=[];for(l=0;l<k.rows.length;l++){o=k.rows[l];n=j.eq(l).find(">ul> ._camount input");m=n.val();if(m==""){app.notifications.add("Error",o.item_name+": Amount required","error");n[0].focus();return false}if(isNaN(m)){app.notifications.add("Error",o.item_name+": Invalid Type, number requiredd","error");n[0].focus();return false}p+=Number(m);h.push({item_id:o.item_id,amount:Number(m)})}if(p!=r.amount){app.notifications.add("Error","Total Doesnt match with the cost","error");return false}return h},submit_form:function(l){var j,h,k;j=this;k=j.options;h=j.validate();if(h!=0){k.callback.call(k.invoker,h);j.close()}}}))();app.popups.AccountWisePopup=new (app.Popup.extend({id:"accountwisedetails_popup",class_name:"_mw1000x",head:"Account Wise Details",btn_map:{set:["Set","Setting"]},events:{"click .op_btn":"submit_form"},beforeInit:function(){return true},render:function(m){var o,n,k,j;j=this;if(!m){n=app.IPS.extend({ip_defaults:{class_name:"_sm2 _type2 _nouline _pdlt0"},class_name:"advance_ips",total_col:"amount",schema:{account_name:{head_label:"Account",width:50,ip_options:{class_name:"_type2 _sm2 _nouline",type:"combobox",label:"Account",url:"/accounts/?name={{value}}&pagination=false&under_defacc={{parent_acc}}&is_cntlacc=false&_select_fields=name,acc_type",use_local:true,dlgTo:"scope"}},narration:{head_label:"Description",width:20,ip_options:{type:"inputbox",id:"",label:"Description"}},cost_adj:{head_label:"Method",width:15,ip_options:{type:"selectbox",default_option:"",class_name:"_type3 _sm2 _nouline",options:{auto:"Auto Calculate ",det:"Item Wise"}}},amount:{head_label:"Amount",width:15,ip_options:{type:"inputbox",id:"_ralign",label:"Amount"}}},validation:{account_name:{required:true},cost_adj:{required:true},narration:{required:false},amount:{required:true}},after_init:function(p){var q;q=this;q.listenTo(q,"all",q.ips_event_handler);q.$el.append('<div class="total_sec">0.00</div>');q.vald_form=new app.Form({el:q.$el,validation:q.validation,is_opening:p.is_opening});q.parent=p.parent},get_total:function(){return _.reduce(this.rows,function(p,r){var q;q=r.cols;return p+Number(q[this.total_col].ip.get_value())},0,this)},update_total:function(){var p;p=this.get_total();this.$el.find(".total_sec").text(to_money(Math.abs(p)))},post_validate:function(q,p,r){if(q&&this.isLast(q)){if(this.parent.options.op_balance&&this.get_total()==this.parent.options.op_balance){this.parent.$el.find(".op_btn_sncl").focus();return false}}return true},ips_event_handler:function(w,v,q,u,r){var z,s,t,y,p,x;x=this;if(v!=undefined){z=x.rows[v]}switch(w){case"row_insert":z.cols.account_name.ip.url_args={parent_acc:_.in_list(j.doc_type,["bill","debit_note"])?"cost_of_op":"other_income"};break;case"text_changed":if(q=="amount"){x.update_total()}if(u.keyCode==8){x.backspace_pressed(z,v,q,u);x.update_total()}break;case"enterkey_press":if(x.focusColumn(z,q,"next",true,{select:true})==false){p=x.validate_row(z,false);if(p==true){if(z.cols.cost_adj.ip.get_value()!="auto"){app.popups.AddDetItems.show({invoker:x,method:"set",details:z.extra_values.details,amount:z.cols.amount.ip.get_value(),item_ips:j.options.invoker.ip_sheet,callback:function(A){z.extra_values.details=A;x.after_validate(z,true,{})}})}else{x.after_validate(z,true,{})}}x.update_total()}break}}});n.merge(app.IPS_ext,true);this.ip_sheet=new n({head:"Additional Charges",ips_id:"",appendTo:this.$el.find(".popup_body"),parent:this})}var l,h;l=j.options;o=j.options.data;h=j.ip_sheet;j.setMode("idle");j.current_tab=null;h.render();h.$el.show();h.release(true);if(!_.isEmpty(o)){h.set_value_list(o,null,_.map(o,function(p){return _.pick(p,["details"])}))}else{h.insertRow({})}h.update_total()},submit_form:function(k){var h=this.options,j;j=this.ip_sheet;if(!(j.rows.length==1&&_.every(j.get_values(0),function(l){return l==""}))&&!j.validate_rows()){return false}res=h.callback.call(h.invoker,j.get_value_list(),j.get_total());if(res!=false){this.close()}}}));app.popups.PrevRatesPopup=new (app.Popup.extend({id:"prev_rates_popup",class_name:"_mw800x",head:"Previous Rates",events:{"click .op_btn":"submit_form"},schema2:{date:{head_label:"Date",style:"width:12%",index:0},doc_no:{head_label:"Doc No",style:"width:14%",index:0},supplier_name:{head_label:"Supplier",style:"width:30%",index:0},customer_name:{head_label:"Customer",style:"width:30%",index:0},quantity:{head_label:"Quantity",style:"width:10%;text-align:right",type:"money",index:1},unit_name:{head_label:"Unit Name",style:"width:10%",index:1},rate:{head_label:"Rate",style:"width:12%;text-align:right",type:"money",index:1},amount:{head_label:"Amount",style:"width:12%;text-align:right",type:"money",index:1}},render:function(n){var o,j,m,l,k,p,h;j=this;if(!n){j.$el.find(".popup_body").append('<div class="rate_cnt" style="text-align: right;font-weight: 600;color: #5656ce;"></div>');j.form=new app.Form({default_attr:{class_name:"_type1 _md _mgrt_1em _comp_inline"},fields:{doc_no:{type:"inputbox",id:"_w10em",label:"Doc No",dlgTo:"scope"},customer_name:{type:"combobox",id:"_w20em",label:"Customer",url:"/cust_n_vendor/customers/?name={{value}}&pagination=false",new_item_btn:true,dlgTo:"scope"},supplier_name:{type:"combobox",id:"_w20em",label:"Supplier",url:"/cust_n_vendor/suppliers/?name={{value}}&pagination=false",list_selector:"items",label_sel:"name",embedd_list_el:false,new_item_btn:true,dlgTo:"scope"}},validation:{name:{required:true}},appendTo:this.$el.find(".popup_body")});j.form.renderInputs();j.listenTo(j.form,"all",j.form_ev_handler);j.ds=new app.DS(_.extend({model:new b,has_pagination:false,appendTo:j.$el.find(".popup_body"),head:"Rates",class_name:"ds_with_head",ds_id:"ds_prev_rates",default_params:{op:"get_prev_rates"}}))}j.setMode("idle");k=j.options;h=_.in_list(k.doc_type,["invoice","credit_note"]);j.ds.schema=_.omit(j.schema2,[h?"supplier_name":"customer_name"]);j.form.hide_comps([h?"supplier_name":"customer_name"]);j.form.show_comps([!h?"supplier_name":"customer_name"]);j.form.reset();j.$el.find(".rate_cnt").html("");j.load_ds()},load_ds:function(k){var j,h;h=this;j=h.options;h.ds.load({params:_.extend(_.pick(j,["item_id","to_date","doc_type"]),k),success:function(m,l){if(l.last_p_rate){h.$el.find(".rate_cnt").html('<div class="_mgbt_1em"><span>Last P.Rate : </span><span>'+to_money(l.last_p_rate)+'</span><span class="_comp_inline _mgrt_2em"></span><span>Avg P.Rate : </span><span>'+to_money(l.avg_p_rate)+"</span></div>")}h.center()}})},form_ev_handler:function(m,j,n){var k,h,l;h=this;k=h.options;if(m=="item_selected"||m=="keyup"||(m=="keydown"&&n.keyCode==13)){h.load_ds(h.form.get_values(true))}},submit_form:function(h){this.close()}}))();app.popups.AttachDNote=new (app.Popup.extend({id:"dnotes_popup",class_name:"_mw800x",head:function(h){return(h&&h.dtype=="bill"?"Attach GRNs":"Attach Delivery Notes")},events:{"click .op_btn":"submit_form"},schema2:{check_box:{head_label:"&nbsp;",style:"width:4%",index:0},date:{head_label:"Date",style:"width:10%",index:0},doc_no:{head_label:"Doc No",style:"width:15%",index:0},particulars:{head_label:"Particulars",style:"width:71%",index:1}},render:function(n){var o,j,m,l,k,p,h;j=this;if(!n){j.ds=new app.DS(_.extend({has_pagination:false,appendTo:j.$el.find(".popup_body"),idAttr:"voucher_id",head:"Delivery Notes",class_name:"ds_with_head",ds_id:"ds_dnotes_sel",default_params:{alter_particulars:true,get_item_data:true,"status.ne":"dvi"},schema:this.schema2}));j.listenTo(j.ds,"all",j.ds_handler)}j.setMode("idle");k=j.options;j.ds.model=k.dtype=="bill"?new app.models.GRN:new app.models.DeliveryNote;j.load_ds()},ds_handler:function(p,k,j,o){var q,h,m,n,l,r;q=this;r=q.options;if(p=="rendered"){h=q.ds.$el.find(".ds_container>.table_list_cnt>.table_list>li");for(l=0;l<h.length;l++){n=h.eq(l);m=Number(n.data("id"));if(r.dnotes&&r.dnotes.indexOf(m)!=-1){n.find(">ul>li:first input").prop("checked",true)}}q.center()}},load_ds:function(l){var j,k,h;h=this;j=h.options;k=j.invoker.options;l=l||{};l["date.lte"]=j.data.date;if(k.method=="update"){l.ignore_vchr=k.data.voucher_id}this.ds.load({params:_.extend(_.pick(j.data,["customer_name","supplier_name","inc_adv_suppl","po_no"]),l)})},submit_form:function(l){var h,k,j;h=this;j=h.options;k=h.ds.get_checked_rows();if(_.isEmpty(k)){return app.notifications.add("Error","No items are selected","error")}j.callback.call(j.invoker,k);this.close()}}))();var g={default_attr:{class_name:"_type1 _sm2 _mgbt_1em"},fields:{credit_period:{type:"inputbox",id:"_w10em",label:"Credit Period (Days)"},shipping_address:{type:"textarea",id:"_w30em",label:"Shipping Address"},_cnt:{tagName:"div",className:"float_right",fields:{bold_btn:{type:"button",label:"<span class='_b'>B</span>",id:"_mgrt_05em fmt_op_btn _b_btn _theme1",dlgTo:"scope"},italic_btn:{type:"button",label:"<span class='_i'>I</span>",id:"_mgrt_05em fmt_op_btn _i_btn _theme1",dlgTo:"scope"},uline_btn:{type:"button",label:"<span class='_u'>U</span>",id:"_mgrt_05em fmt_op_btn _u_btn _theme1",dlgTo:"scope"}}},notes:{type:"textarea",id:"_w100pc notes_txtarea _h20em",label:"Notes"},billwise_det_btn:{type:"button",id:"_w12em",label:"Bill Wise Details",dlgTo:"scope"}}};app.popups.ExtraDetPopup=new (app.Popup.extend({id:"extra_det_popup",class_name:"_mw800x",head:"Additional Details",events:{submit:"submit_form","click .op_btn":"submit_form"},render:function(m){var n,h,l,k,j;h=this;if(!m){h.form=new app.Form(_.extend({appendTo:this.$el.find(".popup_body"),class_name:"extra_det_form"},g));h.form.renderInputs();h.listenTo(h.form,"all",h.form_ev_handler)}h.setMode("idle");h.form.reset();j=this.options;h.form[_.in_list(j.invoker.doc_type,["bill","debit_note"])?"hide_comps":"show_comps"](["shipping_address"]);if(j.invoker.extra_det){h.form.set_values(j.invoker.extra_det)}},form_ev_handler:function(m,j,n){var k,h,l;h=this;k=h.options;if(m=="clicked"&&j.name=="billwise_det_btn"){l=k.invoker.ip_sheet.get_total();app.popups.BillWiseDetails.show({invoker:h,data:k.invoker.ref_data,amount:l.gross_total-l.discount+l.round_off,hide_drcr:true,callback:function(o){k.invoker.ref_data=o}})}else{if(m=="clicked"&&j.$el.hasClass("fmt_op_btn")){h.form.components.notes.format_text(null,j)}}},submit_form:function(j){var h;h=this.options;_.extend(h.invoker.extra_det,this.form.get_values());this.close()}}))();app.popups.DescEdit=new (app.Popup.extend({id:"edit_desc_pp",class_name:"_mw600x",head:"Edit Description",events:{"click .op_btn":"submit_form"},render:function(m){var n,h,l,k,j;h=this;if(!m){h.form=new app.Form({appendTo:this.$el.find(".popup_body"),class_name:"extra_det_form",default_attr:{class_name:"_sm2 _type1"},fields:{bold_btn:{type:"button",label:"<span class='_b'>B</span>",id:"_mgrt_05em _b_btn _theme1",dlgTo:"scope"},italic_btn:{type:"button",label:"<span class='_i'>I</span>",id:"_mgrt_05em _i_btn _theme1",dlgTo:"scope"},uline_btn:{type:"button",label:"<span class='_u'>U</span>",id:"_mgrt_05em _u_btn _theme1",dlgTo:"scope"},desc:{type:"textarea",label:"Description :",id:"_mgtp_1em _h10em",dlgTo:"scope"}}});h.form.renderInputs();h.listenTo(h.form,"all",h.form_ev_handler)}h.setMode("idle");h.form.reset();j=this.options;h.form.set_values({desc:replaceAll(j.row.cols.item_name.ip.get_value(),"\\n","\n")})},form_ev_handler:function(q,n,p){var j,k,o,m,s,l,h,r;j=this.form.components;if(q=="clicked"){j.desc.format_text(null,n)}},submit_form:function(k){var j,h;h=this;j=h.options;j.row.cols.item_name.ip.set_value(replaceAll(h.form.components.desc.get_value(),"\n","\\n"));setTimeout(function(){j.row.cols.item_name.ip.focus()},350);h.close()}}))();item_allocation_ips_schema={godown_name:{head_label:"Godown",width:50,index:10,ip_options:{type:"combobox",id:"",label:"Godown",class_name:"_type2 _sm2 _nouline",dlgTo:"scope",url:"/godowns/?name={{value}}&pagination=false&name_not_in={{excl_names}}"}},batch_name:{head_label:"Batch",width:50,index:10,ip_options:{type:"combobox",id:"",label:"Batch",class_name:"_type2 _sm2 _nouline",dlgTo:"scope",new_item_btn:true,label_sel:"name",value_sel:"name",en_search_by:"a",url:"/batches/?name={{value}}&item_id={{item_id}}&&pagination=false&name_not_in={{excl_names}}"}},batch_expiry:{head_label:"Expiry Date",width:30,index:10,ip_options:{type:"inputbox",id:"",label:"Expiry Date",class_name:"_type2 _sm2 _nouline",disabled:true}},unit_name:{head_label:"Unit",width:30,index:10,ip_options:{type:"inputbox",id:"_nouline",label:"Unit",disabled:true}},quantity:{head_label:"Quantity",width:20,index:10,ip_options:{type:"inputbox",id:"_nouline",label:"Quantity",dlgTo:"scope"}}};itemalloc_ips_validation={godown_name:{required:false},batch_name:{required:false},quantity:{required:true}};var f=app.IPS_ext.extend({class_name:"itemallc_ip_sheet",ip_defaults:{class_name:"_md _type2"},after_init:function(j){var h;h=this;h.parent=j.parent;h.schema=j.schema;h.validation=j.validation;h.item_id=j.item_id;h.vald_form=new app.Form({el:h.$el,validation:h.validation});h.listenTo(h,"all",h.ips_ev_handler)},after_render:function(){var h=this;h.key_col=h.row_delete_key_col=h.parent.options.en_gdn?"godown_name":"batch_name"},update_excl_names:function(o,l,k){var m,j,n,h;h=this;if(o.cols.batch_name&&o.cols.godown_name){o.cols.godown_name.ip.url_args={item_id:h.item_id,excl_names:""};return}j=_.map(this.rows,function(q){var p=q.cols[this.key_col].ip.get_value();if(p!=""){return p}else{return null}},this);m=k?this.rows:[o];for(i=0;i<m.length;i++){n=_.filter(j,function(p,q){return p!=null&&q!=l});m[i].cols[this.key_col].ip.url_args={item_id:this.item_id,excl_names:n.join("|")}}},ips_ev_handler:function(p,o,h,n,k){var l,m,j,q;q=this;row=q.rows[o];switch(p){case"rendered":q.after_render();break;case"row_insert":row.cols.unit_name.ip.set_value(q.parent.options.unit_name);q.update_excl_names(row,o);break;case"add_new_clicked":case"det_btn_clicked":if(h=="batch_name"){app.popups.BatchPopup.show({invoker:q,method:p=="add_new_clicked"?"create":"update",row:row,data:{name:row.cols.batch_name.ip.get_value()}})}break;case"item_selected":case"keydown":if(h=="batch_name"){m=k.comp.get_selected_data();if(m){row.cols.batch_expiry.ip.set_value(m.expiry_date);row.extra_values.batch_id=m.id}}if(h=="godown_name"){m=k.comp.get_selected_data();if(m){row.extra_values.godown_id=m.id}}if(h==q.key_col){q.update_excl_names(row,o,true);if(q.ips_id=="batch_alloc_ips"){m=k.comp.get_selected_data();if(m){row.cols.batch_expiry.ip.set_value(m.expiry_date)}}}break;case"text_changed":if(n.keyCode==8&&n.shiftKey){q.backspace_pressed(row,o,h,n)}break;case"enterkey_press":if(q.focusColumn(row,h,"next",true,{select:true})==false){retval=q.validate_row(row,true);if(retval==-1){setTimeout(function(){q.$el.closest(".popup").find(".popup_footer > .op_btn_sncl").focus()},100)}}break}},check_stock_suffc:function(j,h){if(j[values.godown_name]&&Number(j[values.godown_name]["quantity"])<Number(values.quantity*h.unit_mx)){errors={};errors.quantity={msg:"Insufficient stock"};return errors}},post_validate:function(m,j,l){var h,k;k=this.parent.options.quantity;h=_.reduce(this.get_value_list(),function(o,n){return o+Number(n.quantity)},0);if(l&&h!=k||!l&&h>k){app.notifications.add("Allocation Mismath","Allocation quantity should be equal to item quantity","error");return false}if(!l&&this.isLast(m)&&h>=this.parent.options.quantity){return -1}return true},pre_validate:function(o,j,n,l){var m,k,h;h=this;if(h.er_novalid&&l&&h.rows.length==1&&_.isEmpty(h.get_values(0,null,null,true))){return"skip"}m=h.cl_stock;k=h.parent.options.row;if(m&&!errors){j=h.get_values(o);return h.check_stock_suffc(m,k)}return null}});if((get_cfg("en_godown")=="true"&&get_cfg("linked_gdn")==undefined)||get_cfg("en_batch")=="true"){var a=app.Tab.extend({label:"Stock Allocation",tab_id:"stock_alloc",afterAppend:function(){self=this;self.ip_sheet=new f({validation:_.omit(itemalloc_ips_validation,["batch_name"]),ip_defaults:{class_name:"_type2 _sm2"},appendTo:self.$el,parent:self.$scope,alloc_type:"godown",ips_id:"godown_alloc_ips"})},load_ips:function(){var j,l,h,k,p,r,n,q,m,o;p=this;m=p.ip_sheet;r=p.$scope.options;m.release();m.schema=_.omit(item_allocation_ips_schema,!r.en_gdn?["godown_name"]:null,!r.en_batch?["batch_name","batch_expiry"]:null);m.render();q=r.row;n=traverse(q,"errors.alloc_errors");k=q.extra_values||{};o=k.stock_alloc;if(o){for(j=0;j<o.length;j++){p.ip_sheet.insertRow(o[j],null,null,_.pick(o[j],["godown_id","batch_id"]))}if(n&&n.godown_alloc_errors){m.renderErrors(null,n.godown_alloc_errors,{focus_first:true});n.godown_alloc_errors=null}}else{m.insertRow({})}},validate:function(){return this.ip_sheet.validate_rows()},get_values:function(){return{stock_alloc:this.ip_sheet.get_value_list()}},render_errors:function(h){if(h.stock_alloc_errors){this.ip_sheet.renderErrors(null,h.stock_alloc_errors);delete h.stock_alloc_errors}},on_popup_show:function(){var h;h=this;h.ip_sheet.release(true);options=h.$scope.options;if(options.invoker.check_cl_stock){model=new app.models.Item;model.fetch({data:$.param({id:options.row.data.id,op:"get_godown_wise_list"}),success:function(k,j){h.ip_sheet.cl_stock=_.object(_.map(j.items,function(l){return l.name}),j.items);h.load_ips()},error:function(j,k){}})}else{h.load_ips()}}});set_object("alloc_tab","stock_alloc",a)}if(get_cfg("en_inventory")=="true"){var c=app.Tab.extend({label:"Goods Cost",tab_id:"gdcost_alloc",afterAppend:function(){var j,h;h=this;j=app.IPS_ext.extend({class_name:"itemallc_ip_sheet",ips_id:"godown_alloc_ips",key_col:"doc_no",ip_defaults:{class_name:"_sm2 _type2 _nouline"},schema:{doc_no:{head_label:"Account",width:50,ip_options:{label:"Doc No",dlgTo:"scope",id:"",type:"combobox",label_sel:"doc_no",value_sel:"doc_no",url:"/vouchers/?op=get_list&doc_type_in=grn,bl&doc_no.*={{value}}&pagination=false"}},cost_adj:{head_label:"Method",width:15,ip_options:{type:"selectbox",default_option:"",class_name:"_type3 _sm2 _nouline",options:{auto:"Auto Calculate ",det:"Item Wise"}}},amount:{head_label:"Amount",width:15,ip_options:{type:"inputbox",id:"",label:"Amount"}}},validation:{doc_no:{required:true},cost_adj:{required:true},amount:{required:true}},after_init:function(l){var k;k=this;k.parent=l.parent;k.item_id=l.item_id;k.listenTo(k,"all",k.ips_ev_handler)},update_excl_names:function(q,n,m){var o,l,p,k;k=this;l=_.map(this.rows,function(s){var r=s.cols[this.key_col].ip.get_value();if(r!=""){return r}else{return null}},this);o=m?this.rows:[q];for(i=0;i<o.length;i++){p=_.filter(l,function(r,s){return r!=null&&s!=n});o[i].cols[this.key_col].ip.url_args={excl_names:p.join("|")}}},ips_ev_handler:function(r,q,k,p,m){var n,o,l,s;s=this;row=s.rows[q];switch(r){case"row_insert":s.update_excl_names(row,q);row.cols.doc_no.ip.emul_itemselect();break;case"item_selected":case"keydown":if(k==s.key_col){s.update_excl_names(row,q,true)}break;case"text_changed":if(p.keyCode==8&&p.shiftKey){s.backspace_pressed(row,q,k,p)}break;case"enterkey_press":if(s.focusColumn(row,k,"next",true,{select:true})==false){retval=s.validate_row(row,false);if(retval==true||retval==-1){if(row.cols.cost_adj.ip.get_value()!="auto"){l=row.cols.doc_no.ip.get_selected_data();app.popups.AddDetItems.show({invoker:s,method:"set",load_items:true,details:row.extra_values.details,voucher_id:l.id,amount:row.cols.amount.ip.get_value(),callback:function(t){row.extra_values.details=t;s.after_validate(row,true,{});if(retval==-1){setTimeout(function(){s.$el.closest(".popup").find(".popup_footer > .op_btn_sncl").focus()},100)}}})}else{s.after_validate(row,true,{})}}}break}},post_validate:function(p,l,n){var k,m,o;o=this.parent.options;m=o.amount;k=_.reduce(this.get_value_list(),function(r,q){return r+Number(q.amount)},0);if(n&&k!=m||!n&&k>m){app.notifications.add("Allocation Mismath","Allocation amount should be equal to item amount","error");return false}if(!n&&this.isLast(p)&&k>=o.amount){return -1}return true},pre_validate:function(q,l,p,n){var o,m,k;k=this;if(k.er_novalid&&n&&k.rows.length==1&&_.isEmpty(k.get_values(0,null,null,true))){return"skip"}o=k.cl_stock;m=k.parent.options.row;if(o&&!errors){l=k.get_values(q);return k.check_stock_suffc(o,m)}return null}});h.ip_sheet=new j({appendTo:h.$el,parent:h.$scope})},load_ips:function(){var k,m,j,l,p,r,o,q,n,h;p=this;n=p.ip_sheet;r=p.$scope.options;n.release();n.render();q=r.row;o=traverse(q,"errors.alloc_errors");l=q.extra_values||{};h=l.gdcost_alloc;if(h){for(k=0;k<h.length;k++){p.ip_sheet.insertRow(h[k],null,null,_.pick(h[k],["details"]))}if(o&&o.gdcost_alloc_errors){n.renderErrors(null,o.gdcost_alloc_errors,{focus_first:true});o.gdcost_alloc_errors=null}}else{n.insertRow({})}},validate:function(){return this.ip_sheet.validate_rows()},get_values:function(){return{gdcost_alloc:this.ip_sheet.get_value_list()}},render_errors:function(h){if(h.gdcost_alloc_errors){this.ip_sheet.renderErrors(null,h.gdcost_alloc_errors);delete h.gdcost_alloc_errors}},on_popup_show:function(){var h;h=this;h.ip_sheet.release(true);options=h.$scope.options;h.load_ips()}});set_object("alloc_tab","gdcost_alloc",c)}app.popups.InventoryAlloc=new (app.Popup.extend({id:"inventoryalloc_popup",class_name:"_mw1300x",head:"Inventory Allocation",btn_map:{set:["Set","Setting"]},events:{"click .op_btn":"submit_form"},beforeInit:function(){return true},render:function(k){var l,h;h=this;if(!k){h.ip_sheet=new app.ItemIPS({ips_id:"item_puritemsheet1",class_name:"item_ip_sheet _type1",ip_defaults:{class_name:"_sm _type2"},appendTo:h.$el.find(".popup_body"),rate_sel:h.options.rate_sel,en_prev_rate:true,validation:{},no_total:true,schema:_.omit(sale_purchase_ips_schema,["cl_stock_txt","discount_perc","image","ref_rate"]),parent:h});h.listenTo(h.ip_sheet,"all",h.ips_ev_handler);h.$el.find(".popup_body").append('<div class="price_cnt"></div>')}var j;j=this.options;l=this.options.data;this.setMode("idle");this.current_tab=null;this.ip_sheet.render();this.ip_sheet.$el.show();this.ip_sheet.release(true);if(!_.isEmpty(l)){this.ip_sheet.set_value_list(l)}else{this.ip_sheet.insertRow({})}this.ip_sheet.update_total()},get_date:function(){return this.options.date},update_total:function(h){},submit_form:function(k){var h=this.options,j;j=this.ip_sheet;if(!(j.rows.length==1&&_.every(j.get_values(0),function(l){return l==""}))&&!j.validate_rows()){return false}res=h.callback.call(h.invoker,j.get_value_list(),j.get_total());if(res!=false){this.close()}},ips_ev_handler:function(j,l,h,k){return this.ip_sheet.ips_ev_handler.apply(this.ip_sheet,arguments)}}))();app.popups.RestoreHolded=new (app.Popup.extend({id:"holded_data_popup",class_name:"_mw800x",head:"Holded Vouchers",btn_map:{set:["OK","OK"]},events:{"click .op_btn":"submit_form"},beforeInit:function(){return true},render:function(k){var o,j,l,h,n,m;j=this;if(!k){j.ds=new app.DS({head:"Items",class_name:"hoverable ds_with_head ds_scrollable",ds_id:"ds_hld_item_list",schema:{date:{head_label:"Date",style:"width:15%",index:0},customer_name:{head_label:"Customer Name",style:"width:30%",index:0},particulars:{head_label:"Particulars",style:"width:40%",index:0},net_amount:{head_label:"Amount",type:"money",wrapSPAN:true,style:"width:15%;text-align:right",index:0}},appendTo:this.$el.find(".popup_body")});this.listenTo(this.ds,"all",this.ds_ev_handler)}j.setMode("idle");l=j.options.doc_type;h=localStorage.getItem("holded_data");h=JSON.parse(h);j.holded_data=h;n=h[l];if(!_.isEmpty(n)){m=_.map(n,function(u,s){var p,t,r,q;p={};t=[],r=0;p.date=u.form_data.date;p.customer_name=u.form_data.customer_name;for(q=0;q<u.items.length;q++){t.push(u.items[q].item_name);r+=Number(u.items[q].amount)}p.particulars=t.join(",");p.net_amount=r;p.id=s;return p});j.ds.rows=m;j.ds.render()}else{j.ds.rows=[];j.ds.render()}},ds_ev_handler:function(m,j,h,k,q){var p,n,o,l;p=this;n=p.options;o=p.holded_data;l=o[n.doc_type];if(m=="li_clicked"){n.callback.call(n.invoker,j,l[j],o);p.close()}},submit_form:function(l){var h,k,j,m;j=this;k=j.options;if(!m){h=this.ds.$el.find(".table_list > li.selected").index();if(h!=-1){m=this.ds.rows[h]}}if(m){k.callback.call(k.invoker,m.id,this.ds.data[m.id]);j.close()}else{j.close()}}}))()});FB_Module.register({index:2},function(){var b=get_obj("tax_methods")[get_cfg("tax_method")];var a=app.models.Item;var c=app.sale_purchase_ips_schema={sl_no:{head_label:"Sl No.",width:3,index:10,ip_options:{type:"inputbox",id:"",label:"Sl.",dlgTo:"scope",disabled:true}},barcode:{head_label:"Bar Code",width:10,index:10,ip_options:{type:"inputbox",id:"",label:"Bar Code",dlgTo:"scope"}},item_code:{head_label:"Item Code",width:10,index:10,ip_options:{type:"inputbox",id:"",label:"Item Code",dlgTo:"scope"}},item_name:{head_label:"Item Description",width:40,index:10,ip_options:{type:"inputbox",id:"",label:"Item Description",dlgTo:"scope"}},ref_rate:{head_label:"Ref. Rate",width:9,index:10,ip_options:{type:"inputbox",id:"_ralign",thousand_sep:true,dp:4,label:"Ref. Rate",dlgTo:"scope"}},extra_info:{head_label:"Additional Info",width:20,index:10,ip_options:{type:"inputbox",id:"",label:"Additional Info",dlgTo:"scope"}},unit_name:{head_label:"Unit",width:10,index:20,ip_options:{type:"selectbox",id:"",class_name:"_sm _type3",default_option:"",info_sel:"mx_txt",dlgTo:"scope"}},cl_stock_txt:{head_label:"Closing Stock",width:10,index:30,ip_options:{type:"inputbox",id:"_ralign",label:"Closing Stock",dlgTo:"scope",disabled:true,always_disable:true}},quantity:{head_label:"Quantity",width:10,index:30,ip_options:{type:"inputbox",id:"_ralign",thousand_sep:true,label:"Quantity",dlgTo:"scope"}},rate:{head_label:"Rate",width:10,index:40,ip_options:{type:"inputbox",id:"_ralign",thousand_sep:true,dp:4,label:"Rate",calc_exp:true,dlgTo:"scope"}},gross_amount:{head_label:"Gross Amount",width:10,index:40,ip_options:{type:"inputbox",id:"_ralign",thousand_sep:true,label:"Amount",dlgTo:"scope"}},discount_perc:{head_label:"Disc. %",width:5,index:40,ip_options:{type:"inputbox",id:"",label:"Disc. %",dlgTo:"scope"}},discount:{head_label:"Discount",width:7,index:40,ip_options:{type:"inputbox",id:"_ralign",label:"Discount",thousand_sep:true,dlgTo:"scope"}},amount:{head_label:"Net Amount",width:10,index:50,ip_options:{type:"inputbox",id:"_ralign",thousand_sep:true,label:"Net Amount",dlgTo:"scope"}},image:{head_label:"Image",width:10,index:50,ip_options:{type:"filefield",no_focus:true,id:"_ralign",manual_handle:true,thousand_sep:true,label:"Image",dlgTo:"scope"}}};app.ItemIPS=app.IPS.extend({total_col:"amount",en_click_event:true,after_init:function(d){_.extend(this,_.pick(d,["parent","rate_sel","no_discount"]));this.vald_form=new app.Form({el:$("<div></div>")})},set_height:function(g){var f,e,l,k,j,d,h;f=this.$el.closest(".component.popup");e=f.outerHeight();l=0;j=f.children();for(k=0;k<j.length;k++){if($(j[k]).prop("tagName")!="BUTTON"){l+=$(j[k]).outerHeight()}}l+=(this.parent.$el.find(".price_cnt").outerHeight()||0);if(g&&g.ips_list){d=0;for(k=0;k<g.ips_list.length;k++){j=g.ips_list[k].$el.find(".table_listcnt").outerHeight(true);if(j>d){d=j}}}else{d=this.$el.find(".table_listcnt").outerHeight(true)}j={height:e-(l-d)-30,overflowY:"auto"};if(g&&g.callback){g.callback(j)}else{this.$el.find(".table_listcnt").css(j)}},item_select_callback:function(n,k,j){var m=this,h,l,f,e,g,d;if(k){console.log(k);n.data=k;n.cols.unit_name.ip.unit_data=k.unit_data;n.cols.unit_name.ip.set_options(_.reduce(k.unit_data,function(p,o){p[o.name]=o.name;return p},{}));l={item_code:k.item_code,item_name:k.name,unit_name:k.unit_data[0].name};if(m.schema.barcode){l.barcode=k.barcode}if(m.schema.cl_stock_txt){l.cl_stock_txt=k.cl_stock_txt}if(j){l.quantity=1}m.set_values(n,l,null,_.extend({item_id:k.id},_.pick(k,["stock_enabled","mnt_batch","cost_appl","is_service"])));h=n.cols.unit_name.ip;h.trigger_event("changed",h,null,{focus_next:!j});if(j){h=n.cols.quantity.ip;h.trigger_event("keyup",h,null)}if(j){if(this.isLast(n)){f=m.insertRow({})}else{f=m.nextRow(n)}setTimeout(function(){m.focusColumn(f,"barcode",null,true)},100)}else{setTimeout(function(){m.focusColumn(n,"item_name",null,true)},200)}}else{setTimeout(function(){m.focusColumn(n,"item_name")},200)}},pur_rate_callback:function(f,e){var d;d=this;f.extra_values.purchase_rate=e;setTimeout(function(){d.focusColumn(f,"rate","next",true)},200)},stock_alloc_callback:function(g,f){var e,d;var e=this;d=g.cols.quantity.ip;if(f){g.extra_values=g.extra_values||{};_.extend(g.extra_values,f);d.trigger_event("focusout",d,null);setTimeout(function(){e.focusColumn(g,"quantity","next",true,{select:true})},200)}else{setTimeout(function(){e.focusColumn(g,"quantity")},200)}},set_price:function(h,f){var g,e,d;e=this;d={};g=e.get_values(h,["quantity",e.schema.rate?"rate":null,e.no_discount?null:"discount",e.no_discount?null:"discount_perc",e.schema.rate?"amount":null,e.schema.gross_amount?"gross_amount":null]);if(f=="gross_amount"){g.rate=d.rate=wacky_round((Number(g.gross_amount))/Number(g.quantity),4);g.amount=d.amount=g.gross_amount-(Number(g.discount)||0)}if(f=="amount"){g.rate=d.rate=wacky_round((Number(g.amount)+(Number(g.discount)||0))/Number(g.quantity),4)}if(!e.no_discount){if(f=="discount_perc"){if(!isNaN(g.discount_perc)||g.discount_perc==""){g.discount=d.discount=wacky_round(Number(g.quantity)*Number(g.rate)*Number(g.discount_perc)/100,2)}}else{if(g.discount!=""&&g.rate!=""&&!isNaN(g.rate)&&!isNaN(g.discount)){g.discount_perc=d.discount_perc=wacky_round(Number(g.discount)*100/(Number(g.quantity)*Number(g.rate)),2)}else{d.discount_perc=""}}}if(f!="amount"){if(!isNaN(g.quantity)&&!isNaN(g.rate)){d.amount=g.quantity>=0&&g.rate>=0?wacky_round(Number(g.quantity)*Number(g.rate)-(Number(g.discount)||0),2):""}}if(e.schema.gross_amount&&!isNaN(g.quantity)&&!isNaN(g.rate)){d.gross_amount=g.quantity>=0&&g.rate>=0?wacky_round(Number(g.quantity)*Number(g.rate),2):""}e.set_values(h,d)},find_u:function(d,e){var f;for(f=0;f<d.length;f++){if(d[f].name==e){return d[f]}}return null},unit_changed:function(k,h,e){var j,g,l,f,d;d=this;j=k.cols[h].ip.get_value();g=d.find_u(k.data.unit_data,j);k.unit_mx=Number(g.mx);l=k.data[d.rate_sel];f=_.find(l,function(m){return m.id==g.id});if(!f&&l){f=(g.mx*l[0].rate)/l[0].mx}else{if(f){f=f.rate}}this.parent.$el.find(".popup_footer > .footer_info_cnt").text('Unit info - "Base Unit:'+g.bu_name+", Multiplier:"+g.mx+'"');if(d.rate_sel&&f){d.set_values(k,{rate:j!=""?f||"":""})}k.cols.quantity.ip[j!=""?"enable":"disable"]();if(j!=""&&e){d.focusColumn(k,h,"next",true)}},load_data:function(e){var f,l,j,d,k,g,h;d=this;h=d.schema;k=!this.no_total&&h.discount;if(e.length&&e[0].item_code){for(f in e){j=e[f];l=this.insertRow({});l.data=j;l.cols.quantity.ip.enable();l.cols.unit_name.ip.set_options(_.reduce(j.unit_data,function(n,m){n[m.name]=m.name;return n},{}));if(j.item_code!=""){g=d.find_u(l.data.unit_data,j.unit_name);l.unit_mx=Number(g.mx)}d.set_values(l,j,[h.barcode?"barcode":null,"item_code","item_name",h.ref_rate?"ref_rate":null,h.extra_info?"extra_info":null,"unit_name","quantity",k?"discount":null,!this.no_total?"amount":null,h.cl_stock_txt?"cl_stock_txt":null,h.image?"image":null],_.pick(j,["stock_enabled","cost_appl","mnt_batch","is_service","purchase_rate","item_id","sub_id","stock_alloc","cost_alloc","job_alloc"]));if(!this.no_total&&j.item_code!=""){d.set_price(l,"amount")}}}else{d.insertRow({})}d.update_total()},release:function(){this.update_total();this.__proto__.__proto__.release.apply(this,arguments)},dltRow:function(g,f,e){var d;d=this;d.deleteRow(g);d.rows[f!=0?f-1:0].cols[e].ip.focus();d.update_sl_no()},backspace_pressed:function(f,e,d){if(f.cols[d].ip.get_value()==""){if(f.dclick_flag==true){if(this.rows.length>1){this.dltRow(f,e,d)}}else{this.reset_row(f);f.dclick_flag=true;setTimeout(function(){f.dclick_flag=false},200)}this.update_total()}},get_total:function(){var f,d,e;d=this;f={gross_total:0,total_discount:0};for(i in d.rows){c_row=d.rows[i];if(c_row.cols.amount){e=Number(c_row.cols.amount.ip.get_value());if(!isNaN(e)){f.gross_total+=e}}if(c_row.cols.discount){e=Number(c_row.cols.discount.ip.get_value());if(!isNaN(e)){f.gross_total+=e;f.total_discount+=e}}}if(d.parent.get_total){d.parent.get_total(f)}return f},update_total:function(){var g,k,h,j,m,d,f,e,l;l=this;if(l.no_total){return}e=l.get_total();l.parent.update_total(l,e)},validate_row:function(g,e){var j=this.get_components(g),d=this,f,h;d.vald_form.validation=d.validation;d.vald_form.components=j;if(j.item_name.get_value()==""&&d.rows.length>1&&d.isLast(g)){d.parent.$el.find(".op_btn_snnx").focus();return"outfocus"}else{h=d.vald_form.validate();d.vald_form.renderErrors(h);if(h){d.focusColumn(g,Object.keys(h)[0]);return false}if((d.isLast(g)&&e)||e==2){if(e==2){f=d.insertRow({},this.rows.indexOf(g))}else{f=d.insertRow({})}}else{f=d.nextRow(g)}setTimeout(function(){d.focusRow(f)},20)}return true},updown_arrow_pressed:function(h,f,g){var d;d=this;if(g.keyCode==40&&!d.isLast(h)){d.nextRow(h).cols[f].ip.focus(true)}else{if(g.keyCode==38&&d.getRowIndex(h)>0){d.prevRow(h).cols[f].ip.focus(true)}}},load_item:function(h,g){var d,e,f;e=this;d=new a();f={get_units:true,to_date:e.parent.form.get_values(null,["date"])["date"],get_cstock:true,"item_code.eq":h.comp.get_value(),pagination:false};f[e.rate_sel]=true;d.fetch({data:$.param(f),success:function(k,j){if(j.items.length){if(j.cols){j.items=_.map(j.items,function(l){return _.object(j.cols,l)})}e.item_select_callback(g,j.items[0])}}})},show_item_popup:function(d,h,g){var e,f;f="name_code";e={};e[f]=h.comp.get_value();h.comp.blur();app.popups.ItemSelPopup.show({invoker:this,method:"set",data:e,column:f,callback:this.item_select_callback,row:g})},update_sl_no:function(){if(this.schema.sl_no){var e,d,f;f=this.rows;for(e=0,d=f.length;e<d;e++){f[e].cols.sl_no.ip.set_value(e+1)}}},show_prev_rates_notif:function(f){var e,d;e=this.parent.form.get_values(null,["date",this.parent.client_sel]);if(!e.date||!e[this.parent.client_sel]){return}d={op:"get_prev_rates",item_id:f.extra_values.item_id,limit:5,doc_type:this.parent.doc_type,to_date:e.date};d[this.parent.client_sel]=e[this.parent.client_sel];if(self.prev_rate_xhr){self.prev_rate_xhr.abort()}self.prev_rate_xhr=(new a).fetch({data:d,success:function(h,g){var j;if(f.unit_mx&&!_.isEmpty(g.items)){g.unit_mx=f.unit_mx;j=_.template('<div class="prev_rate_notif"> <% _.each(items,function(itm){ %><li> <%=itm.date%> &nbsp;&nbsp;<%=to_money(itm.rate*unit_mx/itm.mx,2)%> </li><% }); %></div>');f.cols.rate.ip.$el.closest("li").append(j(g))}},error:function(){}})},get_alloc_flags:function(f,h){var d,e,g;d={en_gdn:get_cfg("en_godown")=="true"&&get_cfg("linked_gdn")==undefined,ds_gdn_sb:0,en_batch:true,en_cc:get_cfg("en_costcenter")=="true"&&f.cost_appl,en_job:get_cfg("en_jobs")=="true"};e=h.purpose;if(!(e&&e.get_value()=="cn")){d.en_cc=false}e=h.job_name;if(e&&e.get_value()!=""){d.en_job=false}e=h.godown_name;if(e&&e.get_value()!=""){d.ds_gdn_sb|=1;g=e.get_selected_data();if(g){d.en_batch=g.mnt_batch}}e=h.dst_godown_name;if(e&&e.get_value()!=""){d.ds_gdn_sb|=1;g=e.get_selected_data();if(g){d.en_batch|=g.mnt_batch}}d.en_batch&=f.mnt_batch;d.en_gdn&=(!d.ds_gdn_sb);d.en_batch&=get_cfg("en_batch")=="true"&&get_cfg("lgdn_mnt_batch")!=="";return d},ips_ev_handler:function(q,n,h,m,k){var l,s,r,p,j,g,f,d,o;s=this;r=s.parent;row=this.rows[n];switch(q){case"row_insert":if(s.en_prev_rate){row.cols.rate.ip.$el.parent().append('<button class="_prevrate_btn">...</button>').addClass("_has_btn")}s.update_sl_no();break;case"context_menu":s.show_menu(n,[{label:"Insert Row Above",value:"insert_row"},{label:"Edit Item",value:"edit_item"},(h=="item_name"&&get_cfg("use_custom_desc")=="true"&&row.extra_values.item_id?{label:"Edit Description",value:"edit_desc"}:null),{label:"Delete",value:"delete"}],m);break;case"context_item_click":if(k.value=="edit_desc"){app.popups.DescEdit.show({method:"set",invoker:s,row:row})}else{if(k.value=="delete"){if(this.rows.length>1){this.dltRow(row,n,"item_code")}}else{if(k.value=="insert_row"){s.validate_row(row,2)}else{if(k.value=="edit_item"){app.popups.ItemPopup.show({method:"update",data:{id:row.extra_values.item_id}})}}}}break;case"popup_show":this.set_height(k);break;case"keydown":if((h=="item_name"&&(get_cfg("use_custom_desc")!="true"||!row.extra_values.item_id))||h=="item_code"){if(!(h=="item_code"&&k.comp.get_value()!="")&&m.keyCode==32){m.preventDefault()}}if(h!="unit_name"&&(m.keyCode==38||m.keyCode==40)){s.updown_arrow_pressed(row,h,m)}p=r.form.components;j=row.extra_values;g=s.get_alloc_flags(j,p);if(_.in_list(m.keyCode,[13,9])&&h=="quantity"&&!s.parent.no_alloc&&((j.stock_enabled&&(g.en_gdn||g.en_batch))||g.en_cc||g.en_job)){m.preventDefault();m.stopPropagation();if(row.cols[h].ip.get_value()==""){row.cols[h].ip.render_error("This field is required");return}app.popups.AllocationPopup.show({invoker:s,method:"set",qty_based:true,show_tabs:["stock_alloc",!g.en_job?"job_alloc":null],item:j,en_gdn:g.en_gdn,en_batch:g.en_batch,unit_name:row.cols.unit_name.ip.get_value(),quantity:k.comp.get_value(),callback:this.stock_alloc_callback,row:row})}break;case"clicked":if(m.shiftKey&&m.type=="dblclick"&&h=="item_name"&&row.extra_values.item_id){app.popups.ItemPopup.show({method:"update",data:{id:row.extra_values.item_id}})}else{if($(m.target).hasClass("_prevrate_btn")&&row.extra_values.item_id){app.popups.PrevRatesPopup.show({method:"set",doc_type:s.parent.doc_type,to_date:s.parent.form.get_comp_val("date"),item_id:row.extra_values.item_id})}}break;case"keyup":if(_.in_list(h,["quantity","rate","gross_amount","discount","discount_perc","amount"])){if(!m.keyCode||is_charkey(m)){if(!row.cols.quantity.disabled){if(!this.no_total){s.set_price(row,h)}s.update_total()}}}else{if(h=="barcode"||h=="item_name"||h=="item_code"){l=m.keyCode;if(l==8&&m.shiftKey){s.backspace_pressed(row,n,h)}else{if(h=="barcode"||(h=="item_code"&&get_cfg("icode_direct")=="true"&&!(k.comp.get_value()==""&&m.keyCode==32))){}else{if((h=="item_code"||(get_cfg("use_custom_desc")!="true"||!row.extra_values.item_id))&&(!_.in_list(l,[9,20,38,40,39,37,8,16,18,17,27])||(l==13&&k.comp.get_value()==""))&&!m.ctrlKey){s.show_item_popup(h,k,row)}}}}}break;case"changed":this.unit_changed(row,h,k&&k.focus_next!=undefined?k.focus_next:true);break;case"enterkey_press":if(h=="item_name"&&(!m.ctrlKey)&&k.comp.get_value()==""){s.show_item_popup(h,k,row)}else{if((h=="barcode"||h=="item_code")&&k.comp.get_value()!=""&&get_cfg("icode_direct")=="true"){if(n>0&&s.rows[n-1].data&&(s.rows[n-1].data[h]==k.comp.get_value())){l=Number(s.rows[n-1].cols.quantity.ip.get_value());s.rows[n-1].cols.quantity.ip.set_value(l+1);s.set_price(s.rows[n-1],"quantity");s.update_total();k.comp.set_value("");return}l={};l[h=="barcode"?"barcode.ieq":"item_code.ieq"]=k.comp.get_value();app.popups.ItemSelPopup.load_item(l,{invoker:this,callback:function(e){if(!_.isEmpty(e.items)){if(e.cols){e.items=_.map(e.items,function(t){return _.object(e.cols,t)})}this.item_select_callback(row,e.items[0],true)}else{app.notifications.add("Info","No items found with this item code/barcode","info")}}})}else{if(h=="rate"&&r.doc_type=="credit_note"&&!r.form.components.invoice_no.get_selected_data()){app.popups.PurchaseRatePopup.show({method:"set",row:row,invoker:s,callback:s.pur_rate_callback})}else{if(m.shiftKey){s.validate_row(row,true)}else{if(l=="outfocus"){m.preventDefault()}if(s.focusColumn(row,h,"next",true,{select:true})==false){s.validate_row(row,true)}}}}}break;case"focusin":if(h=="rate"&&s.en_prev_rate){s.show_prev_rates_notif(row)}break;case"focusout":j=row.extra_values;g=row.cols.rate.ip;if(h=="rate"){if(j.cogs_rate!=undefined&&Number(g.get_value())<j.cogs_rate){g.$el.addClass("_red")}else{g.$el.removeClass("_red")}if(s.en_prev_rate){g.$el.closest("li").find(".prev_rate_notif").remove()}}if(h=="quantity"&&((s.rate_sel=="sale_rate"&&get_cfg("notif_cogs_sale")=="true")||(s.ips_id=="sjr_owitemsheet"))){p=r.form.components;f={quantity:k.comp.get_value(),unit_name:row.cols.unit_name.ip.get_value()};if(j&&f.quantity!=""&&f.unit_name!=""){g=s.get_alloc_flags(j,p);if(g.en_gdn||g.en_batch){if(!j.stock_alloc){return}f.alloc_data=_.reduce(j.stock_alloc,function(e,t){return e+(e!=""?",":"")+(t.godown_id||"")+","+(t.batch_id||"")+","+t.quantity},"")}if(p.godown_name){o=p.godown_name;if(o.get_value()!=""){d=o.get_selected_data();f.godown_id=d.id}}(new app.models.Item).fetch({data:_.extend({op:"get_cogs_of_q",method:r.options.method,voucher_id:traverse(r,"options.data.voucher_id"),item_id:j.item_id,to_date:p.date.get_value()},f),success:function(e,t){j.cogs_rate=t.rate;s.trigger("cogs_callback",n)},error:function(e,t){}})}}break;case"file_changed":if(k.files&&k.files.length){if(k.files.length>1){app.notifications.add("Error","Only 1 file can be selected","error");k.comp.set_value("");return}if(k.files[0].size>(1024*1024)){app.notifications.add("Error","File size should be less than 1MB","error");k.comp.set_value("");return}l=new app.models.Attachment;l.doc_id=s.parent.extra_det.uuid;l.doc_type=s.parent.doc_type;k.comp.disable();l.post(k.files,{success:function(t,e){k.comp.enable();row.extra_values.sub_id=e.id;k.comp.$el.find(".file_ip_upbtn").addClass("fb_close")},error:function(e,t){k.comp.enable();app.notifications.add("Error","Error while uploading file","error");k.comp.set_value("")}})}else{k.comp.disable();l=new app.models.Attachment;l.id=row.extra_values.sub_id;l.destroy(l.id,{success:function(t,e){k.comp.enable();k.comp.set_value("");k.comp.$el.find(".file_ip_upbtn").removeClass("fb_close")},error:function(e,t){k.comp.enable();app.notifications.add("Error","Error while deletion","error")}})}}}});if(b.ps_ips_ext){app.ItemIPS.merge(b.ps_ips_ext)}});FB_Module.register({index:2},function(){var q=get_obj("tax_methods")[get_cfg("tax_method")];var k={quantity:{required:true},rate:{required:true}};var g={quantity:{required:true},rate:{required:true}};var l={round_off:{type:"inputbox",class_name:"_type2 _w6em _ralign _wbg _comp_inline",dlgTo:"scope",thousand_sep:true,label:"",maxlength:4},is_draft:{type:"checkbox",class_name:"_type1 _mgrt_4em _comp_inline",value:"true",dlgTo:"scope",label:"Draft"},save_changes:{type:"checkbox",class_name:"_type1 _mgrt_1em _comp_inline",value:"true",dlgTo:"scope",label:"Save Changes"},print_btn:{type:"button",class_name:"_type1 _md _mgrt_05em _comp_inline",dlgTo:"scope",label:"Print"},export_btn:{type:"button",class_name:"_type1 _md _mgrt_2em _comp_inline",dlgTo:"scope",label:"Export"},new_btn:{type:"button",class_name:"_type1 _md _mgrt_1em _comp_inline",dlgTo:"scope",label:"New"},clone_btn:{type:"button",class_name:"_type1 _md _mgrt_1em _comp_inline",dlgTo:"scope",label:"Clone"},print_on_save:{type:"checkbox",class_name:"_type1 _mgtp_4x _mgrt_3em _comp_inline",value:"true",dlgTo:"scope",label:"Print on save"},hold_btn:{type:"button",class_name:"_type1 _theme1 _md _mgrt_05em _comp_inline",dlgTo:"scope",label:"Hold"},unhold_btn:{type:"button",class_name:"_type1 _md _mgrt_05em _comp_inline",dlgTo:"scope",label:"Restore"},_sec1:{tagName:"div",className:"_sec1 _iblock _mgrt_1em",fields:{_other_disc_cnt:{tagName:"div",className:"_mgtp_1em",fields:{_other_disc_txt:{tagName:"SPAN",innerHTML:"Other Discount. :",className:"_mgrt_1em _comp_inline _sm2 _mgbt_05em"},other_discount_perc:{type:"inputbox",class_name:"_type2 _wbg _sm2 _w3em _ralign _mgrt_05em _comp_inline",dlgTo:"scope",label:"Perc %"},other_discount:{type:"inputbox",class_name:"_type2 _wbg _sm2 _w6em _ralign _comp_inline",thousand_sep:true,dlgTo:"scope",label:"Amount"}}},narration:{type:"inputbox",class_name:"_type4 _nobg _sm2 _blk_label _pdlt_8em _mgbt_05em _w25em",label:"Narration:"},pay_terms:{type:"inputbox",class_name:"_type4 _nobg _sm2 _blk_label _pdlt_8em _mgbt_05em _w25em",label:"Payment Terms:"}}},_sec2:{tagName:"div",className:"_sec2 _iblock _mgtp_10x",fields:{_other_charge_cnt:{tagName:"div",className:"_sec2",fields:{other_charges:{type:"inputbox",class_name:"_type4 _nobg _mgrt_05em _sm2 _blk_label _mgtp_2x _pdlt_7em _comp_inline _mgbt_05em _w6em",always_disable:true,label:"Other Charges:"},other_charge_btn:{type:"button",class_name:"_type1 _sm2 _comp_inline _w2em _mgbt_05em",label:"...",dlgTo:"scope"}}},_settle_ref:{tagName:"div",className:"_sec2",fields:{settle_ref:{type:"inputbox",class_name:"_type4 _nobg _mgrt_05em _sm2 _blk_label _mgtp_2x _pdlt_7em _comp_inline _mgbt_05em _w6em",always_disable:true,label:"Ref/Settlements:"},settle_ref_btn:{type:"button",class_name:"_type1 _sm2 _comp_inline _w2em _mgbt_05em",label:"...",dlgTo:"scope"}}},_multi_cnt:{tagName:"div",className:"_sec2 _ps_det _iblock",fields:{cash_amount:{type:"inputbox",class_name:"_type4 _wbg _pdlt_3em _sm2 _w7em _mgrt_1em _ralign",thousand_sep:true,dlgTo:"scope",label:"Cash :"},card_amount:{type:"inputbox",class_name:"_type4 _wbg _pdlt_3em _mgtp_4x _sm2 _w7em _ralign",thousand_sep:true,dlgTo:"scope",label:"Card :"}}}}}};var d={default_attr:{class_name:"_type1 _sm2 _comp_inline _mgrt_1em _mgbt_05em"},fields:{detail_btn:{type:"button",id:"_ps_arrow_btn _theme1",no_focus:true,label:">",dlgTo:"scope",index:0},doc_no:{type:"inputbox",id:"_w12em",label:"Doc No",dlgTo:"scope",index:10},date:{type:"datefield",id:"_w7em",label:"Date",dlgTo:"scope",index:20},invoice_no:{type:"combobox",id:"_w10em",label:"Invoice No",new_item_btn:true,index:30,url:"/invoices/?doc_no.*={{value}}&pagination=false",label_sel:"doc_no",value_sel:"doc_no",dlgTo:"scope"},ps_type:{type:"selectbox",id:"_w8em",label:"Pay Type",default_option:"",dlgTo:"scope",index:40,options:_.extend({},get_cfg("ds_pay_cash")!="true"?{cash:"Cash"}:null,{credit:"Credit"},get_cfg("ds_pay_cash")!="true"?{pettycash:"Petty Cash",card:"Card",multi:"Card/Cash"}:null)},so_no:{type:"combobox",id:"_w10em",label:"S/O No",index:42,url:"/sale_orders/?op=get_so_dn_doc_nos&doc_no={{value}}&pagination=false",label_sel:"doc_no",value_sel:"doc_no",dlgTo:"scope",new_item_btn:true},job_name:{type:"combobox",label:"Job ID",id:"_w15em",url:"/jobs/?name={{value}}&customer_name={{cust_name}}&pagination=false&is_group=false",dlgTo:"scope",label_sel:"name",value_sel:"name"},ps_division_name:{type:"combobox",id:"_w10em",label:"Division",index:50,url:"/ps_divisions/?name={{value}}&pagination=false",dlgTo:"scope"},sale_loc_name:{type:"combobox",id:"_w12em",label:"Location",url:"/sale_loc/?name={{value}}&pagination=false",index:51,dlgTo:"scope"},godown_name:{type:"combobox",id:"_w10em",label:"Godown",index:52,url:"/godowns/?name={{value}}&pagination=false",dlgTo:"scope"},customer_name:{type:"combobox",id:"_w25em",label:"Customer",index:60,url:"/cust_n_vendor/customers/?name={{value}}&pagination=false",new_item_btn:true,dlgTo:"scope",en_search_by:"customer_schema",root_url:"/cust_n_vendor/customers/",en_search_by:"customer_schema",root_url:"/cust_n_vendor/customers/"},po_no:{type:"inputbox",id:"_w10em",label:"P/O No",index:70,dlgTo:"scope"},_dnote_attch_cnt:{tagName:"div",className:"_comp_inline _dnote_attch_cnt",index:90,fields:{src_type:{type:"selectbox",label:"Source",id:"_w8em",default_option:"",dlgTo:"scope",options:{dnote:"Delivery Note",dr:"Direct"}},dnotes_txt:{type:"inputbox",id:"_w10em",label:"Delivery Notes",dlgTo:"scope"},dn_attch_btn:{type:"button",id:"_theme1 _mgtp_10x",label:"Attach",dlgTo:"scope"}}},sales_rep_id:{type:"combobox",id:"_w15em",label:"Sales Man",url:"/accounts/?name={{value}}&is_cntlacc=false&under_defacc=market_exec_pybl&_select_fields=id,display_name&pagination=false",label_sel:"display_name",value_sel:"id",index:110,new_item_btn:true,dlgTo:"scope"},currency_name:{type:"combobox",id:"_w6em",label:"Currency",index:120,url:"/currencies/?name={{value}}&rate_on={{date}}&pagination=false",dlgTo:"scope",info_format:"Rate : {{rate}}",label_sel:"abbr",value_sel:"abbr",auto_show_info:true},is_approved:{type:"selectbox",id:"_w8em",label:"Approve",index:130,options:[{"true":"Yes"},{"false":"No"}],default_option:"",dlgTo:"scope"}},validation:{date:{required:true,pattern:"date"}}};_.extend(d.fields,l);var f={_sec2:{tagName:"div",className:"_sec2 _iblock _mgrt_1em",fields:{delivery_terms:{type:"inputbox",class_name:"_type4 _nobg _mgrt_05em _sm2 _blk_label _mgtp_2x _pdlt_7em _mgbt_05em _w15em",label:"Delivery Terms",dlgTo:"scope"},validity:{type:"inputbox",class_name:"_type4 _nobg _mgrt_05em _sm2 _blk_label _mgtp_2x _pdlt_7em _mgbt_05em _w12em",label:"Validity",dlgTo:"scope"},availability:{type:"inputbox",class_name:"_type4 _nobg _mgrt_05em _sm2 _blk_label _mgtp_2x _pdlt_7em _mgbt_05em _w12em",label:"Availability",dlgTo:"scope"},ref_name:{type:"inputbox",class_name:"_type4 _nobg _mgrt_05em _sm2 _blk_label _mgtp_2x _pdlt_7em _mgbt_05em _w15em",label:"Your Ref",dlgTo:"scope"}}}};var r={_sec2:{tagName:"div",className:"_sec2 _iblock _mgrt_1em",fields:{ref_name:{type:"inputbox",class_name:"_type4 _nobg _mgrt_05em _sm2 _blk_label _mgtp_2x _pdlt_7em _mgbt_05em _w15em",label:"Your Ref",dlgTo:"scope"}}}};if(q.invoice_bill_ext){_.extend(d.fields,q.invoice_bill_ext.form_schema.sp_cat.fields)}var p={default_attr:{class_name:"_type1 _sm2 _comp_inline _mgrt_1em _mgbt_05em"},fields:{detail_btn:{type:"button",id:"_ps_arrow_btn _theme1",label:">",dlgTo:"scope"},doc_no:{type:"inputbox",id:"_w12em",label:"Doc No",dlgTo:"scope"},bill_no:{type:"inputbox",id:"_w10em",label:"Ref No"},ref_no:{type:"inputbox",id:"_w10em",label:"Ref No"},date:{type:"datefield",id:"_w7em",label:"Date",dlgTo:"scope"},ps_type:{type:"selectbox",id:"_w8em",label:"Pay Type",default_option:"",dlgTo:"scope",options:{cash:"Cash",credit:"Credit",pettycash:"Petty Cash",card:"Card",multi:"Card/Cash"}},ps_division_name:{type:"combobox",id:"_w10em",label:"Division",url:"/ps_divisions/?name={{value}}&pagination=false",dlgTo:"scope"},godown_name:{type:"combobox",id:"_w10em",label:"Godown",url:"/godowns/?name={{value}}&pagination=false",dlgTo:"scope"},supplier_name:{type:"combobox",id:"_w25em",label:"Supplier",url:"/cust_n_vendor/suppliers/?name={{value}}&pagination=false",new_item_btn:true,dlgTo:"scope",en_search_by:"vendor_schema",root_url:"/cust_n_vendor/suppliers/"},order_type:{type:"selectbox",label:"Order Type",options:[{po:"Purchase Order"},{vo:"Verbal Order"}],default_option:"",dlgTo:"scope",id:"_w12em"},purpose:{type:"selectbox",label:"Purpose",options:[{cn:"Consumption"},{tr:"Trade"}],default_option:"",dlgTo:"scope",id:"_w12em"},po_no:{type:"inputbox",id:"_w10em",label:"P/O No",dlgTo:"scope"},po_no_cmbx:{type:"combobox",id:"_w10em",label:"P/O No (Out)",name:"po_no",new_item_btn:true,label_sel:"doc_no",value_sel:"doc_no",dlgTo:"scope",url:"/purchase_orders/?doc_no.*={{value}}&customer_name={{cname}}&status.in=pd,prd&pagination=false"},_dnote_attch_cnt:{tagName:"div",className:"_comp_inline _dnote_attch_cnt",fields:{src_type:{type:"selectbox",label:"Source",id:"_w8em",default_option:"",dlgTo:"scope",options:{grn:"GRN",dr:"Direct"}},dnotes_txt:{type:"inputbox",id:"_w10em",label:"GRNs",dlgTo:"scope"},dn_attch_btn:{type:"button",id:"_theme1 _mgtp_10x",label:"Attach",dlgTo:"scope"}}},currency_name:{type:"combobox",id:"_w6em",label:"Currency",url:"/currencies/?name={{value}}&rate_on={{date}}&pagination=false",dlgTo:"scope",info_format:"Rate : {{rate}}",label_sel:"abbr",value_sel:"abbr",auto_show_info:true},pur_man_id:{type:"combobox",id:"_w15em",label:"Purchase Manager",url:"/employees/?name={{value}}&pagination=false",label_sel:"name",value_sel:"id",new_item_btn:true,dlgTo:"scope"},is_approved:{type:"selectbox",id:"_w8em",label:"Approve",default_option:"",options:[{"true":"Yes"},{"false":"No"}],dlgTo:"scope"}},validation:{}};if(q.invoice_bill_ext){_.extend(p.fields,q.invoice_bill_ext.form_schema.sp_cat.fields)}_.extend(p.fields,l);var c={default_attr:{class_name:"_type1 _sm2 _comp_inline _mgrt_1em _mgbt_05em"},fields:{detail_btn:{type:"button",id:"_ps_arrow_btn _theme1",label:">",dlgTo:"scope"},doc_no:{type:"inputbox",id:"_w10em",label:"Doc No"},date:{type:"datefield",id:"_w7em",label:"Date",dlgTo:"scope"},customer_name:{type:"combobox",id:"_w15em",label:"Customer",url:"/cust_n_vendor/customers/?name={{value}}&pagination=false",new_item_btn:true,dlgTo:"scope"},po_no:{type:"inputbox",id:"_w10em",label:"P/O No",dlgTo:"scope"},so_no:{type:"combobox",id:"_w10em",label:"S/O No",new_item_btn:true,url:"/sale_orders/?doc_no.*={{value}}&customer_name={{cname}}&status.in=pd,prd&pagination=false",label_sel:"doc_no",value_sel:"doc_no",dlgTo:"scope"},godown_name:{type:"combobox",id:"_w10em",label:"Godown",url:"/godowns/?name={{value}}&pagination=false",dlgTo:"scope"},currency_name:{type:"combobox",id:"_w6em",label:"Currency",url:"/currencies/?name={{value}}&rate_on={{date}}&pagination=false",dlgTo:"scope",info_format:"Rate : {{rate}}",label_sel:"abbr",value_sel:"abbr",auto_show_info:true},is_approved:{type:"selectbox",id:"_w8em",label:"Approve",default_option:"",options:[{"true":"Yes"},{"false":"No"}],dlgTo:"scope"}},validation:{}};_.extend(c.fields,l);var j={default_attr:{class_name:"_type1 _sm2 _comp_inline _mgrt_1em _mgbt_05em"},fields:{detail_btn:{type:"button",id:"_ps_arrow_btn _theme1",label:">",dlgTo:"scope"},doc_no:{type:"inputbox",id:"_w10em",label:"Doc No",dlgTo:"scope"},date:{type:"datefield",id:"_w7em",label:"Date",dlgTo:"scope"},sub_type:{type:"selectbox",id:"_w10em",label:"Note Type",default_option:"",dlgTo:"scope",options:{op:"Operational",bt:"Branch Transfer"}},supplier_name:{type:"combobox",id:"_w20em",label:"Supplier",url:"/cust_n_vendor/suppliers/?name={{value}}&pagination=false",new_item_btn:true,dlgTo:"scope"},branch_id:{type:"combobox",id:"_w15em",label:"Branch",url:"/accounts/?name={{value}}&under_defacc=branches&excl_defacc=curr_branch&_select_fields=id,display_name&pagination=false",dlgTo:"scope",label_sel:"display_name",value_sel:"id"},godown_name:{type:"combobox",id:"_w15em",label:"Godown",url:"/godowns/?name={{value}}&pagination=false",dlgTo:"scope"},order_type:{type:"selectbox",label:"Order Type",options:[{po:"Purchase Order"},{vo:"Verbal Order"}],default_option:"",dlgTo:"scope",id:"_w12em"},po_no:{type:"combobox",id:"_w10em",label:"P/O No (Out)",new_item_btn:true,url:"/purchase_orders/?doc_no.*={{value}}&customer_name={{cname}}&status.in=pd,prd&pagination=false",label_sel:"doc_no",value_sel:"doc_no",dlgTo:"scope"},bt_ref_no:{type:"combobox",id:"_w10em",label:"Ref No",dlgTo:"scope",url:"/grns/?op=get_stock_issue_vchrs&doc_no={{value}}&branch_id={{branch_id}}&no_limit=true&pagination=false",dlgTo:"scope",label_sel:"doc_no",value_sel:"doc_no"},issue_date:{type:"datefield",id:"_w7em",label:"Issue Date",dlgTo:"scope"},currency_name:{type:"combobox",id:"_w6em",label:"Currency",url:"/currencies/?name={{value}}&rate_on={{date}}&pagination=false",dlgTo:"scope",info_format:"Rate : {{rate}}",label_sel:"abbr",value_sel:"abbr",auto_show_info:true},is_approved:{type:"selectbox",id:"_w8em",label:"Approve",default_option:"",options:[{"true":"Yes"},{"false":"No"}],dlgTo:"scope"}},validation:{}};_.extend(j.fields,l);var h={default_attr:{class_name:"_type1 _sm2 _comp_inline _mgrt_1em _mgbt_05em"},fields:{detail_btn:{type:"button",id:"_ps_arrow_btn _theme1",label:">",dlgTo:"scope"},doc_no:{type:"inputbox",id:"_w10em",label:"Doc No",dlgTo:"scope"},date:{type:"datefield",id:"_w7em",label:"Date",dlgTo:"scope"},godown_name:{type:"combobox",id:"_w15em",label:"Source Godown",url:"/godowns/?name={{value}}&pagination=false",dlgTo:"scope"},dst_godown_name:{type:"combobox",id:"_w15em",label:"Dest. Godown",url:"/godowns/?name={{value}}&pagination=false",dlgTo:"scope"},is_approved:{type:"selectbox",id:"_w8em",label:"Approve",default_option:"",options:[{"true":"Yes"},{"false":"No"}],dlgTo:"scope"}},validation:{}};_.extend(h.fields,l);var n={default_attr:{class_name:"_type1 _sm2 _comp_inline _mgrt_1em _mgbt_05em"},fields:{detail_btn:{type:"button",id:"_ps_arrow_btn _theme1",label:">",dlgTo:"scope",index:0},doc_no:{type:"inputbox",id:"_w10em",label:"Doc No",dlgTo:"scope",index:10},date:{type:"datefield",id:"_w7em",label:"Date",dlgTo:"scope",index:20},customer_name:{type:"combobox",id:"_w25em",label:"Customer",url:"/cust_n_vendor/customers/?name={{value}}&pagination=false",new_item_btn:true,dlgTo:"scope",index:30},supplier_name:{type:"combobox",id:"_w25em",label:"Supplier",url:"/cust_n_vendor/suppliers/?name={{value}}&pagination=false",new_item_btn:true,dlgTo:"scope",index:30},contract_type:{type:"selectbox",id:"_w10em",label:"Contract Type",dlgTo:"scope",options:[{sv:"Service Contract"}],index:40},start_date:{type:"datefield",id:"_w10em",label:"Contract Start Date",dlgTo:"scope",index:50},end_date:{type:"datefield",id:"_w10em",label:"Contract End Date",dlgTo:"scope",index:60},revenue_start_date:{type:"datefield",id:"_w10em",label:"Revenue start Date",dlgTo:"scope",index:70},_inv:{tagName:"div",index:80},auto_invoice:{type:"checkbox",id:"_w7em _mgtp_1em",label:"Auto Invoice",value:"true",dlgTo:"scope",index:90},invoice_period:{type:"selectbox",id:"_w10em",label:"Invoice Period",default_option:"",index:100,options:[{"1month":"Monthly"},{"2month":"Bi Monthly"},{"3month":"Quarterly"},{"6month":"6 Month"},{"12month":"Yearly"}],dlgTo:"scope"},invoice_on:{type:"selectbox",id:"_w10em",label:"Invoice On",default_option:"",index:110,options:[{start:"Start of period"},{end:"End of period"},{date:"Specific Date"}],dlgTo:"scope"},invoice_date:{type:"inputbox",id:"_w10em",label:"Invoice Day",dlgTo:"scope",index:120},currency_name:{type:"combobox",id:"_w6em",label:"Currency",index:130,url:"/currencies/?name={{value}}&rate_on={{date}}&pagination=false",dlgTo:"scope",info_format:"Rate : {{rate}}",label_sel:"abbr",value_sel:"abbr",auto_show_info:true},is_approved:{type:"selectbox",id:"_w8em",label:"Approve",default_option:"",index:140,options:[{"true":"Yes"},{"false":"No"}],dlgTo:"scope"},status:{type:"selectbox",id:"_w8em",label:"Status",default_option:"",index:150,options:[{ac:"Active"},{sp:"Suspended"},{tm:"Terminated"},{fn:"Finished"}],dlgTo:"scope"},status_date:{type:"inputbox",id:"_w10em",label:"Date",dlgTo:"scope",index:160}},validation:{}};_.extend(n.fields,l);set_objs({contract_form_schema:n});stock_opening={default_attr:{class_name:"_type1 _sm2 _comp_inline _mgrt_1em _mgbt_05em"},fields:{detail_btn:{type:"button",id:"_ps_arrow_btn _theme1",label:">",dlgTo:"scope"},doc_no:{type:"inputbox",id:"_w10em",label:"Doc No"},date:{type:"datefield",id:"_w7em",label:"Date",dlgTo:"scope"},godown_name:{type:"combobox",id:"_w10em",label:"Godown",url:"/godowns/?name={{value}}&pagination=false",dlgTo:"scope"},is_approved:{type:"selectbox",id:"_w8em",label:"Approve",default_option:"",options:[{"true":"Yes"},{"false":"No"}]}},validation:{}};_.extend(stock_opening.fields,_.omit(l,["round_off"]));var e={default_attr:{class_name:"_type1 _sm2 _comp_inline _mgrt_1em _mgbt_05em"},fields:{detail_btn:{type:"button",id:"_ps_arrow_btn _theme1",label:">",dlgTo:"scope"},doc_no:{type:"inputbox",id:"_w10em",label:"Doc No"},date:{type:"datefield",id:"_w7em",label:"Date",dlgTo:"scope"},job_name:{type:"combobox",id:"_w25em",label:"Job ID",url:"/jobs/?name={{value}}&pagination=false",new_item_btn:true,dlgTo:"scope"},boq_vchr_no:{type:"combobox",id:"_w10em",label:"BOQ No",url:"/boqs/?doc_no.*={{value}}&job_name={{job_name}}&date.lte={{date}}&pagination=false",value_sel:"doc_no",label_sel:"doc_no",new_item_btn:true,dlgTo:"scope"},is_approved:{type:"selectbox",id:"_w8em",label:"Approve",default_option:"",options:[{"true":"Yes"},{"false":"No"}]}},validation:{}};_.extend(e.fields,l);var a,o,b,s;o=get_cfg("prev_rates")=="true";b=get_cfg("en_multicurr")=="true";s=get_cfg("en_godown")=="true";var t={ips_options:{rate_sel:"sale_rate",validation:g,en_prev_rate:false,ips_exclude:["ref_rate","cl_stock_txt","extra_info","image"]},onrender:function(u){var w,x,v,u;u=this;v=_.bind(u.form_ev_handler,u);x=u.form.components;v("changed",x.invoice_on);v("clicked",x.auto_invoice);u.form[u.options.method=="create"?"hide_comps":"show_comps"](["status"]);v("changed",x.status)},form_ev_handler2:function(z,v,A,w){var u=this,x,y;if(z=="clicked"&&v.name=="auto_invoice"){u.form[v.get_value()=="true"?"show_comps":"hide_comps"](["invoice_period","invoice_on"])}else{if(z=="changed"&&v.name=="invoice_on"){u.form[v.get_value()=="date"?"show_comps":"hide_comps"](["invoice_date"])}else{if(z=="changed"&&v.name=="status"){x=u.form.components.status_date;if(A){x.set_value("")}y=v.get_value();if(y=="sp"){x.set_label("Suspended Date")}else{if(y=="tm"){x.set_label("Terminated Date")}}x[_.in_list(y,["sp","tm"])?"show":"hide"]()}}}}};a={bill:{doc_type:"bill",head:"Bill (Purchase)",model:app.models.Bill,exclude_on_reset:["date","ps_type"],client_sel:"supplier_name",form_schema:{default_attr:p.default_attr,fields:_.omit(p.fields,["ref_no",get_doctype("po").is_enabled!="true"?"order_type":"",get_doctype("po").is_enabled=="true"?"po_no":"",get_doctype("po").is_enabled!="true"?"po_no_cmbx":"",get_cfg("working_mode")!="trcnt"?"purpose":"",get_cfg("en_p_division")!="true"||get_cfg("linked_psd")!=undefined?"ps_division_name":"",!s||get_cfg("linked_gdn")!=undefined?"godown_name":"",get_cfg("en_pur_man")!="true"?"pur_man_id":"",get_doctype("grn").is_enabled!="true"?"_dnote_attch_cnt":"",!(b&&get_doctype("bl").en_multicurr=="true")?"currency_name":"",get_doctype("bl").en_approval!="true"||!AL.any_access("bill.approve")?"is_approved":""])},form_reset_keys:{ps_type:"credit"},extra_item_filter:function(u){if(u.form.components.purpose&&u.form.components.purpose.get_value()=="cn"){return{has_exp_acc:"true"}}return{}},ips_options:{rate_sel:"purchase_rate",validation:k,en_prev_rate:o,ips_exclude:["cl_stock_txt","ref_rate",get_cfg("en_extra_info")!="true"?"extra_info":null,"image"]}},invoice:{doc_type:"invoice",head:"Invoice (Sale)",model:app.models.Invoice,exclude_on_reset:["date","ps_type"],client_sel:"customer_name",form_schema:{default_attr:d.default_attr,fields:_.omit(d.fields,["invoice_no",get_cfg("en_jobs")!="true"?"job_name":"",get_doctype("sor").is_enabled!="true"?"so_no":"",get_cfg("en_s_division")!="true"||get_cfg("linked_psd")!=undefined?"ps_division_name":"",!s||get_cfg("linked_gdn")!=undefined?"godown_name":"",get_cfg("en_sale_loc")!="true"||get_cfg("linked_loc")!=undefined?"sale_loc_name":"",get_cfg("en_salesrep")!="true"?"sales_rep_id":"",get_doctype("gdn").is_enabled!="true"?"_dnote_attch_cnt":"",!(b&&get_doctype("iv").en_multicurr=="true")?"currency_name":"",get_doctype("iv").en_approval!="true"||!AL.any_access("invoice.approve")?"is_approved":""])},form_reset_keys:{ps_type:""},ips_options:{rate_sel:"sale_rate",validation:g,en_prev_rate:o,ips_exclude:["cl_stock_txt","ref_rate",get_cfg("en_extra_info")!="true"?"extra_info":null,"image"]}},credit_note:{doc_type:"credit_note",head:"Credit Note (Sale Return)",model:app.models.CreditNote,exclude_on_reset:["date","ps_type"],client_sel:"customer_name",form_schema:{default_attr:d.default_attr,fields:_.omit(d.fields,["po_no","so_no","_dnote_attch_cnt",get_cfg("en_jobs")!="true"?"job_name":"",get_cfg("en_s_division")!="true"||get_cfg("linked_psd")!=undefined?"ps_division_name":"",get_cfg("en_sale_loc")!="true"||get_cfg("linked_loc")!=undefined?"sale_loc_name":"",!s||get_cfg("linked_gdn")!=undefined?"godown_name":"",get_cfg("en_salesrep")!="true"?"sales_rep_id":"",!(b&&get_doctype("cn").en_multicurr=="true")?"currency_name":"",get_doctype("cn").en_approval!="true"||!AL.any_access("credit_note.approve")?"is_approved":""])},form_reset_keys:{ps_type:""},ips_options:{rate_sel:"sale_rate",validation:g,en_prev_rate:o,ips_exclude:["cl_stock_txt","ref_rate",get_cfg("en_extra_info")!="true"?"extra_info":null,"image"]}},debit_note:{doc_type:"debit_note",head:"Debit Note (Purchase Return)",model:app.models.DebitNote,exclude_on_reset:["date","ps_type"],client_sel:"supplier_name",form_schema:{default_attr:p.default_attr,fields:_.omit(p.fields,["ref_no","po_no","po_no_cmbx","_dnote_attch_cnt","order_type",get_cfg("en_p_division")!="true"||get_cfg("linked_psd")!=undefined?"ps_division_name":"",!s||get_cfg("linked_gdn")!=undefined?"godown_name":"",get_cfg("working_mode")!="trcnt"?"purpose":"",!(b&&get_doctype("dn").en_multicurr=="true")?"currency_name":"",get_cfg("en_pur_man")!="true"?"pur_man_id":"",get_doctype("bl").en_approval!="true"||!AL.any_access("debit_note.approve")?"is_approved":""])},form_reset_keys:{ps_type:""},ips_options:{rate_sel:"purchase_rate",validation:k,en_prev_rate:o,ips_exclude:["cl_stock_txt","ref_rate",get_cfg("en_extra_info")!="true"?"extra_info":null,"image"]}},sales_quotation:{doc_type:"sales_quotation",head:"Sales Quotation",model:app.models.SalesQuotation,exclude_on_reset:["date"],client_sel:"customer_name",form_schema:{default_attr:d.default_attr,fields:_.extend({},_.omit(d.fields,["ps_type","invoice_no","po_no","so_no","_dnote_attch_cnt","godown_name","sale_loc_name",get_cfg("en_salesrep")!="true"?"sales_rep_id":"",get_cfg("en_jobs")!="true"?"job_name":"",get_cfg("en_s_division")!="true"||get_cfg("linked_psd")!=undefined?"ps_division_name":"",get_cfg("en_salesrep")!="true"?"sales_rep_id":"",!(b&&get_doctype("sq").en_multicurr=="true")?"currency_name":"",get_doctype("sq").en_approval!="true"||!AL.any_access("sales_quotation.approve")?"is_approved":"","_sec2"]),f)},extra_det_schema:{delivery_terms:{}},form_reset_keys:{},no_alloc:true,ips_options:{rate_sel:"sale_rate",no_discount:false,validation:g,en_prev_rate:o,ips_exclude:["cl_stock_txt",get_cfg("en_ref_rate")!="true"?"ref_rate":null,get_cfg("en_extra_info")!="true"?"extra_info":null]}},profoma_invoice:{doc_type:"profoma_invoice",head:"Profoma Invoice",model:app.models.ProfomaInvoice,exclude_on_reset:["date"],client_sel:"customer_name",form_schema:{default_attr:d.default_attr,fields:_.extend({},_.omit(d.fields,["ps_type","invoice_no","po_no","so_no","godown_name","_dnote_attch_cnt","sale_loc_name",get_cfg("en_jobs")!="true"?"job_name":"",get_cfg("en_s_division")!="true"||get_cfg("linked_psd")!=undefined?"ps_division_name":"",get_cfg("en_salesrep")!="true"?"sales_rep_id":"",!(b&&get_doctype("prf").en_multicurr=="true")?"currency_name":"",get_doctype("prf").en_approval!="true"||!AL.any_access("profoma_invoice.approve")?"is_approved":"","_sec2"]),f)},extra_det_schema:{delivery_terms:{}},form_reset_keys:{},no_alloc:true,ips_options:{rate_sel:"sale_rate",no_discount:false,validation:g,en_prev_rate:o,ips_exclude:["cl_stock_txt",get_cfg("en_ref_rate")!="true"?"ref_rate":null,get_cfg("en_extra_info")!="true"?"extra_info":null,"image"]}},purchase_order:{doc_type:"purchase_order",head:"Purchase Order",model:app.models.PurchaseOrder,exclude_on_reset:["date"],client_sel:"supplier_name",form_schema:{default_attr:p.default_attr,fields:_.extend({},_.omit(p.fields,["bill_no","ps_type","_dnote_attch_cnt","po_no","po_no_cmbx","godown_name","purpose","order_type",get_cfg("en_p_division")!="true"||get_cfg("linked_psd")!=undefined?"ps_division_name":"",!s||get_cfg("linked_gdn")!=undefined?"godown_name":"",!(b&&get_doctype("po").en_multicurr=="true")?"currency_name":"",get_cfg("en_pur_man")!="true"?"pur_man_id":"",get_doctype("po").en_approval!="true"||!AL.any_access("purchase_order.approve")?"is_approved":""]),r)},form_reset_keys:{},no_alloc:true,ips_options:{rate_sel:"purchase_rate",no_discount:true,validation:g,en_prev_rate:o,ips_exclude:["gross_amount","discount","discount_perc","cl_stock_txt","ref_rate",get_cfg("en_extra_info")!="true"?"extra_info":null,"image"]}},sale_order:{doc_type:"sale_order",head:"Sales Order",model:app.models.SaleOrder,exclude_on_reset:["date"],client_sel:"customer_name",form_schema:{default_attr:d.default_attr,fields:_.omit(d.fields,["invoice_no","so_no","ps_type","godown_name","sale_loc_name","_dnote_attch_cnt",get_cfg("en_salesrep")!="true"?"sales_rep_id":"",get_cfg("en_jobs")!="true"?"job_name":"",get_cfg("en_s_division")!="true"||get_cfg("linked_psd")!=undefined?"ps_division_name":"",!(b&&get_doctype("sor").en_multicurr=="true")?"currency_name":"",get_doctype("sor").en_approval!="true"||!AL.any_access("sale_order.approve")?"is_approved":""])},form_reset_keys:{},no_alloc:true,ips_options:{rate_sel:"sale_rate",no_discount:true,validation:g,en_prev_rate:o,ips_exclude:["gross_amount","discount","discount_perc","cl_stock_txt","ref_rate",get_cfg("en_extra_info")!="true"?"extra_info":null,"image"]}},delivery_note:{doc_type:"delivery_note",head:"Delivery Note",model:app.models.DeliveryNote,exclude_on_reset:["date"],rate_sel:"sale_rate",form_schema:{default_attr:c.default_attr,fields:_.omit(c.fields,[get_doctype("sor").is_enabled=="true"?"po_no":"",get_doctype("sor").is_enabled!="true"?"po_no_cmbx":"",get_doctype("po").en_approval!="true"||!AL.any_access("purchase_order.approve")?"is_approved":"",!s||get_cfg("linked_gdn")!=undefined?"godown_name":"",!(b&&get_doctype("gdn").en_multicurr=="true")?"currency_name":""])},form_reset_keys:{},ips_options:{rate_sel:null,no_discount:true,validation:g,en_prev_rate:false,no_total:true,ips_exclude:["gross_amount","discount","ref_rate","extra_info","discount_perc","rate","amount","image"]}},goods_trans_order:{doc_type:"goods_trans_order",head:"Goods Transfer Order",model:app.models.GTO,exclude_on_reset:["date"],rate_sel:"sale_rate",form_schema:{default_attr:c.default_attr,fields:_.omit(c.fields,["customer_name","godown_name",get_doctype("gto").en_approval!="true"||!AL.any_access("goods_trans_order.approve")?"is_approved":"",!(b&&get_doctype("gdn").en_multicurr=="true")?"currency_name":""])},form_reset_keys:{},ips_options:{rate_sel:"sale_rate",no_discount:true,validation:g,en_prev_rate:false,ips_exclude:["gross_amount","discount","ref_rate","extra_info","discount_perc","rate","amount","image"]}},goods_trans:{doc_type:"goods_trans",head:"Goods Transfer",model:app.models.GT,exclude_on_reset:["date"],rate_sel:"sale_rate",form_schema:{default_attr:h.default_attr,fields:_.omit(h.fields,[get_doctype("gt").en_approval!="true"||!AL.any_access("goods_trans.approve")?"is_approved":""])},form_reset_keys:{},ips_options:{rate_sel:null,no_discount:true,no_total:true,validation:g,en_prev_rate:false,ips_exclude:["gross_amount","discount","ref_rate","extra_info","discount_perc","rate","amount","image"]}},goods_issue:{doc_type:"goods_issue",head:"Goods Issue",model:app.models.GoodsIssue,exclude_on_reset:["date"],rate_sel:null,form_schema:{default_attr:j.default_attr,fields:_.omit(j.fields,["sub_type","supplier_name","order_type","po_no","bt_ref_no","issue_date",!s||get_cfg("linked_gdn")!=undefined?"godown_name":"",get_doctype("gi").en_approval!="true"||!AL.any_access("goods_issue.approve")?"is_approved":"",!(b&&get_doctype("gdn").en_multicurr=="true")?"currency_name":""])},form_reset_keys:{},ips_options:{rate_sel:null,no_total:true,no_discount:true,validation:g,en_prev_rate:false,ips_exclude:["gross_amount","ref_rate","extra_info","discount","discount_perc","rate","amount","image"]}},grn_note:{doc_type:"grn_note",head:"Goods Received Note",model:app.models.GRN,exclude_on_reset:["date"],form_schema:{default_attr:j.default_attr,fields:_.omit(j.fields,[get_doctype("grn").en_approval!="true"||!AL.any_access("grn_note.approve")?"is_approved":"",get_cfg("en_godown")!="true"||get_cfg("linked_gdn")!=undefined?"godown_name":"",!(b&&get_doctype("grn").en_multicurr=="true")?"currency_name":""])},form_reset_keys:{},extra_options:{hide_on_init:["supplier_name","branch_id"]},ips_options:{rate_sel:"purchase_rate",no_discount:true,validation:g,en_prev_rate:false,ips_exclude:["gross_amount","ref_rate","extra_info","discount","discount_perc","cl_stock_txt","image"]}},stock_opening:{doc_type:"stock_opening",head:"Stock Opening",model:app.models.StockOpening,exclude_on_reset:["date"],form_schema:{default_attr:stock_opening.default_attr,fields:_.omit(stock_opening.fields,[get_doctype("so").en_approval!="true"||!AL.any_access("stock_opening.approve")?"is_approved":"",get_cfg("en_godown")!="true"||get_cfg("linked_gdn")!=undefined?"godown_name":""])},form_reset_keys:{},extra_options:{hide_on_init:["date"],no_round_off:true},ips_options:{rate_sel:"purchase_rate",no_discount:true,validation:g,en_prev_rate:false,ips_exclude:["gross_amount","ref_rate","extra_info","discount","discount_perc","cl_stock_txt","image"]}},cust_contract:_.extend({},t,{doc_type:"cust_contract",head:"Customer Contract",model:app.models.CustContract,exclude_on_reset:["date"],rate_sel:null,form_schema:{default_attr:n.default_attr,order_items:true,fields:_.omit(n.fields,["supplier_name",get_doctype("c_cnt").en_approval!="true"||!AL.any_access("cust_contract.approve")?"is_approved":"",!(b&&get_doctype("c_cnt").en_multicurr=="true")?"currency_name":""])},form_reset_keys:{}}),suppl_contract:_.extend({},t,{doc_type:"suppl_contract",head:"Supplier Contract",model:app.models.SupplContract,exclude_on_reset:["date"],rate_sel:null,form_schema:{default_attr:n.default_attr,order_items:true,fields:_.omit(n.fields,["customer_name",get_doctype("s_cnt").en_approval!="true"||!AL.any_access("suppl_contract.approve")?"is_approved":"",!(b&&get_doctype("s_cnt").en_multicurr=="true")?"currency_name":""])},form_reset_keys:{}}),boq:_.extend({},{doc_type:"boq",head:"Bill of Quantity (BOQ)",model:app.models.BOQ,exclude_on_reset:["date"],rate_sel:null,ips_options:{validation:g,en_prev_rate:false,ips_exclude:["gross_amount","ref_rate","extra_info","discount","discount_perc","cl_stock_txt","image"],rate_sel:"sale_rate",no_discount:true,validation:g,en_prev_rate:false},form_schema:{default_attr:e.default_attr,order_items:true,fields:_.omit(e.fields,[!(b&&get_doctype("boq").en_multicurr=="true")?"currency_name":"","boq_vchr_no",get_doctype("boq").en_approval!="true"||!AL.any_access("boq.approve")?"is_approved":""])},form_reset_keys:{}}),boq_variation:_.extend({},{doc_type:"boq_variation",head:"BOQ Variation",model:app.models.BOQ_Variation,exclude_on_reset:["date"],rate_sel:null,ips_options:{rate_sel:null,no_total:true,no_discount:true,validation:g,en_prev_rate:false,ips_exclude:["gross_amount","ref_rate","extra_info","cl_stock_txt","discount","discount_perc","rate","amount","image"]},form_schema:{default_attr:e.default_attr,order_items:true,fields:_.omit(e.fields,[!(b&&get_doctype("boq").en_multicurr=="true")?"currency_name":"",get_doctype("boq_v").en_approval!="true"||!AL.any_access("boq_variation.approve")?"is_approved":""])},form_reset_keys:{},onrender:function(u){console.log(u.form.components.date.get_value())},form_ev_handler2:function(x,v,y,w){var z,u;u=this;z=u.form.components;if((x=="keyup"||x=="value_set")&&v.name=="date"){z.boq_vchr_no.url_args.date=v.get_value()}else{if((x=="item_selected"||x=="keyup")&&v.name=="job_name"){z.boq_vchr_no.url_args.job_name=v.get_value()}}}})};set_objs({ps_popup_configs:a});app.popups.PS_Popup=new (app.Popup.extend({wrap_class:"ps_popup_wrap",save_btn_only:true,show_save_n_next:true,no_close_after_submit:true,id:"ps_popup",events:{"click .op_btn":"submit_form","click .extra_det_btn":"extra_det_clicked"},dont_show_notif:true,beforeInit:function(){return true},extra_det_clicked:function(u){app.popups.ExtraDetPopup.show({invoker:this,method:"set"})},release:function(u){var v=this;if(u){v.form.reset(null,_.union(["print_on_save"],v.exclude_on_reset));v.ip_sheet.release(true);v.ip_sheet.update_total()}else{if(v.form.components){v.form.release()}if(v.ip_sheet.is_rendered){v.ip_sheet.release()}}v.extra_det={}},reset:function(){var u=this;u.form.reset();u.ip_sheet.release(true);u.ip_sheet.update_total();u.extra_det={}},render:function(w,x){var A,C,D,E,v,u,z,y,B;D=this;if(!w){v=D.$el.find(".popup_body");D.form=new app.Form({appendTo:v,class_name:"sp_popup_form"});u=$('<div class="_sidebar"></div>');v.append(u);D.side_form=new app.Form({appendTo:u,fields:{search_key:{type:"inputbox",class_name:"_type2 _mgtp_1em _md _mgbt_05em",label:"Search",dlgTo:"scope"}}});D.side_form.renderInputs();D.listenTo(D.side_form,"all",D.form_ev_handler);D.ds=new app.DS({class_name:"hoverable ds_with_head ds_scrollable",ds_id:"ds_vchr_list",schema:{date:{head_label:"Date",style:"width:35%",index:0},doc_no:{head_label:"Doc No",style:"width:65%",index:0}},model:new app.models.Voucher,default_params:{pagination:false,limit:500},appendTo:u,enable_sorting:true});D.listenTo(D.ds,"all",D.ds_ev_handler);D.ip_sheet=new app.ItemIPS({ips_id:"item_puritemsheet",class_name:"item_ip_sheet _type1",ip_defaults:{class_name:"_sm _type2"},appendTo:v,parent:D});D.$el.find(".popup_body").append('<div class="price_cnt"></div>');D.$el.find(".popup_footer").prepend('<button class="component btn _md _type1 _theme1 float_left extra_det_btn" type="button">Additional Details</button><div class="ip_cnt_left"></div><div class="footer_info_cnt"></div><div class="ip_cnt"><span class="ps_save_status"></span></div>');D.on("after_show",function(){this.ip_sheet.trigger("popup_show")});D.$el.find(".price_cnt").on("focusin focusout","input",function(F,G){D.form.$el.trigger(F,G)});D.listenTo(D.ip_sheet,"all",D.ips_ev_handler);D.listenTo(D.form,"all",D.form_ev_handler)}E=this.options;D.release(x);if(!x){config=a[E.doc_type];_.extend(D,{extra_options:undefined,form_ev_handler2:undefined,extra_item_filter:undefined,onrender:undefined,extensions:undefined},_.pick(config,["doc_type","head","model","client_sel","exclude_on_reset","extra_item_filter","form_reset_keys","no_alloc","extra_options","onrender","form_ev_handler2","extensions"]));if(q.ps_ips_ext){C=q.ps_ips_ext.schema(D,app.sale_purchase_ips_schema)}else{C=app.sale_purchase_ips_schema}_.extend(D.form,{order_items:true},_.pick(config.form_schema,["default_attr","order_items","fields","order_items"]));_.extend(D.ip_sheet,{schema:_.omit(C,config.ips_options.ips_exclude,get_cfg("icode_direct")!="true"?"barcode":null),no_total:false},_.pick(config.ips_options,["validation","rate_sel","no_discount","en_prev_rate","no_total"]));D.set_price_el(D.extra_options&&D.extra_options.no_round_off);D.ip_sheet.render();z=D.form.fields;if(!(D.extra_options&&D.extra_options.no_round_off)){z.round_off.append_to=D.$el.find(".price_cnt_li._round_off")}z._sec1.append_to=D.$el.find(".price_cnt_left");if(z._sec2){z._sec2.append_to=D.$el.find(".price_cnt_left")}y={save_changes:"r",is_draft:"r",print_btn:"l",export_btn:"l",new_btn:"l",clone_btn:"l",hold_btn:"l",unhold_btn:"l",print_on_save:"l"};tmp2=[D.$el.find(".popup_footer .ip_cnt_left"),D.$el.find(".popup_footer .ip_cnt")];for(B in y){z[B].append_to=tmp2[y[B]=="l"?0:1]}D.form.renderInputs()}D.setMode("idle");D.current_tab=null;D.$el.find("._sidebar").hide();D.ip_sheet.$el.removeClass("_two_sided");D.form.components.detail_btn.is_active=false;app.set_docno_field(D.doc_type,D.form);D.fill_data(x)},get_date:function(){return this.form.get_values(null,["date"])["date"]},set_price_el:function(u){this.$el.find(">.popup_body .price_cnt > .price_cnt_innr").remove();if(!u){this.$el.find(".popup_body .price_cnt").append('<div class="price_cnt_innr"><div class="price_cnt_left"></div><div class="price_cnt_right"><span class="price_cnt_li _grosstotal"><span class="price_cnt_label">Gross Total : </span><span class="price_cnt_amount">0.00</span></span><br><span class="price_cnt_li _discount"><span class="price_cnt_label">Discounts : </span><span class="price_cnt_amount">0.00</span></span><br><span class="price_cnt_li _round_off"><span class="price_cnt_label">Round Off : </span></span><br><span class="_total">Net Total : <span>0.00</span></span></div></div>')}else{this.$el.find(".popup_body").append('<div class="price_cnt"><div class="price_cnt_left"></div><div class="price_cnt_right"><span class="_total _total2">Total : <span>0.00</span></span></div></div>')}},get_settle_ref_amount:function(y){var x,v,u,w;v=0;u=0;w=1;if(y.new_ref_data){x=y.new_ref_data;x.total_amount=_.reduce(x.ref_items,function(z,B,A){return z+(Number(B.amount)*(B.dr_cr=="Dr"?1:-1))},0);v=x.total_amount}if(y.ref_data){x=y.ref_data;x.total_amount=_.reduce(_.values(x.ref_items),function(z,B,A){return z+(Number(B.amount)*(B.dr_cr))},0);w=x.dr_cr=x.total_amount>=0?1:-1;x.total_amount=Math.abs(x.total_amount);u=x.total_amount}return Math.abs(v+u*w)},set_form_data:function(B,A,z){var v,x,y;v=this;y=v.form.components;if(!z){x=_.mapObject(B.data,function(C){return C.value})}else{x=B.form_data}v.$el.find(".popup_footer .ip_cnt .ps_save_status").text("");if(A){x=_.pick(x,A)}if(v.options.approval){x.is_approved="true"}if(x.acc_wise_data){x.other_charges=_.reduce(x.acc_wise_data,function(C,D){return C+D.amount},0)}if(x.dnotes_split){x.dnotes=_.map(x.dnotes_split,function(C){return C.voucher_id});x.dnotes_txt=_.map(x.dnotes_split,function(C){return C.doc_no}).join(", ")}if(x.ref_data){x.ref_data={ref_items:x.ref_data}}if(x.new_ref_data){x.new_ref_data={ref_items:x.new_ref_data}}x.settle_ref=v.get_settle_ref_amount(x);v.form.set_values(x);var w,u;u=["customer_name","supplier_name","ps_division_name","godown_name","sale_loc_name","dst_godown_name"];for(w=0;w<u.length;w++){if(y[u[w]]){y[u[w]].emul_itemselect()}}if(y.order_type&&get_cfg("no_pur_wo_po")=="true"){y.order_type.set_value("po");y.order_type.hide()}v.form_ev_handler("focusout",y.date);if(y.sub_type){v.form_ev_handler("changed",y.sub_type)}if(v.doc_type=="grn_note"&&x.sub_type=="bt"){v.form_ev_handler("item_selected",y.branch_id)}if(y.order_type){v.form_ev_handler("changed",y.order_type)}if(y.gi_type){v.form_ev_handler("changed",y.gi_type)}v.update_ps_type();v.toogle_src_type(true);if(!z){v.extra_det=_.pick(x,["uuid","credit_period","shipping_address","dnotes","notes","ref_data","new_ref_data","acc_wise_data"])}else{v.extra_det=_.clone(B.extra_det)}v.ip_sheet.load_data(B.items)},ds_ev_handler:function(A,v,u,y){var D,C,z,B,E,x,w;D=this;E=D.options;if(A=="li_selected"||A=="li_clicked"){if(D.load_timer){clearTimeout(D.load_timer)}if(v==-1){if(E.method=="update"){D.reset(false);if(this.get_req){this.get_req.abort()}_.extend(E,{method:"create",data:null,voucher_id:null});B=D.vchr_backup;D.set_form_data(B,null,true);D.form.hide_comps(["save_changes","is_draft","print_btn","export_btn","clone_btn","new_btn"])}else{return}}else{if(E.method=="create"){D.vchr_backup={form_data:D.form.get_values(),items:D.ip_sheet.get_value_list(),extra_det:D.extra_det};for(x=0;x<D.ip_sheet.rows.length;x++){_.extend(D.vchr_backup.items[x],_.pick(D.ip_sheet.rows[x].data,["unit_data","stock_enabled","is_service","purchase_rate","item_id","sub_id","stock_alloc","cost_alloc","job_alloc"]))}}_.extend(E,{method:"update",data:null,voucher_id:v});D.reset(false);D.load_timer=setTimeout(function(){D.reset(false);D.fill_data(false)},100)}D.setMode("idle");app.set_docno_field(D.doc_type,D.form)}else{if(A=="before_render"){if(E.method=="create"){C=D.form.get_values(null,["doc_no","date"]);v.items.splice(0,0,{id:-1,date:C.date,doc_no:C.doc_no})}for(x=0;x<v.items.length;x++){v.items[x].remark=v.items[x].is_draft?{html:'<span class="draft_vchr">Draft</span>'}:""}}else{if(A=="rendered"){if(E.method=="create"){u.$el.find(".table_list .tl_li:first-child").addClass("_green")}}}}},toogle_src_type:function(x){var u,w,v;u=this;w=u.form.components;if(x&&w.src_type){v=u.doc_type=="invoice"||u.doc_type=="bill";if(v==""){w.src_type.set_value("")}u.form[v==""?"disable":"enable"](["src_type"])}if(w.src_type){v=w.src_type.get_value();u.form[v=="dnote"||v=="grn"?"enable":"disable"](["dnotes_txt","dn_attch_btn"])}},gl_ev_handler:function(v,w){var u;u=this;if(v=="keydown"&&w.keyCode==78&&w.altKey){u.form_ev_handler("clicked",u.form.components.new_btn,null,null);return}return this._gl_ev_handler(v,w)},fill_data:function(v){var x,A,E,B,D,y,w,u,z,C;D=this;E=D.options;B=E.data;C=_.bind(D.form_ev_handler,D);z=D.form.components;if(!v){z.print_on_save.set_value(get_doctype(null,this.doc_type).print_on_save=="true")}D.form[get_cfg("en_holding")=="true"?"show_comps":"hide_comps"](["hold_btn","unhold_btn"]);z.is_draft[get_cfg("en_draft")=="true"?"show":"hide"]();if(E.method=="update"){z.save_changes.set_value("");z.save_changes.show();z.print_btn.show();z.export_btn.show();z.new_btn.show();if(D.extra_options&&D.extra_options.hide_on_init){D.form.hide_comps(D.extra_options.hide_on_init)}if(D.doc_type=="sales_quotation"){z.clone_btn.show()}else{z.clone_btn.hide()}if(B){D.set_form_data(B)}else{if(E.voucher_id){m=new app.models.Voucher;m.set("id",E.voucher_id);if(this.get_req){this.get_req.abort()}this.get_req=m.fetch({success:function(G,F){E.data=F;D.set_form_data(F)}})}}}else{z.save_changes.hide();z.print_btn.hide();z.export_btn.hide();z.new_btn.hide();z.clone_btn.hide();if(D.extra_options&&D.extra_options.hide_on_init){D.form.hide_comps(D.extra_options.hide_on_init)}if(z.order_type&&get_cfg("no_pur_wo_po")=="true"){z.order_type.set_value("po");z.order_type.hide()}if(B){D.set_form_data(B)}u=z.doc_no;w=app.get_new_voucher_date();if(u.disabled){u.set_value()}D.form.set_values(_.extend({},v?null:{date:w},v?null:D.form_reset_keys));D.update_dn();D.update_ps_type();C("focusout",z.date);if(!B){D.extra_det={uuid:uuidv4(),shipping_address:get_cfg("cdet_shipping_address").replace(/<br>/g,"\n")};if(z.sub_type){C("changed",z.sub_type)}if(z.order_type){C("changed",z.order_type)}if(z.gi_type){C("changed",z.gi_type)}D.ip_sheet.insertRow({});D.ip_sheet.update_total();if(get_cfg("use_cash_cust_def")=="true"&&_.in_list(D.doc_type,["invoice","credit_note"])){D.form.set_values({ps_type:"cash",customer_name:"Cash Customer"});z.customer_name.emul_itemselect();C("changed",z.ps_type)}D.toogle_src_type(true)}}if(D.onrender){D.onrender(D)}if(D.extensions){for(ext in D.extensions){if(D.extensions[ext].onrender){D.extensions[ext].onrender(D)}}}},get_total:function(v){var u,w;u=this;w=u.form.components;v.round_off=(w.round_off?Number(w.round_off.get_value()):0)||0;v.other_charges=(w.other_charges?Number(w.other_charges.get_value()):0)||0;if(w.other_discount){v.total_discount+=Number(w.other_discount.get_value())}},after_get_values:function(v){var u;u=this;v.items=u.ip_sheet.get_value_list();_.extend(v,u.extra_det);if(u.options.method=="update"){if(v.save_changes!="true"){app.notifications.add("Info",'Please put check mark on "Save changes" before saving',"info",800);return false}v.voucher_id=v.id=u.options.data.voucher_id}},after_request:function(x,u,w,y){var A,v,z;A=x.responseJSON;v=this;if(u=="success"){app.set_last_no(x);app.notifications.add("Voucher "+(v.options.method=="create"?"created":"updated"),"Voucher has been "+(v.options.method=="create"?"created":"updated")+" successfully","success");v.$el.find(".popup_footer .ip_cnt .ps_save_status").text("Saved on "+(new Date).toDateTimeStr());if($(y.target).hasClass("op_btn_snnx")){v.render(true,true);v.form.focus(v.form.components.detail_btn,"next")}else{if($(y.target).hasClass("op_btn_save")){_.extend(v.options,{method:"update",data:{voucher_id:x.voucher_id},voucher_id:x.voucher_id});v.setMode("idle");z=v.form.components;z.save_changes.set_value("");z.save_changes.show();z.is_draft.hide();z.print_btn.show();z.new_btn.show();if(v.doc_type=="sales_quotation"){z.clone_btn.show()}else{z.clone_btn.hide()}app.set_docno_field(v.doc_type,v.form)}}if(v.ds.$el.is(":visible")){v.ds.load({params:{doc_type:get_doctype(null,v.doc_type).abbr,op:"get_list"}})}if(x.print_html){if(x.has_mlt_fmt){app.utils.show_print_box(x.print_html)}else{app.utils.print_content(x.print_html)}}}else{app.set_docno_field(v.doc_type,v.form);v.toogle_src_type(true)}if(u=="error"&&A&&A.errors&&A.errors.__all__){app.notifications.add("Error",A.errors.__all__,"error")}if(u=="error"&&A&&A.errors&&A.errors.item_errors){this.ip_sheet.renderErrors(null,A.errors.item_errors,{focus_first:true})}},update_ps_type:function(){var u,w,v;u=this;v=u.form.components;w=v.ps_type?v.ps_type.get_value():null;u.$el.find(".price_cnt ._ps_det")[w=="multi"?"show":"hide"]()},update_dn:function(){var w,v,x,z,A,u,B,y,C;C=this;v=this.form.components;if(v.doc_no.disabled){fn=app.generate_doc_no;tmp1=C.doc_type;z=C.options.data;w=v.date.get_value();A={};u={};if(v.ps_type){B=["cash","credit","pettycash","card"];A.ag1=B.indexOf(v.ps_type.get_value())}if(get_cfg("linked_psd_code")){A.DIV=get_cfg("linked_psd_code")}else{if(v.ps_division_name){y=v.ps_division_name.get_selected_data();if(y){A.DIV=y.code}}}tmp2=C.options.method=="create"?fn(tmp1,w,1,true,false,A):z.doc_no;v.doc_no.set_value(tmp2)}},update_total:function(y,v){var u,x,z,w;u=this;z=u.form.components.currency_name;w=z?z.get_value():get_cfg("currency_symbol");x=u.$el.find(".price_cnt");x.find("._grosstotal > .price_cnt_amount").text(to_money(v.gross_total));x.find("._discount > .price_cnt_amount").text(to_money(v.total_discount));x.find("._total > span").text(w+" "+to_money(v.gross_total-v.total_discount+v.other_charges+v.round_off))},load_so_items:function(){var w,x,u,v,y;v=this;y=v.form.components;w=y.po_no.get_selected_data();if(!w){return}if((v.doc_type=="invoice"&&(w.status=="prd"||w.status=="dv"))||(v.doc_type=="delivery_note"&&w.status=="dv")){return}if(w&&w.voucher_id){x=(new app.models.SaleOrder);x.fetch({data:$.param({op:"get_remaining_items",voucher_id:w.voucher_id}),success:function(A,z){v.ip_sheet.release(true);v.ip_sheet.load_data(z.items)},error:function(z,A){app.notifications.add("Error","Error while loading data","error")}})}},load_po_items:function(){var x,y,u,v,z,w;v=this;z=v.form.components;w=v.options;x=z.po_no.get_selected_data();if(!x){z.po_no.render_error("This field is required");return}if((v.doc_type=="bill"&&(x.status=="prd"||x.status=="dv"))||(v.doc_type=="grn_note"&&x.status=="dv")){return}if(x){y=(new app.models.PurchaseOrder);y.fetch({data:$.param({op:"get_remaining_items",voucher_id:x.voucher_id,excl_vchr_id:w.method=="update"?w.data.voucher_id:null}),success:function(B,A){v.ip_sheet.release(true);v.ip_sheet.load_data(A.items)},error:function(A,B){app.notifications.add("Error","Error while loading data","error")}})}},attach_dnote_callback:function(w){var B,v,u,z,C,y,A,x,D;B={};D=this;z=D.form.components;D.extra_det.dnotes=_.map(w,function(F,E){return F.voucher_id});z.dnotes_txt.set_value(_.map(w,function(F,E){return F.doc_no}).join(", "));for(C in w){v=w[C];for(y=0,A=v.item_data.length;y<A;y++){u=v.item_data[y];if(B[u.item_id]){B[u.item_id].quantity+=u.quantity}else{B[u.item_id]=_.clone(u)}}}D.ip_sheet.release(true);D.ip_sheet.load_data(_.values(B))},show_adj_popup:function(){var v,z,y,u,x,w;u=this;x=u.form.components;if(x.customer_name){v=x.customer_name.get_value()}else{if(x.supplier_name){v=x.supplier_name.get_value()}}y={account_name:v,negate_due:_.in_list(u.doc_type,["invoice","debit_note"])?true:false,to_date:x.date.get_value(),ref_type:"adv",unresolved:true,calculate_total:true};if(u.options.method=="update"){y.ignore_unresolved_from=u.options.data.voucher_id}w=u.ip_sheet.get_total();app.popups.RefAdj.show({method:"set",scope:this,amount:(w.gross_total-w.total_discount+w.other_charges+w.round_off)*(y.negate_due?1:-1),params:y,exct_amount:true,data:{ref_data:u.extra_det.ref_data,new_ref_data:u.extra_det.new_ref_data},callback:function(B){var A;u.extra_det.ref_data=B.ref_data;u.extra_det.new_ref_data=B.new_ref_data;u.form.components.settle_ref.set_value(B.total_amount*(_.in_list(u.doc_type,["invoice","debit_note"])?1:-1))}})},hold_clicked:function(y){var w=this,v,u;var x={form_data:w.form.get_values(),items:w.ip_sheet.get_value_list(),extra_det:w.extra_det,options:_.pick(w.options,["method"])};if(x.items.length==1&&x.items[0].item_code==""){app.notifications.add("Info","No Items are added please add some items","info");return}for(i=0;i<w.ip_sheet.rows.length;i++){_.extend(x.items[i],_.pick(w.ip_sheet.rows[i].data,["unit_data","stock_enabled","is_service","purchase_rate","item_id","sub_id","stock_alloc","cost_alloc","job_alloc"]))}if(w.options.method=="update"){x.options.data={voucher_id:w.options.data.voucher_id};x.options.voucher_id=w.options.data.voucher_id}v=localStorage.getItem("holded_data");if(!v){v={}}else{v=JSON.parse(v)}if(!v[w.doc_type]){v[w.doc_type]=[]}u=v[w.doc_type];u.push(x);localStorage.setItem("holded_data",JSON.stringify(v));w.form_ev_handler("clicked",w.form.components.new_btn,null,null);app.notifications.add("Info","Voucher put under hold","success")},restore_clicked:function(w){var v,u;v=this;if(v.ip_sheet.rows[0].cols.item_code.ip.get_value()!=""){app.notifications.add("Alert","There are items added in your current voucher, please save or clear it to restore vouchers","info");return}u=localStorage.getItem("holded_data");u=JSON.parse(u);if(!u||_.isEmpty(u[v.doc_type])){app.notifications.add("Info","There are currently no holded vouchers","info");return}app.popups.RestoreHolded.show({method:"set",doc_type:v.doc_type,invoker:v,callback:function(y,z,x){var x;v.options=z.options;v.reset();v.set_form_data(z,null,true);holded_vchrs=x[v.doc_type];holded_vchrs.splice(y,1);localStorage.setItem("holded_data",JSON.stringify(x))}})},form_ev_handler:function(C,z,B,G){var y,D,x,A,E,w,v,u,F;F=this;y=this.form.components;switch(C){case"keydown":if(z.name=="search_key"){if(_.in_list(B.keyCode,[38,40,13])){F.ds.gl_ev_handler("keydown",B)}else{if(B.keyCode==27){this.form_ev_handler("clicked",y.detail_btn);this.ip_sheet.focusRow(0)}}}else{if(z.name=="dnotes_txt"){if(B.keyCode!=37&&B.keyCode!=39){B.preventDefault()}}}break;case"keyup":if(z.name=="date"){this.update_dn()}else{if(z.name=="round_off"){this.ip_sheet.update_total()}else{if(z.name=="other_discount_perc"){x=this.ip_sheet.get_total();y.other_discount.set_value(Number(z.get_value())*x.gross_total/100);this.ip_sheet.update_total()}else{if(z.name=="other_discount"){this.ip_sheet.update_total()}else{if(z.name=="search_key"){if(!_.in_list(B.keyCode,[38,37,39,40,13])){F.ds.load({params:{doc_type:get_doctype(null,this.doc_type).abbr,op:"get_list",search_key:z.get_value()}})}}else{if(z.name=="customer_name"&&!_.in_list(B.keyCode,[13,9,16])){if(y.po_no){y.po_no.disable()}}else{if(z.name=="po_no"){F.toogle_src_type(true)}}}}}}}if(B.keyCode==0&&y.job_name&&z.name=="customer_name"){y.job_name.url_args.cust_name=""}if(B.keyCode==13&&(z.type!="combobox"||!z.menu_open)){if(window.browser!="firefox"&&z.type=="selectbox"){return}x=this.form.get_next(z);if(x){if(z.name!="search_key"&&x.name!="round_off"){x.focus()}}else{if(this.ip_sheet.rows.length){this.ip_sheet.focusRow(0)}}}break;case"focusout":if(z.name=="date"){x=z.get_value();w=y.currency_name;if(!parse_date(x)){z.render_error("Invalid Date");return}if(w){w.url_args={date:x}}}break;case"clicked":if(z.name=="detail_btn"){tmp=z.get_value();if(z.is_active){F.$el.find("._sidebar").hide();F.ip_sheet.$el.removeClass("_two_sided")}else{F.$el.find("._sidebar").show();F.ip_sheet.$el.addClass("_two_sided");F.ds.$el.find(".ds_container").css({height:this.ip_sheet.$el.height()-this.side_form.$el.outerHeight(true)-20});F.ds.load({params:{doc_type:get_doctype(null,F.doc_type).abbr,op:"get_list"}})}z.set_label(z.is_active?">":"<");z.is_active=!z.is_active}else{if(z.name=="other_charge_btn"){app.popups.AccountWisePopup.show({method:"set",invoker:this,data:this.extra_det.acc_wise_data,callback:function(I,H){this.extra_det.acc_wise_data=I;this.form.components.other_charges.set_value(H);this.ip_sheet.update_total()}})}else{if(z.name=="settle_ref_btn"){F.show_adj_popup()}else{if(z.name=="print_btn"){F.print_data(F.options.data)}else{if(z.name=="export_btn"){$("#myiframwe").attr("src",app.generate_ext_url("vouchers",F.options.data.voucher_id,{op:"export_to_excel"}))}else{if(z.name=="new_btn"){_.extend(F.options,{method:"create",data:null,voucher_id:null});F.release(true);F.fill_data(false);F.setMode("idle");app.set_docno_field(F.doc_type,F.form);if(F.ds.$el.is(":visible")){F.ds.load({params:{doc_type:get_doctype(null,F.doc_type).abbr,op:"get_list"}})}setTimeout(function(){F.form.focus()},100)}else{if(z.name=="clone_btn"){_.extend(F.options,{method:"create",voucher_id:null});_.each(F.options.data.items,function(I,H){I.image=""});F.release(true);F.fill_data(false);F.setMode("idle");app.set_docno_field(F.doc_type,F.form);F.form.components.date.focus();if(F.ds.$el.is(":visible")){F.ds.load({params:{doc_type:get_doctype(null,F.doc_type).abbr,op:"get_list"}})}}else{if(z.name=="hold_btn"){F.hold_clicked(B)}else{if(z.name=="unhold_btn"){F.restore_clicked(B)}else{if(z.name=="dn_attch_btn"){if(((y.order_type&&y.order_type.get_value()=="po"))&&y.po_no.get_value()==""){y.po_no.render_error("This field is required").focus();return}tmp={date:y.date.get_value()};if(y.po_no&&y.po_no.get_value()){tmp.po_no=y.po_no.get_value()}if(y.supplier_name){tmp.supplier_name=y.supplier_name.get_value();tmp.inc_adv_suppl=true}if(y.customer_name){tmp.customer_name=y.customer_name.get_value()}app.popups.AttachDNote.show({invoker:F,method:"set",dtype:F.doc_type,dnotes:F.extra_det.dnotes,data:tmp,callback:F.attach_dnote_callback})}}}}}}}}}}break;case"changed":if(z.name=="sub_type"){if(F.doc_type=="grn_note"){x=z.get_value();F.ip_sheet.release();config=a.grn_note;_.extend(F.ip_sheet,{schema:_.omit(app.sale_purchase_ips_schema,config.ips_options.ips_exclude,null)},_.pick(config.ips_options,["validation","rate_sel","no_discount","en_prev_rate"]));F.ip_sheet.render();if(B){F.ip_sheet.insertRow({})}if(F.options.method=="create"){y.bt_ref_no.disable()}y.issue_date.disable();y.supplier_name[x=="op"?"show":"hide"]();y.branch_id[x=="bt"?"show":"hide"]();y.bt_ref_no[x=="bt"?"show":"hide"]();y.issue_date[x=="bt"?"show":"hide"]();y.order_type[x=="op"?"show":"hide"]();if(F.options.method=="update"){y.po_no[y.order_type.get_value()=="po"?"show":"hide"]()}else{y.po_no["hide"]()}}}else{if(z.name=="order_type"){y.po_no[z.get_value()=="po"?"show":"hide"]()}else{if(z.name=="ps_type"){this.update_dn();this.update_ps_type()}else{if(z.name=="src_type"){F.toogle_src_type(false);if(z.get_value()!="dnote"){y.dnotes_txt.set_value("")}if(get_doctype("sor").is_enabled=="true"&&z.get_value()=="dr"){if(F.doc_type=="delivery_note"||F.doc_type=="invoice"){this.load_so_items()}else{if(F.doc_type=="grn_note"||F.doc_type=="bill"){this.load_po_items()}}}}}}}if(window.browser!="firefox"&&B){x=this.form.get_next(z);if(x){x.focus()}}break;case"item_selected":if(y.job_name&&z.name=="customer_name"){y.job_name.url_args.cust_name=z.get_value()}if(z.name=="customer_name"){edet=this.extra_det=this.extra_det||{};x=z.get_selected_data();if(B){edet.credit_period=x.credit_period}if(B&&y.sales_rep_id){y.sales_rep_id.set_value([x.sales_rep_id,x.sales_rep_name])}if(y.po_no){y.po_no.enable();y.po_no.url_args={cname:x.name}}}else{if(z.name=="supplier_name"){edet=this.extra_det||{};x=z.get_selected_data();if(B){edet.credit_period=x.credit_period}this.extra_det=edet}else{if(z.name=="invoice_no"){tmp=z.get_selected_data();this.form.set_values(_.pick(tmp,["customer_name","sales_rep_id","ps_division_name"]))}else{if(z.name=="ps_division_name"){F.update_dn()}else{if(z.name=="sale_loc_name"){tmp=z.get_selected_data();if(y.godown_name&&B&&tmp.godown_name){y.godown_name.set_value(tmp.godown_name)}}else{if(z.name=="currency_name"){F.ip_sheet.update_total()}else{if(z.name=="branch_id"&&F.doc_type=="grn_note"){y.bt_ref_no.enable();y.bt_ref_no.url_args={branch_id:z.get_value()}}else{if(z.name=="bt_ref_no"){x=z.get_selected_data();w=new app.models.GRN;w.fetch({data:$.param({op:"load_goods_issue_items",voucher_id:x.voucher_id,branch_com_id:x.branch_com_id}),success:function(I,H){F.form.components.issue_date.set_value(H.date);F.ip_sheet.release(true);F.ip_sheet.set_height();F.ip_sheet.load_data(H.items)},error:function(H,I){if(I.responseJSON&&I.responseJSON.errors&&I.responseJSON.errors.__all__){app.notifications.add("Error",I.responseJSON.errors.__all__,"error")}}})}else{if(z.name=="po_no"){this.toogle_src_type(true);if(!y.src_type||y.src_type.get_value()=="dr"){if(F.doc_type=="delivery_note"||F.doc_type=="invoice"){this.load_so_items()}else{if(F.doc_type=="grn_note"){this.load_po_items()}}}}}}}}}}}}if(!B){return}x=this.form.get_next(z);if(x&&x.name!="round_off"){setTimeout(function(){x.focus()},100)}else{setTimeout(function(){F.ip_sheet.focusRow(0)},100)}break;case"add_new_clicked":case"det_btn_clicked":u={customer_name:"cust",supplier_name:"vndr"};if(_.in_list(z.name,["customer_name","supplier_name"])){if(C=="add_new_clicked"){x={name:z.get_value(true),is_debcred:"true",m_type:u[z.name]};w=null}else{w=z.get_selected_data();if(w){w=w.id}if(w){x={is_debcred:"true",m_type:u[z.name]}}else{x=null}}if(x){app.popups.CustVendPopup.show({method:C=="add_new_clicked"?"create":"update",invoker:this,id:w,hide_cont_btn:true,m_type:u[z.name],data:x,callback:function(I,H){z.set_value(H.name);z.emul_itemselect();if(C=="det_btn_clicked"){setTimeout(function(){z.input_el.focus()},500)}}})}}else{if(z.name=="sales_rep_id"){app.popups.AccountPopup.show({method:"create",is_cntlacc:false,hide_cont_btn:true,disable_subacc:true,data:{name:z.get_value(true),subacc_of_defacc:"market_exec_pybl",is_cntlacc:false},invoker:this,callback:function(I,H){z.set_value([H.id,H.name]);z.data={items:[{id:H.id,name:H.name,c_balance:0}]};setTimeout(function(){params.comp.focus()},800)}})}else{if(z.name=="pur_man_id"){app.popups.Employee.show({method:"create",invoker:this,hide_cont_btn:true,callback:function(I,H){z.set_value([H.id,H.name]);z.data={items:[{id:H.id,name:H.name}]};setTimeout(function(){params.comp.focus()},800)}})}else{if(z.name=="invoice_no"){app.popups.COMP_VAL.show({method:"set",invoker:this,val:z.get_value(true),comp:z,pp_type:"new_ref",head:"Ref No"})}else{if(z.name=="po_no"){app.popups.COMP_VAL.show({method:"set",invoker:this,val:z.get_value(true),comp:z,pp_type:"po_no",head:"P/O No"})}else{if(z.name=="so_no"){app.popups.COMP_VAL.show({method:"set",invoker:this,val:z.get_value(true),comp:z,pp_type:"so_no",head:"S/O No"})}}}}}}break}if(F.form_ev_handler2){F.form_ev_handler2.apply(F,arguments)}if(F.extensions){for(ext in F.extensions){if(F.extensions[ext].form_ev_handler2){F.extensions[ext].form_ev_handler2.apply(F,arguments)}}}},print_data:function(w){var u,v;u=this;v=new app.models.Voucher;v.set({id:w.voucher_id});v.fetch({data:$.param({op:"print_preview"}),success:function(y,x){if(x.has_mlt_fmt){app.utils.show_print_box(x.print_html)}else{app.utils.print_content(x.print_html)}},error:function(x,y){app.notifications.add("Print Failed","Unable to print Voucher","error")}})},ips_ev_handler:function(v,x,u,w){return this.ip_sheet.ips_ev_handler.apply(this.ip_sheet,arguments)}}))();set_objs({invoice_popup:app.popups.PS_Popup,bill_popup:app.popups.PS_Popup});FB_Module.init_fn(function(){app.SideMenu.add_item({item_id:"vouchers_cnt",label:"Voucher Registers",index:5.5,is_disabled:!AL.any_access(["invoice.list","bill.list"])});app.SideMenu.add_item({view:"invoices",item_id:"invoice_reports",index:4,under:"vouchers_cnt",label:"Sales/Invoice",replace:true,is_disabled:!AL.any_access("invoice.list")});app.SideMenu.add_item({view:"bills",item_id:"trans_reports",index:5,under:"vouchers_cnt",label:"Purchase/Bill",replace:true,is_disabled:!AL.any_access("bill.list")});app.SideMenu.add_item({item_id:"accvouchers_cnt",label:"New Voucher",index:4,is_disabled:!AL.any_access(["bill.create","invoice.create"])});app.SideMenu.add_item({item_id:"invoice",under:"accvouchers_cnt",label:"Sale/Invoice",index:10,is_disabled:!AL.any_access("invoice.create")||get_doctype("iv").is_enabled!="true",callback:function(){app.popups.PS_Popup.show({method:"create",doc_type:"invoice"})}});app.SideMenu.add_item({item_id:"bill",under:"accvouchers_cnt",label:"Purchase/Bill",index:20,is_disabled:!AL.any_access("bill.create")||get_doctype("bl").is_enabled!="true",callback:function(){app.popups.PS_Popup.show({method:"create",doc_type:"bill"})}});app.SideMenu.add_item({item_id:"credit_note",under:"accvouchers_cnt",label:"Credit Note/Sale Return",index:22,is_disabled:!AL.any_access("credit_note.create")||get_doctype("cn").is_enabled!="true",callback:function(){app.popups.PS_Popup.show({method:"create",doc_type:"credit_note"})}});app.SideMenu.add_item({item_id:"debit_note",under:"accvouchers_cnt",label:"Debit Note/Purchase Return",index:24,is_disabled:!AL.any_access("debit_note.create")||get_doctype("dn").is_enabled!="true",callback:function(){app.popups.PS_Popup.show({method:"create",doc_type:"debit_note"})}});app.SideMenu.add_item({item_id:"sales_quotation",under:"accvouchers_cnt",label:"Sales Quotation",index:40,is_disabled:!AL.any_access("sales_quotation.create")||get_doctype("sq").is_enabled!="true",callback:function(){app.popups.PS_Popup.show({method:"create",doc_type:"sales_quotation"})}});app.SideMenu.add_item({item_id:"profoma_invoice",under:"accvouchers_cnt",label:"Profoma Invoice",index:40,is_disabled:!AL.any_access("profoma_invoice.create")||get_doctype("prf").is_enabled!="true",callback:function(){app.popups.PS_Popup.show({method:"create",doc_type:"profoma_invoice"})}});app.SideMenu.add_item({item_id:"purchase_order",under:"accvouchers_cnt",label:"Purchase Order",index:40,is_disabled:!AL.any_access("purchase_order.create")||get_doctype("po").is_enabled!="true",callback:function(){app.popups.PS_Popup.show({method:"create",doc_type:"purchase_order"})}});app.SideMenu.add_item({item_id:"sale_order",under:"accvouchers_cnt",label:"Sales Order",index:40,is_disabled:!AL.any_access("sale_order.create")||get_doctype("sor").is_enabled!="true",callback:function(){app.popups.PS_Popup.show({method:"create",doc_type:"sale_order"})}});app.SideMenu.add_item({item_id:"delivery_note",under:"accvouchers_cnt",label:"Delivery Note",index:45,is_disabled:!AL.any_access("delivery_note.create")||get_doctype("gdn").is_enabled!="true",callback:function(){app.popups.PS_Popup.show({method:"create",doc_type:"delivery_note"})}});app.SideMenu.add_item({item_id:"grn_note",under:"accvouchers_cnt",label:"Goods Received Note (GRN)",index:50,is_disabled:!AL.any_access("grn_note.create")||get_doctype("grn").is_enabled!="true",callback:function(){app.popups.PS_Popup.show({method:"create",doc_type:"grn_note"})}});app.SideMenu.add_item({item_id:"goods_issue",under:"accvouchers_cnt",label:"Goods Issue",index:55,is_disabled:!AL.any_access("goods_issue.create")||get_doctype("gi").is_enabled!="true",callback:function(){app.popups.PS_Popup.show({method:"create",doc_type:"goods_issue"})}});app.SideMenu.add_item({item_id:"gto",under:"accvouchers_cnt",label:"Goods Transfer Order",index:60,is_disabled:!AL.any_access("goods_trans_order.create")||get_doctype("gto").is_enabled!="true",callback:function(){app.popups.PS_Popup.show({method:"create",doc_type:"goods_trans_order"})}});if(get_cfg("en_godown")=="true"){app.SideMenu.add_item({item_id:"gtr",under:"accvouchers_cnt",label:"Goods Transfer",index:60,is_disabled:!AL.any_access("goods_trans.create")||get_doctype("gt").is_enabled!="true",callback:function(){app.popups.PS_Popup.show({method:"create",doc_type:"goods_trans"})}})}if(get_cfg("en_contract")=="true"){app.SideMenu.add_item({item_id:"new_cust_contract",under:"accvouchers_cnt",label:"Customer Contract",index:60,is_disabled:!AL.any_access("cust_contract.create")||get_doctype("c_cnt").is_enabled!="true",callback:function(){app.popups.PS_Popup.show({method:"create",doc_type:"cust_contract"})}});app.SideMenu.add_item({item_id:"new_suppl_contract",under:"accvouchers_cnt",label:"Supplier Contract",index:60,is_disabled:!AL.any_access("suppl_contract.create")||get_doctype("s_cnt").is_enabled!="true",callback:function(){app.popups.PS_Popup.show({method:"create",doc_type:"suppl_contract"})}})}app.SideMenu.add_item({item_id:"boq",under:"accvouchers_cnt",label:"BOQ",index:60,is_disabled:!AL.any_access("boq.create")||get_doctype("boq").is_enabled!="true",callback:function(){app.popups.PS_Popup.show({method:"create",doc_type:"boq"})}});app.SideMenu.add_item({item_id:"boq_variation",under:"accvouchers_cnt",label:"BOQ Variation",index:60,is_disabled:!AL.any_access("boq_variation.create")||get_doctype("boq_v").is_enabled!="true",callback:function(){app.popups.PS_Popup.show({method:"create",doc_type:"boq_variation"})}})})});FB_Module.register({index:2},function(){var c={default_attr:{class_name:"_type1 _sm2 _comp_inline _mgrt_1em"},fields:{doc_no:{type:"inputbox",id:"_w10em _mgtp_3x",label:"Doc No"},date:{type:"datefield",id:"_w7em _mgtp_2x",label:"Date"},narration:{type:"inputbox",id:"_w30em _mgtp_2x",label:"Narration"}},validation:{}};var b={fields:{doc_no:{head_label:"Inv #",width:"120px",index:0},date:{head_label:"Date",width:"95px",index:0},particulars:{head_label:"Particulars",width:"65%",index:0,url:"/items/?name={{value}}&pagination=false",list_selector:"items",label_sel:"name"},narration:{head_label:"Narration",width:"35%",index:0},amount:{head_label:"Amount",type:"money",width:"100px",align:"right",index:0,prefix:app.appdata.currency_symbol}},show_items:["doc_no","date","particulars","narration","amount"],filter_enable:["doc_no","date","particulars","narration"]};var a={};app.popups.StockJournal=new (app.Popup.extend({id:"stock_journal_popup",wrap_class:"ps_popup_wrap",doc_type:"stock_journal",head:"Stock Journal",show_save_n_next:true,model:app.models.StockJournal,events:{"click .op_btn":"submit_form","click .extra_det_btn":"extra_det_clicked"},beforeInit:function(){return true},reset:function(){var d=this;d.form.reset();d.ow_ip_sheet.release(true);d.iw_ip_sheet.release(true);d.update_total()},set_price_el:function(){this.$el.find(".popup_body").append('<div class="price_cnt"><div class="price_cnt_left"><span class="_total _total2">Total : <span>0.00</span></div><div class="price_cnt_right"><span class="_total _total2">Total : <span>0.00</span></span></div></div>')},render:function(h){var k,d,f,j;f=this;if(!h){f.form=new app.Form(_.extend({appendTo:f.$el.find(".popup_body"),class_name:"sp_popup_form"},c));f.form.renderInputs();j=$("<div></div>");f.$el.find(".popup_body").append(j);d={class_name:"item_ip_sheet _type1",ip_defaults:{class_name:"_sm _type2"},appendTo:j,no_discount:true,validation:a,parent:f};f.ow_ip_sheet=new app.ItemIPS(_.extend({head:"Source (Consumption)",ips_id:"sjr_owitemsheet",alter_total:true,rate_sel:"sale_rate",schema:_.omit(app.sale_purchase_ips_schema,["sl_no","discount","cl_stock_txt","discount_perc","gross_amount","image","tax","ref_rate","extra_info"],get_cfg("icode_direct")!="true"?"barcode":null)},d));f.iw_ip_sheet=new app.ItemIPS(_.extend({head:"Destination (Production)",ips_id:"sjr_iwitemsheet",check_cl_stock:true,alter_total:true,rate_sel:"purchase_rate",schema:_.omit(app.sale_purchase_ips_schema,["sl_no","discount","cl_stock_txt","discount_perc","tax","image","gross_amount","ref_rate","extra_info"],get_cfg("icode_direct")!="true"?"barcode":null)},d));f.set_price_el();f.iw_ip_sheet.render();f.ow_ip_sheet.render();f.on("after_show",function(){f.ow_ip_sheet.trigger("popup_show",null,null,null,{callback:function(l){f.ow_ip_sheet.$el.find(".table_listcnt").css(l);f.iw_ip_sheet.$el.find(".table_listcnt").css(l)},ips_list:[f.ow_ip_sheet,f.iw_ip_sheet]});f.iw_ip_sheet.trigger("popup_show",null,null,null,{callback:function(){}})});f.listenTo(f.ow_ip_sheet,"all",f.ow_ip_sheet_handler);f.listenTo(f.iw_ip_sheet,"all",f.iw_ip_sheet_handler);f.listenTo(f.form,"all",f.form_ev_handler)}k=f.options.data;f.setMode("idle");f.current_tab=null;f.reset();app.set_docno_field(f.doc_type,f.form);var g,e;if(f.options.method=="update"){tmp=_.mapObject(k.data,function(l){return l.value});f.form.set_values(tmp);f.iw_ip_sheet.load_data(k.iw_items);f.ow_ip_sheet.load_data(k.ow_items)}else{tmp2=f.form.components.doc_no;tmp1=app.get_new_voucher_date();if(tmp2.disabled){tmp2.set_value()}f.iw_ip_sheet.insertRow({});f.ow_ip_sheet.insertRow({});f.form.reset(null,["doc_no"]);f.form.set_values({doc_no:app.generate_doc_no(this.doc_type,tmp1,1,true),date:tmp1})}},after_get_values:function(d){d.ow_items=this.ow_ip_sheet.get_value_list();d.iw_items=this.iw_ip_sheet.get_value_list();d.en_godown=get_cfg("en_godown");_.extend(d,this.extra_det);if(this.options.method=="update"){d.voucher_id=d.id=this.options.data.voucher_id}},get_date:function(){return this.form.get_values(null,["date"])["date"]},update_total:function(g,e){var d,f,h;d=this;h=d.form.components.currency_name;currency_prefix=h?h.get_value():get_cfg("currency_symbol");if(!e){e={gross_total:0};f=d.$el.find(".price_cnt")}else{f=d.$el.find(g.ips_id=="sjr_owitemsheet"?".price_cnt_left":".price_cnt_right")}f.find("._total > span").text(currency_prefix+" "+to_money(e.gross_total))},iw_ip_sheet_handler:function(h,g,f,k,m){var l,d,j;j=this.iw_ip_sheet;return j.ips_ev_handler.apply(j,arguments)},ow_ip_sheet_handler:function(l,k,d,j,g){var n,h,m,f;m=this.ow_ip_sheet;n=m.rows[k];switch(l){case"cogs_callback":f=n.extra_values;if(f.cogs_rate){n.cols.rate.ip.set_value(f.cogs_rate);m.set_price(n,"rate");m.update_total()}break}return m.ips_ev_handler.apply(m,arguments)},after_request:function(g,j,m,k){var d,f,h,n,l;n=this;f=g.responseJSON;if(j=="success"){if($(k.target).hasClass("op_btn_snnx")){n.render(true);n.form.components.date.focus()}}else{d=["iw_item_errors","ow_item_errors"];h=[n.iw_ip_sheet,n.ow_ip_sheet];if(j=="error"&&f&&f.errors){for(i=0;i<d.length;i++){if(f.errors[d[i]]){h[i].renderErrors(null,f.errors[d[i]])}}l=f.errors.__all__;return false}else{if(j=="error"){l="Error while saving data"}}if(l){app.notifications.add("Error",l,"error")}}},form_ev_handler:function(f,d,g){},ips_event_handler:function(f,h,d,g){}}))();app.p_views.StockJournal=app.ListPageTemplate.extend({page_name:"stock_journals",model:app.models.StockJournal,disable_menu:true,no_newbtn:true,ds_options:{idAttr:"voucher_id",head:"Stock Journal Register",class_name:"hoverable ds_with_head",ds_id:"stockjournal_ds",flex_schema:b,has_filter:true},header_btns:[],popup:app.popups.StockJournal,drill_to_view:"voucher",heading_plural:"Stock Journal Register",edit_voucher:function(d,e){this.popup.show({method:"update",invoker:this,callback:e,data:d})},render_voucher:function(f,g){var e,d;e=get_obj("vchr_item_ds_schema");if(f.ow_items){d=g.item_ds;d.flex_schema={fields:e.fields,show_items:_.without(e.show_items,"inv_q","description","gross_amount","discount")};d.rows=!_.isEmpty(f.ow_items)?f.ow_items:[{}];d.$el.show();d.render()}else{d.$el.hide()}if(f.iw_items){d=item_ds2;item_ds2.flex_schema={fields:e.fields,show_items:_.without(e.show_items,"inv_q","description","gross_amount","discount")};item_ds2.rows=!_.isEmpty(f.iw_items)?f.iw_items:[{}];item_ds2.$el.show();item_ds2.render()}},initialize:function(){this.init({create_el:true})}});FB_Module.init_fn(function(){app.SideMenu.add_item({item_id:"vouchers_cnt",label:"Voucher Registers",index:5,is_disabled:!AL.any_access("stock_journal.list")});app.SideMenu.add_item({view:"stock_journals",item_id:"stock_journals",index:70,under:"vouchers_cnt",label:"Stock Journal Register",is_disabled:!AL.any_access("stock_journal.list")});app.SideMenu.add_item({item_id:"accvouchers_cnt",label:"New Voucher",index:4,is_disabled:!AL.any_access(["stock_journal.create"])});app.SideMenu.add_item({item_id:"stock_journal",under:"accvouchers_cnt",label:"Stock Journal",index:70,is_disabled:!AL.any_access("stock_journal.create"),callback:function(){app.popups.StockJournal.show({method:"create"})}})})});FB_Module.register({index:2},function(){if(get_cfg("working_mode")=="trade"){return}var b={default_attr:{class_name:"_sm2 _type1 _comp_inline _mgrt_1em"},fields:{doc_no:{type:"inputbox",label:"Vchr No",id:"_w9em",dlgTo:"scope"},date:{type:"datefield",name:"date",label:"Date",id:"_w9em",dlgTo:"scope"},ref_no:{type:"inputbox",label:"Ref No",id:"_w9em",dlgTo:"scope"},customer_name:{type:"combobox",id:"_w25em",label:"Customer",index:60,url:"/cust_n_vendor/customers/?name={{value}}&cust_type=contr&pagination=false",new_item_btn:true,dlgTo:"scope",en_search_by:"customer_schema",root_url:"/cust_n_vendor/customers/",en_search_by:"customer_schema",root_url:"/cust_n_vendor/customers/"},subcontractor_name:{type:"combobox",id:"_w25em",label:"Sub Contractor",index:60,url:"/cust_n_vendor/subcontr/?name={{value}}&pagination=false",new_item_btn:true,dlgTo:"scope",root_url:"/cust_n_vendor/subcontr/",en_search_by:"customer_schema"},job_name:{type:"combobox",label:"Job ID",id:"_w15em",url:"/jobs/?name={{value}}&pagination=false&is_group=false",dlgTo:"scope",label_sel:"name",value_sel:"name"},retention:{type:"inputbox",label:"Retention",id:"_w9em _mgbt_1em ",thousand_sep:true,dlgTo:"scope"},adv_recovered:{type:"inputbox",label:"Advance Recovered",id:"_w9em _mgbt_1em ",thousand_sep:true,dlgTo:"scope"},description:{type:"inputbox",label:"Description :",class_name:"_sm2 _pdlt_6em _w30em _type4",id:"",dlgTo:"scope"},print_btn:{type:"button",id:"float_left _theme1 _w6em",label:"Print",index:100,dlgTo:"scope"}},validation:{date:{required:true}}};var a={account_name:{required:true},amount:{type:"number",required:true}};var f={account_name:{head_label:"Account Name",width:56,index:10,ip_options:{type:"combobox",id:"jpp_accname",label:"Account Name",url:"/accounts/?name={{value}}&is_cntlacc=false&pagination=false&no_genfields=true&_select_fields=id,name,c_balance,acc_type,acc_type_txt2,cost_appl,sub_key",use_local:true,info_sel:"acc_type_txt2",new_item_btn:true,handle_events:["paste"],dlgTo:"scope"}},sub_narration:{head_label:"Remarks",width:30,index:12,ip_options:{type:"inputbox",label:"Remarks",id:"",dlgTo:"scope"}},amount:{head_label:"Amount",width:15,index:20,ip_options:{type:"inputbox",id:"_ralign",label:"Amount",dlgTo:"scope",thousand_sep:true,calc_exp:true}}};var e={beforeInit:function(){this.on("after_show",this.after_show);return true},after_show:function(){var h=this;h.set_colhead_padding();h.set_height();h.set_max_height();h.center()},set_height:function(){var h,i;h=this.$el.find("._ipsheet_cnt");i=$(window).height()-(this.$el.outerHeight()-h.outerHeight())-30;h.css({height:i})},set_max_height:function(){var i,j,h;h=this;i=h.ip_sheet.$el.find(".table_listcnt");j=h.$el.find("._ipsheet_cnt").height()-h.$el.find("._bottom_cnt").height();i.css({maxHeight:j-j%h.ip_sheet.rowHeight})},set_colhead_padding:function(){var h,j,i;h=this.ip_sheet.$el.find(".table_listcnt");j=h.width();i=h.find(">ul").width();h.parent().find(".table_head_ul").css({paddingRight:j-i>3?(j-i)+"px":0})},render:function(j,o){var p,l,n,k,q,t,s,v,r,h;var u=this;v=u.options;if(!j){h=u.$el.find(".popup_body");h.html('<div class="_form_top_cnt"></div><div class="_ipsheet_cnt"></div><div class="_bottom_cnt" style="height:70px"><div class="btm_left float_left"></div><div class="btm_right float_right"><span class="jrform_titem2 _mgtp_10x total_amount">Total: <span class="_tamount"></span></span></div><div class="clearfix"></div></div>');u.form=new app.Form({fields:_.pick(b.fields,u.form_fields),default_attr:b.default_attr,validation:b.validation,appendTo:h.find("._form_top_cnt")});r=u.form.fields;r.retention.append_to=h.find(".btm_left");r.adv_recovered.append_to=h.find(".btm_left");r.description.append_to=h.find(".btm_left");r.print_btn.append_to=h.find(".popup_footer");u.form.renderInputs();u.ip_sheet=new app.IPS_ext({ips_id:u.ips_id,is_scrollable:true,ip_defaults:{class_name:"_sm2 _type2 _nouline"},appendTo:h.find("._ipsheet_cnt"),validation:a,schema:f});u.ip_sheet.render();u.listenTo(u.ip_sheet,"all",u.ipsheet_event);u.listenTo(u.form,"all",u.form_ev_handler)}u.ip_sheet.release(true);u.ip_sheet.rowHeight=null;u.form.reset(null,["date"]);u.setMode("idle");app.set_docno_field(u.doc_type,u.form);u.no_autofocus=(v.method=="update");if(v.data){if(v.data.items){u.set_data(v.data)}else{if(u.last_xhr&&u.last_xhr.readyState!=4){u.last_xhr.abort()}l=new app.models.Voucher;l.context=u;l.set({id:v.data.voucher_id});u.last_xhr=l.fetch({data:$.param({acc_sel:app.LocalDB.has_local("/accounts/")?"account_id":"account_name"}),success:function(m,i){m.context.set_data(i)},error:function(i,m){app.notifications.add("Error","Unable to load data, please check your internet connection","error")}})}}else{u.ip_sheet.insertRow({});u.set_total(0)}u.form[v.method=="update"?"show_comps":"hide_comps"](["print_btn"]);if(v.method!="update"){n=u.form.components.doc_no;p=o?u.form.components.date.get_value():app.get_new_voucher_date();if(n.disabled){n.set_value(app.generate_doc_no(u.doc_type,p,1,true))}else{n.set_value("")}u.form.set_values({date:p,description:""})}},set_data:function(k){var h,l,j,i;h=this;if(h.options.method=="update"){h.form.set_values(_.pick(k,["doc_no","date","customer_name","subcontractor_name","ref_no","retention","adv_recovered","job_name","description"]))}j=k.items;h.ip_sheet.set_value_list(j);h.set_total(null,true);h.ip_sheet.scrollTo("top");h.ip_sheet.focusRow(0,"account_name");setTimeout(function(){h.set_colhead_padding()},100)},context_item_click:function(p,j,k){var m,l,i,h,o,n;o=this;if(j=="insert_above"){m=this.ip_sheet.getRowIndex(p);this.insertRow(m)}else{if(j=="delete_row"){p.cols.account_name.ip.hide_dropdown();if(this.ip_sheet.rows.length>1){this.ip_sheet.deleteRow(p)}}else{if(j=="display"){h=p.cols.account_name.ip;l=h.get_selected_data();if(l){i=new app.models.Account({id:l.id});i.fetch({success:function(r,q){app.popups.AccountPopup.show({method:"update",invoker:o,is_cntlacc:false,hide_cont_btn:true,data:q,callback:function(t,s){h.set_value(s.name+s.suffix);h.data={items:[{id:s.id,cost_appl:s.cost_appl,name:s.name+s.suffix}]};setTimeout(function(){h.focus()},800)}})},error:function(){}})}}}}},form_ev_handler:function(n,k,l){var p,o,h,r,i,j,q;q=this;h=q.form.components;if(n=="keydown"&&k.name=="date"){if(l.keyCode==13){l.preventDefault();q.ip_sheet.focusRow(0)}}else{if(n=="keyup"&&k.name=="date"){dn_comp=h.doc_no;l.preventDefault();r=q.options;o=app.generate_doc_no;if(dn_comp.disabled){p=r.method=="create"?o(q.doc_type,k.get_value(),1,true):r.data.doc_no;h.doc_no.set_value(p)}}else{if(n=="keydown"&&k.name=="description"){if(l.keyCode==13){l.preventDefault();q.$el.find(".popup_footer ."+(q.options.method=="create"?"op_btn_snnx":"op_btn_sncl")).focus()}}else{if(n=="clicked"&&k.name=="print_btn"){app.p_view_inst.Voucher.print_data(q.options.data.voucher_id)}}}}},ipsheet_event:function(u,t,l,s,n){var o,m,k,j,h,w,q,p,v,r;v=this;w=v.ip_sheet.getRow(t);r=v.form.components;switch(u){case"text_changed":if((w.cols[l].ip.get_value()==""||l=="drcr")&&s.keyCode==8&&s.shiftKey){if(w.dclick_flag==true){if(l=="account_name"){w.cols[l].ip.hide_dropdown()}if(v.ip_sheet.rows.length>1){v.ip_sheet.deleteRow(w);v.ip_sheet.rows[t!=0?t-1:0].cols[l].ip.focus()}}else{w.dclick_flag=true;setTimeout(function(){w.dclick_flag=false},200)}}w.extra_values={};break;case"item_selected":case"enterkey_press":if(u=="enterkey_press"){s.preventDefault()}if(u=="enterkey_press"&&l=="amount"&&w.cols.account_name.ip.get_value()==""){r.description.focus();break}if(u=="enterkey_press"&&l=="amount"){tmp=v.ip_sheet.rows;m=tmp[tmp.length-1].cols;p=w.cols.account_name.ip.get_selected_data();if(p&&((get_cfg("en_jobs")=="true"&&r.job_name.get_value()=="")||(get_cfg("en_costcenter")=="true"&&p.cost_appl))){app.popups.AllocationPopup.show({invoker:v,method:"set",qty_based:false,show_tabs:["cost_alloc",r.job_name.get_value()==""?"job_alloc":null],amount:Number(n.comp.get_value()),row:w,callback:function(x,i){x.extra_values=x.extra_values||{};_.extend(x.extra_values,i);setTimeout(function(){v.ip_sheet.validate_row(x,true)},200)}});return}}if(v.ip_sheet.focusColumn(w,l,"next",true,{select:true})==false){v.ip_sheet.validate_row(w,true)}break;case"add_new_clicked":app.popups.AccountPopup.show({method:"create",is_cntlacc:false,hide_cont_btn:true,data:{name:n.comp.get_value(true),is_cntlacc:false},invoker:v,callback:function(x,i){n.comp.set_value(i.name+i.suffix);n.comp.data={items:[{id:i.id,cost_appl:i.cost_appl,name:i.name+i.suffix,c_balance:0}]};setTimeout(function(){n.comp.focus()},800)}});break;case"row_insert":v.set_total(null,true);v.set_colhead_padding();break;case"row_delete":this.set_colhead_padding();break;case"context_menu":o=this;setTimeout(function(){o.context_menu.show(w,{left:s.pageX,top:s.pageY})},100);break;case"arrow_press":j=this.ip_sheet;if(s.keyCode==38&&t>0||s.keyCode==40&&t<j.rows.length-1){o=s.keyCode==38?t-1:t+1;h=j.rows[o].cols[l].ip;h.focus();setTimeout(function(){h.input_el[0].select()});if(o==0){j.scrollTo("top")}else{if(o==j.rows.length-1){j.scrollTo("bottom")}}}break}},after_get_values:function(h){h.items=this.ip_sheet.get_value_list()},get_total:function(){var k,j,h;k=0;j=this.ip_sheet.get_value_list(["amount"]);for(h in j){k+=Number(j[h]["amount"])}return k},set_total:function(j,i){var h;if(i){j=this.get_total()}this.$el.find(".total_amount > span").text(to_money(j))}};app.popups.CntInv=new (app.Popup.extend(_.extend({id:"cnt_invoice",head:"Contract Invoice",class_name:"doc_pp_t1 _mw1200x",model:app.models.CntInv,events:{"click .op_btn":"submit_form"},show_save_n_next:true,ips_id:"contr_ips",doc_type:"contr_invoice",form_fields:["doc_no","date","customer_name","job_name","retention","adv_recovered","description","print_btn"]},e)))();app.popups.SubCntInv=new (app.Popup.extend(_.extend({id:"cnt_bill",head:"Contract Bill",class_name:"doc_pp_t1 _mw1200x",model:app.models.SubCntInv,events:{"click .op_btn":"submit_form"},doc_type:"subc_invoice",show_save_n_next:true,ips_id:"subcontr_ips",form_fields:["doc_no","date","ref_no","subcontractor_name","job_name","retention","adv_recovered","description","print_btn"]},e)))();var d={fields:{doc_no:{head_label:"Doc #",width:"135px"},date:{head_label:"Date",width:"90px"},customer_name:{head_label:"Customer",width:"30%"},description:{head_label:"Description",width:"30%"},amount:{head_label:"Total Amount",width:"120px",align:"right",type:"money",wrapSPAN:true}},show_items:["doc_no","date","customer_name","description","amount"],filter_enable:["doc_no","date","customer_name","description","amount"]};var c={fields:{doc_no:{head_label:"Doc #",width:"135px"},date:{head_label:"Date",width:"90px"},ref_no:{head_label:"Ref No",width:"135px"},subcontractor_name:{head_label:"Sub Contractor",width:"30%"},description:{head_label:"Description",width:"30%"},amount:{head_label:"Total Amount",width:"120px",align:"right",type:"money",wrapSPAN:true}},show_items:["doc_no","date","ref_no","subcontractor_name","description","amount"],filter_enable:["doc_no","date","ref_no","subcontractor_name","description","amount"]};var g={initialize:function(){this.pre_init()},initComps:function(){var h;this.context_menu_items=h=_.clone(this.context_menu_items);h.splice(0,0,{key:"gotovoucher",value:"Go to Voucher"});swap_obj_keys(this,"_context_item_click","context_item_click");this.init({create_el:true})},edit_voucher:function(j,l){var k={},i,h;h.popup.show({method:"update",invoker:h,callback:l,data:j})},_context_item_click:function(j,h){var i;i=this;if(h=="gotovoucher"){app.router.navigate(app.generate_url("voucher",j,null),{trigger:true});return}return i._context_item_click(j,h)},pre_show:function(){if(!this.is_inited){this.initComps()}}};app.p_views.ContrInvoices=app.ListPageTemplate.extend(_.extend({page_name:"contr_invoices",model:app.models.CntInv,no_newbtn:true,doc_type:"contr_invoice",popup:app.popups.CntInv,popup_options:{doc_type:"contr_invoice"},ds_options:{idAttr:"voucher_id",head:"Contracting Invoices",class_name:"hoverable ds_with_head",ds_id:"contr_invoices_ds",default_params:{},flex_schema:d,has_filter:true},header_btns:["print","export"],heading:"",heading_plural:"Contracting Invoices",ds_handler:function(h,k,i,j){if(h=="before_render"){}else{return this._ds_handler(h,k,i,j)}}},g));app.p_views.SubCInvoices=app.ListPageTemplate.extend(_.extend({page_name:"subc_invoices",model:app.models.SubCntInv,no_newbtn:true,doc_type:"subc_invoice",popup:app.popups.SubCntInv,popup_options:{doc_type:"subc_invoice"},ds_options:{idAttr:"voucher_id",head:"Sub Contract Invoices",class_name:"hoverable ds_with_head",ds_id:"subc_invoices_ds",default_params:{},flex_schema:c,has_filter:true},header_btns:["print","export"],heading:"",heading_plural:"Sub Contract Invoices",ds_handler:function(h,k,i,j){if(h=="before_render"){}else{return this._ds_handler(h,k,i,j)}}},g));FB_Module.init_fn(function(){app.SideMenu.add_item({item_id:"vouchers_cnt",label:"Voucher Registers",index:5.5,is_disabled:!AL.any_access("journal_voucher.list")});app.SideMenu.add_item({item_id:"accvouchers_cnt",label:"New Voucher",index:4,is_disabled:!AL.any_access("journal_voucher.create")});app.SideMenu.add_item({view:"contr_invoices",item_id:"contr_invoice_reports",index:45,under:"vouchers_cnt",label:"Contracting Invoices",is_disabled:!AL.any_access("contr_invoice.list")});app.SideMenu.add_item({item_id:"contr_invoice",under:"accvouchers_cnt",label:"Contracting Invoices",index:45,is_disabled:!AL.any_access("contr_invoice.create"),callback:function(){app.popups.CntInv.show({method:"create"})}});app.SideMenu.add_item({view:"subc_invoices",item_id:"subc_inv_reports",index:45,under:"vouchers_cnt",label:"SubContract Invoices",is_disabled:!AL.any_access("subc_invoice.list")});app.SideMenu.add_item({item_id:"subc_invoice",under:"accvouchers_cnt",label:"SubContract Invoice",index:45,is_disabled:!AL.any_access("subc_invoice.create"),callback:function(){app.popups.SubCntInv.show({method:"create"})}})})});FB_Module.register({index:2},function(){var c,b,a;if(get_cfg("en_contract")!="true"){return}c={fields:{doc_no:{head_label:"Doc#",width:"120px"},date:{head_label:"Date",width:"80px"},customer_name:{head_label:"Customer",width:"40%",url:"/cust_n_vendor/customers/?name={{value}}&pagination=false",list_selector:"items",label_sel:"name"},supplier_name:{head_label:"Supplier",width:"40%",url:"/cust_n_vendor/suppliers/?name={{value}}&pagination=false",list_selector:"items",label_sel:"name"},contract_type:{head_label:"Contract Type",key:"contract_type_txt",width:"15%"},start_date:{head_label:"Start Date",width:"80px"},end_date:{head_label:"End Date",width:"80px"},invoice_period:{head_label:"Invoice Period",key:"invoice_period_txt",width:"95px"},last_invoiced_on:{head_label:"Last Invoiced On",width:"10%"},next_invoice_date:{head_label:"Next Invoice Date",width:"10%"},status:{head_label:"Status",key:"status_txt",width:"90px"}},show_items:["doc_no","date","supplier_name","customer_name","contract_type","start_date","end_date","invoice_period","last_invoiced_on","next_invoice_date","status"],filter_enable:["date","doc_no","supplier_name","customer_name","contract_type","start_date","end_date"],ips_filter_enable:["date"]};a={initialize:function(){this.init({create_el:true})},before_init:function(){var d=this;d.popup=app.popups.PS_Popup},edit_voucher:function(d,e){this.popup.show({method:"update",invoker:this,doc_type:this.doc_type,callback:e,data:d})},ds_handler:function(n,g,d,m){var o,h,l,f,k,j;o=this;h={ac:["Active","_blue"],sp:["Suspended","_yellow"],tm:["Terminated","_red"],fn:["Finished","_green"]};l={month:"Monthly",quarter:"Quarterly","6month":"Twice a year",year:"Yearly"};if(n=="before_render"){j=g.items;for(k in j){j[k].invoice_period_txt=l[j[k].invoice_period];j[k].status_txt=h[j[k].status][0]}}else{if(n=="rendered"){f=d.$el.find(".table_list > li");for(k in d.rows){j=d.rows[k];f.eq(k).find(">ul>._cstatus_txt").addClass(h[j.status][1])}}}return this._ds_handler(n,g,d,m)}};app.p_views.CustomerContracts=app.ListPageTemplate.extend(_.extend({page_name:"customer_contracts",model:gen_model("/cust_contracts/"),doc_type:"cust_contract",no_newbtn:true,ds_options:{flex_schema:{fields:_.omit(c.fields,["supplier_name"]),show_items:_.without(c.show_items,"supplier_name"),filter_enable:_.without(c.filter_enable,"supplier_name"),ips_filter_enable:["date"]},ds_id:"ds_c_contracts",idAttr:"voucher_id",class_name:"hoverable",handle_pagination:true,has_filter:true},header_btns:["print","export"],drill_to_view:"voucher",heading:"Customer Contracts",heading_plural:"Customer Contracts"},a));app.p_views.SupplierContracts=app.ListPageTemplate.extend(_.extend({page_name:"supplier_contracts",model:gen_model("/suppl_contracts/"),doc_type:"suppl_contract",no_newbtn:true,ds_options:{flex_schema:{fields:_.omit(c.fields,["customer_name"]),show_items:_.without(c.show_items,"customer_name"),filter_enable:_.without(c.filter_enable,"customer_name"),ips_filter_enable:["date"]},ds_id:"ds_s_contracts",idAttr:"voucher_id",class_name:"hoverable",handle_pagination:true,has_filter:true},header_btns:["print","export"],drill_to_view:"voucher",heading:"Supplier Contracts",heading_plural:"Supplier Contracts"},a));if(AL.any_access("suppl_contract.display","cust_contract.display")){FB_Module.init_fn(function(){app.SideMenu.add_item({item_id:"vouchers_cnt",label:"Voucher Registers",index:5.5,is_disabled:!AL.any_access("suppl_contract.display","cust_contract.display")});app.SideMenu.add_item({view:"customer_contracts",item_id:"customer_contracts",index:10,under:"vouchers_cnt",label:"Customer Contracts",is_disabled:!AL.any_access("cust_contract.display")});app.SideMenu.add_item({view:"supplier_contracts",item_id:"supplier_contracts",index:10,under:"vouchers_cnt",label:"Supplier Contracts",is_disabled:!AL.any_access("suppl_contract.display")})})}});FB_Module.register({index:2},function(){var a,c,b;a={fields:{doc_no:{head_label:"Doc#",width:"120px"},date:{head_label:"Date",width:"80px"},job_name:{head_label:"Job ID",width:"40%",url:"/jobs/?name={{value}}&pagination=false"},boq_no:{head_label:"BOQ No",width:"100px"},particulars:{head_label:"Particulars",width:"40%"},amount:{head_label:"Amount",type:"money",wrapSPAN:true,align:"right",width:"90px"}},show_items:["doc_no","date","job_name","boq_no","particulars","amount"],filter_enable:["doc_no","date","job_name","boq_no","particulars","amount"],ips_filter_enable:["date"]};b={initialize:function(){this.init({create_el:true})},before_init:function(){var d=this;d.popup=app.popups.PS_Popup},edit_voucher:function(d,e){this.popup.show({method:"update",invoker:this,doc_type:this.doc_type,callback:e,data:d})},ds_handler:function(n,g,d,m){var o,h,l,f,k,j;o=this;if(n=="before_render"){j=g.items;for(k in j){}}else{if(n=="rendered"){f=d.$el.find(".table_list > li");for(k in d.rows){j=d.rows[k]}}}return this._ds_handler(n,g,d,m)}};if(AL.any_access("boq.display")&&get_doctype("boq").is_enabled=="true"){app.p_views.BOQ=app.ListPageTemplate.extend(_.extend({page_name:"boqs",model:gen_model("/boqs/"),doc_type:"boq",no_newbtn:true,ds_options:{flex_schema:{fields:_.omit(a.fields,["boq_no"]),show_items:_.without(a.show_items,"boq_no"),filter_enable:_.without(a.filter_enable,"boq_no"),ips_filter_enable:["date"]},ds_id:"ds_boqs",idAttr:"voucher_id",class_name:"hoverable",handle_pagination:true,has_filter:true},header_btns:["print","export"],drill_to_view:"voucher",heading:"BOQ",heading_plural:"BOQ"},b))}if(AL.any_access("boq_variation.display")&&get_doctype("boq_v").is_enabled=="true"){app.p_views.BOQ_Variation=app.ListPageTemplate.extend(_.extend({page_name:"boq_variations",model:gen_model("/boq_variations/"),doc_type:"boq_variation",no_newbtn:true,ds_options:{flex_schema:{fields:_.omit(a.fields,[]),show_items:_.without(a.show_items),filter_enable:_.without(a.filter_enable),ips_filter_enable:["date"]},ds_id:"ds_boq_v",idAttr:"voucher_id",class_name:"hoverable",handle_pagination:true,has_filter:true},header_btns:["print","export"],drill_to_view:"voucher",heading:"BOQ Variation",heading_plural:"BOQ Variations"},b))}if(AL.any_access("boq.display","boq_variation.display")){FB_Module.init_fn(function(){app.SideMenu.add_item({item_id:"vouchers_cnt",label:"Voucher Registers",index:5.5,is_disabled:!AL.any_access("boq.display","boq_variation.display")});if(AL.any_access("boq.display")&&get_doctype("boq").is_enabled=="true"){app.SideMenu.add_item({view:"boqs",item_id:"boqs",index:10,under:"vouchers_cnt",label:"BOQ",is_disabled:false})}if(AL.any_access("boq_variation.display")&&get_doctype("boq_v").is_enabled=="true"){app.SideMenu.add_item({view:"boq_variations",item_id:"boq_variations",index:10,under:"vouchers_cnt",label:"BOQ Variations",is_disabled:false})}})}});FB_Module.register({index:2},function(){var b={};var a={name:{head_label:"&nbsp;",style:"width:80%"},closing:{head_label:"Closing Stock",style:"width:20%;text-align:center"}};var e={fields:{item_code:{head_label:"Item Code",width:"7%",index:0},name:{head_label:"Name",width:"30%",index:0},op_q:{head_label:"Quantity",align:"right",width:"7%",index:0},op_rt:{head_label:"Rate",align:"right",width:"6%",index:0},op_v:{head_label:"Value",align:"right",width:"7%",index:0},iw_q:{head_label:"Quantity",align:"right",width:"7%",index:0},iw_rt:{head_label:"Rate",align:"right",width:"6%",index:0},iw_v:{head_label:"Value",align:"right",width:"7%",index:0},ow_q:{head_label:"Quantity",align:"right",width:"7%",index:0},ow_rt:{head_label:"Rate",align:"right",width:"6%",index:0},ow_v:{head_label:"Value",align:"right",width:"7%",index:0},cl_q:{head_label:"Quantity",align:"right",width:"7%",index:0},cl_rt:{head_label:"Rate",align:"right",width:"6%",index:0},cl_v:{head_label:"Value",align:"right",width:"7%",index:0}},show_items:["item_code","name","op_q","op_rt","op_v","iw_q","iw_rt","iw_v","ow_q","ow_rt","ow_v","cl_q","cl_rt","cl_v"],head_group:{name:{head_label:"&nbsp;",cspan:2},opening:{head_label:"Opening Stock",align:"center",cspan:3},inward:{head_label:"Inwards",align:"center",cspan:3},outward:{head_label:"Outwards",align:"center",cspan:3},closing:{head_label:"Closing Stock",align:"center",cspan:3}}};var k={default_attr:{class_name:"_type1 _sm2 _comp_inline _mgrt_1em"},fields:{group:{type:"selectbox",label:"Group By",default_option:"category",id:"_w10em",options:[{category:"Category Wise"},{brand:"Brand Wise"},get_cfg("en_godown")=="true"?{godown:"Godown Wise"}:null,get_cfg("en_batch")=="true"?{batch:"Batch Wise"}:null]},from_date:{type:"datefield",id:"_w7em _mgtp_2x",label:"From Date"},to_date:{type:"datefield",id:"_w7em _mgtp_2x",label:"To Date"},item_code:{type:"inputbox",id:"_mgbt_1em _w9em",label:"Item Code",dlgTo:"scope"},item_id:{type:"combobox",id:"",label:"Item Name",class_name:"_type1 _md _comp_inline _mgrt_1em _w25em _mgbt_1em",value_sel:"id",label_sel:"name",info_sel:"item_code",auto_show_info:true,dlgTo:"scope",url:"/items/?name_code={{value}}&is_service=false&pagination=false"},category_id:{type:"combobox",id:"",label:"Category Name",class_name:"_type1 _sm2 _comp_inline _w15em _mgtp_3x _mgrt_1em",url:"/item_categories/?name={{value}}&pagination=false",list_selector:"items",label_sel:"name",value_sel:"id",embedd_list_el:false},brand_id:{type:"combobox",id:"",label:"Brand Name",class_name:"_type1 _sm2 _comp_inline _w15em _mgtp_3x _mgrt_1em",url:"/item_brands/?name={{value}}&pagination=false",list_selector:"items",label_sel:"name",value_sel:"id",embedd_list_el:false},godown_id:get_cfg("en_godown")=="true"?{type:"combobox",id:"",label:"Godown Name",class_name:"_type1 _sm2 _comp_inline _w15em _mgtp_3x _mgrt_1em",url:"/godowns/?name={{value}}&pagination=false",list_selector:"items",label_sel:"name",value_sel:"id",embedd_list_el:false}:null,batch_id:get_cfg("en_batch")=="true"?{type:"combobox",id:"",label:"Batch No",class_name:"_type1 _sm2 _comp_inline _w15em _mgtp_3x _mgrt_1em",url:"/batches/?name={{value}}&pagination=false",list_selector:"items",label_sel:"name",value_sel:"id",embedd_list_el:false}:null,stock_status:{type:"selectbox",id:"",label:"Show Items",dlgTo:"scope",class_name:"_type1 _sm2 _comp_inline _w10em _mgrt_1em",default_option:"w_stock",options:{w_stock:"With Stock",all:"All",lw_stock:"Low Stock"}},q_threshold:{type:"inputbox",id:"_mgbt_1em _w7em",label:"Threshold"},_submit_btn:{tagName:"button",className:"component btn _type1 _sm2 _theme1 _mgrt_2em _mgtp_3x hrz_form_btn",innerHTML:"Submit",attrs:{type:"submit"}},display:{type:"selectbox",id:"",label:"Display Type",dlgTo:"scope",class_name:"_type1 _sm2 _comp_inline _w10em _mgrt_1em",default_option:"detailed",options:[{condensed:"Condensed"},{detailed:"Detailed"},{item_wise:"Item Wise"}]},sel_data:{type:"selectbox",id:"",label:"Columns",dlgTo:"scope",class_name:"_type1 _sm2 _comp_inline _w10em _mgrt_1em",default_option:"closing",options:[{closing:"Closing Stock"},{"opening,closing":"Opening,Closing"},{"inward,outward,closing":"Inward,Outward,Closing"},{"opening,inward,outward,closing":"All"}]}},validation:{}};var l={ds_b_rend:function(s,p){var r,q,t,n,o,u,w,v;v=this;u=v.show_lst;t=p.items;for(r=0;r<t.length;r++){n=t[r];for(q=0;q<u.length;q++){w=u[q];if(n[w+"_q"]){n[w+"_r"]=n[w+"_r"]?to_money(n[w+"_r"],false,4):"";n[w+"_v"]=n[w+"_v"]?to_money(n[w+"_v"]):""}}}v.ds.$el.find(".ds_topcnt .total_amount")[t.length?"show":"hide"]().html("Closing Stock : "+to_money(p.closing_stock,true));v.form.reset();v.form.set_values(p);v.form.set_values({from_date:p.from_date,to_date:p.to_date})},ds_rendr:function(r){var n,p,o,t,s,q;t=r.$el.find(".table_list > li");for(n in r.rows){p=r.rows[n];q=p.pr0.toString();o=t.eq(n).addClass(q.indexOf("f")!=-1?"row_l0":"row_l1").addClass((q.indexOf("g")!=-1&&traverse(r,"options.params.display")!="condensed")||q.indexOf("t")!=-1?"_is_head":"").addClass(q.indexOf("i")!=-1?"_i":"")}},ds_handler:function(n,q,o,p){if(n=="before_render"){this.ds_b_rend(null,q)}else{if(n=="rendered"){this.ds_rendr(o)}else{if(n=="context_menu"){if(o.get_row(q).pr0.indexOf("g")!=-1){this.context_menu.show(q,{left:p.pageX,top:p.pageY},{ds:o})}}else{return this._ds_handler(n,q,o,p)}}}},context_item_click:function(q,n,p){var o;if(n=="stock_summary"){o=_.omit(this.form.get_values(),["brand_name","display"]);app.router.navigate(app.generate_url("stock_reports","stock_summary",_.extend({brand_id:q},o)),{trigger:true})}else{if(n=="brand_summary"){o=_.omit(this.form.get_values(),["category_name","display"]);app.router.navigate(app.generate_url("stock_reports","brand_summary",_.extend({category_id:q},o)),{trigger:true})}}},load_ds:function(p,o){p=p||{};var n=this;if(this.pre_load_ds){this.pre_load_ds(p)}n.ds.$el.find(".ds_topcnt .total_amount").html("");n.form.renderServerErrors();n.ds.load({presv_flt:o?2:0,params:p,invoker:n,error:function(q,r){n.form.renderServerErrors(r)}})},onshow:function(p){var o,n;n=this;if(!n.is_inited){n.initComponents();n.is_inited=true}o=_.extend({sel_data:"closing",stock_status:"w_stock",group:"category"},_.pick(p.args,["group","from_date","to_date","brand_id","item_id","category_id","display","sel_data","stock_status","q_threshold","batch_id","godown_id"]));if(n.update_args){n.update_args(o)}if(n.args&&n.args.cl_opt){n.form.reset()}n.form_ev_handler("changed",n.form.components.stock_status);n.load_ds(o,!p.is_navigate)},export_data:function(){var n=this.form.get_values();app.popups.PrintExportOptions.show({invoker:this,callback:function(p){var o,q;$("#myiframwe").attr("src",app.generate_ext_url("reports","stock",_.extend({sub_op:"export_to_excel"},this.ds.default_params,n,p)))}})},li_clicked_b:function(o,q){var r,n,p;n=this;p=q.current_filter;r=this.ds.get_row(o);p[has_ch(r.pr0,"g")?p.group+"_id":"item_id"]=r.id;if(has_ch(r.pr0,"g")){app.router.navigate(app.generate_url("stock_reports",n.tab_id,p),{trigger:true})}else{app.router.navigate(app.generate_url("stock_reports","stock_report",p),{trigger:true})}},li_clicked:function(p,r){var s,q,o,n;n=this;s=r.get_row(p);q=r.current_filter;app.popups.DrillSel.show({method:"set",invoker:n,ds_row:s,map:{detail:["detail","Detail"],category:["category_id","Category"],brand:["brand_id","Brand"],item:["item_id","Item"],batch:["batch_id","Batch"],godown:["godown_id","Godown"]},get_item_options:function(y,v){var t,x,u,w;u=q.group;w=["category","brand"];x=[];if(!(q.item_id||!has_ch(s.pr0,"g"))){x.push("detail")}if(s.pr0.indexOf("i")!=-1){x.push("item")}return _.map(y,function(A,z){return _.in_list(z,w)||(!_.in_list(z,x)&&!q[A[0]]&&z!=u)?[z,A[0],A[1]]:null})},callback:function(u){var t;t=this;q[has_ch(s.pr0,"g")?q.group+"_id":"item_id"]=s.id;if(u!="detail"){if(u=="item"){q.display="item_wise"}else{q.display="condensed";q.group=u}app.router.navigate(app.generate_url("stock_reports",t.tab_id,q),{trigger:true})}else{app.router.navigate(app.generate_url("stock_reports","stock_report",q),{trigger:true})}}})}};var g=app.Tab.extend({label:"Stock Summary",tab_id:"stock_summary",model:app.models.StockReport,show_lst:["op","iw","ow","cl"],context_menu_items:[{key:"brand_summary",value:"Brand Wise Summery"}],is_tab_view:true,heading:"Stock Summary",ds_options:{idAttr:"slNo",flex_schema:$.extend(true,{},e),class_name:"hoverable ds_stock_brand_summary _fz14",ds_id:"ds_stock_summary",default_params:{op:"get_summary",group:"category",sel_data:"opening,inward,outward,closing"}},no_newbtn:true,pre_load_ds:function(p){var o,n;n=this;o=p.sel_data||"closing";n.ds.flex_schema.head_group=_.pick(e.head_group,_.union(["item_code","name"],o.split(",")));n.ds.flex_schema.show_items=_.union(["item_code","name"],o.indexOf("opening")!=-1?["op_q","op_rt","op_v"]:null,o.indexOf("inward")!=-1?["iw_q","iw_rt","iw_v"]:null,o.indexOf("outward")!=-1?["ow_q","ow_rt","ow_v"]:null,["cl_q","cl_rt","cl_v"])},on_show2:function(){var n;n=this;n.form.components.q_threshold.hide()},form_ev_handler:function(s,q,t){var p,o,n,r;o=this;if(s=="form_submit"||(s=="changed"&&q.name!="stock_status")){p=o.form.get_values(true);n={};app.router.navigate(app.generate_url("stock_reports",this.tab_id,_.extend(n,_.omit(p,[]))),{replace:true,trigger:false});o.load_ds(_.extend(p,_.pick(o.args,["brand_id"])))}else{if(s=="changed"&&q.name=="stock_status"){o.form.components.q_threshold[q.get_value()=="lw_stock"?"show":"hide"]()}else{if(s=="keyup"&&(q.name=="item_code"||q.name=="item_id")&&t.keyCode!=13){if(q.name=="item_code"){o.form.components.item_id.set_value(null)}else{o.form.components.item_code.set_value("")}}}}},initComponents:function(){var n=this;n.form=new app.Form(_.extend({appendTo:n.$el,class_name:"stocksummary_form _mgbt_1em"},k));n.form.renderInputs();n.listenTo(n.form,"all",n.form_ev_handler);n.init();n.ds.$el.find(".ds_topcnt").prepend('<span class="total_amount"></span>');n.listenTo(n.ds,"li_clicked",get_cfg("use_mlt_stk_drill")=="true"?n.li_clicked:n.li_clicked_b)}});g.merge(app.ListPageTemplate,true);g.merge(l);var i={name:{head_label:"&nbsp;",style:"width:40%"},inward:{head_label:"Inwards",style:"width:20%;text-align:center"},outward:{head_label:"Outwards",style:"width:20%;text-align:center"},closing:{head_label:"Closing Balance",style:"width:20%;text-align:center"}};var m={date:{head_label:"Date",style:"width:10%",index:0},particulars:{head_label:"Particulars",style:"width:30%",index:0},iw_q:{head_label:"Quantity",style:"width:7%;text-align:right",index:0},iw_r:{head_label:"Rate",style:"width:6%;text-align:right",index:0},iw_v:{head_label:"Value",style:"width:7%;text-align:right",index:0},ow_q:{head_label:"Quantity",style:"width:7%;text-align:right",index:0},ow_r:{head_label:"Rate",style:"width:6%;text-align:right",index:0},ow_v:{head_label:"Value",style:"width:7%;text-align:right",index:0},cl_q:{head_label:"Quantity",style:"width:7%;text-align:right",index:0},cl_r:{head_label:"Rate",style:"width:6%;text-align:right",index:0},cl_v:{head_label:"Value",style:"width:7%;text-align:right",index:0}};set_objs({stock_rpt_hg:i,stock_rpt_schema:m});var j={default_attr:{class_name:"_type1 _md _comp_inline _mgrt_1em"},fields:{item_code:{type:"inputbox",id:"_mgbt_1em _w8em",label:"Item Code",dlgTo:"scope"},item_id:{type:"combobox",id:"",label:"Item Name",class_name:"_type1 _md _comp_inline _mgrt_1em _w20em _mgbt_1em",value_sel:"id",label_sel:"name",info_format:"Item Code : {{item_code}}",auto_show_info:true,url:"/items/?name_code={{value}}&is_service=false&pagination=false",en_search_by:"invitm_ds",root_url:"/items/",dlgTo:"scope"},godown_id:get_cfg("en_godown")=="true"?{type:"combobox",id:"",label:"Godown Name",class_name:"_type1 _sm2 _comp_inline _w15em _mgtp_3x _mgrt_1em",url:"/godowns/?name={{value}}&pagination=false",list_selector:"items",label_sel:"name",value_sel:"id",embedd_list_el:false}:null,batch_id:get_cfg("en_batch")=="true"?{type:"combobox",id:"",label:"Batch No",class_name:"_type1 _sm2 _comp_inline _w15em _mgtp_3x _mgrt_1em",url:"/batches/?name={{value}}&pagination=false",list_selector:"items",label_sel:"name",value_sel:"id",embedd_list_el:false}:null,from_date:{type:"datefield",id:"_w7em",label:"From Date"},to_date:{type:"datefield",id:"_w7em",label:"To Date"},_submit_btn:{tagName:"button",className:"component btn _type1 _md _theme1 _mg_rt_05em hrz_form_btn",innerHTML:"Submit",attrs:{type:"submit"}}},validation:{}};var h=app.Tab.extend({label:"Stock Report",tab_id:"stock_report",model:app.models.StockReport,drill_to_view:"voucher",has_unclickable:true,is_tab_view:true,heading:"Stock Report",ds_options:{head_group:i,schema:m,idAttr:"voucher_id",class_name:"hoverable _fz14",ds_id:"ds_stock_report",default_params:{op:"get_report",sel_data:"inward,outward,closing"}},no_newbtn:true,initComponents:function(){var n=this;this.form=new app.Form(_.extend({appendTo:this.$el,class_name:"stockreport_form _mgbt_1em"},j));this.form.renderInputs();this.listenTo(this.form,"all",this.form_ev_handler);this.init();n.ds.$el.find(".ds_topcnt").prepend('<span class="total_amount"></span>');this.ds.before_render=function(t,q){var s,r,u,o,p,v,w;v=["iw","ow","cl"];u=q.items;for(s=0;s<u.length;s++){o=u[s];for(r=0;r<v.length;r++){w=v[r];o[w+"_r"]=o[w+"_r"]?to_money(o[w+"_r"],false,4):"";o[w+"_v"]=o[w+"_v"]?to_money(o[w+"_v"]):""}}}},ds_rendr:function(q){var n,p,o,s,r;s=q.$el.find(".table_list > li");for(n in q.rows){p=q.rows[n];o=s.eq(n).addClass(p.bld?"_bld":"")}},form_ev_handler:function(r,p,s){var o,q,n;n=this;if(r=="form_submit"){o=n.form.get_values();n.load_ds(o,true)}else{if(r=="det_btn_clicked"){q=p.get_value();if(q){app.popups.ItemPopup.show({method:"update",invoker:n,hide_cont_btn:true,data:{id:q}})}}else{if(r=="keyup"&&(p.name=="item_code"||p.name=="item_id")&&s.keyCode!=13){if(p.name=="item_code"){n.form.components.item_id.set_value(null)}else{n.form.components.item_code.set_value("")}}}}},ds_handler:function(n,q,o,p){if(n=="rendered"){this.ds_rendr(o)}else{if(n=="before_render"){o.$el.find(".ds_topcnt .total_amount")[q.items.length?"show":"hide"]().html("Closing Stock : "+to_money(q.closing_stock,true))}else{return this._ds_handler(n,q,o,p)}}},load_ds:function(p,o,n){p=p||{};this.form.renderServerErrors();this.ds.$el.find(".ds_topcnt .total_amount").html("");this.ds.load({params:p,presv_flt:n?2:0,invoker:this,success:function(r,q){if(o){app.router.navigate(app.generate_url("stock_reports","stock_report",_.extend({item_id:q.item_id[0]},_.pick(q,["from_date","to_date"]))),{trigger:false,replace:true})}this.form.reset();this.form.set_values(_.pick(q,["item_id","item_code","godown_id","batch_id","from_date","to_date"]))},error:function(q,r){this.form.renderServerErrors(r)}})},onshow:function(n){if(!this.is_inited){this.initComponents();this.is_inited=true}this.form.set_values(_.pick(this.args,["from_date","to_date","item_name"]));this.load_ds(_.pick(this.args,["from_date","to_date","item_name","item_id","godown_id","batch_id"]),null,!n.is_navigate)}});h.merge(app.ListPageTemplate,true);var c={fields:{item_code:{head_label:"Item Code",width:"10%",index:0},name:{head_label:"Name",width:"60%",index:0},negetive_trans:{head_label:"Negetive Tran Count",align:"right",width:"10%",index:0}},show_items:["item_code","name","negetive_trans"]};var d=app.Tab.extend({label:"Stock Health",tab_id:"stock_health",model:app.models.StockReport,has_unclickable:true,is_tab_view:true,heading:"Stock Health",ds_options:{flex_schema:c,idAttr:"id",class_name:"hoverable _fz14",ds_id:"ds_stock_health",default_params:{op:"get_health"}},no_newbtn:true,initComponents:function(){var n=this,o;o=$.extend(true,{},j);o.fields.show_items={type:"selectbox",label:"Show Items",id:"_w15em",default_option:"",dlgTo:"scope",options:{all:"All",neg:"With Negetive Stock"}};n.form=new app.Form(_.extend({appendTo:n.$el,class_name:"stockhealth_form _mgbt_05em"},o));n.form.renderInputs();n.listenTo(n.form,"all",n.form_ev_handler);n.init()},form_ev_handler:function(r,p,s){var o,q,n;n=this;if(r=="form_submit"){o=n.form.get_values();n.load_ds(o,true)}else{if(r=="det_btn_clicked"){q=p.get_value();if(q){app.popups.ItemPopup.show({method:"update",invoker:n,hide_cont_btn:true,data:{id:q}})}}else{if(r=="keyup"&&(p.name=="item_code"||p.name=="item_id")&&s.keyCode!=13){if(p.name=="item_code"){n.form.components.item_id.set_value(null)}else{n.form.components.item_code.set_value("")}}else{if(r=="changed"&&p.name=="show_items"){o=n.form.get_values();n.load_ds(o,true)}}}}},ds_handler:function(n,q,o,p){if(n=="li_clicked"){app.router.navigate(app.generate_url("stock_reports/stock_report",null,{item_id:q}),{trigger:true})}else{return this._ds_handler(n,q,o,p)}},load_ds:function(p,o,n){p=p||{};this.form.renderServerErrors();this.ds.load({params:p,presv_flt:n?2:0,invoker:this,success:function(r,q){if(o){app.router.navigate(app.generate_url("stock_reports","stock_health",p),{trigger:false,replace:true})}this.form.reset();this.form.set_values(_.pick(q,["item_id","item_code","category_id","brand_id","show_items","from_date","to_date"]))},error:function(q,r){this.form.renderServerErrors(r)}})},onshow:function(o){var n;n=this;if(!n.is_inited){n.initComponents();n.is_inited=true}n.form.set_values(_.pick(n.args,["from_date","to_date","item_name"]));n.load_ds(_.pick(n.args,["from_date","to_date","item_name","item_id","category_id","brand_id","show_items"]),null,!o.is_navigate)}});d.merge(app.ListPageTemplate,true);if(get_cfg("en_batch")=="true"){var f=app.Tab.extend({label:"Batch Report",tab_id:"batch_report",model:gen_model("/batches/"),is_tab_view:true,ds_options:{schema:{name:{head_label:"Name",style:"width:35%",index:0},expiry_date:{head_label:"Expiry Date",style:"width:10%",index:0},description:{head_label:"Description",style:"width:30%",index:0},cl_stock:{head_label:"Closing Stock",style:"width:13%",index:0},status_txt:{head_label:"Status",style:"width:12%",index:0}},default_params:{inc_cl_stock:true},idAttr:"id",class_name:"hoverable _fz14",ds_id:"ds_batch_rep"},no_newbtn:true,initComponents:function(){var n=this,o;n.form=new app.Form({appendTo:n.$el,class_name:"batch_rep_form _mgbt_05em",default_attr:{class_name:"_comp_inline _mgrt_1em _type1 _sm2"},fields:{batch_name:{type:"combobox",label:"Batch No",id:"_w15em",url:"/batches/?name={{value}}&pagination=false"},show_items:{type:"selectbox",id:"_w10em",label:"Show Items",options:{"":"All",expired:"Expired",exp30:"Expiry in 30 days"}},submit_btn:{type:"button",id:"_mgtp_10x",label:"Submit",dlgTo:"scope",attrs:{type:"submit"}}}});n.form.renderInputs();n.listenTo(n.form,"all",n.form_ev_handler);n.init()},form_ev_handler:function(r,p,s){var o,q,n;n=this;if(r=="form_submit"){o=n.form.get_values();n.load_ds(o,true)}else{if(r=="changed"&&p.name=="show_items"){o=n.form.get_values();n.load_ds(o,true)}}},ds_rendr:function(q){var n,p,o,s,r;s=q.$el.find(".table_list > li");for(n in q.rows){p=q.rows[n];if(p.status&&p.expiry_date){s.eq(n).find("._cexpiry_date,._cstatus_txt").addClass(p.status=="exp"?"_red":"_yellow")}}},ds_handler:function(v,q,p,u){var s,t,n,o,r,w;w=this;if(v=="before_render"){r=new Date();for(s=0,t=q.items.length;s<t;s++){n=q.items[s];if(n.expiry_date){o=parse_date(n.expiry_date);if(o<r){n.status="exp";n.status_txt="Expired"}else{if(o<r.addDays(30)){n.status="exp30";n.status_txt="Expiry with 30 days"}}}}}else{if(v=="rendered"){w.ds_rendr(p)}else{if(v=="li_clicked"){app.router.navigate(app.generate_url("stock_reports","stock_summary",{batch_id:q}),{trigger:true})}else{return w._ds_handler(v,q,p,u)}}}},load_ds:function(q,p,o){var n;n=this;q=q||{};n.form.renderServerErrors();n.ds.load({params:q,presv_flt:o?2:0,invoker:n,success:function(s,r){if(p){app.router.navigate(app.generate_url("stock_reports","batch_report",q),{trigger:false,replace:true})}},error:function(r,s){n.form.renderServerErrors(s)}})},onshow:function(o){var n;n=this;if(!n.is_inited){n.initComponents();n.is_inited=true}n.form.set_values(_.pick(n.args,["batch_name","show_items"]));n.load_ds(_.pick(n.args,["batch_name","show_items"]),null,!o.is_navigate)}});f.merge(app.ListPageTemplate,true)}app.p_views.StockReports=app.PageTemplate.extend({page_name:"stock_reports",heading_plural:"Stock Reports",header_btns:["export"],initialize:function(){var o,n,p;this.init({create_el:true});this.tabs=new app.Tabs({appendTo:this.$el,$scope:this});o=_.union([g,h,d,get_cfg("en_batch")=="true"?f:null],_.values(get_object("streport_tabs")));p=[];for(n in o){if(o[n]){p.push(new o[n]())}}this.tabs.append(p);this.listenTo(this.tabs,"tab_show",this.tab_show)},onshow:function(n,o,p){if(!n){n=this.tabs.get_tab(0).tab_id}this.tabs.show_tab(n,{do_replace:true,args:o,is_navigate:p})},export_data:function(n){var o;o=this.tabs.current_tab;this.tabs.tabs[o].export_data()},print_data:function(n){var o;o=this.tabs.current_tab;this.tabs.tabs[o].print_data()},tab_show:function(o,p,r){var n=this,q=this.tabs.tabs;r.args=p.args;app.router.navigate(app.generate_url("stock_reports",o,p.args),{trigger:false,replace:p.do_replace});var s=this.$el.find(".float-right > *");s.hide()}});FB_Module.init_fn(function(){app.SideMenu.add_item({view:"stock_reports",item_id:"stock_reports",label:"Stock Reports",index:5.2,is_disabled:!AL.any_access(["stock_summary","stock_report"])})})});FB_Module.register({index:2},function(){var b,a;a={default_attr:{class_name:"_type1 _sm2 _comp_inline"},fields:{from_date:{type:"datefield",label:"From Date",id:"_w7em _mgrt_05em"},to_date:{type:"datefield",label:"To Date",id:"_w7em _mgrt_05em"},_submit_btn:{tagName:"button",className:"component btn _type1 _md _theme1 _mg_rt_05em _mgtp_9x",innerHTML:"Submit",attrs:{type:"submit"}}},validation:{from_date:{pattern:"date",required:false},to_date:{pattern:"date",required:false}}};var c=_.template($("#tsummary_template").html());b=app.Tab.extend({label:"Transaction Summary",tab_id:"transaction_summary",afterAppend:function(){var d=this,e;d.form=new app.Form(_.extend({appendTo:d.$el,class_name:"_mgbt_05em"},a));d.listenTo(d.form,"form_submit",d.form_submitted);e=$('<div class="tsummary_cnt component"></div>');e.data("backbone_view",this);d.$el.append(e)},load_data:function(f){var d,e,g;d=new Backbone.Model;e=this;this.url_params=f||this.url_params;this.$el.find(".tsummary_cnt").html('<div class="sheet_loading">Loading...</div>');d.url="/reports/transaction_summary/";d.fetch({data:$.param(this.url_params),success:function(i,h){e.form.renderErrors({});_.extend(h,{symbol:app.appdata.currency_symbol});e.form.set_values(_.pick(h,["from_date","to_date"]));var j=c(h);e.$el.find(".tsummary_cnt").html(j)},error:function(h,i){e.form.renderServerErrors(i)}})},form_submitted:function(f){var d;d=this;d.load_data(d.form.get_values(true))},print_data:function(){var d,e;d=app.generate_ext_url("reports","transaction_summary",_.extend({op:"print_preview"},this.form.get_values()));window.open(d,"_blank").addEventListener("load",function(){this.focus();this.print()},false)},onshow:function(){app.TopButtons.set(["print","export"]);if(!this.form.is_rendered){this.form.renderInputs()}this.load_data(this.form.get_values(true))}});if(AL.any_access("daybook")){set_object("reports_tabs","trans_summary_tab",b);FB_Module.init_fn(function(){app.SideMenu.add_item({item_id:"reports",label:"Reports",index:5});app.SideMenu.add_item({view:"reports/transaction_summary",item_id:"transaction_summary",under:"reports",label:"Transaction Summary",is_disabled:false})})}});FB_Module.register({index:2},function(){if(!AL.any_access("sales_report.display")){return}var d,a,b,c;c=[{customer_name:"Customer"},{sales_rep_name:"Sales Man"},{staff_name:"Staff Name"},{item_name:"Item"},{category_name:"Category"},{brand_name:"Brand"},{doc_no:"Voucher"},{day:"Day"},{month:"Month"},{quarter:"Quarter"},{year:"Year"}];d={default_attr:{class_name:"_type1 _sm2 _mgbt_1em"},fields:{_left_cnt:{tagName:"div",className:"_w48pc float_left",fields:{_structure:{tagName:"h4",className:"head5 _mgbt_1em",innerHTML:"Structure"},group_by:{type:"selectbox",id:"",label:"Group By",default_option:"",options:c},group_by_secondary:{type:"selectbox",id:"",label:"Secondary Group By",default_option:"",options:c,dlgTo:"scope"},inc_subtotal:{type:"checkbox",value:"true",label:"Include Sub Total"},_filters:{tagName:"h4",className:"head5 _mgbt_1em _mgtp_1em",innerHTML:"Filters"},customer_name:{type:"combobox",id:"_w100pc",label:"Customer",url:"/cust_n_vendor/customers/?name={{value}}&pagination=false",dlgTo:"scope",en_search_by:"customer_schema",root_url:"/cust_n_vendor/customers/"},sales_rep_name:{type:"combobox",id:"_w100pc",label:"Sales Rep",url:"/accounts/?name={{value}}&is_cntlacc=false&under_defacc=market_exec_pybl&pagination=false",dlgTo:"scope"},staff_name:{type:"combobox",id:"_w100pc",label:"Staff Name",dlgTo:"scope",url:"/members/?name={{value}}&pagination=false"},category_name:{type:"combobox",label:"Category",id:"_w100pc",url:"/item_categories/?name={{value}}&pagination=false",dlgTo:"scope"},brand_name:{type:"combobox",label:"Brand Name",id:"_w100pc",url:"/item_brands/?name={{value}}&pagination=false",dlgTo:"scope"},item_name:{type:"combobox",label:"Item Name",id:"_w100pc",url:"/items/?name_code={{value}}&pagination=false",dlgTo:"scope"},doc_no:{type:"combobox",label:"Doc No",id:"_w100pc",value_sel:"doc_no",label_sel:"doc_no",url:"/vouchers/?pagination=false&doc_type=iv&doc_no.*={{value}}&op=get_list",dlgTo:"scope"}}},_right_cnt:{tagName:"div",className:"_w48pc float_right",fields:{_columns:{tagName:"h4",className:"head5 _mgbt_1em",innerHTML:"Additional Columns"},col_customer_name:{type:"checkbox",id:"_comp_block",value:"true",label:"Customer Name"},col_category_name:{type:"checkbox",id:"_comp_block",value:"true",label:"Category Name"},col_sale_count:{type:"checkbox",id:"_comp_block",value:"true",label:"No of Sales"},col_quantity:{type:"checkbox",id:"_comp_block",value:"true",label:"Quantity"},col_cstock:{type:"checkbox",id:"_comp_block",value:"true",label:"Closing Stock"},col_salesrep_rcv:{type:"checkbox",id:"_comp_block",value:"true",label:"Sales Rep Received Amount"},_sort_by:{tagName:"h4",className:"head5 _mgbt_1em",innerHTML:"Sorting"},sort_by:{type:"selectbox",id:"_comp_inline _mgrt_1em",label:"Sort By",default_option:"group",options:{group:"Group",cogs:"COGS",amount:"Sale Amount",profit:"Profit",profit_percent:"Profit Percent",sale_count:"No of Sales",quantity:"Quantity"}},sort_order:{type:"selectbox",id:"_comp_inline",label:"Sort Type",default_option:"asc",options:{asc:"Ascending",desc:"Descending"}},_other:{tagName:"h4",className:"head5 _mgbt_1em",innerHTML:"Other Options"},limit:{type:"inputbox",id:"_mgbt_1em _w10em",label:"Limit Results"}}},save_btn:{type:"button",class_name:"float_left _type1 _sm2 _theme1",label:"Save as new Report",dlgTo:"scope"},_clearfix:{tagName:"div",className:"clearfix"}},validation:{report_name:{required:true},group_by:{required:true}}};app.popups.SaveReport=new (app.Popup.extend({id:"savereport_pp",head:"Save Reoort",class_name:"_mw300x",events:{"click .op_btn":"submit_form"},beforeInit:function(){return true},render:function(g){var f,e;e=this;if(!g){e.form=new app.Form(_.extend({appendTo:e.$el.find(".popup_body")},{default_attr:{class_name:"_type1 _sm2 _mgbt_1em"},fields:{report_name:{type:"inputbox",id:"_w15em _mgrt_05em",label:"Report Name"},access_level:{type:"selectbox",id:"_w15em",label:"Access Level",default_option:"",options:{"0":"L0","1":"L1","2":"L2"}}},validation:{report_name:{required:true},access_level:{required:true}}}));e.form.renderInputs();e.listenTo(e.form,"all",e.form_ev_handler)}f=e.options;e.setMode("idle");e.form.reset()},submit_form:function(j){var i,h,g,k,f;g=this;i=g.options;h=g.form.get_values(true);k=g.form.validate();if(k){g.form.renderErrors(k);return}f=new (gen_model("/report_settings/"))();f.set({report_type:i.data.report_type,name:h.report_name,access_level:h.access_level,settings:i.data.options});f.sync("create",f,{success:function(l,e){app.notifications.add("Success","Report Added successfully","success");g.close()},error:function(l,e){app.notifications.add("Error","Error while adding report","error")}})}}))();app.popups.SRReportOptions=new (app.Popup.extend({id:"reportoptions_pp",head:"Report Options",class_name:"_w800px",events:{submit:"submit_form","click .op_btn":"submit_form"},btn_map:{set:["Generate","Generating"]},beforeInit:function(){return true},render:function(g){var f,e;e=this;if(!g){e.form=new app.Form(_.extend({appendTo:e.$el.find(".popup_body")}));e.listenTo(e.form,"all",e.form_ev_handler)}f=e.options;e.form.release();_.extend(e.form,f.schema);e.form.fields.save_btn.append_to=e.$el.find(".popup_footer");e.form.renderInputs();e.setMode("idle");e.current_tab=null;if(f.data){e.form.set_values(f.data.options)}else{e.form.reset()}e.form_ev_handler("changed",e.form.components.group_by_secondary)},form_ev_handler:function(k,i,l){var h,j,n,g,f;h=this;j=h.form.components;if(k=="changed"&&i.name=="group_by_secondary"){if(i.get_value()==""){j.inc_subtotal.set_value("")}h.form[i.get_value()!=""?"show_comps":"hide_comps"](["inc_subtotal"])}else{if(k=="clicked"&&i.name=="save_btn"){n=h.form.validate();if(n){h.form.renderErrors(n);return}g=h.form.get_values(true);app.popups.SaveReport.show({invoker:h,method:"create",data:{options:g,report_type:"sr"}})}}},submit_form:function(h){var g,f;g=this.options;f=this.form.get_values(true);g.data.options=f;if(g.callback){g.callback.call(g.invoker,f)}this.close()}}))();a={default_attr:{class_name:"_type1 _sm2"},fields:{report_name:{type:"combobox",id:"_w25em _comp_inline _mgrt_1em",label:"Report Name",dlgTo:"scope",url:"/report_settings/?name={{value}}&report_type=sr&pagination=false"},from_date:{type:"datefield",id:"_mgbt_05em _w7em _mgrt_1em",label:"From Date"},to_date:{type:"datefield",id:"_mgbt_05em _w7em _mgrt_1em",label:"To Date"},submit_btn:{type:"button",id:"_mgbt_1em _mgtp_10x _mgrt_1em _theme1",label:"Generate",dlgTo:"scope"},report_options:{type:"button",id:"_mgbt_1em _mgtp_10x _mgrt_05em",label:"Settings",dlgTo:"scope"},clear_btn:{type:"button",id:"_mgbt_1em _mgtp_10x _mgrt_05em",label:"Clear",dlgTo:"scope"},delete_btn:{type:"button",id:"_mgbt_1em _mgtp_10x _mgrt_1em",label:"Delete",dlgTo:"scope"}},validation:{}};b=app.Tab.extend({label:"Sales Report",tab_id:"sales_report",afterAppend:function(){var e;e=this;e.form=new app.Form(_.extend({appendTo:e.$el},a));e.report_settings={options:{}};e.$el.append('<div class="report_cnt"></div>');e.listenTo(e.form,"all",e.form_ev_handler)},form_ev_handler:function(l,h,n){var i,g,f,k,j;g=this;if(l=="clicked"){if(h.name=="report_options"){app.popups.SRReportOptions.show({method:"set",invoker:g,schema:d,data:g.report_settings,callback:function(e){_.extend(e,g.form.get_values(true));g.update_report(e)}})}else{if(h.name=="submit_btn"){k=g.form.get_values(true);if((!k.report_name)&&_.isEmpty(g.report_settings.options)){g.form.components.report_name.render_error("This field is required");return}g.update_report(_.extend({},g.report_settings.options,k))}else{if(h.name=="clear_btn"){g.$el.find(".report_cnt").html("")}else{if(h.name=="delete_btn"){k=g.form.components.report_name;j=k.get_selected_data();if(j){f=new (gen_model("/report_settings/"))({id:j.id});f.destroy({success:function(m,e){k.reset();app.notifications.add("Success","Report deleted successfully","success")},error:function(m,e){app.notifications.add("Error","Error while deleting report","error")}})}}}}}}else{if((l=="item_selected"||l=="keyup")&&h.name=="report_name"){k=h.get_selected_data();if(k){g.report_settings.options=h.get_selected_data().settings}g.form.components.delete_btn[k?"show":"hide"]()}}},update_report:function(g){var e,f;e=this;f=new (gen_model("/reports/sales/"))();e.$el.find(".report_cnt").html("Loading...");f.fetch({data:$.param(g),success:function(h,i){e.form.set_values(_.pick(i,["from_date","to_date"]));e.$el.find(".report_cnt").html(i.html)},error:function(h,i){e.form.renderServerErrors(i)}})},export_data:function(){var f,e;e=this;f=e.form.get_values();_.extend(f,e.report_settings.options);$("#myiframwe").attr("src",app.generate_ext_url("reports","sales",_.extend({op:"export_to_excel"},f)))},onshow:function(){var e;e=this;if(!e.form.is_rendered){e.form.renderInputs()}e.form.components.report_options[AL.has_access("sales_report","settings")?"show":"hide"]();e.form_ev_handler("item_selected",e.form.components.report_name,null);app.TopButtons.set(["export"])}});if(AL.any_access("sales_report.display")||true){set_object("reports_tabs","salesreport_tab",b);FB_Module.init_fn(function(){app.SideMenu.add_item({item_id:"reports",label:"Reports",index:5});app.SideMenu.add_item({view:"reports/sales_report",item_id:"sales_report",under:"reports",label:"Sales Report",is_disabled:!AL.any_access("sales_report.display")})})}});FB_Module.register({index:2},function(){if(!AL.any_access("sales_report.display")){return}var c,a,d,b;b=[{supplier_name:"Supplier"},{item_name:"Item"},{category_name:"Category"},{brand_name:"Brand"},{doc_no:"Voucher"},{day:"Day"},{month:"Month"},{quarter:"Quarter"},{year:"Year"}];c={default_attr:{class_name:"_type1 _sm2 _mgbt_1em"},fields:{_left_cnt:{tagName:"div",className:"_w48pc float_left",fields:{_structure:{tagName:"h4",className:"head5 _mgbt_1em",innerHTML:"Structure"},group_by:{type:"selectbox",id:"",label:"Group By",default_option:"",options:b},group_by_secondary:{type:"selectbox",id:"",label:"Secondary Group By",default_option:"",options:b,dlgTo:"scope"},inc_subtotal:{type:"checkbox",value:"true",label:"Include Sub Total"},_filters:{tagName:"h4",className:"head5 _mgbt_1em _mgtp_1em",innerHTML:"Filters"},supplier_name:{type:"combobox",id:"_w100pc",label:"Supplier",url:"/cust_n_vendor/suppliers/?name={{value}}&pagination=false",dlgTo:"scope",en_search_by:"supplier_schema",root_url:"/cust_n_vendor/suppliers/"},category_name:{type:"combobox",label:"Category",id:"_w100pc",url:"/item_categories/?name={{value}}&pagination=false",dlgTo:"scope"},brand_name:{type:"combobox",label:"Brand Name",id:"_w100pc",url:"/item_brands/?name={{value}}&pagination=false",dlgTo:"scope"}}},_right_cnt:{tagName:"div",className:"_w48pc float_right",fields:{_columns:{tagName:"h4",className:"head5 _mgbt_1em",innerHTML:"Additional Columns"},col_supplier_name:{type:"checkbox",id:"_comp_block",value:"true",label:"Supplier Name"},col_category_name:{type:"checkbox",id:"_comp_block",value:"true",label:"Category Name"},col_sale_count:{type:"checkbox",id:"_comp_block",value:"true",label:"No of Sales"},col_p_date:{type:"checkbox",id:"_comp_block",value:"true",label:"Avg.Purchase Date"},_sort_by:{tagName:"h4",className:"head5 _mgbt_1em",innerHTML:"Sorting"},sort_by:{type:"selectbox",id:"_comp_inline _mgrt_1em",label:"Sort By",default_option:"group",options:{group:"Group"}},sort_order:{type:"selectbox",id:"_comp_inline",label:"Sort Type",default_option:"asc",options:{asc:"Ascending",desc:"Descending"}},_other:{tagName:"h4",className:"head5 _mgbt_1em",innerHTML:"Other Options"},limit:{type:"inputbox",id:"_mgbt_1em _w10em",label:"Limit Results"},_addnew:{tagName:"h4",className:"head5 _mgbt_1em",innerHTML:"Add as new report"},report_name:{type:"inputbox",id:"_comp_inline _w15em _mgrt_05em",label:"Report Name"},save_btn:{type:"button",id:"_comp_inline _mgtp_10x",label:"Save",dlgTo:"scope"}}},_clearfix:{tagName:"div",className:"clearfix"}},validation:{report_name:{required:true},group_by:{required:true}}};app.popups.ReportOptions=new (app.Popup.extend({id:"reportoptions_pp",head:"Report Options",class_name:"_w800px",events:{submit:"submit_form","click .op_btn":"submit_form"},btn_map:{set:["Generate","Generating"]},beforeInit:function(){return true},render:function(g){var f,e;e=this;if(!g){e.form=new app.Form(_.extend({appendTo:e.$el.find(".popup_body")}));e.listenTo(e.form,"all",e.form_ev_handler)}f=e.options;e.form.release();_.extend(e.form,f.schema);e.form.renderInputs();e.setMode("idle");e.current_tab=null;if(f.data){e.form.set_values(f.data.options)}else{e.form.reset()}e.form_ev_handler("changed",e.form.components.group_by_secondary)},form_ev_handler:function(k,i,l){var h,j,n,g,f;h=this;j=h.form.components;if(k=="changed"&&i.name=="group_by_secondary"){if(i.get_value()==""){j.inc_subtotal.set_value("")}h.form[i.get_value()!=""?"show_comps":"hide_comps"](["inc_subtotal"])}else{if(k=="clicked"&&i.name=="save_btn"){n=h.form.validate();if(n){h.form.renderErrors(n);return}f=new (gen_model("/report_settings/"))();g=h.form.get_values(true);f.set({report_type:"str",name:g.report_name,settings:_.omit(g,["report_name"])});f.sync("create",f,{success:function(m,e){app.notifications.add("Success","Report Added successfully","success")},error:function(m,e){app.notifications.add("Error","Error while adding report","error")}})}}},submit_form:function(h){var g,f;g=this.options;f=this.form.get_values(true);g.data.options=f;if(g.callback){g.callback.call(g.invoker,f)}this.close()}}))();a={default_attr:{class_name:"_type1 _sm2"},fields:{report_name:{type:"combobox",id:"_w25em _comp_inline _mgrt_1em",label:"Report Name",dlgTo:"scope",url:"/report_settings/?name={{value}}&report_type=str&pagination=false"},from_date:{type:"datefield",id:"_mgbt_05em _w7em _mgrt_1em",label:"From Date"},to_date:{type:"datefield",id:"_mgbt_05em _w7em _mgrt_1em",label:"To Date"},submit_btn:{type:"button",id:"_mgbt_1em _mgtp_10x _mgrt_1em _theme1",label:"Generate",dlgTo:"scope"},report_options:{type:"button",id:"_mgbt_1em _mgtp_10x _mgrt_05em",label:"Settings",dlgTo:"scope"},clear_btn:{type:"button",id:"_mgbt_1em _mgtp_10x _mgrt_05em",label:"Clear",dlgTo:"scope"},delete_btn:{type:"button",id:"_mgbt_1em _mgtp_10x _mgrt_1em",label:"Delete",dlgTo:"scope"}},validation:{}};d=app.Tab.extend({label:"Advanced Stock Report",tab_id:"adv_stock_report",afterAppend:function(){var e;e=this;e.form=new app.Form(_.extend({appendTo:e.$el},a));e.report_settings={options:{group_by:"supplier_name"}};e.$el.append('<div class="report_cnt"></div>');e.listenTo(e.form,"all",e.form_ev_handler)},form_ev_handler:function(l,h,n){var i,g,f,k,j;g=this;if(l=="clicked"){if(h.name=="report_options"){app.popups.ReportOptions.show({method:"set",invoker:g,schema:c,data:g.report_settings,callback:function(e){_.extend(e,g.form.get_values(true));g.update_report(e)}})}else{if(h.name=="submit_btn"){g.update_report(_.extend({},g.report_settings.options,g.form.get_values(true)))}else{if(h.name=="clear_btn"){g.$el.find(".report_cnt").html("")}else{if(h.name=="delete_btn"){k=g.form.components.report_name;j=k.get_selected_data();if(j){f=new (gen_model("/report_settings/"))({id:j.id});f.destroy({success:function(m,e){k.reset();app.notifications.add("Success","Report deleted successfully","success")},error:function(m,e){app.notifications.add("Error","Error while deleting report","error")}})}}}}}}else{if((l=="item_selected"||l=="keyup")&&h.name=="report_name"){k=h.get_selected_data();if(k){g.report_settings.options=h.get_selected_data().settings}g.form.components.delete_btn[k?"show":"hide"]()}}},update_report:function(g){var e,f;e=this;f=new (gen_model("/reports/stock_adv/"))();e.$el.find(".report_cnt").html("Loading...");f.fetch({data:$.param(g),success:function(h,i){e.form.set_values(_.pick(i,["from_date","to_date"]));e.$el.find(".report_cnt").html(i.html)},error:function(){}})},export_data:function(){var f,e;e=this;f=e.form.get_values();$("#myiframwe").attr("src",app.generate_ext_url("reports","stock_adv",_.extend({op:"export_to_excel"},_.extend({},e.report_settings.options,f))))},onshow:function(){var e;e=this;if(!e.form.is_rendered){e.form.renderInputs()}e.form_ev_handler("item_selected",e.form.components.report_name,null);app.TopButtons.set(["export"])}});if(AL.any_access("sales_report")||true){set_object("streport_tabs","adv_report",d)}});FB_Module.register({index:2},function(){var b=gen_model("/reports/monthly_sales_by_cust/");var c=_.extend({customer_name:{head_label:"Customer",style:"width:16%"}},_.object(_.map(["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],function(d,e){return["month_"+(e+1),{head_label:d,style:"width:7%;text-align:right",type:"money"}]})));var a={default_attr:{class_name:"_type1 _md _comp_inline _mgrt_1em _mgbt_1em"},fields:{customer_name:{type:"combobox",label:"Customer",url:"/cust_n_vendor/customers/?name={{value}}&pagination=false",id:"_w25em",dlgTo:"scope"},year:{type:"selectbox",label:"Year",id:"_w7em",options:(function(){var f,d,g,e,h;f=parse_date(get_cfg("finyear_start")).getFullYear();d=(new Date()).getFullYear();e=[];for(g=d;g>=f;g--){h={};h[g+""]=g+"";e.push(h)}return e})()},submit_btn:{type:"button",id:"_mgtp_10x",label:"Submit",dlgTo:"scope",attrs:{type:"submit"}}}};app.p_views.MonthlySales=app.ListPageTemplate.extend({page_name:"monthly_sales_by_cust",model:b,no_ds_autoload:true,heading_plural:"Monthly Sales by Customer",ds_options:{schema:c,class_name:"hoverable _fz14",ds_id:"ds_month_sales_by_cust",default_params:{}},no_newbtn:true,initialize:function(){this.init({create_el:true})},initComponents:function(){var d=this;d.form=new app.Form(_.extend({appendTo:$("<div></div>").insertAfter(d.$el.find(".content-topsec")),class_name:"msc_form_schema _mgbt_1em"},a));d.form.renderInputs();d.listenTo(d.form,"all",d.form_ev_handler)},form_ev_handler:function(i,g,j){var f,d,h;d=this;f=d.form.get_values(true);if(i=="form_submit"){d.load_ds(f)}else{if(i=="clicked"){d.load_ds(_.extend(f,{}))}}},ds_handler:function(g,l,h,k){var d,j,i,f;d=this;if(g=="before_render"){d.form.reset();d.form.set_values(_.pick(l,["customer_id","year"]));app.router.navigate(app.generate_url("monthly_sales_by_cust",null,_.extend(_.pick(this.form.get_values(true),["customer_id","year"]))),{trigger:false,replace:true})}else{return d._ds_handler(g,l,h,k)}},load_ds:function(e){var d;d=this;e=e||{};d.form.renderServerErrors();d.ds.load({params:e,invoker:d,error:function(f,g){d.form.renderServerErrors(g)}})},onshow:function(f,e){var d;d=this;if(!d.is_inited2){d.initComponents();d.is_inited2=true}d.load_ds(_.extend({year:(new Date()).getFullYear()},e))}});FB_Module.init_fn(function(){app.SideMenu.add_item({view:"reports",item_id:"reports",label:"Reports",index:5,is_disabled:!AL.any_access("sales_report.display")});app.SideMenu.add_item({view:"monthly_sales_by_cust",item_id:"month_sales",index:20,under:"reports",label:"Monthly sales by customer",is_disabled:!AL.any_access("sales_report.display")})})});FB_Module.register({index:2},function(){var g,a;if(!(get_cfg("en_costcenter")=="true"&&AL.any_access("cost_center.list"))){return}var h=gen_model("/cost_centers/");var f={default_attr:{class_name:"_type1 _md _mgbt_1em _mgrt_1em _comp_inline"},fields:{group_by:{type:"selectbox",label:"Group By",id:"_w8em _mgrt_1em",dlgTo:"scope",default_option:"costcenter",options:{costcenter:"Cost Center",account:"Account",item:"Item"}},sec_group_by:{type:"selectbox",label:"Sub Group By",id:"_w8em _mgrt_1em",dlgTo:"scope",default_option:"account",options:{costcenter:"Cost Center",account:"Account",item:"Item"}},display:{type:"selectbox",label:"Display",id:"_w8em _mgrt_1em",dlgTo:"scope",default_option:"condensed",options:{condensed:"Condensed",detailed:"Detailed",item_wise:"Item Wise"}},from_date:{type:"datefield",label:"From Date",id:"_w7em _mg_rt_05em"},to_date:{type:"datefield",label:"To Date",id:"_w7em _mg_rt_05em"},costcenter_id:{type:"combobox",id:"_comp_inline _w20em _mgrt_1em",label:"Cost Center",url:"/cost_centers/?name={{value}}&pagination=false&_select_fields=name,id",value_sel:"id",label_sel:"name"},account_id:{type:"combobox",id:"_comp_inline _w20em _mgrt_1em",label:"Account Name",url:"/accounts/?name={{value}}&is_cntlacc=false&cost_appl=true&pagination=false&_select_fields=name,id",value_sel:"id",label_sel:"name"},item_id:{type:"combobox",id:"_comp_inline _w20em _mgrt_1em",label:"Item",url:"/items/?name_code={{value}}&cost_appl=true&pagination=false&_select_fields=name,id",value_sel:"id",label_sel:"name"},submit_btn:{type:"button",id:"_mgtp_10x",label:"Submit",dlgTo:"scope",attrs:{type:"submit"}}},validation:{}};var e={fields:{particulars:{head_label:"Particulars",width:"100%"},quantity:{head_label:"Quantity",width:"150px",align:"right"},debit:{head_label:"Debit",width:"150px",align:"right",type:"money"},credit:{head_label:"Credit",width:"150px",align:"right",type:"money"},balance:{head_label:"Balance",width:"150px",align:"right",type:"money",wrapSPAN:true}},show_items:["particulars","quantity","debit","credit","balance"]};var c=app.Tab.extend({label:"Summary",tab_id:"costcenter_summary",model:gen_model("/reports/cost_center/"),is_tab_view:true,heading:"Summary",ds_options:{flex_schema:e,class_name:"hoverable _fz14",ds_id:"ds_cost_summary",default_params:{rtype:"summary"}},no_newbtn:true,initComponents:function(){var i=this;i.form=new app.Form(_.extend({appendTo:i.$el,class_name:"ccsummary_form _mgbt_1em"},f));i.form.renderInputs();i.listenTo(i.form,"all",function(k,l){var j;j=i.form.get_values(true);if(k=="form_submit"){i.load_ds(j)}else{if(k=="clicked"){i.load_ds(_.extend(j,{}))}}});i.init()},ds_rendr:function(n){var k,m,l,p,o,j;p=n.$el.find(".table_list > li");for(k in n.rows){m=n.rows[k];j=m.flag.toString();if(j.indexOf("b")!="-1"){p.eq(k).addClass("_b")}if(j[3]=="1"){p.eq(k).addClass("_l1")}}},ds_handler:function(k,p,l,o){var i,n,m,j;i=this;if(k=="li_clicked"){n=l.get_row(p);m={c:"costcenter_id",a:"account_id",i:"item_id"};if(n.flag[1]!="t"){j={};if(n.flag[0]=="b"){j[m[n.flag[1]]]=p;app.router.navigate(app.generate_url("costcenter_reports","costcenter_summary",j),{trigger:true})}else{j[m[n.flag[1]]]=p;j[m[n.flag[2]]]=n.ord1;app.router.navigate(app.generate_url("costcenter_reports","costcenter_detail",objFilter(_.extend(_.pick(l.current_filter,["item_id","costcenter_id","account_id"]),j),function(q){return q!=null})),{trigger:true})}}}else{if(k=="rendered"){i.ds_rendr(l)}else{if(k=="before_render"){i.form.reset();i.form.set_values(_.pick(p,["group_by","sec_group_by","display","from_date","to_date","costcenter_id","account_id","item_id"]));app.router.navigate(app.generate_url("costcenter_reports","costcenter_summary",_.extend(_.pick(this.form.get_values(true),["group_by","sec_group_by","display","from_date","to_date","costcenter_id","account_id","item_id"]))),{trigger:false,replace:true})}else{return i._ds_handler(k,p,l,o)}}}},load_ds:function(j){var i;i=this;j=j||{};i.form.renderServerErrors();i.ds.load({params:j,invoker:i,error:function(k,l){i.form.renderServerErrors(l)}})},onshow:function(j){var i;i=this;if(!i.is_inited){i.initComponents();i.is_inited=true}i.load_ds(_.extend({group_by:"costcenter",sec_group_by:"account",display:"condensed"},j.args))}});c.merge(app.ListPageTemplate,true);var d={default_attr:{class_name:"_type1 _md _mgbt_1em _mgrt_1em _comp_inline"},fields:{from_date:{type:"datefield",label:"From Date",id:"_w7em _mg_rt_05em"},to_date:{type:"datefield",label:"To Date",id:"_w7em _mg_rt_05em"},costcenter_id:{type:"combobox",id:"_comp_inline _w20em _mgrt_1em",label:"Cost Center",url:"/cost_centers/?name={{value}}&pagination=false&_select_fields=name,id",value_sel:"id",label_sel:"name"},account_id:{type:"combobox",id:"_comp_inline _w20em _mgrt_1em",label:"Account Name",url:"/accounts/?name={{value}}&is_cntlacc=false&cost_appl=true&pagination=false&_select_fields=name,id",value_sel:"id",label_sel:"name"},item_id:{type:"combobox",id:"_comp_inline _w20em _mgrt_1em",label:"Item",url:"/items/?name_code={{value}}&cost_appl=true&pagination=false&_select_fields=name,id",value_sel:"id",label_sel:"name"},submit_btn:{type:"button",id:"_mgtp_10x",label:"Submit",dlgTo:"scope",attrs:{type:"submit"}}},validation:{}};var e={fields:{date:{head_label:"Date",width:"100px"},doc_no:{head_label:"Doc No",width:"100px"},costcenter_name:{head_label:"Cost Center",width:"30%"},account_name:{head_label:"Account",width:"30%"},item_name:{head_label:"Item",width:"40%"},qty_txt:{head_label:"Quantity",width:"100px",align:"right"},debit:{head_label:"Debit",width:"100px",align:"right",type:"money"},credit:{head_label:"Credit",width:"100px",align:"right",type:"money"},balance:{head_label:"Balance",width:"100px",align:"right",type:"money",wrapSPAN:true}},show_items:["date","doc_no","costcenter_name","account_name","item_name","qty_txt","debit","credit","balance"]};var b=app.Tab.extend({label:"Detail",tab_id:"costcenter_detail",model:gen_model("/reports/cost_center/"),is_tab_view:true,heading:"Detail",drill_to_view:"voucher",has_unclickable:true,ds_options:{flex_schema:e,class_name:"hoverable _fz14",ds_id:"ds_cost_detail",idAttr:"voucher_id",default_params:{rtype:"detail"}},no_newbtn:true,initComponents:function(){var i=this;i.form=new app.Form(_.extend({appendTo:i.$el,class_name:"ccdetail_form _mgbt_1em"},d));i.form.renderInputs();i.listenTo(i.form,"all",function(k,l){var j;j=i.form.get_values(true);if(k=="form_submit"){i.load_ds(j)}else{if(k=="clicked"){i.load_ds(_.extend(j,{}))}}});i.init()},ds_rendr:function(n){var k,m,l,p,o,j;p=n.$el.find(".table_list > li");for(k in n.rows){m=n.rows[k];j=m.flag.toString();if(j.indexOf("b")!="-1"){p.eq(k).addClass("_b");m.clickable=false}}},load_ds:function(i){i=i||{};this.form.renderServerErrors();this.ds.load({params:i,invoker:this,error:function(j,k){this.form.renderServerErrors(k)}})},ds_handler:function(q,l,j,p){var o,r,i,n,m,k,s,t;t=this;if(q=="before_render"){t.form.reset();t.form.set_values(_.pick(l,["from_date","to_date","costcenter_id","account_id","item_id"]))}else{if(q=="rendered"){this.ds_rendr(j)}else{return this._ds_handler(q,l,j,p)}}},onshow:function(j){var i;i=this;if(!i.is_inited){i.initComponents();i.is_inited=true}i.load_ds(j.args)}});b.merge(app.ListPageTemplate,true);app.p_views.CostCenterReports=app.PageTemplate.extend({page_name:"costcenter_reports",heading_plural:"Cost Center Reports",initialize:function(){var k,i,l,j;j=this;j.init({create_el:true});j.tabs=new app.Tabs({appendTo:j.$el,$scope:j});j.tabs.append([new c(),new b()]);j.listenTo(j.tabs,"tab_show",j.tab_show)},onshow:function(i,j){if(!i){i=this.tabs.current_tab||this.tabs.get_tab(0).tab_id}this.tabs.show_tab(i,{do_replace:true,args:j})},export_data:function(i){var j;j=this.tabs.current_tab;this.tabs.tabs[j].export_data()},print_data:function(i){var j;j=this.tabs.current_tab;this.tabs.tabs[j].print_data()},tab_show:function(j,k,m){var i=this,l=this.tabs.tabs;m.args=k.args;app.router.navigate(app.generate_url(this.page_name,j,k.args),{trigger:false,replace:k.do_replace});var n=this.$el.find(".float-right > *");n.hide()}});FB_Module.init_fn(function(){app.SideMenu.add_item({view:"reports",item_id:"reports",label:"Reports",index:5,is_disabled:!AL.any_access(["cost_center"])});app.SideMenu.add_item({view:"costcenter_reports",item_id:"cc_reports",index:20,under:"reports",label:"Cost Centers",is_disabled:!AL.any_access("cost_center.list")})})});FB_Module.register({index:2},function(){var d,c,g;if(!(get_cfg("en_jobs")=="true"&&AL.any_access("jobs.list"))){return}var e=gen_model("/jobs/");var a={default_attr:{class_name:"_type1 _md _mgbt_1em _mgrt_1em _comp_inline"},fields:{group_by:{type:"selectbox",label:"Group By",id:"_w8em _mgrt_1em",dlgTo:"scope",default_option:"job",options:{job:"Job",phase:"Phase",account:"Account",item:"Item"}},sec_group_by:{type:"selectbox",label:"Sub Group By",id:"_w8em _mgrt_1em",dlgTo:"scope",default_option:"",options:{job:"Job",phase:"Phase",account:"Account",item:"Item"}},display:{type:"selectbox",label:"Display",id:"_w8em _mgrt_1em",dlgTo:"scope",default_option:"condensed",options:{condensed:"Condensed",detailed:"Detailed",item_wise:"Item Wise"}},from_date:{type:"datefield",label:"From Date",id:"_w7em _mg_rt_05em"},to_date:{type:"datefield",label:"To Date",id:"_w7em _mg_rt_05em"},job_id:{type:"combobox",id:"_comp_inline _w20em _mgrt_1em",label:"Job Code",url:"/jobs/?name={{value}}&pagination=false&_select_fields=name,id",value_sel:"id",label_sel:"name"},phase_id:{type:"combobox",id:"_comp_inline _w20em _mgrt_1em",label:"Phase",url:"/phases/?name={{value}}&pagination=false&_select_fields=name,id",value_sel:"id",label_sel:"name"},account_id:{type:"combobox",id:"_comp_inline _w20em _mgrt_1em",label:"Account Name",url:"/accounts/?name={{value}}&is_cntlacc=false&cost_appl=true&pagination=false&_select_fields=name,id",value_sel:"id",label_sel:"name"},item_id:{type:"combobox",id:"_comp_inline _w20em _mgrt_1em",label:"Item",url:"/items/?name_code={{value}}&cost_appl=true&pagination=false&_select_fields=name,id",value_sel:"id",label_sel:"name"},submit_btn:{type:"button",id:"_mgtp_10x _mgrt_3em",label:"Submit",dlgTo:"scope",attrs:{type:"submit"}},expand_btn:{type:"button",id:"_mgtp_10x",label:"Expanded Report",dlgTo:"scope"}},validation:{}};var i={fields:{particulars:{head_label:"Particulars",width:"100%"},quantity:{head_label:"Quantity",width:"150px",align:"right"},debit:{head_label:"Debit",width:"150px",align:"right",type:"money"},credit:{head_label:"Credit",width:"150px",align:"right",type:"money"},balance:{head_label:"Balance",width:"150px",align:"right",type:"money",wrapSPAN:true}},show_items:["particulars","quantity","debit","credit","balance"]};var b=app.Tab.extend({label:"Summary",tab_id:"job_summary",model:gen_model("/reports/job_report/"),is_tab_view:true,heading:"Summary",ds_options:{flex_schema:i,class_name:"hoverable _fz14",ds_id:"ds_cost_summary",idAttr:"indx",default_params:{rtype:"summary"}},no_newbtn:true,initComponents:function(){var m=this;m.form=new app.Form(_.extend({appendTo:m.$el,class_name:"ccsummary_form _mgbt_1em"},a));m.form.renderInputs();m.listenTo(m.form,"all",m.form_ev_handler);m.init()},form_ev_handler:function(q,o,r){var n,m,p;m=this;n=m.form.get_values(true);if(q=="form_submit"){m.load_ds(n)}else{if(q=="clicked"&&o.name=="expand_btn"){p=app.generate_ext_url("reports","job_report",_.extend({rtype:"expanded",op:"get_report_cnt"},m.form.get_values(true)));window.open(p,"_blank").focus()}else{if(q=="clicked"){m.load_ds(_.extend(n,{}))}}}},ds_rendr:function(q){var n,p,o,s,r,m;s=q.$el.find(".table_list > li");for(n in q.rows){p=q.rows[n];m=p.flag.toString();if(m.indexOf("b")!="-1"){s.eq(n).addClass("_b")}if(m[3]=="1"){s.eq(n).addClass("_l1")}}},ds_handler:function(o,t,p,s){var m,r,q,n;m=this;if(o=="li_clicked"){r=p.get_row(t);q={j:"job_id",a:"account_id",p:"phase_id",i:"item_id"};if(r.flag[1]!="t"){n={};app.popups.DrillSel.show({method:"set",invoker:m,ds_row:r,current_filter:p.current_filter,map:{detail:["detail","Detail"],job:["job_id","Job"],phase:["phase_id","Phase"],account:["account_id","Account"],item:["item_id","Item"]},get_item_options:function(y,w){var v,u,x;x=w.current_filter;v=x.group_by;u=r.flag[0]!="b"?x.sec_group_by:null;return _.map(y,function(A,z){return z!=v&&z!=u&&!x[A[0]]?[z,A[0],A[1]]:null})},callback:function(u){if(u!="detail"){n[q[r.flag[1]]]=r.id;if(p.current_filter.display=="detailed"){if(r.flag[0]=="b"){n.group_by=p.current_filter.sec_group_by;n.sec_group_by=u}else{n[q[r.flag[2]]]=r.ord1;n.group_by=u;n.display="condensed"}}else{n.group_by=u}app.router.navigate(app.generate_url("job_reports","job_summary",objFilter(_.extend(_.pick(p.current_filter,["item_id","job_id","phase_id","account_id"]),n),function(w){return w!=null})),{trigger:true})}else{n[q[r.flag[1]]]=r.id;n[q[r.flag[2]]]=r.ord1;app.router.navigate(app.generate_url("job_reports","job_detail",objFilter(_.extend(_.pick(p.current_filter,["item_id","job_id","phase_id","account_id"]),n),function(w){return w!=null})),{trigger:true})}}})}}else{if(o=="rendered"){m.ds_rendr(p)}else{if(o=="before_render"){m.form.reset();m.form.set_values(_.pick(t,["group_by","sec_group_by","display","from_date","to_date","job_id","phase_id","account_id","item_id"]));app.router.navigate(app.generate_url("job_reports","job_summary",_.extend(_.pick(this.form.get_values(true),["group_by","sec_group_by","display","from_date","to_date","job_id","phase_id","account_id","item_id"]))),{trigger:false,replace:true})}else{return m._ds_handler(o,t,p,s)}}}},load_ds:function(n){var m;m=this;n=n||{};m.form.renderServerErrors();m.ds.load({params:n,invoker:m,error:function(o,p){m.form.renderServerErrors(p)}})},onshow:function(n){var m;m=this;if(!m.is_inited){m.initComponents();m.is_inited=true}m.load_ds(_.extend({group_by:"job",sec_group_by:"account",display:"condensed"},n.args));app.focus_handler.focus_comp(m.ds)}});b.merge(app.ListPageTemplate,true);var f={default_attr:{class_name:"_type1 _md _mgbt_1em _mgrt_1em _comp_inline"},fields:{from_date:{type:"datefield",label:"From Date",id:"_w7em _mg_rt_05em"},to_date:{type:"datefield",label:"To Date",id:"_w7em _mg_rt_05em"},job_id:{type:"combobox",id:"_comp_inline _w20em _mgrt_1em",label:"Job Code",url:"/jobs/?name={{value}}&pagination=false&_select_fields=name,id",value_sel:"id",label_sel:"name"},phase_id:{type:"combobox",id:"_comp_inline _w20em _mgrt_1em",label:"Phase",url:"/phases/?name={{value}}&pagination=false&_select_fields=name,id",value_sel:"id",label_sel:"name"},account_id:{type:"combobox",id:"_comp_inline _w20em _mgrt_1em",label:"Account Name",url:"/accounts/?name={{value}}&is_cntlacc=false&cost_appl=true&pagination=false&_select_fields=name,id",value_sel:"id",label_sel:"name"},item_id:{type:"combobox",id:"_comp_inline _w20em _mgrt_1em",label:"Item",url:"/items/?name_code={{value}}&cost_appl=true&pagination=false&_select_fields=name,id",value_sel:"id",label_sel:"name"},submit_btn:{type:"button",id:"_mgtp_10x",label:"Submit",dlgTo:"scope",attrs:{type:"submit"}}},validation:{}};var i={fields:{date:{head_label:"Date",width:"100px"},doc_no:{head_label:"Doc No",width:"100px"},vtype_txt:{head_label:"Vchr Type",width:"100px"},job_name:{head_label:"Job Code",width:"30%"},account_name:{head_label:"Account",width:"30%"},item_name:{head_label:"Item",width:"40%"},qty_txt:{head_label:"Quantity",width:"100px",align:"right"},debit:{head_label:"Debit",width:"100px",align:"right",type:"money"},credit:{head_label:"Credit",width:"100px",align:"right",type:"money"},balance:{head_label:"Balance",width:"100px",align:"right",type:"money",wrapSPAN:true}},show_items:["date","doc_no","vtype_txt","job_name","account_name","item_name","qty_txt","debit","credit","balance"]};var l=app.Tab.extend({label:"Detail",tab_id:"job_detail",model:gen_model("/reports/job_report/"),is_tab_view:true,heading:"Detail",drill_to_view:"voucher",has_unclickable:true,ds_options:{flex_schema:i,class_name:"hoverable _fz14",ds_id:"ds_cost_detail",idAttr:"voucher_id",default_params:{rtype:"detail"}},no_newbtn:true,initComponents:function(){var m=this;m.form=new app.Form(_.extend({appendTo:m.$el,class_name:"ccdetail_form _mgbt_1em"},f));m.form.renderInputs();m.listenTo(m.form,"all",function(o,p){var n;n=m.form.get_values(true);if(o=="form_submit"){m.load_ds(n)}else{if(o=="clicked"){m.load_ds(_.extend(n,{}))}}});m.init()},ds_rendr:function(q){var n,p,o,s,r,m;s=q.$el.find(".table_list > li");for(n in q.rows){p=q.rows[n];m=p.flag.toString();if(m.indexOf("b")!="-1"){s.eq(n).addClass("_b");p.clickable=false}}},load_ds:function(m){m=m||{};this.form.renderServerErrors();this.ds.load({params:m,invoker:this,error:function(n,o){this.form.renderServerErrors(o)}})},ds_handler:function(u,p,n,t){var s,v,m,r,q,o,w,x;x=this;if(u=="before_render"){x.form.reset();x.form.set_values(_.pick(p,["from_date","to_date","job_id","phase_id","account_id","item_id"]))}else{if(u=="rendered"){this.ds_rendr(n)}else{return this._ds_handler(u,p,n,t)}}},onshow:function(n){var m;m=this;if(!m.is_inited){m.initComponents();m.is_inited=true}m.load_ds(n.args)}});l.merge(app.ListPageTemplate,true);var k={fields:{job_name:{head_label:"Job Code",width:"20%"},customer_name:{head_label:"Customer",width:"20%"},est_amount:{head_label:"Estimated Amount",width:"8%",align:"right",type:"money"},t_revenue:{head_label:"Total Revenue",width:"8%",align:"right",type:"money"},t_cost:{head_label:"Total Cost",width:"8%",align:"right",type:"money"},profit:{head_label:"Profit",width:"8%",align:"right",type:"money"},profit_perc:{head_label:"Profit %",width:"8%",align:"right",type:"money"},t_received:{head_label:"Total Received",width:"8%",align:"right",type:"money"},t_paid:{head_label:"Total Paid",width:"8%",align:"right",type:"money"}},show_items:["job_name","customer_name","est_amount","t_revenue","t_cost","profit","profit_perc","t_received","t_paid"]};var j={default_attr:{class_name:"_type1 _md _mgbt_1em _mgrt_1em _comp_inline"},fields:{from_date:{type:"datefield",label:"From Date",id:"_w7em _mg_rt_05em"},to_date:{type:"datefield",label:"To Date",id:"_w7em _mg_rt_05em"},job_id:{type:"combobox",id:"_comp_inline _w20em _mgrt_1em",label:"Job Code",url:"/jobs/?name={{value}}&pagination=false&_select_fields=name,id",value_sel:"id",label_sel:"name"},submit_btn:{type:"button",id:"_mgtp_10x",label:"Submit",dlgTo:"scope",attrs:{type:"submit"}}},validation:{}};var h=app.Tab.extend({label:"Job Status",tab_id:"job_status",model:gen_model("/reports/job_report/"),is_tab_view:true,heading:"Job Status",drill_to_view:"voucher",has_unclickable:true,ds_options:{flex_schema:k,class_name:"hoverable _fz14",ds_id:"ds_cost_status",idAttr:"id",default_params:{rtype:"status"}},no_newbtn:true,initComponents:function(){var m=this;m.form=new app.Form(_.extend({appendTo:m.$el,class_name:"ccstatus_form _mgbt_1em"},j));m.form.renderInputs();m.listenTo(m.form,"all",function(o,p){var n;n=m.form.get_values(true);if(o=="form_submit"){m.load_ds(n)}else{if(o=="clicked"){m.load_ds(_.extend(n,{}))}}});m.init()},load_ds:function(m){m=m||{};this.form.renderServerErrors();this.ds.load({params:m,invoker:this,error:function(n,o){this.form.renderServerErrors(o)}})},ds_handler:function(u,p,n,t){var s,v,m,r,q,o,w,x;x=this;if(u=="before_render"){x.form.reset();x.form.set_values(_.pick(p,["from_date","to_date","job_id","customer_id"]))}else{if(u=="li_clicked"){g.show({method:"set",job_id:p})}else{return this._ds_handler(u,p,n,t)}}},onshow:function(n){var m;m=this;if(!m.is_inited){m.initComponents();m.is_inited=true}m.load_ds(n.args)}});h.merge(app.ListPageTemplate,true);g=new (app.Popup.extend({id:"jbstatus_pp",head:"Job Status",center_on_init:false,disable_anim:true,removalDelay:100,class_name:"_mw1200x",manual_focus:true,btn_map:{set:["OK","OK"]},events:{"click .op_btn":"submit_form"},beforeInit:function(){return true},afterShow:function(){this.center()},render:function(q){var r,n,o;n=this;o=n.options;if(!q){n.$el.find(".popup_body").append('<iframe class="report_cnt" style="min-height:600px;width:100%"></iframe>')}n.setMode("idle");var p,m;setTimeout(function(){n.set_data()},500)},set_data:function(){var o,p;o=this;p=o.options;iframe_write(o.$el.find(".report_cnt")[0],'<span style="text-align:center;padding:2em 0;font-size:1.4em;color:#e65f5f;font-weight: 600;display: block;">Loading...</span>');var n=new (gen_model("/reports/job_report/"));n.fetch({data:$.param({rtype:"status",job_id:p.job_id}),success:function(q,m){iframe_write(o.$el.find(".report_cnt")[0],m.html)},error:function(m,q){}})},submit_form:function(m){this.close()}}))();app.p_views.JobReports=app.PageTemplate.extend({page_name:"job_reports",heading_plural:"Job Reports",initialize:function(){var o,m,p,n;n=this;n.init({create_el:true});n.tabs=new app.Tabs({appendTo:n.$el,$scope:n});n.tabs.append([new b(),new l(),new h()]);n.listenTo(n.tabs,"tab_show",n.tab_show)},onshow:function(m,n){if(!m){m=this.tabs.current_tab||this.tabs.get_tab(0).tab_id}this.tabs.show_tab(m,{do_replace:true,args:n})},export_data:function(m){var n;n=this.tabs.current_tab;this.tabs.tabs[n].export_data()},print_data:function(m){var n;n=this.tabs.current_tab;this.tabs.tabs[n].print_data()},tab_show:function(n,o,q){var m=this,p=this.tabs.tabs;q.args=o.args;app.router.navigate(app.generate_url(this.page_name,n,o.args),{trigger:false,replace:o.do_replace});var r=this.$el.find(".float-right > *");r.hide()}});FB_Module.init_fn(function(){app.SideMenu.add_item({view:"reports",item_id:"reports",label:"Reports",index:5,is_disabled:!AL.any_access(["jobs"])});app.SideMenu.add_item({view:"job_reports",item_id:"job_reports",index:20,under:"reports",label:"Job Report",is_disabled:!AL.any_access("jobs.list")})})});FB_Module.register({index:2},function(){var c,d,b;c={default_attr:{class_name:"_type1 _sm2 _mgrt_05em _comp_inline"},fields:{from_date:{type:"datefield",label:"From Date",id:"_w7em "},to_date:{type:"datefield",label:"To Date",id:"_w7em _mgrt_2em"},status:{type:"selectbox",label:"Status",options:{"pd,prd":"Pending & Partial Delivery",pri:"Partially Invoiced",dvi:"Delivered and Invoiced"},default_option:"",id:"_w12em"},excl_status:{type:"checkbox",value:"true",id:"_mgtp_1em _mgrt_2em",label:"Inverted"},customer_name:{type:"combobox",id:"_w20em _mgrt_1em",label:"Customer",url:"/cust_n_vendor/customers/?name={{value}}&pagination=false",dlgTo:"scope"},supplier_name:{type:"combobox",id:"_w20em _mgrt_1em",label:"Supplier",url:"/cust_n_vendor/suppliers/?name={{value}}&pagination=false",dlgTo:"scope"},_submit_btn:{tagName:"button",className:"component btn _type1 _md _theme1 _mg_rt_05em _mgtp_9x",innerHTML:"Submit",attrs:{type:"submit"}}},validation:{from_date:{pattern:"date",required:false},to_date:{pattern:"date",required:false}}};d={fields:{date:{head_label:"Date",width:"85px",index:0},doc_no:{head_label:"Doc No",width:"7%",index:0},po_no:{head_label:"P/O No",width:"9%",index:1},customer_name:{head_label:"Customer",width:"16%",index:1},supplier_name:{head_label:"Supplier",width:"16%",index:1},item_name:{head_label:"Particulars",width:"15%",index:1},o_q:{head_label:"Ordered Qty",width:"7%",align:"right",index:1,type:"money"},d_q:{head_label:"Delivered Qty",width:"7%",align:"right",index:1,type:"money"},d_txt:{head_label:"DNote No",width:"7%",align:"left",index:1},dbl_q:{head_label:"DN Balance Qty",width:"8%",align:"right",index:1,type:"money"},iv_q:{head_label:"Invoiced Qty",width:"7%",align:"right",index:1,type:"money"},iv_txt:{head_label:"INV No",width:"7%",align:"left",index:1},ivbl_q:{head_label:"IV Balance Qty",width:"8%",align:"right",index:1,type:"money"},status:{head_label:"Status",key:"status_txt",width:"9%"}},show_items:["date","doc_no","po_no","customer_name","supplier_name","item_name","o_q","d_txt","d_q","dbl_q","iv_txt","iv_q","ivbl_q","status"]};var a={before_init:function(f){var e;e=this;e.form=new app.Form({appendTo:this.$el,class_name:e.form_class,default_attr:c.default_attr,fields:_.omit(c.fields,e.form_omit),validation:_.omit(c.validation,e.form_omit)});e.listenTo(e.form,"form_submit",function(h){var g=this.form.get_values(true);this.load_ds(g);app.router.navigate(app.generate_url("reports",this.tab_id,g,{replace:true,trigger:false}))})},ds_event_handler:function(n,j,g,l){var q,k,m,f,p,h,o;o=this;h={pd:"Pending",prd:"Partial Delivery",dv:"Delivered not "+o.doc_txt,pri:"Partially "+o.doc_txt,dvi:"Delivered and "+o.doc_txt};if(n=="li_clicked"){q=g.get_row(j);app.router.navigate(app.generate_url("voucher",q.voucher_id,null),{trigger:true})}else{if(n=="before_render"){m=j.items;p=null;for(k=0;k<m.length;k++){f=m[k];if(f.voucher_id!=p){p=f.voucher_id;f.status_txt=h[f.status]}else{f.date="";f.doc_no="";f.po_no="";f.customer_name="";f.supplier_name="";f.d_txt="";f.iv_txt="";f.status_txt=""}}}else{if(n=="rendered"){this.ds_rendr(g)}}}},ds_rendr:function(l){var h,k,j,m,e,f,g;e={pd:"_red",prd:"_yellow",dv:"_blue",pri:"_blue",dvi:"_green"};f=false;g=null;m=l.$el.find(".table_list > li");for(h in l.rows){k=l.rows[h];m.eq(h).find(">ul>._cstatus_txt").addClass(e[k.status]);if(k.voucher_id!=g){f=!f;g=k.voucher_id}if(k.d_q==0){j="_red"}else{if(k.d_q<k.o_q){j="_yellow"}else{j="_green"}}m.eq(h).find(">ul>._cdbl_q").addClass(j);if(k.iv_q==0){j="_red"}else{if(k.iv_q<k.o_q){j="_yellow"}else{j="_green"}}m.eq(h).find(">ul>._civbl_q").addClass(j);if(f){m.eq(h).addClass("_silver")}}},load_ds:function(e){e=e||{};this.form.renderServerErrors();this.ds.load({params:e,invoker:this,error:function(f,g){this.form.renderServerErrors(g)}})},print_data:function(){var e,f;e=app.generate_ext_url("reports",this.tab_id,_.extend({op:"print_preview"},this.form.get_values(),null));window.open(e,"_blank").addEventListener("load",function(){this.focus();this.print()},false)},export_data:function(){var e=this.form.get_values(true);$("#myiframwe").attr("src",app.generate_ext_url("reports",this.tab_id,_.extend({op:"export_to_excel"},e,null)))},onshow:function(){var f,e;e=this;if(!e.form.is_rendered){e.form.renderInputs()}app.TopButtons.set(["print","export"]);f=e.args;e.load_ds(_.pick(f,["from_date","to_date"]))}};if(AL.any_access("sale_order.display")&&get_doctype("sor").is_enabled=="true"){app.p_views.SO_Reports=app.ListPageTemplate.extend(_.extend({},a,{page_name:"so_report",model:gen_model("/reports/so_report/"),ds_options:{idAttr:"id",head:"&nbsp;",default_params:{},class_name:"hoverable ds_with_head",ds_id:"so_report_ds",enable_sorting:true,has_filter:true,flex_schema:d},header_btns:["export"],drill_to_view:"voucher",no_newbtn:true,ds_omit:["supplier_name"],form_omit:["supplier_name"],doc_txt:"Invoiced",heading_plural:"Sale Order Report",initialize:function(){this.init({create_el:true})}}));FB_Module.init_fn(function(){app.SideMenu.add_item({item_id:"reports",label:"Reports",index:5});app.SideMenu.add_item({view:"so_report",item_id:"so_report",under:"reports",label:"Sale Order Report",is_disabled:!AL.any_access("sale_order.display")})})}if(AL.any_access("purchase_order.display")&&get_doctype("po").is_enabled=="true"){app.p_views.PO_Reports=app.ListPageTemplate.extend(_.extend({},a,{page_name:"po_report",model:gen_model("/reports/po_report/"),ds_options:{idAttr:"id",head:"&nbsp;",default_params:{},class_name:"hoverable ds_with_head",ds_id:"po_report_ds",enable_sorting:true,has_filter:true,flex_schema:d},header_btns:["export"],ds_omit:["customer_name"],form_omit:["customer_name"],drill_to_view:"voucher",no_newbtn:true,doc_txt:"Billed",heading_plural:"Purchase Order Report",initialize:function(){this.init({create_el:true})}}));FB_Module.init_fn(function(){app.SideMenu.add_item({item_id:"reports",label:"Reports",index:5});app.SideMenu.add_item({view:"po_report",item_id:"po_report",under:"reports",label:"P/O Report",is_disabled:!AL.any_access("purchase_order.display")})})}});FB_Module.register({index:2},function(){var b,a;b={default_attr:{class_name:"_type1 _sm2 _comp_inline _mgrt_1em _mgbt_05em"},fields:{from_date:{type:"datefield",id:"_w7em _mgtp_1x",label:"From Date"},to_date:{type:"datefield",id:"_w7em _mgtp_1x",label:"To Date"},submit_btn:{type:"button",id:"_mgtp_10x _mgrt_2em",attrs:{type:"submit"},label:"Submit",dlgTo:"scope"},select_all:{type:"checkbox",value:"true",id:"_mgtp_10x _mgrt_7em",label:"Select All",dlgTo:"scope"},print_all_btn:{type:"button",id:"_mgtp_10x _theme1",label:"Print Seperate",dlgTo:"scope"},print_summ_btn:{type:"button",id:"_mgtp_10x _theme1",label:"Print Summary",dlgTo:"scope"}}};a={check_box:{head_label:" ",style:"width:3.5%",index:0},date:{head_label:"Date",style:"width:10%",index:0},doc_no:{head_label:"Doc No",style:"width:10%",index:0},customer_name:{head_label:"Customer",style:"width:26.5%",index:0},particulars:{head_label:"Particulars",style:"width:30%",index:0},total_n:{head_label:"No of Items",style:"width:10%;text-align:right",index:0},total_q:{head_label:"Total Quantity",style:"width:10%;text-align:right",index:0}};app.popups.MultiVchrPopup=new (app.Popup.extend({class_name:"_mw1000x",show_save_n_next:false,head:function(){return"Multi Voucher Print"},events:{"click .op_btn":"submit_form"},model:gen_model("/multi_vchr_print/"),beforeInit:function(){return true},render:function(e){var h,g,f,d,c;c=this;if(!e){g=c.form=new app.Form(_.extend({appendTo:c.$el.find(".popup_body")},b));g.renderInputs();c.listenTo(g,"all",c.form_ev_handler);c.ds=new app.DS({head:"Items",class_name:"hoverable ds_with_head ds_scrollable",ds_id:"ds_vlist",check_box:true,has_pagination:true,handle_pagination:true,schema:a,default_params:{pagination:true,per_page:20,op:"get_list"},model:new c.model,appendTo:this.$el.find(".popup_body")});c.listenTo(c.ds,"all",this.ds_ev_handler)}h=c.options.data;c.setMode("idle");c.current_tab=null;c.form.reset();if(h){c.form.set_values(h)}else{c.form.set_values({from_date:app.get_new_voucher_date(),to_date:app.get_new_voucher_date()})}c.ds.load({params:c.form.get_values(true)})},ds_ev_handler:function(d,h,f,g,c){if(d=="rendered"){this.center()}else{if(d=="checkbox_cliked"){this.form.components.select_all.set_value("")}}},form_ev_handler:function(g,f,i){var c,d,h;d=this;if(g=="clicked"){if(f.name=="print_all_btn"||f.name=="print_summ_btn"){c=new d.model;h=_.values(this.ds.get_checked_rows(true));c.fetch({data:$.param(_.extend({op:f.name=="print_all_btn"?"print_preview":"print_combined",fmt_name:"STORE_PRINT"},d.form.get_values(true),{selected_ids:h.join(",")})),success:function(j,e){app.utils.print_content(e.print_html)},error:function(e,j){}})}else{if(f.name=="select_all"){this.ds.check_uncheck_all(f.get_value()=="true")}}}else{if(g=="form_submit"){d.ds.load({params:d.form.get_values(true)})}}}}))();if(get_cfg("en_dailyreport")=="true"){app.popups.DailyReport=new (app.Popup.extend({class_name:"_mw700x",show_save_n_next:false,head:function(){return"Daily Sale Report"},events:{"click .op_btn":"submit_form"},model:gen_model("/reports/transaction_summary/"),beforeInit:function(){return true},render:function(e){var h,g,f,d,c;c=this;if(!e){g=c.form=new app.Form(_.extend({appendTo:c.$el.find(".popup_body"),class_name:"_mgbt_1em"},{default_attr:{class_name:"_type1 _sm2 _comp_inline _mgrt_1em _mgbt_05em"},fields:{date:{type:"datefield",id:"_w7em _mgtp_1x",label:"Date"},submit_btn:{type:"button",id:"_mgtp_10x _mgrt_2em",attrs:{type:"submit"},label:"Submit",dlgTo:"scope"},print_btn:{type:"button",id:"_mgtp_10x _theme1",label:"Print",dlgTo:"scope"}}}));g.renderInputs();c.data_table=new app.Table({appendTo:this.$el.find(".popup_body")});c.listenTo(g,"all",c.form_ev_handler)}h=c.options.data;c.setMode("idle");c.form.reset();if(h){c.form.set_values(h)}else{c.form.set_values({date:app.get_new_voucher_date()})}c.form_ev_handler("form_submit")},fetch_data:function(f,e){var c,d;d=this;c=new d.model;return c.fetch({data:$.param(_.extend(f,d.form.get_values(true))),success:e,error:function(g,h){d.xhr.abort();app.notifications.add("Error","Unable to load data please try later","error")}})},form_ev_handler:function(g,f,i){var c,d,h;d=this;if(g=="clicked"){if(f.name=="print_btn"){d.fetch_data({op:"print_preview",get_sale_summary:true},function(j,e){app.utils.print_content(e.print_html)})}}else{if(g=="form_submit"){d.data_table.$el.html("<span>Loading...</span>");if(d.xhr){d.xhr.abort()}d.xhr=d.fetch_data({get_sale_summary:true},function(n,k){var q,m,e,o,l,j,p;d.xhr.abort();e={schema:[{class_name:"_w2 key_col _theme1 _lg"},{class_name:"_w2 name_col _theme2 _lg _ralign"}]};q=["cash_sales","card_sales","credit_sales","total_sales","cash_sale_ret","card_sale_ret","credit_sale_ret","total_sale_return","net_cash_sales","net_card_sales","net_credit_sales","net_sales"];l={};for(m=0;m<q.length;m++){o=q[m];p=k.data[o];j=to_money(p.value);if(o.indexOf("total")!=-1||o=="net_sales"){j="<strong>"+j+"</strong>"}l[o]=[p.label,j]}e.data=l;d.data_table.render(e);d.center()})}}}}))()}});